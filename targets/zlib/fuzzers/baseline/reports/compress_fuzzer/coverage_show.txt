/home/minseo/alfha/targets/zlib/fuzzers/baseline/harnesses/ossfuzz_zlib/compress_fuzzer.c:
    1|       |/* Copyright 2022 Google LLC
    2|       |Licensed under the Apache License, Version 2.0 (the "License");
    3|       |you may not use this file except in compliance with the License.
    4|       |You may obtain a copy of the License at
    5|       |      http://www.apache.org/licenses/LICENSE-2.0
    6|       |Unless required by applicable law or agreed to in writing, software
    7|       |distributed under the License is distributed on an "AS IS" BASIS,
    8|       |WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    9|       |See the License for the specific language governing permissions and
   10|       |limitations under the License.
   11|       |*/
   12|       |
   13|       |#include <stdio.h>
   14|       |#include <stddef.h>
   15|       |#include <stdint.h>
   16|       |#include <string.h>
   17|       |#include <assert.h>
   18|       |#include <stdlib.h>
   19|       |#include <inttypes.h>
   20|       |#include "zlib.h"
   21|       |
   22|       |static const uint8_t *data;
   23|       |static size_t dataLen;
   24|       |
   25|       |static void check_compress_level(uint8_t *compr, size_t comprLen,
   26|       |                                 uint8_t *uncompr, size_t uncomprLen,
   27|   263k|                                 int level) {
   28|   263k|  compress2(compr, &comprLen, data, dataLen, level);
   29|   263k|  uncompress(uncompr, &uncomprLen, compr, comprLen);
   30|       |
   31|       |  /* Make sure compress + uncompress gives back the input data. */
   32|   263k|  assert(dataLen == uncomprLen);
   33|   263k|  assert(0 == memcmp(data, uncompr, dataLen));
   34|   263k|}
   35|       |
   36|   526k|#define put_byte(s, i, c) {s[i] = (unsigned char)(c);}
   37|       |
   38|   263k|static void write_zlib_header(uint8_t *s, unsigned compression_method, unsigned flags) {
   39|   263k|  unsigned int header = (Z_DEFLATED + ((flags)<<4)) << 8;
   40|   263k|  header |= (compression_method << 6);
   41|       |
   42|   263k|  header += 31 - (header % 31);
   43|       |
   44|       |  /* s is guaranteed to be longer than 2 bytes. */
   45|   263k|  put_byte(s, 0, (unsigned char)(header >> 8));
   46|   263k|  put_byte(s, 1, (unsigned char)(header & 0xff));
   47|   263k|}
   48|       |
   49|   263k|static void check_decompress(uint8_t *compr, size_t comprLen, unsigned compression_method, unsigned flags) {
   50|       |  /* We need to write a valid zlib header of size two bytes. Copy the input data
   51|       |     in a larger buffer. Do not modify the input data to avoid libFuzzer error:
   52|       |     fuzz target overwrites its const input. */
   53|   263k|  size_t copyLen = dataLen + 2;
   54|   263k|  uint8_t *copy = (uint8_t *)malloc(copyLen);
   55|   263k|  memcpy(copy + 2, data, dataLen);
   56|   263k|  write_zlib_header(copy, compression_method, flags);
   57|       |
   58|   263k|  uncompress(compr, &comprLen, copy, copyLen);
   59|   263k|  free(copy);
   60|   263k|}
   61|       |
   62|   376k|int LLVMFuzzerTestOneInput(const uint8_t *d, size_t size) {
   63|   376k|  if (size < 10 || size > 1024 * 1024)
                                 ^263k
  ------------------
  |  Branch (63:7): [True: 113k, False: 263k]
  |  Branch (63:20): [True: 0, False: 263k]
  ------------------
   64|   113k|    return 0;
   65|       |
   66|   263k|  const int level = d[0] % 10;
   67|   263k|  d++,size--;
   68|       |
   69|       |  //https://web.archive.org/web/20200220015003/http://www.onicos.com/staff/iz/formats/gzip.html
   70|   263k|  unsigned compression_method = d[0] % 5;
   71|   263k|  if (compression_method == 4)  //[4...7] are reserved
  ------------------
  |  Branch (71:7): [True: 94.3k, False: 168k]
  ------------------
   72|  94.3k|    compression_method = 8;
   73|   263k|  d++,size--;
   74|   263k|  unsigned flags = d[0] & (2 << 4);
   75|   263k|  d++,size--;
   76|       |
   77|   263k|  size_t comprLen = compressBound(size);
   78|   263k|  size_t uncomprLen = size;
   79|   263k|  uint8_t *compr = NULL, *uncompr = NULL;
   80|       |
   81|   263k|  data = d;
   82|   263k|  dataLen = size;
   83|   263k|  compr = (uint8_t *)calloc(1, comprLen);
   84|   263k|  if (!compr)
  ------------------
  |  Branch (84:7): [True: 0, False: 263k]
  ------------------
   85|      0|    goto err;
   86|   263k|  uncompr = (uint8_t *)calloc(1, uncomprLen);
   87|   263k|  if (!uncompr)
  ------------------
  |  Branch (87:7): [True: 0, False: 263k]
  ------------------
   88|      0|    goto err;
   89|       |
   90|   263k|  check_compress_level(compr, comprLen, uncompr, uncomprLen, level);
   91|   263k|  check_decompress(compr, comprLen, compression_method, flags);
   92|       |
   93|   263k|err:
   94|   263k|  free(compr);
   95|   263k|  free(uncompr);
   96|       |
   97|       |  /* This function must return 0. */
   98|   263k|  return 0;
   99|   263k|}

/home/minseo/alfha/targets/zlib/target/adler32.c:
    1|       |/* adler32.c -- compute the Adler-32 checksum of a data stream
    2|       | * Copyright (C) 1995-2011, 2016 Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* @(#) $Id$ */
    7|       |
    8|       |#include "zutil.h"
    9|       |
   10|  1.08M|#define BASE 65521U     /* largest prime smaller than 65536 */
   11|   252k|#define NMAX 5552
   12|       |/* NMAX is the largest n such that 255n(n+1)/2 + (n+1)(BASE-1) <= 2^32-1 */
   13|       |
   14|  16.5M|#define DO1(buf,i)  {adler += (buf)[i]; sum2 += adler;}
   15|  8.25M|#define DO2(buf,i)  DO1(buf,i); DO1(buf,i+1);
   16|  4.12M|#define DO4(buf,i)  DO2(buf,i); DO2(buf,i+2);
   17|  2.06M|#define DO8(buf,i)  DO4(buf,i); DO4(buf,i+4);
   18|  1.03M|#define DO16(buf)   DO8(buf,0); DO8(buf,8);
   19|       |
   20|       |/* use NO_DIVIDE if your processor does not do division in hardware --
   21|       |   try it both ways to see which is faster */
   22|       |#ifdef NO_DIVIDE
   23|       |/* note that this assumes BASE is 65521, where 65536 % 65521 == 15
   24|       |   (thank you to John Reiser for pointing this out) */
   25|       |#  define CHOP(a) \
   26|       |    do { \
   27|       |        unsigned long tmp = a >> 16; \
   28|       |        a &= 0xffffUL; \
   29|       |        a += (tmp << 4) - tmp; \
   30|       |    } while (0)
   31|       |#  define MOD28(a) \
   32|       |    do { \
   33|       |        CHOP(a); \
   34|       |        if (a >= BASE) a -= BASE; \
   35|       |    } while (0)
   36|       |#  define MOD(a) \
   37|       |    do { \
   38|       |        CHOP(a); \
   39|       |        MOD28(a); \
   40|       |    } while (0)
   41|       |#  define MOD63(a) \
   42|       |    do { /* this assumes a is not negative */ \
   43|       |        z_off64_t tmp = a >> 32; \
   44|       |        a &= 0xffffffffL; \
   45|       |        a += (tmp << 8) - (tmp << 5) + tmp; \
   46|       |        tmp = a >> 16; \
   47|       |        a &= 0xffffL; \
   48|       |        a += (tmp << 4) - tmp; \
   49|       |        tmp = a >> 16; \
   50|       |        a &= 0xffffL; \
   51|       |        a += (tmp << 4) - tmp; \
   52|       |        if (a >= BASE) a -= BASE; \
   53|       |    } while (0)
   54|       |#else
   55|   505k|#  define MOD(a) a %= BASE
   56|   288k|#  define MOD28(a) a %= BASE
   57|      0|#  define MOD63(a) a %= BASE
   58|       |#endif
   59|       |
   60|       |/* ========================================================================= */
   61|  1.38M|uLong ZEXPORT adler32_z(uLong adler, const Bytef *buf, z_size_t len) {
   62|  1.38M|    unsigned long sum2;
   63|  1.38M|    unsigned n;
   64|       |
   65|       |    /* split Adler-32 into component sums */
   66|  1.38M|    sum2 = (adler >> 16) & 0xffff;
   67|  1.38M|    adler &= 0xffff;
   68|       |
   69|       |    /* in case user likes doing a byte at a time, keep it fast */
   70|  1.38M|    if (len == 1) {
  ------------------
  |  Branch (70:9): [True: 760, False: 1.38M]
  ------------------
   71|    760|        adler += buf[0];
   72|    760|        if (adler >= BASE)
  ------------------
  |  Branch (72:13): [True: 0, False: 760]
  ------------------
   73|      0|            adler -= BASE;
   74|    760|        sum2 += adler;
   75|    760|        if (sum2 >= BASE)
  ------------------
  |  Branch (75:13): [True: 0, False: 760]
  ------------------
   76|      0|            sum2 -= BASE;
   77|    760|        return adler | (sum2 << 16);
   78|    760|    }
   79|       |
   80|       |    /* initial Adler-32 value (deferred check for len == 1 speed) */
   81|  1.38M|    if (buf == Z_NULL)
  ------------------
  |  Branch (81:9): [True: 841k, False: 541k]
  ------------------
   82|   841k|        return 1L;
   83|       |
   84|       |    /* in case short lengths are provided, keep it somewhat fast */
   85|   541k|    if (len < 16) {
  ------------------
  |  Branch (85:9): [True: 288k, False: 252k]
  ------------------
   86|  2.76M|        while (len--) {
  ------------------
  |  Branch (86:16): [True: 2.48M, False: 288k]
  ------------------
   87|  2.48M|            adler += *buf++;
   88|  2.48M|            sum2 += adler;
   89|  2.48M|        }
   90|   288k|        if (adler >= BASE)
  ------------------
  |  Branch (90:13): [True: 0, False: 288k]
  ------------------
   91|      0|            adler -= BASE;
   92|   288k|        MOD28(sum2);            /* only added so many BASE's */
   93|   288k|        return adler | (sum2 << 16);
   94|   288k|    }
   95|       |
   96|       |    /* do length NMAX blocks -- requires just one modulo operation */
   97|   252k|    while (len >= NMAX) {
  ------------------
  |  Branch (97:12): [True: 0, False: 252k]
  ------------------
   98|      0|        len -= NMAX;
   99|      0|        n = NMAX / 16;          /* NMAX is divisible by 16 */
  100|      0|        do {
  101|      0|            DO16(buf);          /* 16 sums unrolled */
  102|      0|            buf += 16;
  103|      0|        } while (--n);
  ------------------
  |  Branch (103:18): [True: 0, False: 0]
  ------------------
  104|      0|        MOD(adler);
  105|      0|        MOD(sum2);
  106|      0|    }
  107|       |
  108|       |    /* do remaining bytes (less than NMAX, still just one modulo) */
  109|   252k|    if (len) {                  /* avoid modulos if none remaining */
  ------------------
  |  Branch (109:9): [True: 252k, False: 0]
  ------------------
  110|  1.28M|        while (len >= 16) {
  ------------------
  |  Branch (110:16): [True: 1.03M, False: 252k]
  ------------------
  111|  1.03M|            len -= 16;
  112|  1.03M|            DO16(buf);
  113|  1.03M|            buf += 16;
  114|  1.03M|        }
  115|  1.89M|        while (len--) {
  ------------------
  |  Branch (115:16): [True: 1.64M, False: 252k]
  ------------------
  116|  1.64M|            adler += *buf++;
  117|  1.64M|            sum2 += adler;
  118|  1.64M|        }
  119|   252k|        MOD(adler);
  120|   252k|        MOD(sum2);
  121|   252k|    }
  122|       |
  123|       |    /* return recombined sums */
  124|   252k|    return adler | (sum2 << 16);
  125|   541k|}
  126|       |
  127|       |/* ========================================================================= */
  128|  1.38M|uLong ZEXPORT adler32(uLong adler, const Bytef *buf, uInt len) {
  129|  1.38M|    return adler32_z(adler, buf, len);
  130|  1.38M|}
  131|       |
  132|       |/* ========================================================================= */
  133|      0|local uLong adler32_combine_(uLong adler1, uLong adler2, z_off64_t len2) {
  134|      0|    unsigned long sum1;
  135|      0|    unsigned long sum2;
  136|      0|    unsigned rem;
  137|       |
  138|       |    /* for negative len, return invalid adler32 as a clue for debugging */
  139|      0|    if (len2 < 0)
  ------------------
  |  Branch (139:9): [True: 0, False: 0]
  ------------------
  140|      0|        return 0xffffffffUL;
  141|       |
  142|       |    /* the derivation of this formula is left as an exercise for the reader */
  143|      0|    MOD63(len2);                /* assumes len2 >= 0 */
  144|      0|    rem = (unsigned)len2;
  145|      0|    sum1 = adler1 & 0xffff;
  146|      0|    sum2 = rem * sum1;
  147|      0|    MOD(sum2);
  148|      0|    sum1 += (adler2 & 0xffff) + BASE - 1;
  149|      0|    sum2 += ((adler1 >> 16) & 0xffff) + ((adler2 >> 16) & 0xffff) + BASE - rem;
  150|      0|    if (sum1 >= BASE) sum1 -= BASE;
  ------------------
  |  Branch (150:9): [True: 0, False: 0]
  ------------------
  151|      0|    if (sum1 >= BASE) sum1 -= BASE;
  ------------------
  |  Branch (151:9): [True: 0, False: 0]
  ------------------
  152|      0|    if (sum2 >= ((unsigned long)BASE << 1)) sum2 -= ((unsigned long)BASE << 1);
  ------------------
  |  Branch (152:9): [True: 0, False: 0]
  ------------------
  153|      0|    if (sum2 >= BASE) sum2 -= BASE;
  ------------------
  |  Branch (153:9): [True: 0, False: 0]
  ------------------
  154|      0|    return sum1 | (sum2 << 16);
  155|      0|}
  156|       |
  157|       |/* ========================================================================= */
  158|      0|uLong ZEXPORT adler32_combine(uLong adler1, uLong adler2, z_off_t len2) {
  159|      0|    return adler32_combine_(adler1, adler2, len2);
  160|      0|}
  161|       |
  162|      0|uLong ZEXPORT adler32_combine64(uLong adler1, uLong adler2, z_off64_t len2) {
  163|      0|    return adler32_combine_(adler1, adler2, len2);
  164|      0|}

/home/minseo/alfha/targets/zlib/target/compress.c:
    1|       |/* compress.c -- compress a memory buffer
    2|       | * Copyright (C) 1995-2005, 2014, 2016 Jean-loup Gailly, Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* @(#) $Id$ */
    7|       |
    8|       |#define ZLIB_INTERNAL
    9|       |#include "zlib.h"
   10|       |
   11|       |/* ===========================================================================
   12|       |     Compresses the source buffer into the destination buffer. The level
   13|       |   parameter has the same meaning as in deflateInit.  sourceLen is the byte
   14|       |   length of the source buffer. Upon entry, destLen is the total size of the
   15|       |   destination buffer, which must be at least 0.1% larger than sourceLen plus
   16|       |   12 bytes. Upon exit, destLen is the actual size of the compressed buffer.
   17|       |
   18|       |     compress2 returns Z_OK if success, Z_MEM_ERROR if there was not enough
   19|       |   memory, Z_BUF_ERROR if there was not enough room in the output buffer,
   20|       |   Z_STREAM_ERROR if the level parameter is invalid.
   21|       |*/
   22|       |int ZEXPORT compress2(Bytef *dest, uLongf *destLen, const Bytef *source,
   23|   263k|                      uLong sourceLen, int level) {
   24|   263k|    z_stream stream;
   25|   263k|    int err;
   26|   263k|    const uInt max = (uInt)-1;
   27|   263k|    uLong left;
   28|       |
   29|   263k|    left = *destLen;
   30|   263k|    *destLen = 0;
   31|       |
   32|   263k|    stream.zalloc = (alloc_func)0;
   33|   263k|    stream.zfree = (free_func)0;
   34|   263k|    stream.opaque = (voidpf)0;
   35|       |
   36|   263k|    err = deflateInit(&stream, level);
   37|   263k|    if (err != Z_OK) return err;
                                   ^0
  ------------------
  |  Branch (37:9): [True: 0, False: 263k]
  ------------------
   38|       |
   39|   263k|    stream.next_out = dest;
   40|   263k|    stream.avail_out = 0;
   41|   263k|    stream.next_in = (z_const Bytef *)source;
   42|   263k|    stream.avail_in = 0;
   43|       |
   44|   263k|    do {
   45|   263k|        if (stream.avail_out == 0) {
  ------------------
  |  Branch (45:13): [True: 263k, False: 0]
  ------------------
   46|   263k|            stream.avail_out = left > (uLong)max ? max : (uInt)left;
                                                                 ^0
  ------------------
  |  Branch (46:32): [True: 0, False: 263k]
  ------------------
   47|   263k|            left -= stream.avail_out;
   48|   263k|        }
   49|   263k|        if (stream.avail_in == 0) {
  ------------------
  |  Branch (49:13): [True: 263k, False: 0]
  ------------------
   50|   263k|            stream.avail_in = sourceLen > (uLong)max ? max : (uInt)sourceLen;
                                                                     ^0
  ------------------
  |  Branch (50:31): [True: 0, False: 263k]
  ------------------
   51|   263k|            sourceLen -= stream.avail_in;
   52|   263k|        }
   53|   263k|        err = deflate(&stream, sourceLen ? Z_NO_FLUSH : Z_FINISH);
                                                         ^0
  ------------------
  |  Branch (53:32): [True: 0, False: 263k]
  ------------------
   54|   263k|    } while (err == Z_OK);
  ------------------
  |  Branch (54:14): [True: 0, False: 263k]
  ------------------
   55|       |
   56|   263k|    *destLen = stream.total_out;
   57|   263k|    deflateEnd(&stream);
   58|   263k|    return err == Z_STREAM_END ? Z_OK : err;
                                                      ^0
  ------------------
  |  Branch (58:12): [True: 263k, False: 0]
  ------------------
   59|   263k|}
   60|       |
   61|       |/* ===========================================================================
   62|       | */
   63|       |int ZEXPORT compress(Bytef *dest, uLongf *destLen, const Bytef *source,
   64|      0|                     uLong sourceLen) {
   65|      0|    return compress2(dest, destLen, source, sourceLen, Z_DEFAULT_COMPRESSION);
   66|      0|}
   67|       |
   68|       |/* ===========================================================================
   69|       |     If the default memLevel or windowBits for deflateInit() is changed, then
   70|       |   this function needs to be updated.
   71|       | */
   72|   263k|uLong ZEXPORT compressBound(uLong sourceLen) {
   73|   263k|    return sourceLen + (sourceLen >> 12) + (sourceLen >> 14) +
   74|   263k|           (sourceLen >> 25) + 13;
   75|   263k|}

/home/minseo/alfha/targets/zlib/target/crc32.c:
    1|       |/* crc32.c -- compute the CRC-32 of a data stream
    2|       | * Copyright (C) 1995-2022 Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | *
    5|       | * This interleaved implementation of a CRC makes use of pipelined multiple
    6|       | * arithmetic-logic units, commonly found in modern CPU cores. It is due to
    7|       | * Kadatch and Jenkins (2010). See doc/crc-doc.1.0.pdf in this distribution.
    8|       | */
    9|       |
   10|       |/* @(#) $Id$ */
   11|       |
   12|       |/*
   13|       |  Note on the use of DYNAMIC_CRC_TABLE: there is no mutex or semaphore
   14|       |  protection on the static variables used to control the first-use generation
   15|       |  of the crc tables. Therefore, if you #define DYNAMIC_CRC_TABLE, you should
   16|       |  first call get_crc_table() to initialize the tables before allowing more than
   17|       |  one thread to use crc32().
   18|       |
   19|       |  MAKECRCH can be #defined to write out crc32.h. A main() routine is also
   20|       |  produced, so that this one source file can be compiled to an executable.
   21|       | */
   22|       |
   23|       |#ifdef MAKECRCH
   24|       |#  include <stdio.h>
   25|       |#  ifndef DYNAMIC_CRC_TABLE
   26|       |#    define DYNAMIC_CRC_TABLE
   27|       |#  endif /* !DYNAMIC_CRC_TABLE */
   28|       |#endif /* MAKECRCH */
   29|       |
   30|       |#include "zutil.h"      /* for Z_U4, Z_U8, z_crc_t, and FAR definitions */
   31|       |
   32|       | /*
   33|       |  A CRC of a message is computed on N braids of words in the message, where
   34|       |  each word consists of W bytes (4 or 8). If N is 3, for example, then three
   35|       |  running sparse CRCs are calculated respectively on each braid, at these
   36|       |  indices in the array of words: 0, 3, 6, ..., 1, 4, 7, ..., and 2, 5, 8, ...
   37|       |  This is done starting at a word boundary, and continues until as many blocks
   38|       |  of N * W bytes as are available have been processed. The results are combined
   39|       |  into a single CRC at the end. For this code, N must be in the range 1..6 and
   40|       |  W must be 4 or 8. The upper limit on N can be increased if desired by adding
   41|       |  more #if blocks, extending the patterns apparent in the code. In addition,
   42|       |  crc32.h would need to be regenerated, if the maximum N value is increased.
   43|       |
   44|       |  N and W are chosen empirically by benchmarking the execution time on a given
   45|       |  processor. The choices for N and W below were based on testing on Intel Kaby
   46|       |  Lake i7, AMD Ryzen 7, ARM Cortex-A57, Sparc64-VII, PowerPC POWER9, and MIPS64
   47|       |  Octeon II processors. The Intel, AMD, and ARM processors were all fastest
   48|       |  with N=5, W=8. The Sparc, PowerPC, and MIPS64 were all fastest at N=5, W=4.
   49|       |  They were all tested with either gcc or clang, all using the -O3 optimization
   50|       |  level. Your mileage may vary.
   51|       | */
   52|       |
   53|       |/* Define N */
   54|       |#ifdef Z_TESTN
   55|       |#  define N Z_TESTN
   56|       |#else
   57|      0|#  define N 5
   58|       |#endif
   59|       |#if N < 1 || N > 6
   60|       |#  error N must be in 1..6
   61|       |#endif
   62|       |
   63|       |/*
   64|       |  z_crc_t must be at least 32 bits. z_word_t must be at least as long as
   65|       |  z_crc_t. It is assumed here that z_word_t is either 32 bits or 64 bits, and
   66|       |  that bytes are eight bits.
   67|       | */
   68|       |
   69|       |/*
   70|       |  Define W and the associated z_word_t type. If W is not defined, then a
   71|       |  braided calculation is not used, and the associated tables and code are not
   72|       |  compiled.
   73|       | */
   74|       |#ifdef Z_TESTW
   75|       |#  if Z_TESTW-1 != -1
   76|       |#    define W Z_TESTW
   77|       |#  endif
   78|       |#else
   79|       |#  ifdef MAKECRCH
   80|       |#    define W 8         /* required for MAKECRCH */
   81|       |#  else
   82|       |#    if defined(__x86_64__) || defined(__aarch64__)
   83|      0|#      define W 8
   84|       |#    else
   85|       |#      define W 4
   86|       |#    endif
   87|       |#  endif
   88|       |#endif
   89|       |#ifdef W
   90|       |#  if W == 8 && defined(Z_U8)
   91|       |     typedef Z_U8 z_word_t;
   92|       |#  elif defined(Z_U4)
   93|       |#    undef W
   94|       |#    define W 4
   95|       |     typedef Z_U4 z_word_t;
   96|       |#  else
   97|       |#    undef W
   98|       |#  endif
   99|       |#endif
  100|       |
  101|       |/* If available, use the ARM processor CRC32 instruction. */
  102|       |#if defined(__aarch64__) && defined(__ARM_FEATURE_CRC32) && W == 8
  103|       |#  define ARMCRC32
  104|       |#endif
  105|       |
  106|       |#if defined(W) && (!defined(ARMCRC32) || defined(DYNAMIC_CRC_TABLE))
  107|       |/*
  108|       |  Swap the bytes in a z_word_t to convert between little and big endian. Any
  109|       |  self-respecting compiler will optimize this to a single machine byte-swap
  110|       |  instruction, if one is available. This assumes that word_t is either 32 bits
  111|       |  or 64 bits.
  112|       | */
  113|      0|local z_word_t byte_swap(z_word_t word) {
  114|      0|#  if W == 8
  115|      0|    return
  116|      0|        (word & 0xff00000000000000) >> 56 |
  117|      0|        (word & 0xff000000000000) >> 40 |
  118|      0|        (word & 0xff0000000000) >> 24 |
  119|      0|        (word & 0xff00000000) >> 8 |
  120|      0|        (word & 0xff000000) << 8 |
  121|      0|        (word & 0xff0000) << 24 |
  122|      0|        (word & 0xff00) << 40 |
  123|      0|        (word & 0xff) << 56;
  124|       |#  else   /* W == 4 */
  125|       |    return
  126|       |        (word & 0xff000000) >> 24 |
  127|       |        (word & 0xff0000) >> 8 |
  128|       |        (word & 0xff00) << 8 |
  129|       |        (word & 0xff) << 24;
  130|       |#  endif
  131|      0|}
  132|       |#endif
  133|       |
  134|       |#ifdef DYNAMIC_CRC_TABLE
  135|       |/* =========================================================================
  136|       | * Table of powers of x for combining CRC-32s, filled in by make_crc_table()
  137|       | * below.
  138|       | */
  139|       |   local z_crc_t FAR x2n_table[32];
  140|       |#else
  141|       |/* =========================================================================
  142|       | * Tables for byte-wise and braided CRC-32 calculations, and a table of powers
  143|       | * of x for combining CRC-32s, all made by make_crc_table().
  144|       | */
  145|       |#  include "crc32.h"
  146|       |#endif
  147|       |
  148|       |/* CRC polynomial. */
  149|      0|#define POLY 0xedb88320         /* p(x) reflected, with x^32 implied */
  150|       |
  151|       |/*
  152|       |  Return a(x) multiplied by b(x) modulo p(x), where p(x) is the CRC polynomial,
  153|       |  reflected. For speed, this requires that a not be zero.
  154|       | */
  155|      0|local z_crc_t multmodp(z_crc_t a, z_crc_t b) {
  156|      0|    z_crc_t m, p;
  157|       |
  158|      0|    m = (z_crc_t)1 << 31;
  159|      0|    p = 0;
  160|      0|    for (;;) {
  161|      0|        if (a & m) {
  ------------------
  |  Branch (161:13): [True: 0, False: 0]
  ------------------
  162|      0|            p ^= b;
  163|      0|            if ((a & (m - 1)) == 0)
  ------------------
  |  Branch (163:17): [True: 0, False: 0]
  ------------------
  164|      0|                break;
  165|      0|        }
  166|      0|        m >>= 1;
  167|      0|        b = b & 1 ? (b >> 1) ^ POLY : b >> 1;
  ------------------
  |  Branch (167:13): [True: 0, False: 0]
  ------------------
  168|      0|    }
  169|      0|    return p;
  170|      0|}
  171|       |
  172|       |/*
  173|       |  Return x^(n * 2^k) modulo p(x). Requires that x2n_table[] has been
  174|       |  initialized.
  175|       | */
  176|      0|local z_crc_t x2nmodp(z_off64_t n, unsigned k) {
  177|      0|    z_crc_t p;
  178|       |
  179|      0|    p = (z_crc_t)1 << 31;           /* x^0 == 1 */
  180|      0|    while (n) {
  ------------------
  |  Branch (180:12): [True: 0, False: 0]
  ------------------
  181|      0|        if (n & 1)
  ------------------
  |  Branch (181:13): [True: 0, False: 0]
  ------------------
  182|      0|            p = multmodp(x2n_table[k & 31], p);
  183|      0|        n >>= 1;
  184|      0|        k++;
  185|      0|    }
  186|      0|    return p;
  187|      0|}
  188|       |
  189|       |#ifdef DYNAMIC_CRC_TABLE
  190|       |/* =========================================================================
  191|       | * Build the tables for byte-wise and braided CRC-32 calculations, and a table
  192|       | * of powers of x for combining CRC-32s.
  193|       | */
  194|       |local z_crc_t FAR crc_table[256];
  195|       |#ifdef W
  196|       |   local z_word_t FAR crc_big_table[256];
  197|       |   local z_crc_t FAR crc_braid_table[W][256];
  198|       |   local z_word_t FAR crc_braid_big_table[W][256];
  199|       |   local void braid(z_crc_t [][256], z_word_t [][256], int, int);
  200|       |#endif
  201|       |#ifdef MAKECRCH
  202|       |   local void write_table(FILE *, const z_crc_t FAR *, int);
  203|       |   local void write_table32hi(FILE *, const z_word_t FAR *, int);
  204|       |   local void write_table64(FILE *, const z_word_t FAR *, int);
  205|       |#endif /* MAKECRCH */
  206|       |
  207|       |/*
  208|       |  Define a once() function depending on the availability of atomics. If this is
  209|       |  compiled with DYNAMIC_CRC_TABLE defined, and if CRCs will be computed in
  210|       |  multiple threads, and if atomics are not available, then get_crc_table() must
  211|       |  be called to initialize the tables and must return before any threads are
  212|       |  allowed to compute or combine CRCs.
  213|       | */
  214|       |
  215|       |/* Definition of once functionality. */
  216|       |typedef struct once_s once_t;
  217|       |
  218|       |/* Check for the availability of atomics. */
  219|       |#if defined(__STDC__) && __STDC_VERSION__ >= 201112L && \
  220|       |    !defined(__STDC_NO_ATOMICS__)
  221|       |
  222|       |#include <stdatomic.h>
  223|       |
  224|       |/* Structure for once(), which must be initialized with ONCE_INIT. */
  225|       |struct once_s {
  226|       |    atomic_flag begun;
  227|       |    atomic_int done;
  228|       |};
  229|       |#define ONCE_INIT {ATOMIC_FLAG_INIT, 0}
  230|       |
  231|       |/*
  232|       |  Run the provided init() function exactly once, even if multiple threads
  233|       |  invoke once() at the same time. The state must be a once_t initialized with
  234|       |  ONCE_INIT.
  235|       | */
  236|       |local void once(once_t *state, void (*init)(void)) {
  237|       |    if (!atomic_load(&state->done)) {
  238|       |        if (atomic_flag_test_and_set(&state->begun))
  239|       |            while (!atomic_load(&state->done))
  240|       |                ;
  241|       |        else {
  242|       |            init();
  243|       |            atomic_store(&state->done, 1);
  244|       |        }
  245|       |    }
  246|       |}
  247|       |
  248|       |#else   /* no atomics */
  249|       |
  250|       |/* Structure for once(), which must be initialized with ONCE_INIT. */
  251|       |struct once_s {
  252|       |    volatile int begun;
  253|       |    volatile int done;
  254|       |};
  255|       |#define ONCE_INIT {0, 0}
  256|       |
  257|       |/* Test and set. Alas, not atomic, but tries to minimize the period of
  258|       |   vulnerability. */
  259|       |local int test_and_set(int volatile *flag) {
  260|       |    int was;
  261|       |
  262|       |    was = *flag;
  263|       |    *flag = 1;
  264|       |    return was;
  265|       |}
  266|       |
  267|       |/* Run the provided init() function once. This is not thread-safe. */
  268|       |local void once(once_t *state, void (*init)(void)) {
  269|       |    if (!state->done) {
  270|       |        if (test_and_set(&state->begun))
  271|       |            while (!state->done)
  272|       |                ;
  273|       |        else {
  274|       |            init();
  275|       |            state->done = 1;
  276|       |        }
  277|       |    }
  278|       |}
  279|       |
  280|       |#endif
  281|       |
  282|       |/* State for once(). */
  283|       |local once_t made = ONCE_INIT;
  284|       |
  285|       |/*
  286|       |  Generate tables for a byte-wise 32-bit CRC calculation on the polynomial:
  287|       |  x^32+x^26+x^23+x^22+x^16+x^12+x^11+x^10+x^8+x^7+x^5+x^4+x^2+x+1.
  288|       |
  289|       |  Polynomials over GF(2) are represented in binary, one bit per coefficient,
  290|       |  with the lowest powers in the most significant bit. Then adding polynomials
  291|       |  is just exclusive-or, and multiplying a polynomial by x is a right shift by
  292|       |  one. If we call the above polynomial p, and represent a byte as the
  293|       |  polynomial q, also with the lowest power in the most significant bit (so the
  294|       |  byte 0xb1 is the polynomial x^7+x^3+x^2+1), then the CRC is (q*x^32) mod p,
  295|       |  where a mod b means the remainder after dividing a by b.
  296|       |
  297|       |  This calculation is done using the shift-register method of multiplying and
  298|       |  taking the remainder. The register is initialized to zero, and for each
  299|       |  incoming bit, x^32 is added mod p to the register if the bit is a one (where
  300|       |  x^32 mod p is p+x^32 = x^26+...+1), and the register is multiplied mod p by x
  301|       |  (which is shifting right by one and adding x^32 mod p if the bit shifted out
  302|       |  is a one). We start with the highest power (least significant bit) of q and
  303|       |  repeat for all eight bits of q.
  304|       |
  305|       |  The table is simply the CRC of all possible eight bit values. This is all the
  306|       |  information needed to generate CRCs on data a byte at a time for all
  307|       |  combinations of CRC register values and incoming bytes.
  308|       | */
  309|       |
  310|       |local void make_crc_table(void) {
  311|       |    unsigned i, j, n;
  312|       |    z_crc_t p;
  313|       |
  314|       |    /* initialize the CRC of bytes tables */
  315|       |    for (i = 0; i < 256; i++) {
  316|       |        p = i;
  317|       |        for (j = 0; j < 8; j++)
  318|       |            p = p & 1 ? (p >> 1) ^ POLY : p >> 1;
  319|       |        crc_table[i] = p;
  320|       |#ifdef W
  321|       |        crc_big_table[i] = byte_swap(p);
  322|       |#endif
  323|       |    }
  324|       |
  325|       |    /* initialize the x^2^n mod p(x) table */
  326|       |    p = (z_crc_t)1 << 30;         /* x^1 */
  327|       |    x2n_table[0] = p;
  328|       |    for (n = 1; n < 32; n++)
  329|       |        x2n_table[n] = p = multmodp(p, p);
  330|       |
  331|       |#ifdef W
  332|       |    /* initialize the braiding tables -- needs x2n_table[] */
  333|       |    braid(crc_braid_table, crc_braid_big_table, N, W);
  334|       |#endif
  335|       |
  336|       |#ifdef MAKECRCH
  337|       |    {
  338|       |        /*
  339|       |          The crc32.h header file contains tables for both 32-bit and 64-bit
  340|       |          z_word_t's, and so requires a 64-bit type be available. In that case,
  341|       |          z_word_t must be defined to be 64-bits. This code then also generates
  342|       |          and writes out the tables for the case that z_word_t is 32 bits.
  343|       |         */
  344|       |#if !defined(W) || W != 8
  345|       |#  error Need a 64-bit integer type in order to generate crc32.h.
  346|       |#endif
  347|       |        FILE *out;
  348|       |        int k, n;
  349|       |        z_crc_t ltl[8][256];
  350|       |        z_word_t big[8][256];
  351|       |
  352|       |        out = fopen("crc32.h", "w");
  353|       |        if (out == NULL) return;
  354|       |
  355|       |        /* write out little-endian CRC table to crc32.h */
  356|       |        fprintf(out,
  357|       |            "/* crc32.h -- tables for rapid CRC calculation\n"
  358|       |            " * Generated automatically by crc32.c\n */\n"
  359|       |            "\n"
  360|       |            "local const z_crc_t FAR crc_table[] = {\n"
  361|       |            "    ");
  362|       |        write_table(out, crc_table, 256);
  363|       |        fprintf(out,
  364|       |            "};\n");
  365|       |
  366|       |        /* write out big-endian CRC table for 64-bit z_word_t to crc32.h */
  367|       |        fprintf(out,
  368|       |            "\n"
  369|       |            "#ifdef W\n"
  370|       |            "\n"
  371|       |            "#if W == 8\n"
  372|       |            "\n"
  373|       |            "local const z_word_t FAR crc_big_table[] = {\n"
  374|       |            "    ");
  375|       |        write_table64(out, crc_big_table, 256);
  376|       |        fprintf(out,
  377|       |            "};\n");
  378|       |
  379|       |        /* write out big-endian CRC table for 32-bit z_word_t to crc32.h */
  380|       |        fprintf(out,
  381|       |            "\n"
  382|       |            "#else /* W == 4 */\n"
  383|       |            "\n"
  384|       |            "local const z_word_t FAR crc_big_table[] = {\n"
  385|       |            "    ");
  386|       |        write_table32hi(out, crc_big_table, 256);
  387|       |        fprintf(out,
  388|       |            "};\n"
  389|       |            "\n"
  390|       |            "#endif\n");
  391|       |
  392|       |        /* write out braid tables for each value of N */
  393|       |        for (n = 1; n <= 6; n++) {
  394|       |            fprintf(out,
  395|       |            "\n"
  396|       |            "#if N == %d\n", n);
  397|       |
  398|       |            /* compute braid tables for this N and 64-bit word_t */
  399|       |            braid(ltl, big, n, 8);
  400|       |
  401|       |            /* write out braid tables for 64-bit z_word_t to crc32.h */
  402|       |            fprintf(out,
  403|       |            "\n"
  404|       |            "#if W == 8\n"
  405|       |            "\n"
  406|       |            "local const z_crc_t FAR crc_braid_table[][256] = {\n");
  407|       |            for (k = 0; k < 8; k++) {
  408|       |                fprintf(out, "   {");
  409|       |                write_table(out, ltl[k], 256);
  410|       |                fprintf(out, "}%s", k < 7 ? ",\n" : "");
  411|       |            }
  412|       |            fprintf(out,
  413|       |            "};\n"
  414|       |            "\n"
  415|       |            "local const z_word_t FAR crc_braid_big_table[][256] = {\n");
  416|       |            for (k = 0; k < 8; k++) {
  417|       |                fprintf(out, "   {");
  418|       |                write_table64(out, big[k], 256);
  419|       |                fprintf(out, "}%s", k < 7 ? ",\n" : "");
  420|       |            }
  421|       |            fprintf(out,
  422|       |            "};\n");
  423|       |
  424|       |            /* compute braid tables for this N and 32-bit word_t */
  425|       |            braid(ltl, big, n, 4);
  426|       |
  427|       |            /* write out braid tables for 32-bit z_word_t to crc32.h */
  428|       |            fprintf(out,
  429|       |            "\n"
  430|       |            "#else /* W == 4 */\n"
  431|       |            "\n"
  432|       |            "local const z_crc_t FAR crc_braid_table[][256] = {\n");
  433|       |            for (k = 0; k < 4; k++) {
  434|       |                fprintf(out, "   {");
  435|       |                write_table(out, ltl[k], 256);
  436|       |                fprintf(out, "}%s", k < 3 ? ",\n" : "");
  437|       |            }
  438|       |            fprintf(out,
  439|       |            "};\n"
  440|       |            "\n"
  441|       |            "local const z_word_t FAR crc_braid_big_table[][256] = {\n");
  442|       |            for (k = 0; k < 4; k++) {
  443|       |                fprintf(out, "   {");
  444|       |                write_table32hi(out, big[k], 256);
  445|       |                fprintf(out, "}%s", k < 3 ? ",\n" : "");
  446|       |            }
  447|       |            fprintf(out,
  448|       |            "};\n"
  449|       |            "\n"
  450|       |            "#endif\n"
  451|       |            "\n"
  452|       |            "#endif\n");
  453|       |        }
  454|       |        fprintf(out,
  455|       |            "\n"
  456|       |            "#endif\n");
  457|       |
  458|       |        /* write out zeros operator table to crc32.h */
  459|       |        fprintf(out,
  460|       |            "\n"
  461|       |            "local const z_crc_t FAR x2n_table[] = {\n"
  462|       |            "    ");
  463|       |        write_table(out, x2n_table, 32);
  464|       |        fprintf(out,
  465|       |            "};\n");
  466|       |        fclose(out);
  467|       |    }
  468|       |#endif /* MAKECRCH */
  469|       |}
  470|       |
  471|       |#ifdef MAKECRCH
  472|       |
  473|       |/*
  474|       |   Write the 32-bit values in table[0..k-1] to out, five per line in
  475|       |   hexadecimal separated by commas.
  476|       | */
  477|       |local void write_table(FILE *out, const z_crc_t FAR *table, int k) {
  478|       |    int n;
  479|       |
  480|       |    for (n = 0; n < k; n++)
  481|       |        fprintf(out, "%s0x%08lx%s", n == 0 || n % 5 ? "" : "    ",
  482|       |                (unsigned long)(table[n]),
  483|       |                n == k - 1 ? "" : (n % 5 == 4 ? ",\n" : ", "));
  484|       |}
  485|       |
  486|       |/*
  487|       |   Write the high 32-bits of each value in table[0..k-1] to out, five per line
  488|       |   in hexadecimal separated by commas.
  489|       | */
  490|       |local void write_table32hi(FILE *out, const z_word_t FAR *table, int k) {
  491|       |    int n;
  492|       |
  493|       |    for (n = 0; n < k; n++)
  494|       |        fprintf(out, "%s0x%08lx%s", n == 0 || n % 5 ? "" : "    ",
  495|       |                (unsigned long)(table[n] >> 32),
  496|       |                n == k - 1 ? "" : (n % 5 == 4 ? ",\n" : ", "));
  497|       |}
  498|       |
  499|       |/*
  500|       |  Write the 64-bit values in table[0..k-1] to out, three per line in
  501|       |  hexadecimal separated by commas. This assumes that if there is a 64-bit
  502|       |  type, then there is also a long long integer type, and it is at least 64
  503|       |  bits. If not, then the type cast and format string can be adjusted
  504|       |  accordingly.
  505|       | */
  506|       |local void write_table64(FILE *out, const z_word_t FAR *table, int k) {
  507|       |    int n;
  508|       |
  509|       |    for (n = 0; n < k; n++)
  510|       |        fprintf(out, "%s0x%016llx%s", n == 0 || n % 3 ? "" : "    ",
  511|       |                (unsigned long long)(table[n]),
  512|       |                n == k - 1 ? "" : (n % 3 == 2 ? ",\n" : ", "));
  513|       |}
  514|       |
  515|       |/* Actually do the deed. */
  516|       |int main(void) {
  517|       |    make_crc_table();
  518|       |    return 0;
  519|       |}
  520|       |
  521|       |#endif /* MAKECRCH */
  522|       |
  523|       |#ifdef W
  524|       |/*
  525|       |  Generate the little and big-endian braid tables for the given n and z_word_t
  526|       |  size w. Each array must have room for w blocks of 256 elements.
  527|       | */
  528|       |local void braid(z_crc_t ltl[][256], z_word_t big[][256], int n, int w) {
  529|       |    int k;
  530|       |    z_crc_t i, p, q;
  531|       |    for (k = 0; k < w; k++) {
  532|       |        p = x2nmodp((n * w + 3 - k) << 3, 0);
  533|       |        ltl[k][0] = 0;
  534|       |        big[w - 1 - k][0] = 0;
  535|       |        for (i = 1; i < 256; i++) {
  536|       |            ltl[k][i] = q = multmodp(i << 24, p);
  537|       |            big[w - 1 - k][i] = byte_swap(q);
  538|       |        }
  539|       |    }
  540|       |}
  541|       |#endif
  542|       |
  543|       |#endif /* DYNAMIC_CRC_TABLE */
  544|       |
  545|       |/* =========================================================================
  546|       | * This function can be used by asm versions of crc32(), and to force the
  547|       | * generation of the CRC tables in a threaded application.
  548|       | */
  549|      0|const z_crc_t FAR * ZEXPORT get_crc_table(void) {
  550|       |#ifdef DYNAMIC_CRC_TABLE
  551|       |    once(&made, make_crc_table);
  552|       |#endif /* DYNAMIC_CRC_TABLE */
  553|      0|    return (const z_crc_t FAR *)crc_table;
  554|      0|}
  555|       |
  556|       |/* =========================================================================
  557|       | * Use ARM machine instructions if available. This will compute the CRC about
  558|       | * ten times faster than the braided calculation. This code does not check for
  559|       | * the presence of the CRC instruction at run time. __ARM_FEATURE_CRC32 will
  560|       | * only be defined if the compilation specifies an ARM processor architecture
  561|       | * that has the instructions. For example, compiling with -march=armv8.1-a or
  562|       | * -march=armv8-a+crc, or -march=native if the compile machine has the crc32
  563|       | * instructions.
  564|       | */
  565|       |#ifdef ARMCRC32
  566|       |
  567|       |/*
  568|       |   Constants empirically determined to maximize speed. These values are from
  569|       |   measurements on a Cortex-A57. Your mileage may vary.
  570|       | */
  571|       |#define Z_BATCH 3990                /* number of words in a batch */
  572|       |#define Z_BATCH_ZEROS 0xa10d3d0c    /* computed from Z_BATCH = 3990 */
  573|       |#define Z_BATCH_MIN 800             /* fewest words in a final batch */
  574|       |
  575|       |unsigned long ZEXPORT crc32_z(unsigned long crc, const unsigned char FAR *buf,
  576|       |                              z_size_t len) {
  577|       |    z_crc_t val;
  578|       |    z_word_t crc1, crc2;
  579|       |    const z_word_t *word;
  580|       |    z_word_t val0, val1, val2;
  581|       |    z_size_t last, last2, i;
  582|       |    z_size_t num;
  583|       |
  584|       |    /* Return initial CRC, if requested. */
  585|       |    if (buf == Z_NULL) return 0;
  586|       |
  587|       |#ifdef DYNAMIC_CRC_TABLE
  588|       |    once(&made, make_crc_table);
  589|       |#endif /* DYNAMIC_CRC_TABLE */
  590|       |
  591|       |    /* Pre-condition the CRC */
  592|       |    crc = (~crc) & 0xffffffff;
  593|       |
  594|       |    /* Compute the CRC up to a word boundary. */
  595|       |    while (len && ((z_size_t)buf & 7) != 0) {
  596|       |        len--;
  597|       |        val = *buf++;
  598|       |        __asm__ volatile("crc32b %w0, %w0, %w1" : "+r"(crc) : "r"(val));
  599|       |    }
  600|       |
  601|       |    /* Prepare to compute the CRC on full 64-bit words word[0..num-1]. */
  602|       |    word = (z_word_t const *)buf;
  603|       |    num = len >> 3;
  604|       |    len &= 7;
  605|       |
  606|       |    /* Do three interleaved CRCs to realize the throughput of one crc32x
  607|       |       instruction per cycle. Each CRC is calculated on Z_BATCH words. The
  608|       |       three CRCs are combined into a single CRC after each set of batches. */
  609|       |    while (num >= 3 * Z_BATCH) {
  610|       |        crc1 = 0;
  611|       |        crc2 = 0;
  612|       |        for (i = 0; i < Z_BATCH; i++) {
  613|       |            val0 = word[i];
  614|       |            val1 = word[i + Z_BATCH];
  615|       |            val2 = word[i + 2 * Z_BATCH];
  616|       |            __asm__ volatile("crc32x %w0, %w0, %x1" : "+r"(crc) : "r"(val0));
  617|       |            __asm__ volatile("crc32x %w0, %w0, %x1" : "+r"(crc1) : "r"(val1));
  618|       |            __asm__ volatile("crc32x %w0, %w0, %x1" : "+r"(crc2) : "r"(val2));
  619|       |        }
  620|       |        word += 3 * Z_BATCH;
  621|       |        num -= 3 * Z_BATCH;
  622|       |        crc = multmodp(Z_BATCH_ZEROS, crc) ^ crc1;
  623|       |        crc = multmodp(Z_BATCH_ZEROS, crc) ^ crc2;
  624|       |    }
  625|       |
  626|       |    /* Do one last smaller batch with the remaining words, if there are enough
  627|       |       to pay for the combination of CRCs. */
  628|       |    last = num / 3;
  629|       |    if (last >= Z_BATCH_MIN) {
  630|       |        last2 = last << 1;
  631|       |        crc1 = 0;
  632|       |        crc2 = 0;
  633|       |        for (i = 0; i < last; i++) {
  634|       |            val0 = word[i];
  635|       |            val1 = word[i + last];
  636|       |            val2 = word[i + last2];
  637|       |            __asm__ volatile("crc32x %w0, %w0, %x1" : "+r"(crc) : "r"(val0));
  638|       |            __asm__ volatile("crc32x %w0, %w0, %x1" : "+r"(crc1) : "r"(val1));
  639|       |            __asm__ volatile("crc32x %w0, %w0, %x1" : "+r"(crc2) : "r"(val2));
  640|       |        }
  641|       |        word += 3 * last;
  642|       |        num -= 3 * last;
  643|       |        val = x2nmodp(last, 6);
  644|       |        crc = multmodp(val, crc) ^ crc1;
  645|       |        crc = multmodp(val, crc) ^ crc2;
  646|       |    }
  647|       |
  648|       |    /* Compute the CRC on any remaining words. */
  649|       |    for (i = 0; i < num; i++) {
  650|       |        val0 = word[i];
  651|       |        __asm__ volatile("crc32x %w0, %w0, %x1" : "+r"(crc) : "r"(val0));
  652|       |    }
  653|       |    word += num;
  654|       |
  655|       |    /* Complete the CRC on any remaining bytes. */
  656|       |    buf = (const unsigned char FAR *)word;
  657|       |    while (len) {
  658|       |        len--;
  659|       |        val = *buf++;
  660|       |        __asm__ volatile("crc32b %w0, %w0, %w1" : "+r"(crc) : "r"(val));
  661|       |    }
  662|       |
  663|       |    /* Return the CRC, post-conditioned. */
  664|       |    return crc ^ 0xffffffff;
  665|       |}
  666|       |
  667|       |#else
  668|       |
  669|       |#ifdef W
  670|       |
  671|       |/*
  672|       |  Return the CRC of the W bytes in the word_t data, taking the
  673|       |  least-significant byte of the word as the first byte of data, without any pre
  674|       |  or post conditioning. This is used to combine the CRCs of each braid.
  675|       | */
  676|      0|local z_crc_t crc_word(z_word_t data) {
  677|      0|    int k;
  678|      0|    for (k = 0; k < W; k++)
  ------------------
  |  Branch (678:17): [True: 0, False: 0]
  ------------------
  679|      0|        data = (data >> 8) ^ crc_table[data & 0xff];
  680|      0|    return (z_crc_t)data;
  681|      0|}
  682|       |
  683|      0|local z_word_t crc_word_big(z_word_t data) {
  684|      0|    int k;
  685|      0|    for (k = 0; k < W; k++)
  ------------------
  |  Branch (685:17): [True: 0, False: 0]
  ------------------
  686|      0|        data = (data << 8) ^
  687|      0|            crc_big_table[(data >> ((W - 1) << 3)) & 0xff];
  688|      0|    return data;
  689|      0|}
  690|       |
  691|       |#endif
  692|       |
  693|       |/* ========================================================================= */
  694|       |unsigned long ZEXPORT crc32_z(unsigned long crc, const unsigned char FAR *buf,
  695|      0|                              z_size_t len) {
  696|       |    /* Return initial CRC, if requested. */
  697|      0|    if (buf == Z_NULL) return 0;
  ------------------
  |  Branch (697:9): [True: 0, False: 0]
  ------------------
  698|       |
  699|       |#ifdef DYNAMIC_CRC_TABLE
  700|       |    once(&made, make_crc_table);
  701|       |#endif /* DYNAMIC_CRC_TABLE */
  702|       |
  703|       |    /* Pre-condition the CRC */
  704|      0|    crc = (~crc) & 0xffffffff;
  705|       |
  706|      0|#ifdef W
  707|       |
  708|       |    /* If provided enough bytes, do a braided CRC calculation. */
  709|      0|    if (len >= N * W + W - 1) {
  ------------------
  |  Branch (709:9): [True: 0, False: 0]
  ------------------
  710|      0|        z_size_t blks;
  711|      0|        z_word_t const *words;
  712|      0|        unsigned endian;
  713|      0|        int k;
  714|       |
  715|       |        /* Compute the CRC up to a z_word_t boundary. */
  716|      0|        while (len && ((z_size_t)buf & (W - 1)) != 0) {
  ------------------
  |  Branch (716:16): [True: 0, False: 0]
  |  Branch (716:23): [True: 0, False: 0]
  ------------------
  717|      0|            len--;
  718|      0|            crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
  719|      0|        }
  720|       |
  721|       |        /* Compute the CRC on as many N z_word_t blocks as are available. */
  722|      0|        blks = len / (N * W);
  723|      0|        len -= blks * N * W;
  724|      0|        words = (z_word_t const *)buf;
  725|       |
  726|       |        /* Do endian check at execution time instead of compile time, since ARM
  727|       |           processors can change the endianness at execution time. If the
  728|       |           compiler knows what the endianness will be, it can optimize out the
  729|       |           check and the unused branch. */
  730|      0|        endian = 1;
  731|      0|        if (*(unsigned char *)&endian) {
  ------------------
  |  Branch (731:13): [True: 0, False: 0]
  ------------------
  732|       |            /* Little endian. */
  733|       |
  734|      0|            z_crc_t crc0;
  735|      0|            z_word_t word0;
  736|      0|#if N > 1
  737|      0|            z_crc_t crc1;
  738|      0|            z_word_t word1;
  739|      0|#if N > 2
  740|      0|            z_crc_t crc2;
  741|      0|            z_word_t word2;
  742|      0|#if N > 3
  743|      0|            z_crc_t crc3;
  744|      0|            z_word_t word3;
  745|      0|#if N > 4
  746|      0|            z_crc_t crc4;
  747|      0|            z_word_t word4;
  748|       |#if N > 5
  749|       |            z_crc_t crc5;
  750|       |            z_word_t word5;
  751|       |#endif
  752|      0|#endif
  753|      0|#endif
  754|      0|#endif
  755|      0|#endif
  756|       |
  757|       |            /* Initialize the CRC for each braid. */
  758|      0|            crc0 = crc;
  759|      0|#if N > 1
  760|      0|            crc1 = 0;
  761|      0|#if N > 2
  762|      0|            crc2 = 0;
  763|      0|#if N > 3
  764|      0|            crc3 = 0;
  765|      0|#if N > 4
  766|      0|            crc4 = 0;
  767|       |#if N > 5
  768|       |            crc5 = 0;
  769|       |#endif
  770|      0|#endif
  771|      0|#endif
  772|      0|#endif
  773|      0|#endif
  774|       |
  775|       |            /*
  776|       |              Process the first blks-1 blocks, computing the CRCs on each braid
  777|       |              independently.
  778|       |             */
  779|      0|            while (--blks) {
  ------------------
  |  Branch (779:20): [True: 0, False: 0]
  ------------------
  780|       |                /* Load the word for each braid into registers. */
  781|      0|                word0 = crc0 ^ words[0];
  782|      0|#if N > 1
  783|      0|                word1 = crc1 ^ words[1];
  784|      0|#if N > 2
  785|      0|                word2 = crc2 ^ words[2];
  786|      0|#if N > 3
  787|      0|                word3 = crc3 ^ words[3];
  788|      0|#if N > 4
  789|      0|                word4 = crc4 ^ words[4];
  790|       |#if N > 5
  791|       |                word5 = crc5 ^ words[5];
  792|       |#endif
  793|      0|#endif
  794|      0|#endif
  795|      0|#endif
  796|      0|#endif
  797|      0|                words += N;
  798|       |
  799|       |                /* Compute and update the CRC for each word. The loop should
  800|       |                   get unrolled. */
  801|      0|                crc0 = crc_braid_table[0][word0 & 0xff];
  802|      0|#if N > 1
  803|      0|                crc1 = crc_braid_table[0][word1 & 0xff];
  804|      0|#if N > 2
  805|      0|                crc2 = crc_braid_table[0][word2 & 0xff];
  806|      0|#if N > 3
  807|      0|                crc3 = crc_braid_table[0][word3 & 0xff];
  808|      0|#if N > 4
  809|      0|                crc4 = crc_braid_table[0][word4 & 0xff];
  810|       |#if N > 5
  811|       |                crc5 = crc_braid_table[0][word5 & 0xff];
  812|       |#endif
  813|      0|#endif
  814|      0|#endif
  815|      0|#endif
  816|      0|#endif
  817|      0|                for (k = 1; k < W; k++) {
  ------------------
  |  Branch (817:29): [True: 0, False: 0]
  ------------------
  818|      0|                    crc0 ^= crc_braid_table[k][(word0 >> (k << 3)) & 0xff];
  819|      0|#if N > 1
  820|      0|                    crc1 ^= crc_braid_table[k][(word1 >> (k << 3)) & 0xff];
  821|      0|#if N > 2
  822|      0|                    crc2 ^= crc_braid_table[k][(word2 >> (k << 3)) & 0xff];
  823|      0|#if N > 3
  824|      0|                    crc3 ^= crc_braid_table[k][(word3 >> (k << 3)) & 0xff];
  825|      0|#if N > 4
  826|      0|                    crc4 ^= crc_braid_table[k][(word4 >> (k << 3)) & 0xff];
  827|       |#if N > 5
  828|       |                    crc5 ^= crc_braid_table[k][(word5 >> (k << 3)) & 0xff];
  829|       |#endif
  830|      0|#endif
  831|      0|#endif
  832|      0|#endif
  833|      0|#endif
  834|      0|                }
  835|      0|            }
  836|       |
  837|       |            /*
  838|       |              Process the last block, combining the CRCs of the N braids at the
  839|       |              same time.
  840|       |             */
  841|      0|            crc = crc_word(crc0 ^ words[0]);
  842|      0|#if N > 1
  843|      0|            crc = crc_word(crc1 ^ words[1] ^ crc);
  844|      0|#if N > 2
  845|      0|            crc = crc_word(crc2 ^ words[2] ^ crc);
  846|      0|#if N > 3
  847|      0|            crc = crc_word(crc3 ^ words[3] ^ crc);
  848|      0|#if N > 4
  849|      0|            crc = crc_word(crc4 ^ words[4] ^ crc);
  850|       |#if N > 5
  851|       |            crc = crc_word(crc5 ^ words[5] ^ crc);
  852|       |#endif
  853|      0|#endif
  854|      0|#endif
  855|      0|#endif
  856|      0|#endif
  857|      0|            words += N;
  858|      0|        }
  859|      0|        else {
  860|       |            /* Big endian. */
  861|       |
  862|      0|            z_word_t crc0, word0, comb;
  863|      0|#if N > 1
  864|      0|            z_word_t crc1, word1;
  865|      0|#if N > 2
  866|      0|            z_word_t crc2, word2;
  867|      0|#if N > 3
  868|      0|            z_word_t crc3, word3;
  869|      0|#if N > 4
  870|      0|            z_word_t crc4, word4;
  871|       |#if N > 5
  872|       |            z_word_t crc5, word5;
  873|       |#endif
  874|      0|#endif
  875|      0|#endif
  876|      0|#endif
  877|      0|#endif
  878|       |
  879|       |            /* Initialize the CRC for each braid. */
  880|      0|            crc0 = byte_swap(crc);
  881|      0|#if N > 1
  882|      0|            crc1 = 0;
  883|      0|#if N > 2
  884|      0|            crc2 = 0;
  885|      0|#if N > 3
  886|      0|            crc3 = 0;
  887|      0|#if N > 4
  888|      0|            crc4 = 0;
  889|       |#if N > 5
  890|       |            crc5 = 0;
  891|       |#endif
  892|      0|#endif
  893|      0|#endif
  894|      0|#endif
  895|      0|#endif
  896|       |
  897|       |            /*
  898|       |              Process the first blks-1 blocks, computing the CRCs on each braid
  899|       |              independently.
  900|       |             */
  901|      0|            while (--blks) {
  ------------------
  |  Branch (901:20): [True: 0, False: 0]
  ------------------
  902|       |                /* Load the word for each braid into registers. */
  903|      0|                word0 = crc0 ^ words[0];
  904|      0|#if N > 1
  905|      0|                word1 = crc1 ^ words[1];
  906|      0|#if N > 2
  907|      0|                word2 = crc2 ^ words[2];
  908|      0|#if N > 3
  909|      0|                word3 = crc3 ^ words[3];
  910|      0|#if N > 4
  911|      0|                word4 = crc4 ^ words[4];
  912|       |#if N > 5
  913|       |                word5 = crc5 ^ words[5];
  914|       |#endif
  915|      0|#endif
  916|      0|#endif
  917|      0|#endif
  918|      0|#endif
  919|      0|                words += N;
  920|       |
  921|       |                /* Compute and update the CRC for each word. The loop should
  922|       |                   get unrolled. */
  923|      0|                crc0 = crc_braid_big_table[0][word0 & 0xff];
  924|      0|#if N > 1
  925|      0|                crc1 = crc_braid_big_table[0][word1 & 0xff];
  926|      0|#if N > 2
  927|      0|                crc2 = crc_braid_big_table[0][word2 & 0xff];
  928|      0|#if N > 3
  929|      0|                crc3 = crc_braid_big_table[0][word3 & 0xff];
  930|      0|#if N > 4
  931|      0|                crc4 = crc_braid_big_table[0][word4 & 0xff];
  932|       |#if N > 5
  933|       |                crc5 = crc_braid_big_table[0][word5 & 0xff];
  934|       |#endif
  935|      0|#endif
  936|      0|#endif
  937|      0|#endif
  938|      0|#endif
  939|      0|                for (k = 1; k < W; k++) {
  ------------------
  |  Branch (939:29): [True: 0, False: 0]
  ------------------
  940|      0|                    crc0 ^= crc_braid_big_table[k][(word0 >> (k << 3)) & 0xff];
  941|      0|#if N > 1
  942|      0|                    crc1 ^= crc_braid_big_table[k][(word1 >> (k << 3)) & 0xff];
  943|      0|#if N > 2
  944|      0|                    crc2 ^= crc_braid_big_table[k][(word2 >> (k << 3)) & 0xff];
  945|      0|#if N > 3
  946|      0|                    crc3 ^= crc_braid_big_table[k][(word3 >> (k << 3)) & 0xff];
  947|      0|#if N > 4
  948|      0|                    crc4 ^= crc_braid_big_table[k][(word4 >> (k << 3)) & 0xff];
  949|       |#if N > 5
  950|       |                    crc5 ^= crc_braid_big_table[k][(word5 >> (k << 3)) & 0xff];
  951|       |#endif
  952|      0|#endif
  953|      0|#endif
  954|      0|#endif
  955|      0|#endif
  956|      0|                }
  957|      0|            }
  958|       |
  959|       |            /*
  960|       |              Process the last block, combining the CRCs of the N braids at the
  961|       |              same time.
  962|       |             */
  963|      0|            comb = crc_word_big(crc0 ^ words[0]);
  964|      0|#if N > 1
  965|      0|            comb = crc_word_big(crc1 ^ words[1] ^ comb);
  966|      0|#if N > 2
  967|      0|            comb = crc_word_big(crc2 ^ words[2] ^ comb);
  968|      0|#if N > 3
  969|      0|            comb = crc_word_big(crc3 ^ words[3] ^ comb);
  970|      0|#if N > 4
  971|      0|            comb = crc_word_big(crc4 ^ words[4] ^ comb);
  972|       |#if N > 5
  973|       |            comb = crc_word_big(crc5 ^ words[5] ^ comb);
  974|       |#endif
  975|      0|#endif
  976|      0|#endif
  977|      0|#endif
  978|      0|#endif
  979|      0|            words += N;
  980|      0|            crc = byte_swap(comb);
  981|      0|        }
  982|       |
  983|       |        /*
  984|       |          Update the pointer to the remaining bytes to process.
  985|       |         */
  986|      0|        buf = (unsigned char const *)words;
  987|      0|    }
  988|       |
  989|      0|#endif /* W */
  990|       |
  991|       |    /* Complete the computation of the CRC on any remaining bytes. */
  992|      0|    while (len >= 8) {
  ------------------
  |  Branch (992:12): [True: 0, False: 0]
  ------------------
  993|      0|        len -= 8;
  994|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
  995|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
  996|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
  997|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
  998|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
  999|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
 1000|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
 1001|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
 1002|      0|    }
 1003|      0|    while (len) {
  ------------------
  |  Branch (1003:12): [True: 0, False: 0]
  ------------------
 1004|      0|        len--;
 1005|      0|        crc = (crc >> 8) ^ crc_table[(crc ^ *buf++) & 0xff];
 1006|      0|    }
 1007|       |
 1008|       |    /* Return the CRC, post-conditioned. */
 1009|      0|    return crc ^ 0xffffffff;
 1010|      0|}
 1011|       |
 1012|       |#endif
 1013|       |
 1014|       |/* ========================================================================= */
 1015|       |unsigned long ZEXPORT crc32(unsigned long crc, const unsigned char FAR *buf,
 1016|      0|                            uInt len) {
 1017|      0|    return crc32_z(crc, buf, len);
 1018|      0|}
 1019|       |
 1020|       |/* ========================================================================= */
 1021|      0|uLong ZEXPORT crc32_combine64(uLong crc1, uLong crc2, z_off64_t len2) {
 1022|       |#ifdef DYNAMIC_CRC_TABLE
 1023|       |    once(&made, make_crc_table);
 1024|       |#endif /* DYNAMIC_CRC_TABLE */
 1025|      0|    return multmodp(x2nmodp(len2, 3), crc1) ^ (crc2 & 0xffffffff);
 1026|      0|}
 1027|       |
 1028|       |/* ========================================================================= */
 1029|      0|uLong ZEXPORT crc32_combine(uLong crc1, uLong crc2, z_off_t len2) {
 1030|      0|    return crc32_combine64(crc1, crc2, (z_off64_t)len2);
 1031|      0|}
 1032|       |
 1033|       |/* ========================================================================= */
 1034|      0|uLong ZEXPORT crc32_combine_gen64(z_off64_t len2) {
 1035|       |#ifdef DYNAMIC_CRC_TABLE
 1036|       |    once(&made, make_crc_table);
 1037|       |#endif /* DYNAMIC_CRC_TABLE */
 1038|      0|    return x2nmodp(len2, 3);
 1039|      0|}
 1040|       |
 1041|       |/* ========================================================================= */
 1042|      0|uLong ZEXPORT crc32_combine_gen(z_off_t len2) {
 1043|      0|    return crc32_combine_gen64((z_off64_t)len2);
 1044|      0|}
 1045|       |
 1046|       |/* ========================================================================= */
 1047|      0|uLong ZEXPORT crc32_combine_op(uLong crc1, uLong crc2, uLong op) {
 1048|      0|    return multmodp(op, crc1) ^ (crc2 & 0xffffffff);
 1049|      0|}

/home/minseo/alfha/targets/zlib/target/deflate.c:
    1|       |/* deflate.c -- compress data using the deflation algorithm
    2|       | * Copyright (C) 1995-2025 Jean-loup Gailly and Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/*
    7|       | *  ALGORITHM
    8|       | *
    9|       | *      The "deflation" process depends on being able to identify portions
   10|       | *      of the input text which are identical to earlier input (within a
   11|       | *      sliding window trailing behind the input currently being processed).
   12|       | *
   13|       | *      The most straightforward technique turns out to be the fastest for
   14|       | *      most input files: try all possible matches and select the longest.
   15|       | *      The key feature of this algorithm is that insertions into the string
   16|       | *      dictionary are very simple and thus fast, and deletions are avoided
   17|       | *      completely. Insertions are performed at each input character, whereas
   18|       | *      string matches are performed only when the previous match ends. So it
   19|       | *      is preferable to spend more time in matches to allow very fast string
   20|       | *      insertions and avoid deletions. The matching algorithm for small
   21|       | *      strings is inspired from that of Rabin & Karp. A brute force approach
   22|       | *      is used to find longer strings when a small match has been found.
   23|       | *      A similar algorithm is used in comic (by Jan-Mark Wams) and freeze
   24|       | *      (by Leonid Broukhis).
   25|       | *         A previous version of this file used a more sophisticated algorithm
   26|       | *      (by Fiala and Greene) which is guaranteed to run in linear amortized
   27|       | *      time, but has a larger average cost, uses more memory and is patented.
   28|       | *      However the F&G algorithm may be faster for some highly redundant
   29|       | *      files if the parameter max_chain_length (described below) is too large.
   30|       | *
   31|       | *  ACKNOWLEDGEMENTS
   32|       | *
   33|       | *      The idea of lazy evaluation of matches is due to Jan-Mark Wams, and
   34|       | *      I found it in 'freeze' written by Leonid Broukhis.
   35|       | *      Thanks to many people for bug reports and testing.
   36|       | *
   37|       | *  REFERENCES
   38|       | *
   39|       | *      Deutsch, L.P.,"DEFLATE Compressed Data Format Specification".
   40|       | *      Available at https://datatracker.ietf.org/doc/html/rfc1951
   41|       | *
   42|       | *      A description of the Rabin and Karp algorithm is given in the book
   43|       | *         "Algorithms" by R. Sedgewick, Addison-Wesley, p252.
   44|       | *
   45|       | *      Fiala,E.R., and Greene,D.H.
   46|       | *         Data Compression with Finite Windows, Comm.ACM, 32,4 (1989) 490-595
   47|       | *
   48|       | */
   49|       |
   50|       |/* @(#) $Id$ */
   51|       |
   52|       |#include "deflate.h"
   53|       |
   54|       |const char deflate_copyright[] =
   55|       |   " deflate 1.3.1.2 Copyright 1995-2025 Jean-loup Gailly and Mark Adler ";
   56|       |/*
   57|       |  If you use the zlib library in a product, an acknowledgment is welcome
   58|       |  in the documentation of your product. If for some reason you cannot
   59|       |  include such an acknowledgment, I would appreciate that you keep this
   60|       |  copyright string in the executable of your product.
   61|       | */
   62|       |
   63|       |typedef enum {
   64|       |    need_more,      /* block not completed, need more input or more output */
   65|       |    block_done,     /* block flush performed */
   66|       |    finish_started, /* finish started, need only more output at next deflate */
   67|       |    finish_done     /* finish done, accept no more input or output */
   68|       |} block_state;
   69|       |
   70|       |typedef block_state (*compress_func)(deflate_state *s, int flush);
   71|       |/* Compression function. Returns the block state after the call. */
   72|       |
   73|       |local block_state deflate_stored(deflate_state *s, int flush);
   74|       |local block_state deflate_fast(deflate_state *s, int flush);
   75|       |#ifndef FASTEST
   76|       |local block_state deflate_slow(deflate_state *s, int flush);
   77|       |#endif
   78|       |local block_state deflate_rle(deflate_state *s, int flush);
   79|       |local block_state deflate_huff(deflate_state *s, int flush);
   80|       |
   81|       |/* ===========================================================================
   82|       | * Local data
   83|       | */
   84|       |
   85|  8.09M|#define NIL 0
   86|       |/* Tail of hash chains */
   87|       |
   88|       |#ifndef TOO_FAR
   89|  64.1k|#  define TOO_FAR 4096
   90|       |#endif
   91|       |/* Matches of length 3 are discarded if their distance exceeds TOO_FAR */
   92|       |
   93|       |/* Values for max_lazy_match, good_match and max_chain_length, depending on
   94|       | * the desired pack level (0..9). The values given below have been tuned to
   95|       | * exclude worst case performance for pathological files. Better values may be
   96|       | * found for specific files.
   97|       | */
   98|       |typedef struct config_s {
   99|       |   ush good_length; /* reduce lazy search above this match length */
  100|       |   ush max_lazy;    /* do not perform lazy search above this match length */
  101|       |   ush nice_length; /* quit search above this match length */
  102|       |   ush max_chain;
  103|       |   compress_func func;
  104|       |} config;
  105|       |
  106|       |#ifdef FASTEST
  107|       |local const config configuration_table[2] = {
  108|       |/*      good lazy nice chain */
  109|       |/* 0 */ {0,    0,  0,    0, deflate_stored},  /* store only */
  110|       |/* 1 */ {4,    4,  8,    4, deflate_fast}}; /* max speed, no lazy matches */
  111|       |#else
  112|       |local const config configuration_table[10] = {
  113|       |/*      good lazy nice chain */
  114|       |/* 0 */ {0,    0,  0,    0, deflate_stored},  /* store only */
  115|       |/* 1 */ {4,    4,  8,    4, deflate_fast}, /* max speed, no lazy matches */
  116|       |/* 2 */ {4,    5, 16,    8, deflate_fast},
  117|       |/* 3 */ {4,    6, 32,   32, deflate_fast},
  118|       |
  119|       |/* 4 */ {4,    4, 16,   16, deflate_slow},  /* lazy matches */
  120|       |/* 5 */ {8,   16, 32,   32, deflate_slow},
  121|       |/* 6 */ {8,   16, 128, 128, deflate_slow},
  122|       |/* 7 */ {8,   32, 128, 256, deflate_slow},
  123|       |/* 8 */ {32, 128, 258, 1024, deflate_slow},
  124|       |/* 9 */ {32, 258, 258, 4096, deflate_slow}}; /* max compression */
  125|       |#endif
  126|       |
  127|       |/* Note: the deflate() code requires max_lazy >= MIN_MATCH and max_chain >= 4
  128|       | * For deflate_fast() (levels <= 3) good is ignored and lazy has a different
  129|       | * meaning.
  130|       | */
  131|       |
  132|       |/* rank Z_BLOCK between Z_NO_FLUSH and Z_PARTIAL_FLUSH */
  133|   263k|#define RANK(f) (((f) * 2) - ((f) > 4 ? 9 : 0))
                                            ^0        ^0  ^0
  134|       |
  135|       |/* ===========================================================================
  136|       | * Update a hash value with the given input byte
  137|       | * IN  assertion: all calls to UPDATE_HASH are made with consecutive input
  138|       | *    characters, so that a running hash key can be computed from the previous
  139|       | *    key instead of complete recalculation each time.
  140|       | */
  141|  8.65M|#define UPDATE_HASH(s,h,c) (h = (((h) << s->hash_shift) ^ (c)) & s->hash_mask)
  142|       |
  143|       |
  144|       |/* ===========================================================================
  145|       | * Insert string str in the dictionary and set match_head to the previous head
  146|       | * of the hash chain (the most recent string with same hash key). Return
  147|       | * the previous length of the hash chain.
  148|       | * If this file is compiled with -DFASTEST, the compression level is forced
  149|       | * to 1, and no hash chains are maintained.
  150|       | * IN  assertion: all calls to INSERT_STRING are made with consecutive input
  151|       | *    characters and the first MIN_MATCH bytes of str are valid (except for
  152|       | *    the last MIN_MATCH-1 bytes of the input file).
  153|       | */
  154|       |#ifdef FASTEST
  155|       |#define INSERT_STRING(s, str, match_head) \
  156|       |   (UPDATE_HASH(s, s->ins_h, s->window[(str) + (MIN_MATCH-1)]), \
  157|       |    match_head = s->head[s->ins_h], \
  158|       |    s->head[s->ins_h] = (Pos)(str))
  159|       |#else
  160|       |#define INSERT_STRING(s, str, match_head) \
  161|  8.38M|   (UPDATE_HASH(s, s->ins_h, s->window[(str) + (MIN_MATCH-1)]), \
  162|  8.38M|    match_head = s->prev[(str) & s->w_mask] = s->head[s->ins_h], \
  163|  8.38M|    s->head[s->ins_h] = (Pos)(str))
  164|       |#endif
  165|       |
  166|       |/* ===========================================================================
  167|       | * Initialize the hash table (avoiding 64K overflow for 16 bit systems).
  168|       | * prev[] will be initialized on the fly.
  169|       | */
  170|       |#define CLEAR_HASH(s) \
  171|   263k|    do { \
  172|   263k|        s->head[s->hash_size - 1] = NIL; \
  173|   263k|        zmemzero((Bytef *)s->head, \
  174|   263k|                 (unsigned)(s->hash_size - 1)*sizeof(*s->head)); \
  175|   263k|    } while (0)
  176|       |
  177|       |/* ===========================================================================
  178|       | * Slide the hash table when sliding the window down (could be avoided with 32
  179|       | * bit values at the expense of memory usage). We slide even when level == 0 to
  180|       | * keep the hash table consistent if we switch back to level > 0 later.
  181|       | */
  182|       |#if defined(__has_feature)
  183|       |#  if __has_feature(memory_sanitizer)
  184|       |     __attribute__((no_sanitize("memory")))
  185|       |#  endif
  186|       |#endif
  187|      0|local void slide_hash(deflate_state *s) {
  188|      0|    unsigned n, m;
  189|      0|    Posf *p;
  190|      0|    uInt wsize = s->w_size;
  191|       |
  192|      0|    n = s->hash_size;
  193|      0|    p = &s->head[n];
  194|      0|    do {
  195|      0|        m = *--p;
  196|      0|        *p = (Pos)(m >= wsize ? m - wsize : NIL);
  ------------------
  |  Branch (196:20): [True: 0, False: 0]
  ------------------
  197|      0|    } while (--n);
  ------------------
  |  Branch (197:14): [True: 0, False: 0]
  ------------------
  198|      0|    n = wsize;
  199|      0|#ifndef FASTEST
  200|      0|    p = &s->prev[n];
  201|      0|    do {
  202|      0|        m = *--p;
  203|      0|        *p = (Pos)(m >= wsize ? m - wsize : NIL);
  ------------------
  |  Branch (203:20): [True: 0, False: 0]
  ------------------
  204|       |        /* If n is not on any hash chain, prev[n] is garbage but
  205|       |         * its value will never be used.
  206|       |         */
  207|      0|    } while (--n);
  ------------------
  |  Branch (207:14): [True: 0, False: 0]
  ------------------
  208|      0|#endif
  209|      0|}
  210|       |
  211|       |/* ===========================================================================
  212|       | * Read a new buffer from the current input stream, update the adler32
  213|       | * and total number of bytes read.  All deflate() input goes through
  214|       | * this function so some applications may wish to modify it to avoid
  215|       | * allocating a large strm->next_in buffer and copying from it.
  216|       | * (See also flush_pending()).
  217|       | */
  218|   263k|local unsigned read_buf(z_streamp strm, Bytef *buf, unsigned size) {
  219|   263k|    unsigned len = strm->avail_in;
  220|       |
  221|   263k|    if (len > size) len = size;
                                  ^0
  ------------------
  |  Branch (221:9): [True: 0, False: 263k]
  ------------------
  222|   263k|    if (len == 0) return 0;
                                ^0
  ------------------
  |  Branch (222:9): [True: 0, False: 263k]
  ------------------
  223|       |
  224|   263k|    strm->avail_in  -= len;
  225|       |
  226|   263k|    zmemcpy(buf, strm->next_in, len);
  227|   263k|    if (strm->state->wrap == 1) {
  ------------------
  |  Branch (227:9): [True: 263k, False: 0]
  ------------------
  228|   263k|        strm->adler = adler32(strm->adler, buf, len);
  229|   263k|    }
  230|      0|#ifdef GZIP
  231|      0|    else if (strm->state->wrap == 2) {
  ------------------
  |  Branch (231:14): [True: 0, False: 0]
  ------------------
  232|      0|        strm->adler = crc32(strm->adler, buf, len);
  233|      0|    }
  234|   263k|#endif
  235|   263k|    strm->next_in  += len;
  236|   263k|    strm->total_in += len;
  237|       |
  238|   263k|    return len;
  239|   263k|}
  240|       |
  241|       |/* ===========================================================================
  242|       | * Fill the window when the lookahead becomes insufficient.
  243|       | * Updates strstart and lookahead.
  244|       | *
  245|       | * IN assertion: lookahead < MIN_LOOKAHEAD
  246|       | * OUT assertions: strstart <= window_size-MIN_LOOKAHEAD
  247|       | *    At least one byte has been read, or avail_in == 0; reads are
  248|       | *    performed for at least two bytes (required for the zip translate_eol
  249|       | *    option -- not supported here).
  250|       | */
  251|  2.68M|local void fill_window(deflate_state *s) {
  252|  2.68M|    unsigned n;
  253|  2.68M|    unsigned more;    /* Amount of free space at the end of the window. */
  254|  2.68M|    uInt wsize = s->w_size;
  255|       |
  256|  2.68M|    Assert(s->lookahead < MIN_LOOKAHEAD, "already enough lookahead");
  257|       |
  258|  2.68M|    do {
  259|  2.68M|        more = (unsigned)(s->window_size -(ulg)s->lookahead -(ulg)s->strstart);
  260|       |
  261|       |        /* Deal with !@#$% 64K limit: */
  262|  2.68M|        if (sizeof(int) <= 2) {
  ------------------
  |  Branch (262:13): [Folded - Ignored]
  ------------------
  263|      0|            if (more == 0 && s->strstart == 0 && s->lookahead == 0) {
  ------------------
  |  Branch (263:17): [True: 0, False: 0]
  |  Branch (263:30): [True: 0, False: 0]
  |  Branch (263:50): [True: 0, False: 0]
  ------------------
  264|      0|                more = wsize;
  265|       |
  266|      0|            } else if (more == (unsigned)(-1)) {
  ------------------
  |  Branch (266:24): [True: 0, False: 0]
  ------------------
  267|       |                /* Very unlikely, but possible on 16 bit machine if
  268|       |                 * strstart == 0 && lookahead == 1 (input done a byte at time)
  269|       |                 */
  270|      0|                more--;
  271|      0|            }
  272|      0|        }
  273|       |
  274|       |        /* If the window is almost full and there is insufficient lookahead,
  275|       |         * move the upper half to the lower one to make room in the upper half.
  276|       |         */
  277|  2.68M|        if (s->strstart >= wsize + MAX_DIST(s)) {
  ------------------
  |  Branch (277:13): [True: 0, False: 2.68M]
  ------------------
  278|       |
  279|      0|            zmemcpy(s->window, s->window + wsize, (unsigned)wsize - more);
  280|      0|            s->match_start -= wsize;
  281|      0|            s->strstart    -= wsize; /* we now have strstart >= MAX_DIST */
  282|      0|            s->block_start -= (long) wsize;
  283|      0|            if (s->insert > s->strstart)
  ------------------
  |  Branch (283:17): [True: 0, False: 0]
  ------------------
  284|      0|                s->insert = s->strstart;
  285|      0|            slide_hash(s);
  286|      0|            more += wsize;
  287|      0|        }
  288|  2.68M|        if (s->strm->avail_in == 0) break;
                                                  ^2.44M
  ------------------
  |  Branch (288:13): [True: 2.44M, False: 248k]
  ------------------
  289|       |
  290|       |        /* If there was no sliding:
  291|       |         *    strstart <= WSIZE+MAX_DIST-1 && lookahead <= MIN_LOOKAHEAD - 1 &&
  292|       |         *    more == window_size - lookahead - strstart
  293|       |         * => more >= window_size - (MIN_LOOKAHEAD-1 + WSIZE + MAX_DIST-1)
  294|       |         * => more >= window_size - 2*WSIZE + 2
  295|       |         * In the BIG_MEM or MMAP case (not yet supported),
  296|       |         *   window_size == input_size + MIN_LOOKAHEAD  &&
  297|       |         *   strstart + s->lookahead <= input_size => more >= MIN_LOOKAHEAD.
  298|       |         * Otherwise, window_size == 2*WSIZE so more >= 2.
  299|       |         * If there was sliding, more >= WSIZE. So in all cases, more >= 2.
  300|       |         */
  301|   248k|        Assert(more >= 2, "more < 2");
  302|       |
  303|   248k|        n = read_buf(s->strm, s->window + s->strstart + s->lookahead, more);
  304|   248k|        s->lookahead += n;
  305|       |
  306|       |        /* Initialize the hash value now that we have some input: */
  307|   248k|        if (s->lookahead + s->insert >= MIN_MATCH) {
  ------------------
  |  Branch (307:13): [True: 248k, False: 0]
  ------------------
  308|   248k|            uInt str = s->strstart - s->insert;
  309|   248k|            s->ins_h = s->window[str];
  310|   248k|            UPDATE_HASH(s, s->ins_h, s->window[str + 1]);
  311|       |#if MIN_MATCH != 3
  312|       |            Call UPDATE_HASH() MIN_MATCH-3 more times
  313|       |#endif
  314|   248k|            while (s->insert) {
  ------------------
  |  Branch (314:20): [True: 0, False: 248k]
  ------------------
  315|      0|                UPDATE_HASH(s, s->ins_h, s->window[str + MIN_MATCH-1]);
  316|      0|#ifndef FASTEST
  317|      0|                s->prev[str & s->w_mask] = s->head[s->ins_h];
  318|      0|#endif
  319|      0|                s->head[s->ins_h] = (Pos)str;
  320|      0|                str++;
  321|      0|                s->insert--;
  322|      0|                if (s->lookahead + s->insert < MIN_MATCH)
  ------------------
  |  Branch (322:21): [True: 0, False: 0]
  ------------------
  323|      0|                    break;
  324|      0|            }
  325|   248k|        }
  326|       |        /* If the whole input has less than MIN_MATCH bytes, ins_h is garbage,
  327|       |         * but this is not important since only literal bytes will be emitted.
  328|       |         */
  329|       |
  330|   248k|    } while (s->lookahead < MIN_LOOKAHEAD && s->strm->avail_in != 0);
                                                           ^248k
  ------------------
  |  Branch (330:14): [True: 248k, False: 427]
  |  Branch (330:46): [True: 0, False: 248k]
  ------------------
  331|       |
  332|       |    /* If the WIN_INIT bytes after the end of the current data have never been
  333|       |     * written, then zero those bytes in order to avoid memory check reports of
  334|       |     * the use of uninitialized (or uninitialised as Julian writes) bytes by
  335|       |     * the longest match routines.  Update the high water mark for the next
  336|       |     * time through here.  WIN_INIT is set to MAX_MATCH since the longest match
  337|       |     * routines allow scanning to strstart + MAX_MATCH, ignoring lookahead.
  338|       |     */
  339|  2.68M|    if (s->high_water < s->window_size) {
  ------------------
  |  Branch (339:9): [True: 2.68M, False: 0]
  ------------------
  340|  2.68M|        ulg curr = s->strstart + (ulg)(s->lookahead);
  341|  2.68M|        ulg init;
  342|       |
  343|  2.68M|        if (s->high_water < curr) {
  ------------------
  |  Branch (343:13): [True: 248k, False: 2.44M]
  ------------------
  344|       |            /* Previous high water mark below current data -- zero WIN_INIT
  345|       |             * bytes or up to end of window, whichever is less.
  346|       |             */
  347|   248k|            init = s->window_size - curr;
  348|   248k|            if (init > WIN_INIT)
  ------------------
  |  Branch (348:17): [True: 248k, False: 0]
  ------------------
  349|   248k|                init = WIN_INIT;
  350|   248k|            zmemzero(s->window + curr, (unsigned)init);
  351|   248k|            s->high_water = curr + init;
  352|   248k|        }
  353|  2.44M|        else if (s->high_water < (ulg)curr + WIN_INIT) {
  ------------------
  |  Branch (353:18): [True: 0, False: 2.44M]
  ------------------
  354|       |            /* High water mark at or above current data, but below current data
  355|       |             * plus WIN_INIT -- zero out to current data plus WIN_INIT, or up
  356|       |             * to end of window, whichever is less.
  357|       |             */
  358|      0|            init = (ulg)curr + WIN_INIT - s->high_water;
  359|      0|            if (init > s->window_size - s->high_water)
  ------------------
  |  Branch (359:17): [True: 0, False: 0]
  ------------------
  360|      0|                init = s->window_size - s->high_water;
  361|      0|            zmemzero(s->window + s->high_water, (unsigned)init);
  362|      0|            s->high_water += init;
  363|      0|        }
  364|  2.68M|    }
  365|       |
  366|  2.68M|    Assert((ulg)s->strstart <= s->window_size - MIN_LOOKAHEAD,
  367|  2.68M|           "not enough room for search");
  368|  2.68M|}
  369|       |
  370|       |/* ========================================================================= */
  371|       |int ZEXPORT deflateInit_(z_streamp strm, int level, const char *version,
  372|   263k|                         int stream_size) {
  373|   263k|    return deflateInit2_(strm, level, Z_DEFLATED, MAX_WBITS, DEF_MEM_LEVEL,
  374|   263k|                         Z_DEFAULT_STRATEGY, version, stream_size);
  375|       |    /* To do: ignore strm->next_in if we use it as window */
  376|   263k|}
  377|       |
  378|       |/* ========================================================================= */
  379|       |int ZEXPORT deflateInit2_(z_streamp strm, int level, int method,
  380|       |                          int windowBits, int memLevel, int strategy,
  381|   263k|                          const char *version, int stream_size) {
  382|   263k|    deflate_state *s;
  383|   263k|    int wrap = 1;
  384|   263k|    static const char my_version[] = ZLIB_VERSION;
  385|       |
  386|   263k|    if (version == Z_NULL || version[0] != my_version[0] ||
  ------------------
  |  Branch (386:9): [True: 0, False: 263k]
  |  Branch (386:30): [True: 0, False: 263k]
  ------------------
  387|   263k|        stream_size != sizeof(z_stream)) {
  ------------------
  |  Branch (387:9): [True: 0, False: 263k]
  ------------------
  388|      0|        return Z_VERSION_ERROR;
  389|      0|    }
  390|   263k|    if (strm == Z_NULL) return Z_STREAM_ERROR;
                                      ^0     ^0
  ------------------
  |  Branch (390:9): [True: 0, False: 263k]
  ------------------
  391|       |
  392|   263k|    strm->msg = Z_NULL;
  393|   263k|    if (strm->zalloc == (alloc_func)0) {
  ------------------
  |  Branch (393:9): [True: 263k, False: 0]
  ------------------
  394|       |#ifdef Z_SOLO
  395|       |        return Z_STREAM_ERROR;
  396|       |#else
  397|   263k|        strm->zalloc = zcalloc;
  398|   263k|        strm->opaque = (voidpf)0;
  399|   263k|#endif
  400|   263k|    }
  401|   263k|    if (strm->zfree == (free_func)0)
  ------------------
  |  Branch (401:9): [True: 263k, False: 0]
  ------------------
  402|       |#ifdef Z_SOLO
  403|       |        return Z_STREAM_ERROR;
  404|       |#else
  405|   263k|        strm->zfree = zcfree;
  406|   263k|#endif
  407|       |
  408|       |#ifdef FASTEST
  409|       |    if (level != 0) level = 1;
  410|       |#else
  411|   263k|    if (level == Z_DEFAULT_COMPRESSION) level = 6;
                                                      ^0
  ------------------
  |  Branch (411:9): [True: 0, False: 263k]
  ------------------
  412|   263k|#endif
  413|       |
  414|   263k|    if (windowBits < 0) { /* suppress zlib wrapper */
  ------------------
  |  Branch (414:9): [True: 0, False: 263k]
  ------------------
  415|      0|        wrap = 0;
  416|      0|        if (windowBits < -15)
  ------------------
  |  Branch (416:13): [True: 0, False: 0]
  ------------------
  417|      0|            return Z_STREAM_ERROR;
  418|      0|        windowBits = -windowBits;
  419|      0|    }
  420|   263k|#ifdef GZIP
  421|   263k|    else if (windowBits > 15) {
  ------------------
  |  Branch (421:14): [True: 0, False: 263k]
  ------------------
  422|      0|        wrap = 2;       /* write gzip wrapper instead */
  423|      0|        windowBits -= 16;
  424|      0|    }
  425|   263k|#endif
  426|   263k|    if (memLevel < 1 || memLevel > MAX_MEM_LEVEL || method != Z_DEFLATED ||
  ------------------
  |  Branch (426:9): [True: 0, False: 263k]
  |  Branch (426:25): [True: 0, False: 263k]
  |  Branch (426:53): [True: 0, False: 263k]
  ------------------
  427|   263k|        windowBits < 8 || windowBits > 15 || level < 0 || level > 9 ||
  ------------------
  |  Branch (427:9): [True: 0, False: 263k]
  |  Branch (427:27): [True: 0, False: 263k]
  |  Branch (427:46): [True: 0, False: 263k]
  |  Branch (427:59): [True: 0, False: 263k]
  ------------------
  428|   263k|        strategy < 0 || strategy > Z_FIXED || (windowBits == 8 && wrap != 1)) {
                                                                                ^0
  ------------------
  |  Branch (428:9): [True: 0, False: 263k]
  |  Branch (428:25): [True: 0, False: 263k]
  |  Branch (428:48): [True: 0, False: 263k]
  |  Branch (428:67): [True: 0, False: 0]
  ------------------
  429|      0|        return Z_STREAM_ERROR;
  430|      0|    }
  431|   263k|    if (windowBits == 8) windowBits = 9;  /* until 256-byte window bug fixed */
                                       ^0
  ------------------
  |  Branch (431:9): [True: 0, False: 263k]
  ------------------
  432|   263k|    s = (deflate_state *) ZALLOC(strm, 1, sizeof(deflate_state));
  433|   263k|    if (s == Z_NULL) return Z_MEM_ERROR;
                                   ^0     ^0
  ------------------
  |  Branch (433:9): [True: 0, False: 263k]
  ------------------
  434|   263k|    strm->state = (struct internal_state FAR *)s;
  435|   263k|    s->strm = strm;
  436|   263k|    s->status = INIT_STATE;     /* to pass state test in deflateReset() */
  437|       |
  438|   263k|    s->wrap = wrap;
  439|   263k|    s->gzhead = Z_NULL;
  440|   263k|    s->w_bits = (uInt)windowBits;
  441|   263k|    s->w_size = 1 << s->w_bits;
  442|   263k|    s->w_mask = s->w_size - 1;
  443|       |
  444|   263k|    s->hash_bits = (uInt)memLevel + 7;
  445|   263k|    s->hash_size = 1 << s->hash_bits;
  446|   263k|    s->hash_mask = s->hash_size - 1;
  447|   263k|    s->hash_shift =  ((s->hash_bits + MIN_MATCH-1) / MIN_MATCH);
  448|       |
  449|   263k|    s->window = (Bytef *) ZALLOC(strm, s->w_size, 2*sizeof(Byte));
  450|   263k|    s->prev   = (Posf *)  ZALLOC(strm, s->w_size, sizeof(Pos));
  451|   263k|    s->head   = (Posf *)  ZALLOC(strm, s->hash_size, sizeof(Pos));
  452|       |
  453|   263k|    s->high_water = 0;      /* nothing written to s->window yet */
  454|       |
  455|   263k|    s->lit_bufsize = 1 << (memLevel + 6); /* 16K elements by default */
  456|       |
  457|       |    /* We overlay pending_buf and sym_buf. This works since the average size
  458|       |     * for length/distance pairs over any compressed block is assured to be 31
  459|       |     * bits or less.
  460|       |     *
  461|       |     * Analysis: The longest fixed codes are a length code of 8 bits plus 5
  462|       |     * extra bits, for lengths 131 to 257. The longest fixed distance codes are
  463|       |     * 5 bits plus 13 extra bits, for distances 16385 to 32768. The longest
  464|       |     * possible fixed-codes length/distance pair is then 31 bits total.
  465|       |     *
  466|       |     * sym_buf starts one-fourth of the way into pending_buf. So there are
  467|       |     * three bytes in sym_buf for every four bytes in pending_buf. Each symbol
  468|       |     * in sym_buf is three bytes -- two for the distance and one for the
  469|       |     * literal/length. As each symbol is consumed, the pointer to the next
  470|       |     * sym_buf value to read moves forward three bytes. From that symbol, up to
  471|       |     * 31 bits are written to pending_buf. The closest the written pending_buf
  472|       |     * bits gets to the next sym_buf symbol to read is just before the last
  473|       |     * code is written. At that time, 31*(n - 2) bits have been written, just
  474|       |     * after 24*(n - 2) bits have been consumed from sym_buf. sym_buf starts at
  475|       |     * 8*n bits into pending_buf. (Note that the symbol buffer fills when n - 1
  476|       |     * symbols are written.) The closest the writing gets to what is unread is
  477|       |     * then n + 14 bits. Here n is lit_bufsize, which is 16384 by default, and
  478|       |     * can range from 128 to 32768.
  479|       |     *
  480|       |     * Therefore, at a minimum, there are 142 bits of space between what is
  481|       |     * written and what is read in the overlain buffers, so the symbols cannot
  482|       |     * be overwritten by the compressed data. That space is actually 139 bits,
  483|       |     * due to the three-bit fixed-code block header.
  484|       |     *
  485|       |     * That covers the case where either Z_FIXED is specified, forcing fixed
  486|       |     * codes, or when the use of fixed codes is chosen, because that choice
  487|       |     * results in a smaller compressed block than dynamic codes. That latter
  488|       |     * condition then assures that the above analysis also covers all dynamic
  489|       |     * blocks. A dynamic-code block will only be chosen to be emitted if it has
  490|       |     * fewer bits than a fixed-code block would for the same set of symbols.
  491|       |     * Therefore its average symbol length is assured to be less than 31. So
  492|       |     * the compressed data for a dynamic block also cannot overwrite the
  493|       |     * symbols from which it is being constructed.
  494|       |     */
  495|       |
  496|   263k|    s->pending_buf = (uchf *) ZALLOC(strm, s->lit_bufsize, LIT_BUFS);
  497|   263k|    s->pending_buf_size = (ulg)s->lit_bufsize * 4;
  498|       |
  499|   263k|    if (s->window == Z_NULL || s->prev == Z_NULL || s->head == Z_NULL ||
  ------------------
  |  Branch (499:9): [True: 0, False: 263k]
  |  Branch (499:32): [True: 0, False: 263k]
  |  Branch (499:53): [True: 0, False: 263k]
  ------------------
  500|   263k|        s->pending_buf == Z_NULL) {
  ------------------
  |  Branch (500:9): [True: 0, False: 263k]
  ------------------
  501|      0|        s->status = FINISH_STATE;
  502|      0|        strm->msg = ERR_MSG(Z_MEM_ERROR);
  503|      0|        deflateEnd (strm);
  504|      0|        return Z_MEM_ERROR;
  505|      0|    }
  506|       |#ifdef LIT_MEM
  507|       |    s->d_buf = (ushf *)(s->pending_buf + (s->lit_bufsize << 1));
  508|       |    s->l_buf = s->pending_buf + (s->lit_bufsize << 2);
  509|       |    s->sym_end = s->lit_bufsize - 1;
  510|       |#else
  511|   263k|    s->sym_buf = s->pending_buf + s->lit_bufsize;
  512|   263k|    s->sym_end = (s->lit_bufsize - 1) * 3;
  513|   263k|#endif
  514|       |    /* We avoid equality with lit_bufsize*3 because of wraparound at 64K
  515|       |     * on 16 bit machines and because stored blocks are restricted to
  516|       |     * 64K-1 bytes.
  517|       |     */
  518|       |
  519|   263k|    s->level = level;
  520|   263k|    s->strategy = strategy;
  521|   263k|    s->method = (Byte)method;
  522|       |
  523|   263k|    return deflateReset(strm);
  524|   263k|}
  525|       |
  526|       |/* =========================================================================
  527|       | * Check for a valid deflate stream state. Return 0 if ok, 1 if not.
  528|       | */
  529|   789k|local int deflateStateCheck(z_streamp strm) {
  530|   789k|    deflate_state *s;
  531|   789k|    if (strm == Z_NULL ||
  ------------------
  |  Branch (531:9): [True: 0, False: 789k]
  ------------------
  532|   789k|        strm->zalloc == (alloc_func)0 || strm->zfree == (free_func)0)
  ------------------
  |  Branch (532:9): [True: 0, False: 789k]
  |  Branch (532:42): [True: 0, False: 789k]
  ------------------
  533|      0|        return 1;
  534|   789k|    s = strm->state;
  535|   789k|    if (s == Z_NULL || s->strm != strm || (s->status != INIT_STATE &&
  ------------------
  |  Branch (535:9): [True: 0, False: 789k]
  |  Branch (535:24): [True: 0, False: 789k]
  |  Branch (535:44): [True: 263k, False: 526k]
  ------------------
  536|   789k|#ifdef GZIP
  537|   789k|                                           s->status != GZIP_STATE &&
                                                         ^263k        ^263k
  ------------------
  |  Branch (537:44): [True: 263k, False: 0]
  ------------------
  538|   789k|#endif
  539|   789k|                                           s->status != EXTRA_STATE &&
                                                         ^263k        ^263k
  ------------------
  |  Branch (539:44): [True: 263k, False: 0]
  ------------------
  540|   789k|                                           s->status != NAME_STATE &&
                                                         ^263k        ^263k
  ------------------
  |  Branch (540:44): [True: 263k, False: 0]
  ------------------
  541|   789k|                                           s->status != COMMENT_STATE &&
                                                         ^263k        ^263k
  ------------------
  |  Branch (541:44): [True: 263k, False: 0]
  ------------------
  542|   789k|                                           s->status != HCRC_STATE &&
                                                         ^263k        ^263k
  ------------------
  |  Branch (542:44): [True: 263k, False: 0]
  ------------------
  543|   789k|                                           s->status != BUSY_STATE &&
                                                         ^263k        ^263k
  ------------------
  |  Branch (543:44): [True: 263k, False: 0]
  ------------------
  544|   789k|                                           s->status != FINISH_STATE))
                                                         ^263k        ^263k
  ------------------
  |  Branch (544:44): [True: 0, False: 263k]
  ------------------
  545|      0|        return 1;
  546|   789k|    return 0;
  547|   789k|}
  548|       |
  549|       |/* ========================================================================= */
  550|       |int ZEXPORT deflateSetDictionary(z_streamp strm, const Bytef *dictionary,
  551|      0|                                 uInt  dictLength) {
  552|      0|    deflate_state *s;
  553|      0|    uInt str, n;
  554|      0|    int wrap;
  555|      0|    unsigned avail;
  556|      0|    z_const unsigned char *next;
  557|       |
  558|      0|    if (deflateStateCheck(strm) || dictionary == Z_NULL)
  ------------------
  |  Branch (558:9): [True: 0, False: 0]
  |  Branch (558:36): [True: 0, False: 0]
  ------------------
  559|      0|        return Z_STREAM_ERROR;
  560|      0|    s = strm->state;
  561|      0|    wrap = s->wrap;
  562|      0|    if (wrap == 2 || (wrap == 1 && s->status != INIT_STATE) || s->lookahead)
  ------------------
  |  Branch (562:9): [True: 0, False: 0]
  |  Branch (562:23): [True: 0, False: 0]
  |  Branch (562:36): [True: 0, False: 0]
  |  Branch (562:64): [True: 0, False: 0]
  ------------------
  563|      0|        return Z_STREAM_ERROR;
  564|       |
  565|       |    /* when using zlib wrappers, compute Adler-32 for provided dictionary */
  566|      0|    if (wrap == 1)
  ------------------
  |  Branch (566:9): [True: 0, False: 0]
  ------------------
  567|      0|        strm->adler = adler32(strm->adler, dictionary, dictLength);
  568|      0|    s->wrap = 0;                    /* avoid computing Adler-32 in read_buf */
  569|       |
  570|       |    /* if dictionary would fill window, just replace the history */
  571|      0|    if (dictLength >= s->w_size) {
  ------------------
  |  Branch (571:9): [True: 0, False: 0]
  ------------------
  572|      0|        if (wrap == 0) {            /* already empty otherwise */
  ------------------
  |  Branch (572:13): [True: 0, False: 0]
  ------------------
  573|      0|            CLEAR_HASH(s);
  574|      0|            s->strstart = 0;
  575|      0|            s->block_start = 0L;
  576|      0|            s->insert = 0;
  577|      0|        }
  578|      0|        dictionary += dictLength - s->w_size;  /* use the tail */
  579|      0|        dictLength = s->w_size;
  580|      0|    }
  581|       |
  582|       |    /* insert dictionary into window and hash */
  583|      0|    avail = strm->avail_in;
  584|      0|    next = strm->next_in;
  585|      0|    strm->avail_in = dictLength;
  586|      0|    strm->next_in = (z_const Bytef *)dictionary;
  587|      0|    fill_window(s);
  588|      0|    while (s->lookahead >= MIN_MATCH) {
  ------------------
  |  Branch (588:12): [True: 0, False: 0]
  ------------------
  589|      0|        str = s->strstart;
  590|      0|        n = s->lookahead - (MIN_MATCH-1);
  591|      0|        do {
  592|      0|            UPDATE_HASH(s, s->ins_h, s->window[str + MIN_MATCH-1]);
  593|      0|#ifndef FASTEST
  594|      0|            s->prev[str & s->w_mask] = s->head[s->ins_h];
  595|      0|#endif
  596|      0|            s->head[s->ins_h] = (Pos)str;
  597|      0|            str++;
  598|      0|        } while (--n);
  ------------------
  |  Branch (598:18): [True: 0, False: 0]
  ------------------
  599|      0|        s->strstart = str;
  600|      0|        s->lookahead = MIN_MATCH-1;
  601|      0|        fill_window(s);
  602|      0|    }
  603|      0|    s->strstart += s->lookahead;
  604|      0|    s->block_start = (long)s->strstart;
  605|      0|    s->insert = s->lookahead;
  606|      0|    s->lookahead = 0;
  607|      0|    s->match_length = s->prev_length = MIN_MATCH-1;
  608|      0|    s->match_available = 0;
  609|      0|    strm->next_in = next;
  610|      0|    strm->avail_in = avail;
  611|      0|    s->wrap = wrap;
  612|      0|    return Z_OK;
  613|      0|}
  614|       |
  615|       |/* ========================================================================= */
  616|       |int ZEXPORT deflateGetDictionary(z_streamp strm, Bytef *dictionary,
  617|      0|                                 uInt *dictLength) {
  618|      0|    deflate_state *s;
  619|      0|    uInt len;
  620|       |
  621|      0|    if (deflateStateCheck(strm))
  ------------------
  |  Branch (621:9): [True: 0, False: 0]
  ------------------
  622|      0|        return Z_STREAM_ERROR;
  623|      0|    s = strm->state;
  624|      0|    len = s->strstart + s->lookahead;
  625|      0|    if (len > s->w_size)
  ------------------
  |  Branch (625:9): [True: 0, False: 0]
  ------------------
  626|      0|        len = s->w_size;
  627|      0|    if (dictionary != Z_NULL && len)
  ------------------
  |  Branch (627:9): [True: 0, False: 0]
  |  Branch (627:33): [True: 0, False: 0]
  ------------------
  628|      0|        zmemcpy(dictionary, s->window + s->strstart + s->lookahead - len, len);
  629|      0|    if (dictLength != Z_NULL)
  ------------------
  |  Branch (629:9): [True: 0, False: 0]
  ------------------
  630|      0|        *dictLength = len;
  631|      0|    return Z_OK;
  632|      0|}
  633|       |
  634|       |/* ========================================================================= */
  635|   263k|int ZEXPORT deflateResetKeep(z_streamp strm) {
  636|   263k|    deflate_state *s;
  637|       |
  638|   263k|    if (deflateStateCheck(strm)) {
  ------------------
  |  Branch (638:9): [True: 0, False: 263k]
  ------------------
  639|      0|        return Z_STREAM_ERROR;
  640|      0|    }
  641|       |
  642|   263k|    strm->total_in = strm->total_out = 0;
  643|   263k|    strm->msg = Z_NULL; /* use zfree if we ever allocate msg dynamically */
  644|   263k|    strm->data_type = Z_UNKNOWN;
  645|       |
  646|   263k|    s = (deflate_state *)strm->state;
  647|   263k|    s->pending = 0;
  648|   263k|    s->pending_out = s->pending_buf;
  649|       |
  650|   263k|    if (s->wrap < 0) {
  ------------------
  |  Branch (650:9): [True: 0, False: 263k]
  ------------------
  651|      0|        s->wrap = -s->wrap; /* was made negative by deflate(..., Z_FINISH); */
  652|      0|    }
  653|   263k|    s->status =
  654|   263k|#ifdef GZIP
  655|   263k|        s->wrap == 2 ? GZIP_STATE :
                                     ^0
  ------------------
  |  Branch (655:9): [True: 0, False: 263k]
  ------------------
  656|   263k|#endif
  657|   263k|        INIT_STATE;
  658|   263k|    strm->adler =
  659|   263k|#ifdef GZIP
  660|   263k|        s->wrap == 2 ? crc32(0L, Z_NULL, 0) :
                                     ^0        ^0
  ------------------
  |  Branch (660:9): [True: 0, False: 263k]
  ------------------
  661|   263k|#endif
  662|   263k|        adler32(0L, Z_NULL, 0);
  663|   263k|    s->last_flush = -2;
  664|       |
  665|   263k|    _tr_init(s);
  666|       |
  667|   263k|    return Z_OK;
  668|   263k|}
  669|       |
  670|       |/* ===========================================================================
  671|       | * Initialize the "longest match" routines for a new zlib stream
  672|       | */
  673|   263k|local void lm_init(deflate_state *s) {
  674|   263k|    s->window_size = (ulg)2L*s->w_size;
  675|       |
  676|   263k|    CLEAR_HASH(s);
  677|       |
  678|       |    /* Set the default configuration parameters:
  679|       |     */
  680|   263k|    s->max_lazy_match   = configuration_table[s->level].max_lazy;
  681|   263k|    s->good_match       = configuration_table[s->level].good_length;
  682|   263k|    s->nice_match       = configuration_table[s->level].nice_length;
  683|   263k|    s->max_chain_length = configuration_table[s->level].max_chain;
  684|       |
  685|   263k|    s->strstart = 0;
  686|   263k|    s->block_start = 0L;
  687|   263k|    s->lookahead = 0;
  688|   263k|    s->insert = 0;
  689|   263k|    s->match_length = s->prev_length = MIN_MATCH-1;
  690|   263k|    s->match_available = 0;
  691|   263k|    s->ins_h = 0;
  692|   263k|}
  693|       |
  694|       |/* ========================================================================= */
  695|   263k|int ZEXPORT deflateReset(z_streamp strm) {
  696|   263k|    int ret;
  697|       |
  698|   263k|    ret = deflateResetKeep(strm);
  699|   263k|    if (ret == Z_OK)
  ------------------
  |  Branch (699:9): [True: 263k, False: 0]
  ------------------
  700|   263k|        lm_init(strm->state);
  701|   263k|    return ret;
  702|   263k|}
  703|       |
  704|       |/* ========================================================================= */
  705|      0|int ZEXPORT deflateSetHeader(z_streamp strm, gz_headerp head) {
  706|      0|    if (deflateStateCheck(strm) || strm->state->wrap != 2)
  ------------------
  |  Branch (706:9): [True: 0, False: 0]
  |  Branch (706:36): [True: 0, False: 0]
  ------------------
  707|      0|        return Z_STREAM_ERROR;
  708|      0|    strm->state->gzhead = head;
  709|      0|    return Z_OK;
  710|      0|}
  711|       |
  712|       |/* ========================================================================= */
  713|      0|int ZEXPORT deflatePending(z_streamp strm, unsigned *pending, int *bits) {
  714|      0|    if (deflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (714:9): [True: 0, False: 0]
  ------------------
  715|      0|    if (pending != Z_NULL)
  ------------------
  |  Branch (715:9): [True: 0, False: 0]
  ------------------
  716|      0|        *pending = strm->state->pending;
  717|      0|    if (bits != Z_NULL)
  ------------------
  |  Branch (717:9): [True: 0, False: 0]
  ------------------
  718|      0|        *bits = strm->state->bi_valid;
  719|      0|    return Z_OK;
  720|      0|}
  721|       |
  722|       |/* ========================================================================= */
  723|      0|int ZEXPORT deflateUsed(z_streamp strm, int *bits) {
  724|      0|    if (deflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (724:9): [True: 0, False: 0]
  ------------------
  725|      0|    if (bits != Z_NULL)
  ------------------
  |  Branch (725:9): [True: 0, False: 0]
  ------------------
  726|      0|        *bits = strm->state->bi_used;
  727|      0|    return Z_OK;
  728|      0|}
  729|       |
  730|       |/* ========================================================================= */
  731|      0|int ZEXPORT deflatePrime(z_streamp strm, int bits, int value) {
  732|      0|    deflate_state *s;
  733|      0|    int put;
  734|       |
  735|      0|    if (deflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (735:9): [True: 0, False: 0]
  ------------------
  736|      0|    s = strm->state;
  737|       |#ifdef LIT_MEM
  738|       |    if (bits < 0 || bits > 16 ||
  739|       |        (uchf *)s->d_buf < s->pending_out + ((Buf_size + 7) >> 3))
  740|       |        return Z_BUF_ERROR;
  741|       |#else
  742|      0|    if (bits < 0 || bits > 16 ||
  ------------------
  |  Branch (742:9): [True: 0, False: 0]
  |  Branch (742:21): [True: 0, False: 0]
  ------------------
  743|      0|        s->sym_buf < s->pending_out + ((Buf_size + 7) >> 3))
  ------------------
  |  Branch (743:9): [True: 0, False: 0]
  ------------------
  744|      0|        return Z_BUF_ERROR;
  745|      0|#endif
  746|      0|    do {
  747|      0|        put = Buf_size - s->bi_valid;
  748|      0|        if (put > bits)
  ------------------
  |  Branch (748:13): [True: 0, False: 0]
  ------------------
  749|      0|            put = bits;
  750|      0|        s->bi_buf |= (ush)((value & ((1 << put) - 1)) << s->bi_valid);
  751|      0|        s->bi_valid += put;
  752|      0|        _tr_flush_bits(s);
  753|      0|        value >>= put;
  754|      0|        bits -= put;
  755|      0|    } while (bits);
  ------------------
  |  Branch (755:14): [True: 0, False: 0]
  ------------------
  756|      0|    return Z_OK;
  757|      0|}
  758|       |
  759|       |/* ========================================================================= */
  760|      0|int ZEXPORT deflateParams(z_streamp strm, int level, int strategy) {
  761|      0|    deflate_state *s;
  762|      0|    compress_func func;
  763|       |
  764|      0|    if (deflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (764:9): [True: 0, False: 0]
  ------------------
  765|      0|    s = strm->state;
  766|       |
  767|       |#ifdef FASTEST
  768|       |    if (level != 0) level = 1;
  769|       |#else
  770|      0|    if (level == Z_DEFAULT_COMPRESSION) level = 6;
  ------------------
  |  Branch (770:9): [True: 0, False: 0]
  ------------------
  771|      0|#endif
  772|      0|    if (level < 0 || level > 9 || strategy < 0 || strategy > Z_FIXED) {
  ------------------
  |  Branch (772:9): [True: 0, False: 0]
  |  Branch (772:22): [True: 0, False: 0]
  |  Branch (772:35): [True: 0, False: 0]
  |  Branch (772:51): [True: 0, False: 0]
  ------------------
  773|      0|        return Z_STREAM_ERROR;
  774|      0|    }
  775|      0|    func = configuration_table[s->level].func;
  776|       |
  777|      0|    if ((strategy != s->strategy || func != configuration_table[level].func) &&
  ------------------
  |  Branch (777:10): [True: 0, False: 0]
  |  Branch (777:37): [True: 0, False: 0]
  ------------------
  778|      0|        s->last_flush != -2) {
  ------------------
  |  Branch (778:9): [True: 0, False: 0]
  ------------------
  779|       |        /* Flush the last buffer: */
  780|      0|        int err = deflate(strm, Z_BLOCK);
  781|      0|        if (err == Z_STREAM_ERROR)
  ------------------
  |  Branch (781:13): [True: 0, False: 0]
  ------------------
  782|      0|            return err;
  783|      0|        if (strm->avail_in || (s->strstart - s->block_start) + s->lookahead)
  ------------------
  |  Branch (783:13): [True: 0, False: 0]
  |  Branch (783:31): [True: 0, False: 0]
  ------------------
  784|      0|            return Z_BUF_ERROR;
  785|      0|    }
  786|      0|    if (s->level != level) {
  ------------------
  |  Branch (786:9): [True: 0, False: 0]
  ------------------
  787|      0|        if (s->level == 0 && s->matches != 0) {
  ------------------
  |  Branch (787:13): [True: 0, False: 0]
  |  Branch (787:30): [True: 0, False: 0]
  ------------------
  788|      0|            if (s->matches == 1)
  ------------------
  |  Branch (788:17): [True: 0, False: 0]
  ------------------
  789|      0|                slide_hash(s);
  790|      0|            else
  791|      0|                CLEAR_HASH(s);
  792|      0|            s->matches = 0;
  793|      0|        }
  794|      0|        s->level = level;
  795|      0|        s->max_lazy_match   = configuration_table[level].max_lazy;
  796|      0|        s->good_match       = configuration_table[level].good_length;
  797|      0|        s->nice_match       = configuration_table[level].nice_length;
  798|      0|        s->max_chain_length = configuration_table[level].max_chain;
  799|      0|    }
  800|      0|    s->strategy = strategy;
  801|      0|    return Z_OK;
  802|      0|}
  803|       |
  804|       |/* ========================================================================= */
  805|       |int ZEXPORT deflateTune(z_streamp strm, int good_length, int max_lazy,
  806|      0|                        int nice_length, int max_chain) {
  807|      0|    deflate_state *s;
  808|       |
  809|      0|    if (deflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (809:9): [True: 0, False: 0]
  ------------------
  810|      0|    s = strm->state;
  811|      0|    s->good_match = (uInt)good_length;
  812|      0|    s->max_lazy_match = (uInt)max_lazy;
  813|      0|    s->nice_match = nice_length;
  814|      0|    s->max_chain_length = (uInt)max_chain;
  815|      0|    return Z_OK;
  816|      0|}
  817|       |
  818|       |/* =========================================================================
  819|       | * For the default windowBits of 15 and memLevel of 8, this function returns a
  820|       | * close to exact, as well as small, upper bound on the compressed size. This
  821|       | * is an expansion of ~0.03%, plus a small constant.
  822|       | *
  823|       | * For any setting other than those defaults for windowBits and memLevel, one
  824|       | * of two worst case bounds is returned. This is at most an expansion of ~4% or
  825|       | * ~13%, plus a small constant.
  826|       | *
  827|       | * Both the 0.03% and 4% derive from the overhead of stored blocks. The first
  828|       | * one is for stored blocks of 16383 bytes (memLevel == 8), whereas the second
  829|       | * is for stored blocks of 127 bytes (the worst case memLevel == 1). The
  830|       | * expansion results from five bytes of header for each stored block.
  831|       | *
  832|       | * The larger expansion of 13% results from a window size less than or equal to
  833|       | * the symbols buffer size (windowBits <= memLevel + 7). In that case some of
  834|       | * the data being compressed may have slid out of the sliding window, impeding
  835|       | * a stored block from being emitted. Then the only choice is a fixed or
  836|       | * dynamic block, where a fixed block limits the maximum expansion to 9 bits
  837|       | * per 8-bit byte, plus 10 bits for every block. The smallest block size for
  838|       | * which this can occur is 255 (memLevel == 2).
  839|       | *
  840|       | * Shifts are used to approximate divisions, for speed.
  841|       | */
  842|      0|uLong ZEXPORT deflateBound(z_streamp strm, uLong sourceLen) {
  843|      0|    deflate_state *s;
  844|      0|    uLong fixedlen, storelen, wraplen;
  845|       |
  846|       |    /* upper bound for fixed blocks with 9-bit literals and length 255
  847|       |       (memLevel == 2, which is the lowest that may not use stored blocks) --
  848|       |       ~13% overhead plus a small constant */
  849|      0|    fixedlen = sourceLen + (sourceLen >> 3) + (sourceLen >> 8) +
  850|      0|               (sourceLen >> 9) + 4;
  851|       |
  852|       |    /* upper bound for stored blocks with length 127 (memLevel == 1) --
  853|       |       ~4% overhead plus a small constant */
  854|      0|    storelen = sourceLen + (sourceLen >> 5) + (sourceLen >> 7) +
  855|      0|               (sourceLen >> 11) + 7;
  856|       |
  857|       |    /* if can't get parameters, return larger bound plus a wrapper */
  858|      0|    if (deflateStateCheck(strm))
  ------------------
  |  Branch (858:9): [True: 0, False: 0]
  ------------------
  859|      0|        return (fixedlen > storelen ? fixedlen : storelen) + 18;
  ------------------
  |  Branch (859:17): [True: 0, False: 0]
  ------------------
  860|       |
  861|       |    /* compute wrapper length */
  862|      0|    s = strm->state;
  863|      0|    switch (s->wrap < 0 ? -s->wrap : s->wrap) {
  ------------------
  |  Branch (863:13): [True: 0, False: 0]
  ------------------
  864|      0|    case 0:                                 /* raw deflate */
  ------------------
  |  Branch (864:5): [True: 0, False: 0]
  ------------------
  865|      0|        wraplen = 0;
  866|      0|        break;
  867|      0|    case 1:                                 /* zlib wrapper */
  ------------------
  |  Branch (867:5): [True: 0, False: 0]
  ------------------
  868|      0|        wraplen = 6 + (s->strstart ? 4 : 0);
  ------------------
  |  Branch (868:24): [True: 0, False: 0]
  ------------------
  869|      0|        break;
  870|      0|#ifdef GZIP
  871|      0|    case 2:                                 /* gzip wrapper */
  ------------------
  |  Branch (871:5): [True: 0, False: 0]
  ------------------
  872|      0|        wraplen = 18;
  873|      0|        if (s->gzhead != Z_NULL) {          /* user-supplied gzip header */
  ------------------
  |  Branch (873:13): [True: 0, False: 0]
  ------------------
  874|      0|            Bytef *str;
  875|      0|            if (s->gzhead->extra != Z_NULL)
  ------------------
  |  Branch (875:17): [True: 0, False: 0]
  ------------------
  876|      0|                wraplen += 2 + s->gzhead->extra_len;
  877|      0|            str = s->gzhead->name;
  878|      0|            if (str != Z_NULL)
  ------------------
  |  Branch (878:17): [True: 0, False: 0]
  ------------------
  879|      0|                do {
  880|      0|                    wraplen++;
  881|      0|                } while (*str++);
  ------------------
  |  Branch (881:26): [True: 0, False: 0]
  ------------------
  882|      0|            str = s->gzhead->comment;
  883|      0|            if (str != Z_NULL)
  ------------------
  |  Branch (883:17): [True: 0, False: 0]
  ------------------
  884|      0|                do {
  885|      0|                    wraplen++;
  886|      0|                } while (*str++);
  ------------------
  |  Branch (886:26): [True: 0, False: 0]
  ------------------
  887|      0|            if (s->gzhead->hcrc)
  ------------------
  |  Branch (887:17): [True: 0, False: 0]
  ------------------
  888|      0|                wraplen += 2;
  889|      0|        }
  890|      0|        break;
  891|      0|#endif
  892|      0|    default:                                /* for compiler happiness */
  ------------------
  |  Branch (892:5): [True: 0, False: 0]
  ------------------
  893|      0|        wraplen = 18;
  894|      0|    }
  895|       |
  896|       |    /* if not default parameters, return one of the conservative bounds */
  897|      0|    if (s->w_bits != 15 || s->hash_bits != 8 + 7)
  ------------------
  |  Branch (897:9): [True: 0, False: 0]
  |  Branch (897:28): [True: 0, False: 0]
  ------------------
  898|      0|        return (s->w_bits <= s->hash_bits && s->level ? fixedlen : storelen) +
  ------------------
  |  Branch (898:17): [True: 0, False: 0]
  |  Branch (898:46): [True: 0, False: 0]
  ------------------
  899|      0|               wraplen;
  900|       |
  901|       |    /* default settings: return tight bound for that case -- ~0.03% overhead
  902|       |       plus a small constant */
  903|      0|    return sourceLen + (sourceLen >> 12) + (sourceLen >> 14) +
  904|      0|           (sourceLen >> 25) + 13 - 6 + wraplen;
  905|      0|}
  906|       |
  907|       |/* =========================================================================
  908|       | * Put a short in the pending buffer. The 16-bit value is put in MSB order.
  909|       | * IN assertion: the stream state is correct and there is enough room in
  910|       | * pending_buf.
  911|       | */
  912|   789k|local void putShortMSB(deflate_state *s, uInt b) {
  913|   789k|    put_byte(s, (Byte)(b >> 8));
  914|   789k|    put_byte(s, (Byte)(b & 0xff));
  915|   789k|}
  916|       |
  917|       |/* =========================================================================
  918|       | * Flush as much pending output as possible. All deflate() output, except for
  919|       | * some deflate_stored() output, goes through this function so some
  920|       | * applications may wish to modify it to avoid allocating a large
  921|       | * strm->next_out buffer and copying into it. (See also read_buf()).
  922|       | */
  923|   789k|local void flush_pending(z_streamp strm) {
  924|   789k|    unsigned len;
  925|   789k|    deflate_state *s = strm->state;
  926|       |
  927|   789k|    _tr_flush_bits(s);
  928|   789k|    len = s->pending;
  929|   789k|    if (len > strm->avail_out) len = strm->avail_out;
                                             ^0
  ------------------
  |  Branch (929:9): [True: 0, False: 789k]
  ------------------
  930|   789k|    if (len == 0) return;
                                ^0
  ------------------
  |  Branch (930:9): [True: 0, False: 789k]
  ------------------
  931|       |
  932|   789k|    zmemcpy(strm->next_out, s->pending_out, len);
  933|   789k|    strm->next_out  += len;
  934|   789k|    s->pending_out  += len;
  935|   789k|    strm->total_out += len;
  936|   789k|    strm->avail_out -= len;
  937|   789k|    s->pending      -= len;
  938|   789k|    if (s->pending == 0) {
  ------------------
  |  Branch (938:9): [True: 789k, False: 0]
  ------------------
  939|   789k|        s->pending_out = s->pending_buf;
  940|   789k|    }
  941|   789k|}
  942|       |
  943|       |/* ===========================================================================
  944|       | * Update the header CRC with the bytes s->pending_buf[beg..s->pending - 1].
  945|       | */
  946|       |#define HCRC_UPDATE(beg) \
  947|      0|    do { \
  948|      0|        if (s->gzhead->hcrc && s->pending > (beg)) \
  949|      0|            strm->adler = crc32(strm->adler, s->pending_buf + (beg), \
  950|      0|                                s->pending - (beg)); \
  951|      0|    } while (0)
  952|       |
  953|       |/* ========================================================================= */
  954|   263k|int ZEXPORT deflate(z_streamp strm, int flush) {
  955|   263k|    int old_flush; /* value of flush param for previous deflate call */
  956|   263k|    deflate_state *s;
  957|       |
  958|   263k|    if (deflateStateCheck(strm) || flush > Z_BLOCK || flush < 0) {
  ------------------
  |  Branch (958:9): [True: 0, False: 263k]
  |  Branch (958:36): [True: 0, False: 263k]
  |  Branch (958:55): [True: 0, False: 263k]
  ------------------
  959|      0|        return Z_STREAM_ERROR;
  960|      0|    }
  961|   263k|    s = strm->state;
  962|       |
  963|   263k|    if (strm->next_out == Z_NULL ||
  ------------------
  |  Branch (963:9): [True: 0, False: 263k]
  ------------------
  964|   263k|        (strm->avail_in != 0 && strm->next_in == Z_NULL) ||
  ------------------
  |  Branch (964:10): [True: 263k, False: 0]
  |  Branch (964:33): [True: 0, False: 263k]
  ------------------
  965|   263k|        (s->status == FINISH_STATE && flush != Z_FINISH)) {
                                                    ^0       ^0
  ------------------
  |  Branch (965:10): [True: 0, False: 263k]
  |  Branch (965:39): [True: 0, False: 0]
  ------------------
  966|      0|        ERR_RETURN(strm, Z_STREAM_ERROR);
  967|      0|    }
  968|   263k|    if (strm->avail_out == 0) ERR_RETURN(strm, Z_BUF_ERROR);
                                            ^0
  ------------------
  |  Branch (968:9): [True: 0, False: 263k]
  ------------------
  969|       |
  970|   263k|    old_flush = s->last_flush;
  971|   263k|    s->last_flush = flush;
  972|       |
  973|       |    /* Flush as much pending output as possible */
  974|   263k|    if (s->pending != 0) {
  ------------------
  |  Branch (974:9): [True: 0, False: 263k]
  ------------------
  975|      0|        flush_pending(strm);
  976|      0|        if (strm->avail_out == 0) {
  ------------------
  |  Branch (976:13): [True: 0, False: 0]
  ------------------
  977|       |            /* Since avail_out is 0, deflate will be called again with
  978|       |             * more output space, but possibly with both pending and
  979|       |             * avail_in equal to zero. There won't be anything to do,
  980|       |             * but this is not an error situation so make sure we
  981|       |             * return OK instead of BUF_ERROR at next call of deflate:
  982|       |             */
  983|      0|            s->last_flush = -1;
  984|      0|            return Z_OK;
  985|      0|        }
  986|       |
  987|       |    /* Make sure there is something to do and avoid duplicate consecutive
  988|       |     * flushes. For repeated and useless calls with Z_FINISH, we keep
  989|       |     * returning Z_STREAM_END instead of Z_BUF_ERROR.
  990|       |     */
  991|   263k|    } else if (strm->avail_in == 0 && RANK(flush) <= RANK(old_flush) &&
                                                    ^0  ^0         ^0
  ------------------
  |  Branch (991:16): [True: 0, False: 263k]
  |  Branch (991:39): [True: 0, False: 0]
  ------------------
  992|   263k|               flush != Z_FINISH) {
                             ^0       ^0
  ------------------
  |  Branch (992:16): [True: 0, False: 0]
  ------------------
  993|      0|        ERR_RETURN(strm, Z_BUF_ERROR);
  994|      0|    }
  995|       |
  996|       |    /* User must not provide more input after the first FINISH: */
  997|   263k|    if (s->status == FINISH_STATE && strm->avail_in != 0) {
                                                   ^0
  ------------------
  |  Branch (997:9): [True: 0, False: 263k]
  |  Branch (997:38): [True: 0, False: 0]
  ------------------
  998|      0|        ERR_RETURN(strm, Z_BUF_ERROR);
  999|      0|    }
 1000|       |
 1001|       |    /* Write the header */
 1002|   263k|    if (s->status == INIT_STATE && s->wrap == 0)
  ------------------
  |  Branch (1002:9): [True: 263k, False: 0]
  |  Branch (1002:36): [True: 0, False: 263k]
  ------------------
 1003|      0|        s->status = BUSY_STATE;
 1004|   263k|    if (s->status == INIT_STATE) {
  ------------------
  |  Branch (1004:9): [True: 263k, False: 0]
  ------------------
 1005|       |        /* zlib header */
 1006|   263k|        uInt header = (Z_DEFLATED + ((s->w_bits - 8) << 4)) << 8;
 1007|   263k|        uInt level_flags;
 1008|       |
 1009|   263k|        if (s->strategy >= Z_HUFFMAN_ONLY || s->level < 2)
  ------------------
  |  Branch (1009:13): [True: 0, False: 263k]
  |  Branch (1009:46): [True: 20.2k, False: 242k]
  ------------------
 1010|  20.2k|            level_flags = 0;
 1011|   242k|        else if (s->level < 6)
  ------------------
  |  Branch (1011:18): [True: 134k, False: 108k]
  ------------------
 1012|   134k|            level_flags = 1;
 1013|   108k|        else if (s->level == 6)
  ------------------
  |  Branch (1013:18): [True: 96.6k, False: 11.8k]
  ------------------
 1014|  96.6k|            level_flags = 2;
 1015|  11.8k|        else
 1016|  11.8k|            level_flags = 3;
 1017|   263k|        header |= (level_flags << 6);
 1018|   263k|        if (s->strstart != 0) header |= PRESET_DICT;
                                            ^0        ^0
  ------------------
  |  Branch (1018:13): [True: 0, False: 263k]
  ------------------
 1019|   263k|        header += 31 - (header % 31);
 1020|       |
 1021|   263k|        putShortMSB(s, header);
 1022|       |
 1023|       |        /* Save the adler32 of the preset dictionary: */
 1024|   263k|        if (s->strstart != 0) {
  ------------------
  |  Branch (1024:13): [True: 0, False: 263k]
  ------------------
 1025|      0|            putShortMSB(s, (uInt)(strm->adler >> 16));
 1026|      0|            putShortMSB(s, (uInt)(strm->adler & 0xffff));
 1027|      0|        }
 1028|   263k|        strm->adler = adler32(0L, Z_NULL, 0);
 1029|   263k|        s->status = BUSY_STATE;
 1030|       |
 1031|       |        /* Compression must start with an empty pending buffer */
 1032|   263k|        flush_pending(strm);
 1033|   263k|        if (s->pending != 0) {
  ------------------
  |  Branch (1033:13): [True: 0, False: 263k]
  ------------------
 1034|      0|            s->last_flush = -1;
 1035|      0|            return Z_OK;
 1036|      0|        }
 1037|   263k|    }
 1038|   263k|#ifdef GZIP
 1039|   263k|    if (s->status == GZIP_STATE) {
  ------------------
  |  Branch (1039:9): [True: 0, False: 263k]
  ------------------
 1040|       |        /* gzip header */
 1041|      0|        strm->adler = crc32(0L, Z_NULL, 0);
 1042|      0|        put_byte(s, 31);
 1043|      0|        put_byte(s, 139);
 1044|      0|        put_byte(s, 8);
 1045|      0|        if (s->gzhead == Z_NULL) {
  ------------------
  |  Branch (1045:13): [True: 0, False: 0]
  ------------------
 1046|      0|            put_byte(s, 0);
 1047|      0|            put_byte(s, 0);
 1048|      0|            put_byte(s, 0);
 1049|      0|            put_byte(s, 0);
 1050|      0|            put_byte(s, 0);
 1051|      0|            put_byte(s, s->level == 9 ? 2 :
 1052|      0|                     (s->strategy >= Z_HUFFMAN_ONLY || s->level < 2 ?
 1053|      0|                      4 : 0));
 1054|      0|            put_byte(s, OS_CODE);
 1055|      0|            s->status = BUSY_STATE;
 1056|       |
 1057|       |            /* Compression must start with an empty pending buffer */
 1058|      0|            flush_pending(strm);
 1059|      0|            if (s->pending != 0) {
  ------------------
  |  Branch (1059:17): [True: 0, False: 0]
  ------------------
 1060|      0|                s->last_flush = -1;
 1061|      0|                return Z_OK;
 1062|      0|            }
 1063|      0|        }
 1064|      0|        else {
 1065|      0|            put_byte(s, (s->gzhead->text ? 1 : 0) +
 1066|      0|                     (s->gzhead->hcrc ? 2 : 0) +
 1067|      0|                     (s->gzhead->extra == Z_NULL ? 0 : 4) +
 1068|      0|                     (s->gzhead->name == Z_NULL ? 0 : 8) +
 1069|      0|                     (s->gzhead->comment == Z_NULL ? 0 : 16)
 1070|      0|                     );
 1071|      0|            put_byte(s, (Byte)(s->gzhead->time & 0xff));
 1072|      0|            put_byte(s, (Byte)((s->gzhead->time >> 8) & 0xff));
 1073|      0|            put_byte(s, (Byte)((s->gzhead->time >> 16) & 0xff));
 1074|      0|            put_byte(s, (Byte)((s->gzhead->time >> 24) & 0xff));
 1075|      0|            put_byte(s, s->level == 9 ? 2 :
 1076|      0|                     (s->strategy >= Z_HUFFMAN_ONLY || s->level < 2 ?
 1077|      0|                      4 : 0));
 1078|      0|            put_byte(s, s->gzhead->os & 0xff);
 1079|      0|            if (s->gzhead->extra != Z_NULL) {
  ------------------
  |  Branch (1079:17): [True: 0, False: 0]
  ------------------
 1080|      0|                put_byte(s, s->gzhead->extra_len & 0xff);
 1081|      0|                put_byte(s, (s->gzhead->extra_len >> 8) & 0xff);
 1082|      0|            }
 1083|      0|            if (s->gzhead->hcrc)
  ------------------
  |  Branch (1083:17): [True: 0, False: 0]
  ------------------
 1084|      0|                strm->adler = crc32(strm->adler, s->pending_buf,
 1085|      0|                                    s->pending);
 1086|      0|            s->gzindex = 0;
 1087|      0|            s->status = EXTRA_STATE;
 1088|      0|        }
 1089|      0|    }
 1090|   263k|    if (s->status == EXTRA_STATE) {
  ------------------
  |  Branch (1090:9): [True: 0, False: 263k]
  ------------------
 1091|      0|        if (s->gzhead->extra != Z_NULL) {
  ------------------
  |  Branch (1091:13): [True: 0, False: 0]
  ------------------
 1092|      0|            ulg beg = s->pending;   /* start of bytes to update crc */
 1093|      0|            uInt left = (s->gzhead->extra_len & 0xffff) - s->gzindex;
 1094|      0|            while (s->pending + left > s->pending_buf_size) {
  ------------------
  |  Branch (1094:20): [True: 0, False: 0]
  ------------------
 1095|      0|                uInt copy = s->pending_buf_size - s->pending;
 1096|      0|                zmemcpy(s->pending_buf + s->pending,
 1097|      0|                        s->gzhead->extra + s->gzindex, copy);
 1098|      0|                s->pending = s->pending_buf_size;
 1099|      0|                HCRC_UPDATE(beg);
 1100|      0|                s->gzindex += copy;
 1101|      0|                flush_pending(strm);
 1102|      0|                if (s->pending != 0) {
  ------------------
  |  Branch (1102:21): [True: 0, False: 0]
  ------------------
 1103|      0|                    s->last_flush = -1;
 1104|      0|                    return Z_OK;
 1105|      0|                }
 1106|      0|                beg = 0;
 1107|      0|                left -= copy;
 1108|      0|            }
 1109|      0|            zmemcpy(s->pending_buf + s->pending,
 1110|      0|                    s->gzhead->extra + s->gzindex, left);
 1111|      0|            s->pending += left;
 1112|      0|            HCRC_UPDATE(beg);
 1113|      0|            s->gzindex = 0;
 1114|      0|        }
 1115|      0|        s->status = NAME_STATE;
 1116|      0|    }
 1117|   263k|    if (s->status == NAME_STATE) {
  ------------------
  |  Branch (1117:9): [True: 0, False: 263k]
  ------------------
 1118|      0|        if (s->gzhead->name != Z_NULL) {
  ------------------
  |  Branch (1118:13): [True: 0, False: 0]
  ------------------
 1119|      0|            ulg beg = s->pending;   /* start of bytes to update crc */
 1120|      0|            int val;
 1121|      0|            do {
 1122|      0|                if (s->pending == s->pending_buf_size) {
  ------------------
  |  Branch (1122:21): [True: 0, False: 0]
  ------------------
 1123|      0|                    HCRC_UPDATE(beg);
 1124|      0|                    flush_pending(strm);
 1125|      0|                    if (s->pending != 0) {
  ------------------
  |  Branch (1125:25): [True: 0, False: 0]
  ------------------
 1126|      0|                        s->last_flush = -1;
 1127|      0|                        return Z_OK;
 1128|      0|                    }
 1129|      0|                    beg = 0;
 1130|      0|                }
 1131|      0|                val = s->gzhead->name[s->gzindex++];
 1132|      0|                put_byte(s, val);
 1133|      0|            } while (val != 0);
  ------------------
  |  Branch (1133:22): [True: 0, False: 0]
  ------------------
 1134|      0|            HCRC_UPDATE(beg);
 1135|      0|            s->gzindex = 0;
 1136|      0|        }
 1137|      0|        s->status = COMMENT_STATE;
 1138|      0|    }
 1139|   263k|    if (s->status == COMMENT_STATE) {
  ------------------
  |  Branch (1139:9): [True: 0, False: 263k]
  ------------------
 1140|      0|        if (s->gzhead->comment != Z_NULL) {
  ------------------
  |  Branch (1140:13): [True: 0, False: 0]
  ------------------
 1141|      0|            ulg beg = s->pending;   /* start of bytes to update crc */
 1142|      0|            int val;
 1143|      0|            do {
 1144|      0|                if (s->pending == s->pending_buf_size) {
  ------------------
  |  Branch (1144:21): [True: 0, False: 0]
  ------------------
 1145|      0|                    HCRC_UPDATE(beg);
 1146|      0|                    flush_pending(strm);
 1147|      0|                    if (s->pending != 0) {
  ------------------
  |  Branch (1147:25): [True: 0, False: 0]
  ------------------
 1148|      0|                        s->last_flush = -1;
 1149|      0|                        return Z_OK;
 1150|      0|                    }
 1151|      0|                    beg = 0;
 1152|      0|                }
 1153|      0|                val = s->gzhead->comment[s->gzindex++];
 1154|      0|                put_byte(s, val);
 1155|      0|            } while (val != 0);
  ------------------
  |  Branch (1155:22): [True: 0, False: 0]
  ------------------
 1156|      0|            HCRC_UPDATE(beg);
 1157|      0|        }
 1158|      0|        s->status = HCRC_STATE;
 1159|      0|    }
 1160|   263k|    if (s->status == HCRC_STATE) {
  ------------------
  |  Branch (1160:9): [True: 0, False: 263k]
  ------------------
 1161|      0|        if (s->gzhead->hcrc) {
  ------------------
  |  Branch (1161:13): [True: 0, False: 0]
  ------------------
 1162|      0|            if (s->pending + 2 > s->pending_buf_size) {
  ------------------
  |  Branch (1162:17): [True: 0, False: 0]
  ------------------
 1163|      0|                flush_pending(strm);
 1164|      0|                if (s->pending != 0) {
  ------------------
  |  Branch (1164:21): [True: 0, False: 0]
  ------------------
 1165|      0|                    s->last_flush = -1;
 1166|      0|                    return Z_OK;
 1167|      0|                }
 1168|      0|            }
 1169|      0|            put_byte(s, (Byte)(strm->adler & 0xff));
 1170|      0|            put_byte(s, (Byte)((strm->adler >> 8) & 0xff));
 1171|      0|            strm->adler = crc32(0L, Z_NULL, 0);
 1172|      0|        }
 1173|      0|        s->status = BUSY_STATE;
 1174|       |
 1175|       |        /* Compression must start with an empty pending buffer */
 1176|      0|        flush_pending(strm);
 1177|      0|        if (s->pending != 0) {
  ------------------
  |  Branch (1177:13): [True: 0, False: 0]
  ------------------
 1178|      0|            s->last_flush = -1;
 1179|      0|            return Z_OK;
 1180|      0|        }
 1181|      0|    }
 1182|   263k|#endif
 1183|       |
 1184|       |    /* Start a new block or continue the current one.
 1185|       |     */
 1186|   263k|    if (strm->avail_in != 0 || s->lookahead != 0 ||
                                             ^0
  ------------------
  |  Branch (1186:9): [True: 263k, False: 0]
  |  Branch (1186:32): [True: 0, False: 0]
  ------------------
 1187|   263k|        (flush != Z_NO_FLUSH && s->status != FINISH_STATE)) {
                      ^0^0       ^0            ^0           ^0
  ------------------
  |  Branch (1187:10): [True: 0, False: 0]
  |  Branch (1187:33): [True: 0, False: 0]
  ------------------
 1188|   263k|        block_state bstate;
 1189|       |
 1190|   263k|        bstate = s->level == 0 ? deflate_stored(s, flush) :
                                               ^14.5k
  ------------------
  |  Branch (1190:18): [True: 14.5k, False: 248k]
  ------------------
 1191|   263k|                 s->strategy == Z_HUFFMAN_ONLY ? deflate_huff(s, flush) :
                               ^248k          ^248k            ^0
  ------------------
  |  Branch (1191:18): [True: 0, False: 248k]
  ------------------
 1192|   248k|                 s->strategy == Z_RLE ? deflate_rle(s, flush) :
                                                      ^0
  ------------------
  |  Branch (1192:18): [True: 0, False: 248k]
  ------------------
 1193|   248k|                 (*(configuration_table[s->level].func))(s, flush);
 1194|       |
 1195|   263k|        if (bstate == finish_started || bstate == finish_done) {
  ------------------
  |  Branch (1195:13): [True: 0, False: 263k]
  |  Branch (1195:41): [True: 263k, False: 0]
  ------------------
 1196|   263k|            s->status = FINISH_STATE;
 1197|   263k|        }
 1198|   263k|        if (bstate == need_more || bstate == finish_started) {
  ------------------
  |  Branch (1198:13): [True: 0, False: 263k]
  |  Branch (1198:36): [True: 0, False: 263k]
  ------------------
 1199|      0|            if (strm->avail_out == 0) {
  ------------------
  |  Branch (1199:17): [True: 0, False: 0]
  ------------------
 1200|      0|                s->last_flush = -1; /* avoid BUF_ERROR next call, see above */
 1201|      0|            }
 1202|      0|            return Z_OK;
 1203|       |            /* If flush != Z_NO_FLUSH && avail_out == 0, the next call
 1204|       |             * of deflate should use the same flush parameter to make sure
 1205|       |             * that the flush is complete. So we don't have to output an
 1206|       |             * empty block here, this will be done at next call. This also
 1207|       |             * ensures that for a very small output buffer, we emit at most
 1208|       |             * one empty block.
 1209|       |             */
 1210|      0|        }
 1211|   263k|        if (bstate == block_done) {
  ------------------
  |  Branch (1211:13): [True: 0, False: 263k]
  ------------------
 1212|      0|            if (flush == Z_PARTIAL_FLUSH) {
  ------------------
  |  Branch (1212:17): [True: 0, False: 0]
  ------------------
 1213|      0|                _tr_align(s);
 1214|      0|            } else if (flush != Z_BLOCK) { /* FULL_FLUSH or SYNC_FLUSH */
  ------------------
  |  Branch (1214:24): [True: 0, False: 0]
  ------------------
 1215|      0|                _tr_stored_block(s, (char*)0, 0L, 0);
 1216|       |                /* For a full flush, this empty block will be recognized
 1217|       |                 * as a special marker by inflate_sync().
 1218|       |                 */
 1219|      0|                if (flush == Z_FULL_FLUSH) {
  ------------------
  |  Branch (1219:21): [True: 0, False: 0]
  ------------------
 1220|      0|                    CLEAR_HASH(s);             /* forget history */
 1221|      0|                    if (s->lookahead == 0) {
  ------------------
  |  Branch (1221:25): [True: 0, False: 0]
  ------------------
 1222|      0|                        s->strstart = 0;
 1223|      0|                        s->block_start = 0L;
 1224|      0|                        s->insert = 0;
 1225|      0|                    }
 1226|      0|                }
 1227|      0|            }
 1228|      0|            flush_pending(strm);
 1229|      0|            if (strm->avail_out == 0) {
  ------------------
  |  Branch (1229:17): [True: 0, False: 0]
  ------------------
 1230|      0|              s->last_flush = -1; /* avoid BUF_ERROR at next call, see above */
 1231|      0|              return Z_OK;
 1232|      0|            }
 1233|      0|        }
 1234|   263k|    }
 1235|       |
 1236|   263k|    if (flush != Z_FINISH) return Z_OK;
                                         ^0     ^0
  ------------------
  |  Branch (1236:9): [True: 0, False: 263k]
  ------------------
 1237|   263k|    if (s->wrap <= 0) return Z_STREAM_END;
                                    ^0     ^0
  ------------------
  |  Branch (1237:9): [True: 0, False: 263k]
  ------------------
 1238|       |
 1239|       |    /* Write the trailer */
 1240|   263k|#ifdef GZIP
 1241|   263k|    if (s->wrap == 2) {
  ------------------
  |  Branch (1241:9): [True: 0, False: 263k]
  ------------------
 1242|      0|        put_byte(s, (Byte)(strm->adler & 0xff));
 1243|      0|        put_byte(s, (Byte)((strm->adler >> 8) & 0xff));
 1244|      0|        put_byte(s, (Byte)((strm->adler >> 16) & 0xff));
 1245|      0|        put_byte(s, (Byte)((strm->adler >> 24) & 0xff));
 1246|      0|        put_byte(s, (Byte)(strm->total_in & 0xff));
 1247|      0|        put_byte(s, (Byte)((strm->total_in >> 8) & 0xff));
 1248|      0|        put_byte(s, (Byte)((strm->total_in >> 16) & 0xff));
 1249|      0|        put_byte(s, (Byte)((strm->total_in >> 24) & 0xff));
 1250|      0|    }
 1251|   263k|    else
 1252|   263k|#endif
 1253|   263k|    {
 1254|   263k|        putShortMSB(s, (uInt)(strm->adler >> 16));
 1255|   263k|        putShortMSB(s, (uInt)(strm->adler & 0xffff));
 1256|   263k|    }
 1257|   263k|    flush_pending(strm);
 1258|       |    /* If avail_out is zero, the application will call deflate again
 1259|       |     * to flush the rest.
 1260|       |     */
 1261|   263k|    if (s->wrap > 0) s->wrap = -s->wrap; /* write the trailer only once! */
  ------------------
  |  Branch (1261:9): [True: 263k, False: 0]
  ------------------
 1262|   263k|    return s->pending != 0 ? Z_OK : Z_STREAM_END;
                                           ^0
  ------------------
  |  Branch (1262:12): [True: 0, False: 263k]
  ------------------
 1263|   263k|}
 1264|       |
 1265|       |/* ========================================================================= */
 1266|   263k|int ZEXPORT deflateEnd(z_streamp strm) {
 1267|   263k|    int status;
 1268|       |
 1269|   263k|    if (deflateStateCheck(strm)) return Z_STREAM_ERROR;
                                               ^0     ^0
  ------------------
  |  Branch (1269:9): [True: 0, False: 263k]
  ------------------
 1270|       |
 1271|   263k|    status = strm->state->status;
 1272|       |
 1273|       |    /* Deallocate in reverse order of allocations: */
 1274|   263k|    TRY_FREE(strm, strm->state->pending_buf);
 1275|   263k|    TRY_FREE(strm, strm->state->head);
 1276|   263k|    TRY_FREE(strm, strm->state->prev);
 1277|   263k|    TRY_FREE(strm, strm->state->window);
 1278|       |
 1279|   263k|    ZFREE(strm, strm->state);
 1280|   263k|    strm->state = Z_NULL;
 1281|       |
 1282|   263k|    return status == BUSY_STATE ? Z_DATA_ERROR : Z_OK;
                                                ^0
  ------------------
  |  Branch (1282:12): [True: 0, False: 263k]
  ------------------
 1283|   263k|}
 1284|       |
 1285|       |/* =========================================================================
 1286|       | * Copy the source state to the destination state.
 1287|       | * To simplify the source, this is not supported for 16-bit MSDOS (which
 1288|       | * doesn't have enough memory anyway to duplicate compression states).
 1289|       | */
 1290|      0|int ZEXPORT deflateCopy(z_streamp dest, z_streamp source) {
 1291|       |#ifdef MAXSEG_64K
 1292|       |    (void)dest;
 1293|       |    (void)source;
 1294|       |    return Z_STREAM_ERROR;
 1295|       |#else
 1296|      0|    deflate_state *ds;
 1297|      0|    deflate_state *ss;
 1298|       |
 1299|       |
 1300|      0|    if (deflateStateCheck(source) || dest == Z_NULL) {
  ------------------
  |  Branch (1300:9): [True: 0, False: 0]
  |  Branch (1300:38): [True: 0, False: 0]
  ------------------
 1301|      0|        return Z_STREAM_ERROR;
 1302|      0|    }
 1303|       |
 1304|      0|    ss = source->state;
 1305|       |
 1306|      0|    zmemcpy((voidpf)dest, (voidpf)source, sizeof(z_stream));
 1307|       |
 1308|      0|    ds = (deflate_state *) ZALLOC(dest, 1, sizeof(deflate_state));
 1309|      0|    if (ds == Z_NULL) return Z_MEM_ERROR;
  ------------------
  |  Branch (1309:9): [True: 0, False: 0]
  ------------------
 1310|      0|    dest->state = (struct internal_state FAR *) ds;
 1311|      0|    zmemcpy((voidpf)ds, (voidpf)ss, sizeof(deflate_state));
 1312|      0|    ds->strm = dest;
 1313|       |
 1314|      0|    ds->window = (Bytef *) ZALLOC(dest, ds->w_size, 2*sizeof(Byte));
 1315|      0|    ds->prev   = (Posf *)  ZALLOC(dest, ds->w_size, sizeof(Pos));
 1316|      0|    ds->head   = (Posf *)  ZALLOC(dest, ds->hash_size, sizeof(Pos));
 1317|      0|    ds->pending_buf = (uchf *) ZALLOC(dest, ds->lit_bufsize, LIT_BUFS);
 1318|       |
 1319|      0|    if (ds->window == Z_NULL || ds->prev == Z_NULL || ds->head == Z_NULL ||
  ------------------
  |  Branch (1319:9): [True: 0, False: 0]
  |  Branch (1319:33): [True: 0, False: 0]
  |  Branch (1319:55): [True: 0, False: 0]
  ------------------
 1320|      0|        ds->pending_buf == Z_NULL) {
  ------------------
  |  Branch (1320:9): [True: 0, False: 0]
  ------------------
 1321|      0|        deflateEnd (dest);
 1322|      0|        return Z_MEM_ERROR;
 1323|      0|    }
 1324|       |    /* following zmemcpy do not work for 16-bit MSDOS */
 1325|      0|    zmemcpy(ds->window, ss->window, ds->w_size * 2 * sizeof(Byte));
 1326|      0|    zmemcpy((voidpf)ds->prev, (voidpf)ss->prev, ds->w_size * sizeof(Pos));
 1327|      0|    zmemcpy((voidpf)ds->head, (voidpf)ss->head, ds->hash_size * sizeof(Pos));
 1328|      0|    zmemcpy(ds->pending_buf, ss->pending_buf, ds->lit_bufsize * LIT_BUFS);
 1329|       |
 1330|      0|    ds->pending_out = ds->pending_buf + (ss->pending_out - ss->pending_buf);
 1331|       |#ifdef LIT_MEM
 1332|       |    ds->d_buf = (ushf *)(ds->pending_buf + (ds->lit_bufsize << 1));
 1333|       |    ds->l_buf = ds->pending_buf + (ds->lit_bufsize << 2);
 1334|       |#else
 1335|      0|    ds->sym_buf = ds->pending_buf + ds->lit_bufsize;
 1336|      0|#endif
 1337|       |
 1338|      0|    ds->l_desc.dyn_tree = ds->dyn_ltree;
 1339|      0|    ds->d_desc.dyn_tree = ds->dyn_dtree;
 1340|      0|    ds->bl_desc.dyn_tree = ds->bl_tree;
 1341|       |
 1342|      0|    return Z_OK;
 1343|      0|#endif /* MAXSEG_64K */
 1344|      0|}
 1345|       |
 1346|       |#ifndef FASTEST
 1347|       |/* ===========================================================================
 1348|       | * Set match_start to the longest match starting at the given string and
 1349|       | * return its length. Matches shorter or equal to prev_length are discarded,
 1350|       | * in which case the result is equal to prev_length and match_start is
 1351|       | * garbage.
 1352|       | * IN assertions: cur_match is the head of the hash chain for the current
 1353|       | *   string (strstart) and its distance is <= MAX_DIST, and prev_length >= 1
 1354|       | * OUT assertion: the match length is not greater than s->lookahead.
 1355|       | */
 1356|   501k|local uInt longest_match(deflate_state *s, IPos cur_match) {
 1357|   501k|    unsigned chain_length = s->max_chain_length;/* max hash chain length */
 1358|   501k|    register Bytef *scan = s->window + s->strstart; /* current string */
 1359|   501k|    register Bytef *match;                      /* matched string */
 1360|   501k|    register int len;                           /* length of current match */
 1361|   501k|    int best_len = (int)s->prev_length;         /* best match length so far */
 1362|   501k|    int nice_match = s->nice_match;             /* stop if match long enough */
 1363|   501k|    IPos limit = s->strstart > (IPos)MAX_DIST(s) ?
  ------------------
  |  Branch (1363:18): [True: 0, False: 501k]
  ------------------
 1364|   501k|        s->strstart - (IPos)MAX_DIST(s) : NIL;
                      ^0                  ^0
 1365|       |    /* Stop when cur_match becomes <= limit. To simplify the code,
 1366|       |     * we prevent matches with the string of window index 0.
 1367|       |     */
 1368|   501k|    Posf *prev = s->prev;
 1369|   501k|    uInt wmask = s->w_mask;
 1370|       |
 1371|       |#ifdef UNALIGNED_OK
 1372|       |    /* Compare two bytes at a time. Note: this is not always beneficial.
 1373|       |     * Try with and without -DUNALIGNED_OK to check.
 1374|       |     */
 1375|       |    register Bytef *strend = s->window + s->strstart + MAX_MATCH - 1;
 1376|       |    register ush scan_start = *(ushf*)scan;
 1377|       |    register ush scan_end   = *(ushf*)(scan + best_len - 1);
 1378|       |#else
 1379|   501k|    register Bytef *strend = s->window + s->strstart + MAX_MATCH;
 1380|   501k|    register Byte scan_end1  = scan[best_len - 1];
 1381|   501k|    register Byte scan_end   = scan[best_len];
 1382|   501k|#endif
 1383|       |
 1384|       |    /* The code is optimized for HASH_BITS >= 8 and MAX_MATCH-2 multiple of 16.
 1385|       |     * It is easy to get rid of this optimization if necessary.
 1386|       |     */
 1387|   501k|    Assert(s->hash_bits >= 8 && MAX_MATCH == 258, "Code too clever");
 1388|       |
 1389|       |    /* Do not waste too much time if we already have a good match: */
 1390|   501k|    if (s->prev_length >= s->good_match) {
  ------------------
  |  Branch (1390:9): [True: 29.0k, False: 472k]
  ------------------
 1391|  29.0k|        chain_length >>= 2;
 1392|  29.0k|    }
 1393|       |    /* Do not look for matches beyond the end of the input. This is necessary
 1394|       |     * to make deflate deterministic.
 1395|       |     */
 1396|   501k|    if ((uInt)nice_match > s->lookahead) nice_match = (int)s->lookahead;
                                                       ^359k
  ------------------
  |  Branch (1396:9): [True: 359k, False: 142k]
  ------------------
 1397|       |
 1398|   501k|    Assert((ulg)s->strstart <= s->window_size - MIN_LOOKAHEAD,
 1399|   501k|           "need lookahead");
 1400|       |
 1401|  2.75M|    do {
 1402|  2.75M|        Assert(cur_match < s->strstart, "no future");
 1403|  2.75M|        match = s->window + cur_match;
 1404|       |
 1405|       |        /* Skip to next match if the match length cannot increase
 1406|       |         * or if the match length is less than 2.  Note that the checks below
 1407|       |         * for insufficient lookahead only occur occasionally for performance
 1408|       |         * reasons.  Therefore uninitialized memory will be accessed, and
 1409|       |         * conditional jumps will be made that depend on those values.
 1410|       |         * However the length of the match is limited to the lookahead, so
 1411|       |         * the output of deflate is not affected by the uninitialized values.
 1412|       |         */
 1413|       |#if (defined(UNALIGNED_OK) && MAX_MATCH == 258)
 1414|       |        /* This code assumes sizeof(unsigned short) == 2. Do not use
 1415|       |         * UNALIGNED_OK if your compiler uses a different size.
 1416|       |         */
 1417|       |        if (*(ushf*)(match + best_len - 1) != scan_end ||
 1418|       |            *(ushf*)match != scan_start) continue;
 1419|       |
 1420|       |        /* It is not necessary to compare scan[2] and match[2] since they are
 1421|       |         * always equal when the other bytes match, given that the hash keys
 1422|       |         * are equal and that HASH_BITS >= 8. Compare 2 bytes at a time at
 1423|       |         * strstart + 3, + 5, up to strstart + 257. We check for insufficient
 1424|       |         * lookahead only every 4th comparison; the 128th check will be made
 1425|       |         * at strstart + 257. If MAX_MATCH-2 is not a multiple of 8, it is
 1426|       |         * necessary to put more guard bytes at the end of the window, or
 1427|       |         * to check more often for insufficient lookahead.
 1428|       |         */
 1429|       |        Assert(scan[2] == match[2], "scan[2]?");
 1430|       |        scan++, match++;
 1431|       |        do {
 1432|       |        } while (*(ushf*)(scan += 2) == *(ushf*)(match += 2) &&
 1433|       |                 *(ushf*)(scan += 2) == *(ushf*)(match += 2) &&
 1434|       |                 *(ushf*)(scan += 2) == *(ushf*)(match += 2) &&
 1435|       |                 *(ushf*)(scan += 2) == *(ushf*)(match += 2) &&
 1436|       |                 scan < strend);
 1437|       |        /* The funny "do {}" generates better code on most compilers */
 1438|       |
 1439|       |        /* Here, scan <= window + strstart + 257 */
 1440|       |        Assert(scan <= s->window + (unsigned)(s->window_size - 1),
 1441|       |               "wild scan");
 1442|       |        if (*scan == *match) scan++;
 1443|       |
 1444|       |        len = (MAX_MATCH - 1) - (int)(strend - scan);
 1445|       |        scan = strend - (MAX_MATCH-1);
 1446|       |
 1447|       |#else /* UNALIGNED_OK */
 1448|       |
 1449|  2.75M|        if (match[best_len]     != scan_end  ||
  ------------------
  |  Branch (1449:13): [True: 1.40M, False: 1.34M]
  ------------------
 1450|  2.75M|            match[best_len - 1] != scan_end1 ||
                          ^1.34M
  ------------------
  |  Branch (1450:13): [True: 137k, False: 1.20M]
  ------------------
 1451|  2.75M|            *match              != *scan     ||
                          ^1.20M
  ------------------
  |  Branch (1451:13): [True: 154k, False: 1.05M]
  ------------------
 1452|  2.75M|            *++match            != scan[1])      continue;
                          ^1.05M                               ^1.70M
  ------------------
  |  Branch (1452:13): [True: 1, False: 1.05M]
  ------------------
 1453|       |
 1454|       |        /* The check at best_len - 1 can be removed because it will be made
 1455|       |         * again later. (This heuristic is not always a win.)
 1456|       |         * It is not necessary to compare scan[2] and match[2] since they
 1457|       |         * are always equal when the other bytes match, given that
 1458|       |         * the hash keys are equal and that HASH_BITS >= 8.
 1459|       |         */
 1460|  1.05M|        scan += 2, match++;
 1461|  1.05M|        Assert(*scan == *match, "match[2]?");
 1462|       |
 1463|       |        /* We check for insufficient lookahead only every 8th comparison;
 1464|       |         * the 256th check will be made at strstart + 258.
 1465|       |         */
 1466|  2.48M|        do {
 1467|  2.48M|        } while (*++scan == *++match && *++scan == *++match &&
                                                      ^2.27M
  ------------------
  |  Branch (1467:18): [True: 2.27M, False: 208k]
  |  Branch (1467:41): [True: 2.09M, False: 179k]
  ------------------
 1468|  2.48M|                 *++scan == *++match && *++scan == *++match &&
                               ^2.09M                 ^1.94M
  ------------------
  |  Branch (1468:18): [True: 1.94M, False: 146k]
  |  Branch (1468:41): [True: 1.81M, False: 130k]
  ------------------
 1469|  2.48M|                 *++scan == *++match && *++scan == *++match &&
                               ^1.81M                 ^1.70M
  ------------------
  |  Branch (1469:18): [True: 1.70M, False: 113k]
  |  Branch (1469:41): [True: 1.59M, False: 104k]
  ------------------
 1470|  2.48M|                 *++scan == *++match && *++scan == *++match &&
                               ^1.59M                 ^1.51M
  ------------------
  |  Branch (1470:18): [True: 1.51M, False: 84.0k]
  |  Branch (1470:41): [True: 1.43M, False: 78.5k]
  ------------------
 1471|  2.48M|                 scan < strend);
                               ^1.43M
  ------------------
  |  Branch (1471:18): [True: 1.43M, False: 7.10k]
  ------------------
 1472|       |
 1473|  1.05M|        Assert(scan <= s->window + (unsigned)(s->window_size - 1),
 1474|  1.05M|               "wild scan");
 1475|       |
 1476|  1.05M|        len = MAX_MATCH - (int)(strend - scan);
 1477|  1.05M|        scan = strend - MAX_MATCH;
 1478|       |
 1479|  1.05M|#endif /* UNALIGNED_OK */
 1480|       |
 1481|  1.05M|        if (len > best_len) {
  ------------------
  |  Branch (1481:13): [True: 1.01M, False: 42.5k]
  ------------------
 1482|  1.01M|            s->match_start = cur_match;
 1483|  1.01M|            best_len = len;
 1484|  1.01M|            if (len >= nice_match) break;
                                                 ^110k
  ------------------
  |  Branch (1484:17): [True: 110k, False: 900k]
  ------------------
 1485|       |#ifdef UNALIGNED_OK
 1486|       |            scan_end = *(ushf*)(scan + best_len - 1);
 1487|       |#else
 1488|   900k|            scan_end1  = scan[best_len - 1];
 1489|   900k|            scan_end   = scan[best_len];
 1490|   900k|#endif
 1491|   900k|        }
 1492|  2.64M|    } while ((cur_match = prev[cur_match & wmask]) > limit
  ------------------
  |  Branch (1492:14): [True: 2.27M, False: 370k]
  ------------------
 1493|  2.64M|             && --chain_length != 0);
                              ^2.27M
  ------------------
  |  Branch (1493:17): [True: 2.25M, False: 21.0k]
  ------------------
 1494|       |
 1495|   501k|    if ((uInt)best_len <= s->lookahead) return (uInt)best_len;
                                                      ^486k
  ------------------
  |  Branch (1495:9): [True: 486k, False: 15.4k]
  ------------------
 1496|  15.4k|    return s->lookahead;
 1497|   501k|}
 1498|       |
 1499|       |#else /* FASTEST */
 1500|       |
 1501|       |/* ---------------------------------------------------------------------------
 1502|       | * Optimized version for FASTEST only
 1503|       | */
 1504|       |local uInt longest_match(deflate_state *s, IPos cur_match) {
 1505|       |    register Bytef *scan = s->window + s->strstart; /* current string */
 1506|       |    register Bytef *match;                       /* matched string */
 1507|       |    register int len;                           /* length of current match */
 1508|       |    register Bytef *strend = s->window + s->strstart + MAX_MATCH;
 1509|       |
 1510|       |    /* The code is optimized for HASH_BITS >= 8 and MAX_MATCH-2 multiple of 16.
 1511|       |     * It is easy to get rid of this optimization if necessary.
 1512|       |     */
 1513|       |    Assert(s->hash_bits >= 8 && MAX_MATCH == 258, "Code too clever");
 1514|       |
 1515|       |    Assert((ulg)s->strstart <= s->window_size - MIN_LOOKAHEAD,
 1516|       |           "need lookahead");
 1517|       |
 1518|       |    Assert(cur_match < s->strstart, "no future");
 1519|       |
 1520|       |    match = s->window + cur_match;
 1521|       |
 1522|       |    /* Return failure if the match length is less than 2:
 1523|       |     */
 1524|       |    if (match[0] != scan[0] || match[1] != scan[1]) return MIN_MATCH-1;
 1525|       |
 1526|       |    /* The check at best_len - 1 can be removed because it will be made
 1527|       |     * again later. (This heuristic is not always a win.)
 1528|       |     * It is not necessary to compare scan[2] and match[2] since they
 1529|       |     * are always equal when the other bytes match, given that
 1530|       |     * the hash keys are equal and that HASH_BITS >= 8.
 1531|       |     */
 1532|       |    scan += 2, match += 2;
 1533|       |    Assert(*scan == *match, "match[2]?");
 1534|       |
 1535|       |    /* We check for insufficient lookahead only every 8th comparison;
 1536|       |     * the 256th check will be made at strstart + 258.
 1537|       |     */
 1538|       |    do {
 1539|       |    } while (*++scan == *++match && *++scan == *++match &&
 1540|       |             *++scan == *++match && *++scan == *++match &&
 1541|       |             *++scan == *++match && *++scan == *++match &&
 1542|       |             *++scan == *++match && *++scan == *++match &&
 1543|       |             scan < strend);
 1544|       |
 1545|       |    Assert(scan <= s->window + (unsigned)(s->window_size - 1), "wild scan");
 1546|       |
 1547|       |    len = MAX_MATCH - (int)(strend - scan);
 1548|       |
 1549|       |    if (len < MIN_MATCH) return MIN_MATCH - 1;
 1550|       |
 1551|       |    s->match_start = cur_match;
 1552|       |    return (uInt)len <= s->lookahead ? (uInt)len : s->lookahead;
 1553|       |}
 1554|       |
 1555|       |#endif /* FASTEST */
 1556|       |
 1557|       |#ifdef ZLIB_DEBUG
 1558|       |
 1559|       |#define EQUAL 0
 1560|       |/* result of memcmp for equal strings */
 1561|       |
 1562|       |/* ===========================================================================
 1563|       | * Check that the match at match_start is indeed a match.
 1564|       | */
 1565|       |local void check_match(deflate_state *s, IPos start, IPos match, int length) {
 1566|       |    /* check that the match is indeed a match */
 1567|       |    Bytef *back = s->window + (int)match, *here = s->window + start;
 1568|       |    IPos len = length;
 1569|       |    if (match == (IPos)-1) {
 1570|       |        /* match starts one byte before the current window -- just compare the
 1571|       |           subsequent length-1 bytes */
 1572|       |        back++;
 1573|       |        here++;
 1574|       |        len--;
 1575|       |    }
 1576|       |    if (zmemcmp(back, here, len) != EQUAL) {
 1577|       |        fprintf(stderr, " start %u, match %d, length %d\n",
 1578|       |                start, (int)match, length);
 1579|       |        do {
 1580|       |            fprintf(stderr, "(%02x %02x)", *back++, *here++);
 1581|       |        } while (--len != 0);
 1582|       |        z_error("invalid match");
 1583|       |    }
 1584|       |    if (z_verbose > 1) {
 1585|       |        fprintf(stderr,"\\[%d,%d]", start - match, length);
 1586|       |        do { putc(s->window[start++], stderr); } while (--length != 0);
 1587|       |    }
 1588|       |}
 1589|       |#else
 1590|       |#  define check_match(s, start, match, length)
 1591|       |#endif /* ZLIB_DEBUG */
 1592|       |
 1593|       |/* ===========================================================================
 1594|       | * Flush the current block, with given end-of-file flag.
 1595|       | * IN assertion: strstart is set to the end of the current match.
 1596|       | */
 1597|   248k|#define FLUSH_BLOCK_ONLY(s, last) { \
 1598|   248k|   _tr_flush_block(s, (s->block_start >= 0L ? \
 1599|   248k|                   (charf *)&s->window[(unsigned)s->block_start] : \
 1600|   248k|                   (charf *)Z_NULL), \
                                 ^0       ^0
 1601|   248k|                (ulg)((long)s->strstart - s->block_start), \
 1602|   248k|                (last)); \
 1603|   248k|   s->block_start = s->strstart; \
 1604|   248k|   flush_pending(s->strm); \
 1605|   248k|   Tracev((stderr,"[FLUSH]")); \
 1606|   248k|}
 1607|       |
 1608|       |/* Same but force premature exit if necessary. */
 1609|   248k|#define FLUSH_BLOCK(s, last) { \
 1610|   248k|   FLUSH_BLOCK_ONLY(s, last); \
 1611|   248k|   if (s->strm->avail_out == 0) return (last) ? finish_started : need_more; \
                                              ^0     ^0       ^0               ^0
 1612|   248k|}
 1613|       |
 1614|       |/* Maximum stored block length in deflate format (not including header). */
 1615|  14.5k|#define MAX_STORED 65535
 1616|       |
 1617|       |/* Minimum of a and b. */
 1618|  29.1k|#define MIN(a, b) ((a) > (b) ? (b) : (a))
                                             ^14.5k^14.5k
 1619|       |
 1620|       |/* ===========================================================================
 1621|       | * Copy without compression as much as possible from the input stream, return
 1622|       | * the current block state.
 1623|       | *
 1624|       | * In case deflateParams() is used to later switch to a non-zero compression
 1625|       | * level, s->matches (otherwise unused when storing) keeps track of the number
 1626|       | * of hash table slides to perform. If s->matches is 1, then one hash table
 1627|       | * slide will be done when switching. If s->matches is 2, the maximum value
 1628|       | * allowed here, then the hash table will be cleared, since two or more slides
 1629|       | * is the same as a clear.
 1630|       | *
 1631|       | * deflate_stored() is written to minimize the number of times an input byte is
 1632|       | * copied. It is most efficient with large input and output buffers, which
 1633|       | * maximizes the opportunities to have a single copy from next_in to next_out.
 1634|       | */
 1635|  14.5k|local block_state deflate_stored(deflate_state *s, int flush) {
 1636|       |    /* Smallest worthy block size when not flushing or finishing. By default
 1637|       |     * this is 32K. This can be as small as 507 bytes for memLevel == 1. For
 1638|       |     * large input and output buffers, the stored block size will be larger.
 1639|       |     */
 1640|  14.5k|    unsigned min_block = MIN(s->pending_buf_size - 5, s->w_size);
 1641|       |
 1642|       |    /* Copy as many min_block or larger stored blocks directly to next_out as
 1643|       |     * possible. If flushing, copy the remaining available input to next_out as
 1644|       |     * stored blocks, if there is enough space.
 1645|       |     */
 1646|  14.5k|    int last = 0;
 1647|  14.5k|    unsigned len, left, have;
 1648|  14.5k|    unsigned used = s->strm->avail_in;
 1649|  14.5k|    do {
 1650|       |        /* Set len to the maximum size block that we can copy directly with the
 1651|       |         * available input data and output space. Set left to how much of that
 1652|       |         * would be copied from what's left in the window.
 1653|       |         */
 1654|  14.5k|        len = MAX_STORED;       /* maximum deflate stored block length */
 1655|  14.5k|        have = (s->bi_valid + 42) >> 3;         /* number of header bytes */
 1656|  14.5k|        if (s->strm->avail_out < have)          /* need room for header */
  ------------------
  |  Branch (1656:13): [True: 0, False: 14.5k]
  ------------------
 1657|      0|            break;
 1658|       |            /* maximum stored block length that will fit in avail_out: */
 1659|  14.5k|        have = s->strm->avail_out - have;
 1660|  14.5k|        left = s->strstart - s->block_start;    /* bytes left in window */
 1661|  14.5k|        if (len > (ulg)left + s->strm->avail_in)
  ------------------
  |  Branch (1661:13): [True: 14.5k, False: 0]
  ------------------
 1662|  14.5k|            len = left + s->strm->avail_in;     /* limit len to the input */
 1663|  14.5k|        if (len > have)
  ------------------
  |  Branch (1663:13): [True: 0, False: 14.5k]
  ------------------
 1664|      0|            len = have;                         /* limit len to the output */
 1665|       |
 1666|       |        /* If the stored block would be less than min_block in length, or if
 1667|       |         * unable to copy all of the available input when flushing, then try
 1668|       |         * copying to the window and the pending buffer instead. Also don't
 1669|       |         * write an empty block when flushing -- deflate() does that.
 1670|       |         */
 1671|  14.5k|        if (len < min_block && ((len == 0 && flush != Z_FINISH) ||
                                                           ^0       ^0
  ------------------
  |  Branch (1671:13): [True: 14.5k, False: 0]
  |  Branch (1671:34): [True: 0, False: 14.5k]
  |  Branch (1671:46): [True: 0, False: 0]
  ------------------
 1672|  14.5k|                                flush == Z_NO_FLUSH ||
  ------------------
  |  Branch (1672:33): [True: 0, False: 14.5k]
  ------------------
 1673|  14.5k|                                len != left + s->strm->avail_in))
  ------------------
  |  Branch (1673:33): [True: 0, False: 14.5k]
  ------------------
 1674|      0|            break;
 1675|       |
 1676|       |        /* Make a dummy stored block in pending to get the header bytes,
 1677|       |         * including any pending bits. This also updates the debugging counts.
 1678|       |         */
 1679|  14.5k|        last = flush == Z_FINISH && len == left + s->strm->avail_in ? 1 : 0;
                                                                                        ^0
  ------------------
  |  Branch (1679:16): [True: 14.5k, False: 0]
  |  Branch (1679:37): [True: 14.5k, False: 0]
  ------------------
 1680|  14.5k|        _tr_stored_block(s, (char *)0, 0L, last);
 1681|       |
 1682|       |        /* Replace the lengths in the dummy stored block with len. */
 1683|  14.5k|        s->pending_buf[s->pending - 4] = (Bytef)len;
 1684|  14.5k|        s->pending_buf[s->pending - 3] = (Bytef)(len >> 8);
 1685|  14.5k|        s->pending_buf[s->pending - 2] = (Bytef)~len;
 1686|  14.5k|        s->pending_buf[s->pending - 1] = (Bytef)(~len >> 8);
 1687|       |
 1688|       |        /* Write the stored block header bytes. */
 1689|  14.5k|        flush_pending(s->strm);
 1690|       |
 1691|       |#ifdef ZLIB_DEBUG
 1692|       |        /* Update debugging counts for the data about to be copied. */
 1693|       |        s->compressed_len += len << 3;
 1694|       |        s->bits_sent += len << 3;
 1695|       |#endif
 1696|       |
 1697|       |        /* Copy uncompressed bytes from the window to next_out. */
 1698|  14.5k|        if (left) {
  ------------------
  |  Branch (1698:13): [True: 0, False: 14.5k]
  ------------------
 1699|      0|            if (left > len)
  ------------------
  |  Branch (1699:17): [True: 0, False: 0]
  ------------------
 1700|      0|                left = len;
 1701|      0|            zmemcpy(s->strm->next_out, s->window + s->block_start, left);
 1702|      0|            s->strm->next_out += left;
 1703|      0|            s->strm->avail_out -= left;
 1704|      0|            s->strm->total_out += left;
 1705|      0|            s->block_start += left;
 1706|      0|            len -= left;
 1707|      0|        }
 1708|       |
 1709|       |        /* Copy uncompressed bytes directly from next_in to next_out, updating
 1710|       |         * the check value.
 1711|       |         */
 1712|  14.5k|        if (len) {
  ------------------
  |  Branch (1712:13): [True: 14.5k, False: 0]
  ------------------
 1713|  14.5k|            read_buf(s->strm, s->strm->next_out, len);
 1714|  14.5k|            s->strm->next_out += len;
 1715|  14.5k|            s->strm->avail_out -= len;
 1716|  14.5k|            s->strm->total_out += len;
 1717|  14.5k|        }
 1718|  14.5k|    } while (last == 0);
  ------------------
  |  Branch (1718:14): [True: 0, False: 14.5k]
  ------------------
 1719|       |
 1720|       |    /* Update the sliding window with the last s->w_size bytes of the copied
 1721|       |     * data, or append all of the copied data to the existing window if less
 1722|       |     * than s->w_size bytes were copied. Also update the number of bytes to
 1723|       |     * insert in the hash tables, in the event that deflateParams() switches to
 1724|       |     * a non-zero compression level.
 1725|       |     */
 1726|      0|    used -= s->strm->avail_in;      /* number of input bytes directly copied */
 1727|  14.5k|    if (used) {
  ------------------
  |  Branch (1727:9): [True: 14.5k, False: 0]
  ------------------
 1728|       |        /* If any input was used, then no unused input remains in the window,
 1729|       |         * therefore s->block_start == s->strstart.
 1730|       |         */
 1731|  14.5k|        if (used >= s->w_size) {    /* supplant the previous history */
  ------------------
  |  Branch (1731:13): [True: 0, False: 14.5k]
  ------------------
 1732|      0|            s->matches = 2;         /* clear hash */
 1733|      0|            zmemcpy(s->window, s->strm->next_in - s->w_size, s->w_size);
 1734|      0|            s->strstart = s->w_size;
 1735|      0|            s->insert = s->strstart;
 1736|      0|        }
 1737|  14.5k|        else {
 1738|  14.5k|            if (s->window_size - s->strstart <= used) {
  ------------------
  |  Branch (1738:17): [True: 0, False: 14.5k]
  ------------------
 1739|       |                /* Slide the window down. */
 1740|      0|                s->strstart -= s->w_size;
 1741|      0|                zmemcpy(s->window, s->window + s->w_size, s->strstart);
 1742|      0|                if (s->matches < 2)
  ------------------
  |  Branch (1742:21): [True: 0, False: 0]
  ------------------
 1743|      0|                    s->matches++;   /* add a pending slide_hash() */
 1744|      0|                if (s->insert > s->strstart)
  ------------------
  |  Branch (1744:21): [True: 0, False: 0]
  ------------------
 1745|      0|                    s->insert = s->strstart;
 1746|      0|            }
 1747|  14.5k|            zmemcpy(s->window + s->strstart, s->strm->next_in - used, used);
 1748|  14.5k|            s->strstart += used;
 1749|  14.5k|            s->insert += MIN(used, s->w_size - s->insert);
 1750|  14.5k|        }
 1751|  14.5k|        s->block_start = s->strstart;
 1752|  14.5k|    }
 1753|  14.5k|    if (s->high_water < s->strstart)
  ------------------
  |  Branch (1753:9): [True: 14.5k, False: 0]
  ------------------
 1754|  14.5k|        s->high_water = s->strstart;
 1755|       |
 1756|       |    /* If the last block was written to next_out, then done. */
 1757|  14.5k|    if (last) {
  ------------------
  |  Branch (1757:9): [True: 14.5k, False: 0]
  ------------------
 1758|  14.5k|        s->bi_used = 8;
 1759|  14.5k|        return finish_done;
 1760|  14.5k|    }
 1761|       |
 1762|       |    /* If flushing and all input has been consumed, then done. */
 1763|      0|    if (flush != Z_NO_FLUSH && flush != Z_FINISH &&
  ------------------
  |  Branch (1763:9): [True: 0, False: 0]
  |  Branch (1763:32): [True: 0, False: 0]
  ------------------
 1764|      0|        s->strm->avail_in == 0 && (long)s->strstart == s->block_start)
  ------------------
  |  Branch (1764:9): [True: 0, False: 0]
  |  Branch (1764:35): [True: 0, False: 0]
  ------------------
 1765|      0|        return block_done;
 1766|       |
 1767|       |    /* Fill the window with any remaining input. */
 1768|      0|    have = s->window_size - s->strstart;
 1769|      0|    if (s->strm->avail_in > have && s->block_start >= (long)s->w_size) {
  ------------------
  |  Branch (1769:9): [True: 0, False: 0]
  |  Branch (1769:37): [True: 0, False: 0]
  ------------------
 1770|       |        /* Slide the window down. */
 1771|      0|        s->block_start -= s->w_size;
 1772|      0|        s->strstart -= s->w_size;
 1773|      0|        zmemcpy(s->window, s->window + s->w_size, s->strstart);
 1774|      0|        if (s->matches < 2)
  ------------------
  |  Branch (1774:13): [True: 0, False: 0]
  ------------------
 1775|      0|            s->matches++;           /* add a pending slide_hash() */
 1776|      0|        have += s->w_size;          /* more space now */
 1777|      0|        if (s->insert > s->strstart)
  ------------------
  |  Branch (1777:13): [True: 0, False: 0]
  ------------------
 1778|      0|            s->insert = s->strstart;
 1779|      0|    }
 1780|      0|    if (have > s->strm->avail_in)
  ------------------
  |  Branch (1780:9): [True: 0, False: 0]
  ------------------
 1781|      0|        have = s->strm->avail_in;
 1782|      0|    if (have) {
  ------------------
  |  Branch (1782:9): [True: 0, False: 0]
  ------------------
 1783|      0|        read_buf(s->strm, s->window + s->strstart, have);
 1784|      0|        s->strstart += have;
 1785|      0|        s->insert += MIN(have, s->w_size - s->insert);
 1786|      0|    }
 1787|      0|    if (s->high_water < s->strstart)
  ------------------
  |  Branch (1787:9): [True: 0, False: 0]
  ------------------
 1788|      0|        s->high_water = s->strstart;
 1789|       |
 1790|       |    /* There was not enough avail_out to write a complete worthy or flushed
 1791|       |     * stored block to next_out. Write a stored block to pending instead, if we
 1792|       |     * have enough input for a worthy block, or if flushing and there is enough
 1793|       |     * room for the remaining input as a stored block in the pending buffer.
 1794|       |     */
 1795|      0|    have = (s->bi_valid + 42) >> 3;         /* number of header bytes */
 1796|       |        /* maximum stored block length that will fit in pending: */
 1797|      0|    have = MIN(s->pending_buf_size - have, MAX_STORED);
 1798|      0|    min_block = MIN(have, s->w_size);
 1799|      0|    left = s->strstart - s->block_start;
 1800|      0|    if (left >= min_block ||
  ------------------
  |  Branch (1800:9): [True: 0, False: 0]
  ------------------
 1801|      0|        ((left || flush == Z_FINISH) && flush != Z_NO_FLUSH &&
  ------------------
  |  Branch (1801:11): [True: 0, False: 0]
  |  Branch (1801:19): [True: 0, False: 0]
  |  Branch (1801:41): [True: 0, False: 0]
  ------------------
 1802|      0|         s->strm->avail_in == 0 && left <= have)) {
  ------------------
  |  Branch (1802:10): [True: 0, False: 0]
  |  Branch (1802:36): [True: 0, False: 0]
  ------------------
 1803|      0|        len = MIN(left, have);
 1804|      0|        last = flush == Z_FINISH && s->strm->avail_in == 0 &&
  ------------------
  |  Branch (1804:16): [True: 0, False: 0]
  |  Branch (1804:37): [True: 0, False: 0]
  ------------------
 1805|      0|               len == left ? 1 : 0;
  ------------------
  |  Branch (1805:16): [True: 0, False: 0]
  ------------------
 1806|      0|        _tr_stored_block(s, (charf *)s->window + s->block_start, len, last);
 1807|      0|        s->block_start += len;
 1808|      0|        flush_pending(s->strm);
 1809|      0|    }
 1810|       |
 1811|       |    /* We've done all we can with the available input and output. */
 1812|      0|    if (last)
  ------------------
  |  Branch (1812:9): [True: 0, False: 0]
  ------------------
 1813|      0|        s->bi_used = 8;
 1814|      0|    return last ? finish_started : need_more;
  ------------------
  |  Branch (1814:12): [True: 0, False: 0]
  ------------------
 1815|      0|}
 1816|       |
 1817|       |/* ===========================================================================
 1818|       | * Compress as much as possible from the input stream, return the current
 1819|       | * block state.
 1820|       | * This function does not perform lazy evaluation of matches and inserts
 1821|       | * new strings in the dictionary only for unmatched strings or for short
 1822|       | * matches. It is used only for the fast compression options.
 1823|       | */
 1824|  16.3k|local block_state deflate_fast(deflate_state *s, int flush) {
 1825|  16.3k|    IPos hash_head;       /* head of the hash chain */
 1826|  16.3k|    int bflush;           /* set if current block must be flushed */
 1827|       |
 1828|   147k|    for (;;) {
 1829|       |        /* Make sure that we always have enough lookahead, except
 1830|       |         * at the end of the input file. We need MAX_MATCH bytes
 1831|       |         * for the next match, plus MIN_MATCH bytes to insert the
 1832|       |         * string following the next match.
 1833|       |         */
 1834|   147k|        if (s->lookahead < MIN_LOOKAHEAD) {
  ------------------
  |  Branch (1834:13): [True: 147k, False: 77]
  ------------------
 1835|   147k|            fill_window(s);
 1836|   147k|            if (s->lookahead < MIN_LOOKAHEAD && flush == Z_NO_FLUSH) {
                                                              ^147k    ^147k
  ------------------
  |  Branch (1836:17): [True: 147k, False: 21]
  |  Branch (1836:49): [True: 0, False: 147k]
  ------------------
 1837|      0|                return need_more;
 1838|      0|            }
 1839|   147k|            if (s->lookahead == 0) break; /* flush the current block */
                                                 ^16.3k
  ------------------
  |  Branch (1839:17): [True: 16.3k, False: 131k]
  ------------------
 1840|   147k|        }
 1841|       |
 1842|       |        /* Insert the string window[strstart .. strstart + 2] in the
 1843|       |         * dictionary, and set hash_head to the head of the hash chain:
 1844|       |         */
 1845|   131k|        hash_head = NIL;
 1846|   131k|        if (s->lookahead >= MIN_MATCH) {
  ------------------
  |  Branch (1846:13): [True: 109k, False: 22.3k]
  ------------------
 1847|   109k|            INSERT_STRING(s, s->strstart, hash_head);
 1848|   109k|        }
 1849|       |
 1850|       |        /* Find the longest match, discarding those <= prev_length.
 1851|       |         * At this point we have always match_length < MIN_MATCH
 1852|       |         */
 1853|   131k|        if (hash_head != NIL && s->strstart - hash_head <= MAX_DIST(s)) {
                                              ^25.0k                     ^25.0k
  ------------------
  |  Branch (1853:13): [True: 25.0k, False: 106k]
  |  Branch (1853:33): [True: 25.0k, False: 0]
  ------------------
 1854|       |            /* To simplify the code, we prevent matches with the string
 1855|       |             * of window index 0 (in particular we have to avoid a match
 1856|       |             * of the string with itself at the start of the input file).
 1857|       |             */
 1858|  25.0k|            s->match_length = longest_match (s, hash_head);
 1859|       |            /* longest_match() sets match_start */
 1860|  25.0k|        }
 1861|   131k|        if (s->match_length >= MIN_MATCH) {
  ------------------
  |  Branch (1861:13): [True: 22.8k, False: 108k]
  ------------------
 1862|  22.8k|            check_match(s, s->strstart, s->match_start, s->match_length);
 1863|       |
 1864|  22.8k|            _tr_tally_dist(s, s->strstart - s->match_start,
 1865|  22.8k|                           s->match_length - MIN_MATCH, bflush);
 1866|       |
 1867|  22.8k|            s->lookahead -= s->match_length;
 1868|       |
 1869|       |            /* Insert new strings in the hash table only if the match length
 1870|       |             * is not too large. This saves time but degrades compression.
 1871|       |             */
 1872|  22.8k|#ifndef FASTEST
 1873|  22.8k|            if (s->match_length <= s->max_insert_length &&
  ------------------
  |  Branch (1873:17): [True: 7.50k, False: 15.3k]
  ------------------
 1874|  22.8k|                s->lookahead >= MIN_MATCH) {
                              ^7.50k          ^7.50k
  ------------------
  |  Branch (1874:17): [True: 3.96k, False: 3.53k]
  ------------------
 1875|  3.96k|                s->match_length--; /* string at strstart already in table */
 1876|  10.5k|                do {
 1877|  10.5k|                    s->strstart++;
 1878|  10.5k|                    INSERT_STRING(s, s->strstart, hash_head);
 1879|       |                    /* strstart never exceeds WSIZE-MAX_MATCH, so there are
 1880|       |                     * always MIN_MATCH bytes ahead.
 1881|       |                     */
 1882|  10.5k|                } while (--s->match_length != 0);
  ------------------
  |  Branch (1882:26): [True: 6.61k, False: 3.96k]
  ------------------
 1883|  3.96k|                s->strstart++;
 1884|  3.96k|            } else
 1885|  18.8k|#endif
 1886|  18.8k|            {
 1887|  18.8k|                s->strstart += s->match_length;
 1888|  18.8k|                s->match_length = 0;
 1889|  18.8k|                s->ins_h = s->window[s->strstart];
 1890|  18.8k|                UPDATE_HASH(s, s->ins_h, s->window[s->strstart + 1]);
 1891|       |#if MIN_MATCH != 3
 1892|       |                Call UPDATE_HASH() MIN_MATCH-3 more times
 1893|       |#endif
 1894|       |                /* If lookahead < MIN_MATCH, ins_h is garbage, but it does not
 1895|       |                 * matter since it will be recomputed at next deflate call.
 1896|       |                 */
 1897|  18.8k|            }
 1898|   108k|        } else {
 1899|       |            /* No match, output a literal byte */
 1900|   108k|            Tracevv((stderr,"%c", s->window[s->strstart]));
 1901|   108k|            _tr_tally_lit(s, s->window[s->strstart], bflush);
 1902|   108k|            s->lookahead--;
 1903|   108k|            s->strstart++;
 1904|   108k|        }
 1905|   131k|        if (bflush) FLUSH_BLOCK(s, 0);
                                  ^0
  ------------------
  |  Branch (1905:13): [True: 0, False: 131k]
  ------------------
 1906|   131k|    }
 1907|  16.3k|    s->insert = s->strstart < MIN_MATCH-1 ? s->strstart : MIN_MATCH-1;
                                                          ^0
  ------------------
  |  Branch (1907:17): [True: 0, False: 16.3k]
  ------------------
 1908|  16.3k|    if (flush == Z_FINISH) {
  ------------------
  |  Branch (1908:9): [True: 16.3k, False: 0]
  ------------------
 1909|  16.3k|        FLUSH_BLOCK(s, 1);
 1910|  16.3k|        return finish_done;
 1911|  16.3k|    }
 1912|      0|    if (s->sym_next)
  ------------------
  |  Branch (1912:9): [True: 0, False: 0]
  ------------------
 1913|      0|        FLUSH_BLOCK(s, 0);
 1914|      0|    return block_done;
 1915|      0|}
 1916|       |
 1917|       |#ifndef FASTEST
 1918|       |/* ===========================================================================
 1919|       | * Same as above, but achieves better compression. We use a lazy
 1920|       | * evaluation for matches: a match is finally adopted only if there is
 1921|       | * no better match at the next window position.
 1922|       | */
 1923|   232k|local block_state deflate_slow(deflate_state *s, int flush) {
 1924|   232k|    IPos hash_head;          /* head of hash chain */
 1925|   232k|    int bflush;              /* set if current block must be flushed */
 1926|       |
 1927|       |    /* Process the input block. */
 1928|  2.54M|    for (;;) {
 1929|       |        /* Make sure that we always have enough lookahead, except
 1930|       |         * at the end of the input file. We need MAX_MATCH bytes
 1931|       |         * for the next match, plus MIN_MATCH bytes to insert the
 1932|       |         * string following the next match.
 1933|       |         */
 1934|  2.54M|        if (s->lookahead < MIN_LOOKAHEAD) {
  ------------------
  |  Branch (1934:13): [True: 2.54M, False: 2.49k]
  ------------------
 1935|  2.54M|            fill_window(s);
 1936|  2.54M|            if (s->lookahead < MIN_LOOKAHEAD && flush == Z_NO_FLUSH) {
                                                              ^2.54M   ^2.54M
  ------------------
  |  Branch (1936:17): [True: 2.54M, False: 406]
  |  Branch (1936:49): [True: 0, False: 2.54M]
  ------------------
 1937|      0|                return need_more;
 1938|      0|            }
 1939|  2.54M|            if (s->lookahead == 0) break; /* flush the current block */
                                                 ^232k
  ------------------
  |  Branch (1939:17): [True: 232k, False: 2.30M]
  ------------------
 1940|  2.54M|        }
 1941|       |
 1942|       |        /* Insert the string window[strstart .. strstart + 2] in the
 1943|       |         * dictionary, and set hash_head to the head of the hash chain:
 1944|       |         */
 1945|  2.31M|        hash_head = NIL;
 1946|  2.31M|        if (s->lookahead >= MIN_MATCH) {
  ------------------
  |  Branch (1946:13): [True: 1.97M, False: 335k]
  ------------------
 1947|  1.97M|            INSERT_STRING(s, s->strstart, hash_head);
 1948|  1.97M|        }
 1949|       |
 1950|       |        /* Find the longest match, discarding those <= prev_length.
 1951|       |         */
 1952|  2.31M|        s->prev_length = s->match_length, s->prev_match = s->match_start;
 1953|  2.31M|        s->match_length = MIN_MATCH-1;
 1954|       |
 1955|  2.31M|        if (hash_head != NIL && s->prev_length < s->max_lazy_match &&
                                              ^655k
  ------------------
  |  Branch (1955:13): [True: 655k, False: 1.65M]
  |  Branch (1955:33): [True: 476k, False: 179k]
  ------------------
 1956|  2.31M|            s->strstart - hash_head <= MAX_DIST(s)) {
                          ^476k                      ^476k
  ------------------
  |  Branch (1956:13): [True: 476k, False: 0]
  ------------------
 1957|       |            /* To simplify the code, we prevent matches with the string
 1958|       |             * of window index 0 (in particular we have to avoid a match
 1959|       |             * of the string with itself at the start of the input file).
 1960|       |             */
 1961|   476k|            s->match_length = longest_match (s, hash_head);
 1962|       |            /* longest_match() sets match_start */
 1963|       |
 1964|   476k|            if (s->match_length <= 5 && (s->strategy == Z_FILTERED
                                                      ^224k^224k          ^224k
  ------------------
  |  Branch (1964:17): [True: 224k, False: 252k]
  |  Branch (1964:42): [True: 0, False: 224k]
  ------------------
 1965|   224k|#if TOO_FAR <= 32767
 1966|   224k|                || (s->match_length == MIN_MATCH &&
  ------------------
  |  Branch (1966:21): [True: 64.1k, False: 160k]
  ------------------
 1967|   224k|                    s->strstart - s->match_start > TOO_FAR)
                                  ^64.1k                         ^64.1k
  ------------------
  |  Branch (1967:21): [True: 0, False: 64.1k]
  ------------------
 1968|   224k|#endif
 1969|   224k|                )) {
 1970|       |
 1971|       |                /* If prev_match is also MIN_MATCH, match_start is garbage
 1972|       |                 * but we will ignore the current match anyway.
 1973|       |                 */
 1974|      0|                s->match_length = MIN_MATCH-1;
 1975|      0|            }
 1976|   476k|        }
 1977|       |        /* If there was a match at the previous step and the current
 1978|       |         * match is not better, output the previous match:
 1979|       |         */
 1980|  2.31M|        if (s->prev_length >= MIN_MATCH && s->match_length <= s->prev_length) {
                                                         ^342k
  ------------------
  |  Branch (1980:13): [True: 342k, False: 1.97M]
  |  Branch (1980:44): [True: 327k, False: 14.8k]
  ------------------
 1981|   327k|            uInt max_insert = s->strstart + s->lookahead - MIN_MATCH;
 1982|       |            /* Do not insert strings in hash table beyond this. */
 1983|       |
 1984|   327k|            check_match(s, s->strstart - 1, s->prev_match, s->prev_length);
 1985|       |
 1986|   327k|            _tr_tally_dist(s, s->strstart - 1 - s->prev_match,
 1987|   327k|                           s->prev_length - MIN_MATCH, bflush);
 1988|       |
 1989|       |            /* Insert in hash table all strings up to the end of the match.
 1990|       |             * strstart - 1 and strstart are already inserted. If there is not
 1991|       |             * enough lookahead, the last two strings are not inserted in
 1992|       |             * the hash table.
 1993|       |             */
 1994|   327k|            s->lookahead -= s->prev_length - 1;
 1995|   327k|            s->prev_length -= 2;
 1996|  6.41M|            do {
 1997|  6.41M|                if (++s->strstart <= max_insert) {
  ------------------
  |  Branch (1997:21): [True: 6.28M, False: 129k]
  ------------------
 1998|  6.28M|                    INSERT_STRING(s, s->strstart, hash_head);
 1999|  6.28M|                }
 2000|  6.41M|            } while (--s->prev_length != 0);
  ------------------
  |  Branch (2000:22): [True: 6.08M, False: 327k]
  ------------------
 2001|   327k|            s->match_available = 0;
 2002|   327k|            s->match_length = MIN_MATCH-1;
 2003|   327k|            s->strstart++;
 2004|       |
 2005|   327k|            if (bflush) FLUSH_BLOCK(s, 0);
                                      ^0
  ------------------
  |  Branch (2005:17): [True: 0, False: 327k]
  ------------------
 2006|       |
 2007|  1.98M|        } else if (s->match_available) {
  ------------------
  |  Branch (2007:20): [True: 1.46M, False: 521k]
  ------------------
 2008|       |            /* If there was no match at the previous position, output a
 2009|       |             * single literal. If there was a match but the current match
 2010|       |             * is longer, truncate the previous match to a single literal.
 2011|       |             */
 2012|  1.46M|            Tracevv((stderr,"%c", s->window[s->strstart - 1]));
 2013|  1.46M|            _tr_tally_lit(s, s->window[s->strstart - 1], bflush);
 2014|  1.46M|            if (bflush) {
  ------------------
  |  Branch (2014:17): [True: 0, False: 1.46M]
  ------------------
 2015|      0|                FLUSH_BLOCK_ONLY(s, 0);
 2016|      0|            }
 2017|  1.46M|            s->strstart++;
 2018|  1.46M|            s->lookahead--;
 2019|  1.46M|            if (s->strm->avail_out == 0) return need_more;
                                                       ^0
  ------------------
  |  Branch (2019:17): [True: 0, False: 1.46M]
  ------------------
 2020|  1.46M|        } else {
 2021|       |            /* There is no previous match to compare with, wait for
 2022|       |             * the next step to decide.
 2023|       |             */
 2024|   521k|            s->match_available = 1;
 2025|   521k|            s->strstart++;
 2026|   521k|            s->lookahead--;
 2027|   521k|        }
 2028|  2.31M|    }
 2029|   232k|    Assert (flush != Z_NO_FLUSH, "no flush?");
 2030|   232k|    if (s->match_available) {
  ------------------
  |  Branch (2030:9): [True: 193k, False: 38.3k]
  ------------------
 2031|   193k|        Tracevv((stderr,"%c", s->window[s->strstart - 1]));
 2032|   193k|        _tr_tally_lit(s, s->window[s->strstart - 1], bflush);
 2033|   193k|        s->match_available = 0;
 2034|   193k|    }
 2035|   232k|    s->insert = s->strstart < MIN_MATCH-1 ? s->strstart : MIN_MATCH-1;
                                                          ^0
  ------------------
  |  Branch (2035:17): [True: 0, False: 232k]
  ------------------
 2036|   232k|    if (flush == Z_FINISH) {
  ------------------
  |  Branch (2036:9): [True: 232k, False: 0]
  ------------------
 2037|   232k|        FLUSH_BLOCK(s, 1);
 2038|   232k|        return finish_done;
 2039|   232k|    }
 2040|      0|    if (s->sym_next)
  ------------------
  |  Branch (2040:9): [True: 0, False: 0]
  ------------------
 2041|      0|        FLUSH_BLOCK(s, 0);
 2042|      0|    return block_done;
 2043|      0|}
 2044|       |#endif /* FASTEST */
 2045|       |
 2046|       |/* ===========================================================================
 2047|       | * For Z_RLE, simply look for runs of bytes, generate matches only of distance
 2048|       | * one.  Do not maintain a hash table.  (It will be regenerated if this run of
 2049|       | * deflate switches away from Z_RLE.)
 2050|       | */
 2051|      0|local block_state deflate_rle(deflate_state *s, int flush) {
 2052|      0|    int bflush;             /* set if current block must be flushed */
 2053|      0|    uInt prev;              /* byte at distance one to match */
 2054|      0|    Bytef *scan, *strend;   /* scan goes up to strend for length of run */
 2055|       |
 2056|      0|    for (;;) {
 2057|       |        /* Make sure that we always have enough lookahead, except
 2058|       |         * at the end of the input file. We need MAX_MATCH bytes
 2059|       |         * for the longest run, plus one for the unrolled loop.
 2060|       |         */
 2061|      0|        if (s->lookahead <= MAX_MATCH) {
  ------------------
  |  Branch (2061:13): [True: 0, False: 0]
  ------------------
 2062|      0|            fill_window(s);
 2063|      0|            if (s->lookahead <= MAX_MATCH && flush == Z_NO_FLUSH) {
  ------------------
  |  Branch (2063:17): [True: 0, False: 0]
  |  Branch (2063:46): [True: 0, False: 0]
  ------------------
 2064|      0|                return need_more;
 2065|      0|            }
 2066|      0|            if (s->lookahead == 0) break; /* flush the current block */
  ------------------
  |  Branch (2066:17): [True: 0, False: 0]
  ------------------
 2067|      0|        }
 2068|       |
 2069|       |        /* See how many times the previous byte repeats */
 2070|      0|        s->match_length = 0;
 2071|      0|        if (s->lookahead >= MIN_MATCH && s->strstart > 0) {
  ------------------
  |  Branch (2071:13): [True: 0, False: 0]
  |  Branch (2071:42): [True: 0, False: 0]
  ------------------
 2072|      0|            scan = s->window + s->strstart - 1;
 2073|      0|            prev = *scan;
 2074|      0|            if (prev == *++scan && prev == *++scan && prev == *++scan) {
  ------------------
  |  Branch (2074:17): [True: 0, False: 0]
  |  Branch (2074:36): [True: 0, False: 0]
  |  Branch (2074:55): [True: 0, False: 0]
  ------------------
 2075|      0|                strend = s->window + s->strstart + MAX_MATCH;
 2076|      0|                do {
 2077|      0|                } while (prev == *++scan && prev == *++scan &&
  ------------------
  |  Branch (2077:26): [True: 0, False: 0]
  |  Branch (2077:45): [True: 0, False: 0]
  ------------------
 2078|      0|                         prev == *++scan && prev == *++scan &&
  ------------------
  |  Branch (2078:26): [True: 0, False: 0]
  |  Branch (2078:45): [True: 0, False: 0]
  ------------------
 2079|      0|                         prev == *++scan && prev == *++scan &&
  ------------------
  |  Branch (2079:26): [True: 0, False: 0]
  |  Branch (2079:45): [True: 0, False: 0]
  ------------------
 2080|      0|                         prev == *++scan && prev == *++scan &&
  ------------------
  |  Branch (2080:26): [True: 0, False: 0]
  |  Branch (2080:45): [True: 0, False: 0]
  ------------------
 2081|      0|                         scan < strend);
  ------------------
  |  Branch (2081:26): [True: 0, False: 0]
  ------------------
 2082|      0|                s->match_length = MAX_MATCH - (uInt)(strend - scan);
 2083|      0|                if (s->match_length > s->lookahead)
  ------------------
  |  Branch (2083:21): [True: 0, False: 0]
  ------------------
 2084|      0|                    s->match_length = s->lookahead;
 2085|      0|            }
 2086|      0|            Assert(scan <= s->window + (uInt)(s->window_size - 1),
 2087|      0|                   "wild scan");
 2088|      0|        }
 2089|       |
 2090|       |        /* Emit match if have run of MIN_MATCH or longer, else emit literal */
 2091|      0|        if (s->match_length >= MIN_MATCH) {
  ------------------
  |  Branch (2091:13): [True: 0, False: 0]
  ------------------
 2092|      0|            check_match(s, s->strstart, s->strstart - 1, s->match_length);
 2093|       |
 2094|      0|            _tr_tally_dist(s, 1, s->match_length - MIN_MATCH, bflush);
 2095|       |
 2096|      0|            s->lookahead -= s->match_length;
 2097|      0|            s->strstart += s->match_length;
 2098|      0|            s->match_length = 0;
 2099|      0|        } else {
 2100|       |            /* No match, output a literal byte */
 2101|      0|            Tracevv((stderr,"%c", s->window[s->strstart]));
 2102|      0|            _tr_tally_lit(s, s->window[s->strstart], bflush);
 2103|      0|            s->lookahead--;
 2104|      0|            s->strstart++;
 2105|      0|        }
 2106|      0|        if (bflush) FLUSH_BLOCK(s, 0);
  ------------------
  |  Branch (2106:13): [True: 0, False: 0]
  ------------------
 2107|      0|    }
 2108|      0|    s->insert = 0;
 2109|      0|    if (flush == Z_FINISH) {
  ------------------
  |  Branch (2109:9): [True: 0, False: 0]
  ------------------
 2110|      0|        FLUSH_BLOCK(s, 1);
 2111|      0|        return finish_done;
 2112|      0|    }
 2113|      0|    if (s->sym_next)
  ------------------
  |  Branch (2113:9): [True: 0, False: 0]
  ------------------
 2114|      0|        FLUSH_BLOCK(s, 0);
 2115|      0|    return block_done;
 2116|      0|}
 2117|       |
 2118|       |/* ===========================================================================
 2119|       | * For Z_HUFFMAN_ONLY, do not look for matches.  Do not maintain a hash table.
 2120|       | * (It will be regenerated if this run of deflate switches away from Huffman.)
 2121|       | */
 2122|      0|local block_state deflate_huff(deflate_state *s, int flush) {
 2123|      0|    int bflush;             /* set if current block must be flushed */
 2124|       |
 2125|      0|    for (;;) {
 2126|       |        /* Make sure that we have a literal to write. */
 2127|      0|        if (s->lookahead == 0) {
  ------------------
  |  Branch (2127:13): [True: 0, False: 0]
  ------------------
 2128|      0|            fill_window(s);
 2129|      0|            if (s->lookahead == 0) {
  ------------------
  |  Branch (2129:17): [True: 0, False: 0]
  ------------------
 2130|      0|                if (flush == Z_NO_FLUSH)
  ------------------
  |  Branch (2130:21): [True: 0, False: 0]
  ------------------
 2131|      0|                    return need_more;
 2132|      0|                break;      /* flush the current block */
 2133|      0|            }
 2134|      0|        }
 2135|       |
 2136|       |        /* Output a literal byte */
 2137|      0|        s->match_length = 0;
 2138|      0|        Tracevv((stderr,"%c", s->window[s->strstart]));
 2139|      0|        _tr_tally_lit(s, s->window[s->strstart], bflush);
 2140|      0|        s->lookahead--;
 2141|      0|        s->strstart++;
 2142|      0|        if (bflush) FLUSH_BLOCK(s, 0);
  ------------------
  |  Branch (2142:13): [True: 0, False: 0]
  ------------------
 2143|      0|    }
 2144|      0|    s->insert = 0;
 2145|      0|    if (flush == Z_FINISH) {
  ------------------
  |  Branch (2145:9): [True: 0, False: 0]
  ------------------
 2146|      0|        FLUSH_BLOCK(s, 1);
 2147|      0|        return finish_done;
 2148|      0|    }
 2149|      0|    if (s->sym_next)
  ------------------
  |  Branch (2149:9): [True: 0, False: 0]
  ------------------
 2150|      0|        FLUSH_BLOCK(s, 0);
 2151|      0|    return block_done;
 2152|      0|}

/home/minseo/alfha/targets/zlib/target/deflate.h:
    1|       |/* deflate.h -- internal compression state
    2|       | * Copyright (C) 1995-2024 Jean-loup Gailly
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* WARNING: this file should *not* be used by applications. It is
    7|       |   part of the implementation of the compression library and is
    8|       |   subject to change. Applications should only use zlib.h.
    9|       | */
   10|       |
   11|       |/* @(#) $Id$ */
   12|       |
   13|       |#ifndef DEFLATE_H
   14|       |#define DEFLATE_H
   15|       |
   16|       |#include "zutil.h"
   17|       |
   18|       |/* define NO_GZIP when compiling if you want to disable gzip header and
   19|       |   trailer creation by deflate().  NO_GZIP would be used to avoid linking in
   20|       |   the crc code when it is not needed.  For shared libraries, gzip encoding
   21|       |   should be left enabled. */
   22|       |#ifndef NO_GZIP
   23|       |#  define GZIP
   24|       |#endif
   25|       |
   26|       |/* define LIT_MEM to slightly increase the speed of deflate (order 1% to 2%) at
   27|       |   the cost of a larger memory footprint */
   28|       |/* #define LIT_MEM */
   29|       |
   30|       |/* ===========================================================================
   31|       | * Internal compression state.
   32|       | */
   33|       |
   34|   153M|#define LENGTH_CODES 29
   35|       |/* number of length codes, not counting the special END_BLOCK code */
   36|       |
   37|   160M|#define LITERALS  256
   38|       |/* number of literal bytes 0..255 */
   39|       |
   40|   153M|#define L_CODES (LITERALS+1+LENGTH_CODES)
   41|       |/* number of Literal or Length codes, including the END_BLOCK code */
   42|       |
   43|  15.8M|#define D_CODES   30
   44|       |/* number of distance codes */
   45|       |
   46|  10.4M|#define BL_CODES  19
   47|       |/* number of codes used to transfer the bit lengths */
   48|       |
   49|  6.44M|#define HEAP_SIZE (2*L_CODES+1)
   50|       |/* maximum heap size */
   51|       |
   52|  24.6M|#define MAX_BITS 15
   53|       |/* All codes must not exceed MAX_BITS bits */
   54|       |
   55|  5.70M|#define Buf_size 16
   56|       |/* size of bit buffer in bi_buf */
   57|       |
   58|  3.15M|#define INIT_STATE    42    /* zlib header -> BUSY_STATE */
   59|       |#ifdef GZIP
   60|  1.31M|#  define GZIP_STATE  57    /* gzip header -> BUSY_STATE | EXTRA_STATE */
   61|       |#endif
   62|  1.31M|#define EXTRA_STATE   69    /* gzip extra block -> NAME_STATE */
   63|  1.31M|#define NAME_STATE    73    /* gzip file name -> COMMENT_STATE */
   64|  1.31M|#define COMMENT_STATE 91    /* gzip comment -> HCRC_STATE */
   65|  1.31M|#define HCRC_STATE   103    /* gzip header CRC -> BUSY_STATE */
   66|  1.57M|#define BUSY_STATE   113    /* deflate -> FINISH_STATE */
   67|  1.57M|#define FINISH_STATE 666    /* stream complete */
   68|       |/* Stream status */
   69|       |
   70|       |
   71|       |/* Data structure describing a single value and its code string. */
   72|       |typedef struct ct_data_s {
   73|       |    union {
   74|       |        ush  freq;       /* frequency count */
   75|       |        ush  code;       /* bit string */
   76|       |    } fc;
   77|       |    union {
   78|       |        ush  dad;        /* father node in Huffman tree */
   79|       |        ush  len;        /* length of bit string */
   80|       |    } dl;
   81|       |} FAR ct_data;
   82|       |
   83|   342M|#define Freq fc.freq
   84|  3.22M|#define Code fc.code
   85|  9.90M|#define Dad  dl.dad
   86|   232M|#define Len  dl.len
   87|       |
   88|       |typedef struct static_tree_desc_s  static_tree_desc;
   89|       |
   90|       |typedef struct tree_desc_s {
   91|       |    ct_data *dyn_tree;           /* the dynamic tree */
   92|       |    int     max_code;            /* largest code with non zero frequency */
   93|       |    const static_tree_desc *stat_desc;  /* the corresponding static tree */
   94|       |} FAR tree_desc;
   95|       |
   96|       |typedef ush Pos;
   97|       |typedef Pos FAR Posf;
   98|       |typedef unsigned IPos;
   99|       |
  100|       |/* A Pos is an index in the character window. We use short instead of int to
  101|       | * save space in the various tables. IPos is used only for parameter passing.
  102|       | */
  103|       |
  104|       |typedef struct internal_state {
  105|       |    z_streamp strm;      /* pointer back to this zlib stream */
  106|       |    int   status;        /* as the name implies */
  107|       |    Bytef *pending_buf;  /* output still pending */
  108|       |    ulg   pending_buf_size; /* size of pending_buf */
  109|       |    Bytef *pending_out;  /* next pending byte to output to the stream */
  110|       |    ulg   pending;       /* nb of bytes in the pending buffer */
  111|       |    int   wrap;          /* bit 0 true for zlib, bit 1 true for gzip */
  112|       |    gz_headerp  gzhead;  /* gzip header information to write */
  113|       |    ulg   gzindex;       /* where in extra, name, or comment */
  114|       |    Byte  method;        /* can only be DEFLATED */
  115|       |    int   last_flush;    /* value of flush param for previous deflate call */
  116|       |
  117|       |                /* used by deflate.c: */
  118|       |
  119|       |    uInt  w_size;        /* LZ77 window size (32K by default) */
  120|       |    uInt  w_bits;        /* log2(w_size)  (8..16) */
  121|       |    uInt  w_mask;        /* w_size - 1 */
  122|       |
  123|       |    Bytef *window;
  124|       |    /* Sliding window. Input bytes are read into the second half of the window,
  125|       |     * and move to the first half later to keep a dictionary of at least wSize
  126|       |     * bytes. With this organization, matches are limited to a distance of
  127|       |     * wSize-MAX_MATCH bytes, but this ensures that IO is always
  128|       |     * performed with a length multiple of the block size. Also, it limits
  129|       |     * the window size to 64K, which is quite useful on MSDOS.
  130|       |     * To do: use the user input buffer as sliding window.
  131|       |     */
  132|       |
  133|       |    ulg window_size;
  134|       |    /* Actual size of window: 2*wSize, except when the user input buffer
  135|       |     * is directly used as sliding window.
  136|       |     */
  137|       |
  138|       |    Posf *prev;
  139|       |    /* Link to older string with same hash index. To limit the size of this
  140|       |     * array to 64K, this link is maintained only for the last 32K strings.
  141|       |     * An index in this array is thus a window index modulo 32K.
  142|       |     */
  143|       |
  144|       |    Posf *head; /* Heads of the hash chains or NIL. */
  145|       |
  146|       |    uInt  ins_h;          /* hash index of string to be inserted */
  147|       |    uInt  hash_size;      /* number of elements in hash table */
  148|       |    uInt  hash_bits;      /* log2(hash_size) */
  149|       |    uInt  hash_mask;      /* hash_size-1 */
  150|       |
  151|       |    uInt  hash_shift;
  152|       |    /* Number of bits by which ins_h must be shifted at each input
  153|       |     * step. It must be such that after MIN_MATCH steps, the oldest
  154|       |     * byte no longer takes part in the hash key, that is:
  155|       |     *   hash_shift * MIN_MATCH >= hash_bits
  156|       |     */
  157|       |
  158|       |    long block_start;
  159|       |    /* Window position at the beginning of the current output block. Gets
  160|       |     * negative when the window is moved backwards.
  161|       |     */
  162|       |
  163|       |    uInt match_length;           /* length of best match */
  164|       |    IPos prev_match;             /* previous match */
  165|       |    int match_available;         /* set if previous match exists */
  166|       |    uInt strstart;               /* start of string to insert */
  167|       |    uInt match_start;            /* start of matching string */
  168|       |    uInt lookahead;              /* number of valid bytes ahead in window */
  169|       |
  170|       |    uInt prev_length;
  171|       |    /* Length of the best match at previous step. Matches not greater than this
  172|       |     * are discarded. This is used in the lazy match evaluation.
  173|       |     */
  174|       |
  175|       |    uInt max_chain_length;
  176|       |    /* To speed up deflation, hash chains are never searched beyond this
  177|       |     * length.  A higher limit improves compression ratio but degrades the
  178|       |     * speed.
  179|       |     */
  180|       |
  181|       |    uInt max_lazy_match;
  182|       |    /* Attempt to find a better match only when the current match is strictly
  183|       |     * smaller than this value. This mechanism is used only for compression
  184|       |     * levels >= 4.
  185|       |     */
  186|  45.6k|#   define max_insert_length  max_lazy_match
  187|       |    /* Insert new strings in the hash table only if the match length is not
  188|       |     * greater than this length. This saves time but degrades compression.
  189|       |     * max_insert_length is used only for compression levels <= 3.
  190|       |     */
  191|       |
  192|       |    int level;    /* compression level (1..9) */
  193|       |    int strategy; /* favor or force Huffman coding*/
  194|       |
  195|       |    uInt good_match;
  196|       |    /* Use a faster search when the previous match is longer than this */
  197|       |
  198|       |    int nice_match; /* Stop searching when current match exceeds this */
  199|       |
  200|       |                /* used by trees.c: */
  201|       |    /* Didn't use ct_data typedef below to suppress compiler warning */
  202|       |    struct ct_data_s dyn_ltree[HEAP_SIZE];   /* literal and length tree */
  203|       |    struct ct_data_s dyn_dtree[2*D_CODES+1]; /* distance tree */
  204|       |    struct ct_data_s bl_tree[2*BL_CODES+1];  /* Huffman tree for bit lengths */
  205|       |
  206|       |    struct tree_desc_s l_desc;               /* desc. for literal tree */
  207|       |    struct tree_desc_s d_desc;               /* desc. for distance tree */
  208|       |    struct tree_desc_s bl_desc;              /* desc. for bit length tree */
  209|       |
  210|       |    ush bl_count[MAX_BITS+1];
  211|       |    /* number of codes at each bit length for an optimal tree */
  212|       |
  213|       |    int heap[2*L_CODES+1];      /* heap used to build the Huffman trees */
  214|       |    int heap_len;               /* number of elements in the heap */
  215|       |    int heap_max;               /* element of largest frequency */
  216|       |    /* The sons of heap[n] are heap[2*n] and heap[2*n+1]. heap[0] is not used.
  217|       |     * The same heap array is used to build all trees.
  218|       |     */
  219|       |
  220|       |    uch depth[2*L_CODES+1];
  221|       |    /* Depth of each subtree used as tie breaker for trees of equal frequency
  222|       |     */
  223|       |
  224|       |#ifdef LIT_MEM
  225|       |#   define LIT_BUFS 5
  226|       |    ushf *d_buf;          /* buffer for distances */
  227|       |    uchf *l_buf;          /* buffer for literals/lengths */
  228|       |#else
  229|      0|#   define LIT_BUFS 4
  230|       |    uchf *sym_buf;        /* buffer for distances and literals/lengths */
  231|       |#endif
  232|       |
  233|       |    uInt  lit_bufsize;
  234|       |    /* Size of match buffer for literals/lengths.  There are 4 reasons for
  235|       |     * limiting lit_bufsize to 64K:
  236|       |     *   - frequencies can be kept in 16 bit counters
  237|       |     *   - if compression is not successful for the first block, all input
  238|       |     *     data is still in the window so we can still emit a stored block even
  239|       |     *     when input comes from standard input.  (This can also be done for
  240|       |     *     all blocks if lit_bufsize is not greater than 32K.)
  241|       |     *   - if compression is not successful for a file smaller than 64K, we can
  242|       |     *     even emit a stored file instead of a stored block (saving 5 bytes).
  243|       |     *     This is applicable only for zip (not gzip or zlib).
  244|       |     *   - creating new Huffman trees less frequently may not provide fast
  245|       |     *     adaptation to changes in the input data statistics. (Take for
  246|       |     *     example a binary file with poorly compressible code followed by
  247|       |     *     a highly compressible string table.) Smaller buffer sizes give
  248|       |     *     fast adaptation but have of course the overhead of transmitting
  249|       |     *     trees more frequently.
  250|       |     *   - I can't count above 4
  251|       |     */
  252|       |
  253|       |    uInt sym_next;      /* running index in symbol buffer */
  254|       |    uInt sym_end;       /* symbol table full when sym_next reaches this */
  255|       |
  256|       |    ulg opt_len;        /* bit length of current block with optimal trees */
  257|       |    ulg static_len;     /* bit length of current block with static trees */
  258|       |    uInt matches;       /* number of string matches in current block */
  259|       |    uInt insert;        /* bytes at end of window left to insert */
  260|       |
  261|       |#ifdef ZLIB_DEBUG
  262|       |    ulg compressed_len; /* total bit length of compressed file mod 2^32 */
  263|       |    ulg bits_sent;      /* bit length of compressed data sent mod 2^32 */
  264|       |#endif
  265|       |
  266|       |    ush bi_buf;
  267|       |    /* Output buffer. bits are inserted starting at the bottom (least
  268|       |     * significant bits).
  269|       |     */
  270|       |    int bi_valid;
  271|       |    /* Number of valid bits in bi_buf.  All bits above the last valid bit
  272|       |     * are always zero.
  273|       |     */
  274|       |    int bi_used;
  275|       |    /* Last number of used bits when going to a byte boundary.
  276|       |     */
  277|       |
  278|       |    ulg high_water;
  279|       |    /* High water mark offset in window for initialized bytes -- bytes above
  280|       |     * this are set to zero in order to avoid memory check warnings when
  281|       |     * longest match routines access bytes past the input.  This is then
  282|       |     * updated to the new high water mark.
  283|       |     */
  284|       |
  285|       |} FAR deflate_state;
  286|       |
  287|       |/* Output a byte on the stream.
  288|       | * IN assertion: there is enough room in pending_buf.
  289|       | */
  290|  4.49M|#define put_byte(s, c) {s->pending_buf[s->pending++] = (Bytef)(c);}
                                                                             ^0
  291|       |
  292|       |
  293|  12.2M|#define MIN_LOOKAHEAD (MAX_MATCH+MIN_MATCH+1)
                                     ^9.32M    ^9.32M
  294|       |/* Minimum amount of lookahead, except at the end of the input file.
  295|       | * See deflate.c for comments about the MIN_MATCH+1.
  296|       | */
  297|       |
  298|  3.69M|#define MAX_DIST(s)  ((s)->w_size-MIN_LOOKAHEAD)
  299|       |/* In order to simplify the code, particularly on 16 bit machines, match
  300|       | * distances are limited to MAX_DIST instead of WSIZE.
  301|       | */
  302|       |
  303|  2.93M|#define WIN_INIT MAX_MATCH
  304|       |/* Number of bytes after end of data in window to initialize in order to avoid
  305|       |   memory checker errors from longest match routines */
  306|       |
  307|       |        /* in trees.c */
  308|       |void ZLIB_INTERNAL _tr_init(deflate_state *s);
  309|       |int ZLIB_INTERNAL _tr_tally(deflate_state *s, unsigned dist, unsigned lc);
  310|       |void ZLIB_INTERNAL _tr_flush_block(deflate_state *s, charf *buf,
  311|       |                                   ulg stored_len, int last);
  312|       |void ZLIB_INTERNAL _tr_flush_bits(deflate_state *s);
  313|       |void ZLIB_INTERNAL _tr_align(deflate_state *s);
  314|       |void ZLIB_INTERNAL _tr_stored_block(deflate_state *s, charf *buf,
  315|       |                                    ulg stored_len, int last);
  316|       |
  317|       |#define d_code(dist) \
  318|   700k|   ((dist) < 256 ? _dist_code[dist] : _dist_code[256+((dist)>>7)])
                                 ^700k              ^44
  319|       |/* Mapping from a distance to a distance code. dist is the distance - 1 and
  320|       | * must not have side effects. _dist_code[256] and _dist_code[257] are never
  321|       | * used.
  322|       | */
  323|       |
  324|       |#ifndef ZLIB_DEBUG
  325|       |/* Inline versions of _tr_tally for speed: */
  326|       |
  327|       |#if defined(GEN_TREES_H) || !defined(STDC)
  328|       |  extern uch ZLIB_INTERNAL _length_code[];
  329|       |  extern uch ZLIB_INTERNAL _dist_code[];
  330|       |#else
  331|       |  extern const uch ZLIB_INTERNAL _length_code[];
  332|       |  extern const uch ZLIB_INTERNAL _dist_code[];
  333|       |#endif
  334|       |
  335|       |#ifdef LIT_MEM
  336|       |# define _tr_tally_lit(s, c, flush) \
  337|       |  { uch cc = (c); \
  338|       |    s->d_buf[s->sym_next] = 0; \
  339|       |    s->l_buf[s->sym_next++] = cc; \
  340|       |    s->dyn_ltree[cc].Freq++; \
  341|       |    flush = (s->sym_next == s->sym_end); \
  342|       |   }
  343|       |# define _tr_tally_dist(s, distance, length, flush) \
  344|       |  { uch len = (uch)(length); \
  345|       |    ush dist = (ush)(distance); \
  346|       |    s->d_buf[s->sym_next] = dist; \
  347|       |    s->l_buf[s->sym_next++] = len; \
  348|       |    dist--; \
  349|       |    s->dyn_ltree[_length_code[len]+LITERALS+1].Freq++; \
  350|       |    s->dyn_dtree[d_code(dist)].Freq++; \
  351|       |    flush = (s->sym_next == s->sym_end); \
  352|       |  }
  353|       |#else
  354|       |# define _tr_tally_lit(s, c, flush) \
  355|  1.76M|  { uch cc = (c); \
  356|  1.76M|    s->sym_buf[s->sym_next++] = 0; \
  357|  1.76M|    s->sym_buf[s->sym_next++] = 0; \
  358|  1.76M|    s->sym_buf[s->sym_next++] = cc; \
  359|  1.76M|    s->dyn_ltree[cc].Freq++; \
  360|  1.76M|    flush = (s->sym_next == s->sym_end); \
  361|  1.76M|   }
  362|       |# define _tr_tally_dist(s, distance, length, flush) \
  363|   350k|  { uch len = (uch)(length); \
  364|   350k|    ush dist = (ush)(distance); \
  365|   350k|    s->sym_buf[s->sym_next++] = (uch)dist; \
  366|   350k|    s->sym_buf[s->sym_next++] = (uch)(dist >> 8); \
  367|   350k|    s->sym_buf[s->sym_next++] = len; \
  368|   350k|    dist--; \
  369|   350k|    s->dyn_ltree[_length_code[len]+LITERALS+1].Freq++; \
  370|   350k|    s->dyn_dtree[d_code(dist)].Freq++; \
  371|   350k|    flush = (s->sym_next == s->sym_end); \
  372|   350k|  }
  373|       |#endif
  374|       |#else
  375|       |# define _tr_tally_lit(s, c, flush) flush = _tr_tally(s, 0, c)
  376|       |# define _tr_tally_dist(s, distance, length, flush) \
  377|       |              flush = _tr_tally(s, distance, length)
  378|       |#endif
  379|       |
  380|       |#endif /* DEFLATE_H */

/home/minseo/alfha/targets/zlib/target/inffast.c:
    1|       |/* inffast.c -- fast decoding
    2|       | * Copyright (C) 1995-2025 Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |#include "zutil.h"
    7|       |#include "inftrees.h"
    8|       |#include "inflate.h"
    9|       |#include "inffast.h"
   10|       |
   11|       |#ifdef ASMINF
   12|       |#  pragma message("Assembler code may have bugs -- use at your own risk")
   13|       |#else
   14|       |
   15|       |/*
   16|       |   Decode literal, length, and distance codes and write out the resulting
   17|       |   literal and match bytes until either not enough input or output is
   18|       |   available, an end-of-block is encountered, or a data error is encountered.
   19|       |   When large enough input and output buffers are supplied to inflate(), for
   20|       |   example, a 16K input buffer and a 64K output buffer, more than 95% of the
   21|       |   inflate execution time is spent in this routine.
   22|       |
   23|       |   Entry assumptions:
   24|       |
   25|       |        state->mode == LEN
   26|       |        strm->avail_in >= 6
   27|       |        strm->avail_out >= 258
   28|       |        start >= strm->avail_out
   29|       |        state->bits < 8
   30|       |
   31|       |   On return, state->mode is one of:
   32|       |
   33|       |        LEN -- ran out of enough output space or enough available input
   34|       |        TYPE -- reached end of block code, inflate() to interpret next block
   35|       |        BAD -- error in block data
   36|       |
   37|       |   Notes:
   38|       |
   39|       |    - The maximum input bits used by a length/distance pair is 15 bits for the
   40|       |      length code, 5 bits for the length extra, 15 bits for the distance code,
   41|       |      and 13 bits for the distance extra.  This totals 48 bits, or six bytes.
   42|       |      Therefore if strm->avail_in >= 6, then there is enough input to avoid
   43|       |      checking for available input while decoding.
   44|       |
   45|       |    - The maximum bytes that a single length/distance pair can output is 258
   46|       |      bytes, which is the maximum length that can be coded.  inflate_fast()
   47|       |      requires strm->avail_out >= 258 for each loop to avoid checking for
   48|       |      output space.
   49|       | */
   50|    494|void ZLIB_INTERNAL inflate_fast(z_streamp strm, unsigned start) {
   51|    494|    struct inflate_state FAR *state;
   52|    494|    z_const unsigned char FAR *in;      /* local strm->next_in */
   53|    494|    z_const unsigned char FAR *last;    /* have enough input while in < last */
   54|    494|    unsigned char FAR *out;     /* local strm->next_out */
   55|    494|    unsigned char FAR *beg;     /* inflate()'s initial strm->next_out */
   56|    494|    unsigned char FAR *end;     /* while out < end, enough space available */
   57|       |#ifdef INFLATE_STRICT
   58|       |    unsigned dmax;              /* maximum distance from zlib header */
   59|       |#endif
   60|    494|    unsigned wsize;             /* window size or zero if not using window */
   61|    494|    unsigned whave;             /* valid bytes in the window */
   62|    494|    unsigned wnext;             /* window write index */
   63|    494|    unsigned char FAR *window;  /* allocated sliding window, if wsize != 0 */
   64|    494|    unsigned long hold;         /* local strm->hold */
   65|    494|    unsigned bits;              /* local strm->bits */
   66|    494|    code const FAR *lcode;      /* local strm->lencode */
   67|    494|    code const FAR *dcode;      /* local strm->distcode */
   68|    494|    unsigned lmask;             /* mask for first level of length codes */
   69|    494|    unsigned dmask;             /* mask for first level of distance codes */
   70|    494|    code const *here;           /* retrieved table entry */
   71|    494|    unsigned op;                /* code bits, operation, extra bits, or */
   72|       |                                /*  window position, window bytes to copy */
   73|    494|    unsigned len;               /* match length, unused bytes */
   74|    494|    unsigned dist;              /* match distance */
   75|    494|    unsigned char FAR *from;    /* where to copy match from */
   76|       |
   77|       |    /* copy state to local variables */
   78|    494|    state = (struct inflate_state FAR *)strm->state;
   79|    494|    in = strm->next_in;
   80|    494|    last = in + (strm->avail_in - 5);
   81|    494|    out = strm->next_out;
   82|    494|    beg = out - (start - strm->avail_out);
   83|    494|    end = out + (strm->avail_out - 257);
   84|       |#ifdef INFLATE_STRICT
   85|       |    dmax = state->dmax;
   86|       |#endif
   87|    494|    wsize = state->wsize;
   88|    494|    whave = state->whave;
   89|    494|    wnext = state->wnext;
   90|    494|    window = state->window;
   91|    494|    hold = state->hold;
   92|    494|    bits = state->bits;
   93|    494|    lcode = state->lencode;
   94|    494|    dcode = state->distcode;
   95|    494|    lmask = (1U << state->lenbits) - 1;
   96|    494|    dmask = (1U << state->distbits) - 1;
   97|       |
   98|       |    /* decode literals and length/distances until end-of-block or not enough
   99|       |       input data or output space */
  100|  3.35k|    do {
  101|  3.35k|        if (bits < 15) {
  ------------------
  |  Branch (101:13): [True: 1.91k, False: 1.43k]
  ------------------
  102|  1.91k|            hold += (unsigned long)(*in++) << bits;
  103|  1.91k|            bits += 8;
  104|  1.91k|            hold += (unsigned long)(*in++) << bits;
  105|  1.91k|            bits += 8;
  106|  1.91k|        }
  107|  3.35k|        here = lcode + (hold & lmask);
  108|  3.35k|      dolen:
  109|  3.35k|        op = (unsigned)(here->bits);
  110|  3.35k|        hold >>= op;
  111|  3.35k|        bits -= op;
  112|  3.35k|        op = (unsigned)(here->op);
  113|  3.35k|        if (op == 0) {                          /* literal */
  ------------------
  |  Branch (113:13): [True: 2.55k, False: 797]
  ------------------
  114|  2.55k|            Tracevv((stderr, here->val >= 0x20 && here->val < 0x7f ?
  115|  2.55k|                    "inflate:         literal '%c'\n" :
  116|  2.55k|                    "inflate:         literal 0x%02x\n", here->val));
  117|  2.55k|            *out++ = (unsigned char)(here->val);
  118|  2.55k|        }
  119|    797|        else if (op & 16) {                     /* length base */
  ------------------
  |  Branch (119:18): [True: 791, False: 6]
  ------------------
  120|    791|            len = (unsigned)(here->val);
  121|    791|            op &= 15;                           /* number of extra bits */
  122|    791|            if (op) {
  ------------------
  |  Branch (122:17): [True: 634, False: 157]
  ------------------
  123|    634|                if (bits < op) {
  ------------------
  |  Branch (123:21): [True: 0, False: 634]
  ------------------
  124|      0|                    hold += (unsigned long)(*in++) << bits;
  125|      0|                    bits += 8;
  126|      0|                }
  127|    634|                len += (unsigned)hold & ((1U << op) - 1);
  128|    634|                hold >>= op;
  129|    634|                bits -= op;
  130|    634|            }
  131|    791|            Tracevv((stderr, "inflate:         length %u\n", len));
  132|    791|            if (bits < 15) {
  ------------------
  |  Branch (132:17): [True: 544, False: 247]
  ------------------
  133|    544|                hold += (unsigned long)(*in++) << bits;
  134|    544|                bits += 8;
  135|    544|                hold += (unsigned long)(*in++) << bits;
  136|    544|                bits += 8;
  137|    544|            }
  138|    791|            here = dcode + (hold & dmask);
  139|    791|          dodist:
  140|    791|            op = (unsigned)(here->bits);
  141|    791|            hold >>= op;
  142|    791|            bits -= op;
  143|    791|            op = (unsigned)(here->op);
  144|    791|            if (op & 16) {                      /* distance base */
  ------------------
  |  Branch (144:17): [True: 791, False: 0]
  ------------------
  145|    791|                dist = (unsigned)(here->val);
  146|    791|                op &= 15;                       /* number of extra bits */
  147|    791|                if (bits < op) {
  ------------------
  |  Branch (147:21): [True: 0, False: 791]
  ------------------
  148|      0|                    hold += (unsigned long)(*in++) << bits;
  149|      0|                    bits += 8;
  150|      0|                    if (bits < op) {
  ------------------
  |  Branch (150:25): [True: 0, False: 0]
  ------------------
  151|      0|                        hold += (unsigned long)(*in++) << bits;
  152|      0|                        bits += 8;
  153|      0|                    }
  154|      0|                }
  155|    791|                dist += (unsigned)hold & ((1U << op) - 1);
  156|       |#ifdef INFLATE_STRICT
  157|       |                if (dist > dmax) {
  158|       |                    strm->msg = (z_const char *)
  159|       |                        "invalid distance too far back";
  160|       |                    state->mode = BAD;
  161|       |                    break;
  162|       |                }
  163|       |#endif
  164|    791|                hold >>= op;
  165|    791|                bits -= op;
  166|    791|                Tracevv((stderr, "inflate:         distance %u\n", dist));
  167|    791|                op = (unsigned)(out - beg);     /* max distance in output */
  168|    791|                if (dist > op) {                /* see if copy from window */
  ------------------
  |  Branch (168:21): [True: 12, False: 779]
  ------------------
  169|     12|                    op = dist - op;             /* distance back in window */
  170|     12|                    if (op > whave) {
  ------------------
  |  Branch (170:25): [True: 12, False: 0]
  ------------------
  171|     12|                        if (state->sane) {
  ------------------
  |  Branch (171:29): [True: 12, False: 0]
  ------------------
  172|     12|                            strm->msg = (z_const char *)
  173|     12|                                "invalid distance too far back";
  174|     12|                            state->mode = BAD;
  175|     12|                            break;
  176|     12|                        }
  177|       |#ifdef INFLATE_ALLOW_INVALID_DISTANCE_TOOFAR_ARRR
  178|       |                        if (len <= op - whave) {
  179|       |                            do {
  180|       |                                *out++ = 0;
  181|       |                            } while (--len);
  182|       |                            continue;
  183|       |                        }
  184|       |                        len -= op - whave;
  185|       |                        do {
  186|       |                            *out++ = 0;
  187|       |                        } while (--op > whave);
  188|       |                        if (op == 0) {
  189|       |                            from = out - dist;
  190|       |                            do {
  191|       |                                *out++ = *from++;
  192|       |                            } while (--len);
  193|       |                            continue;
  194|       |                        }
  195|       |#endif
  196|     12|                    }
  197|      0|                    from = window;
  198|      0|                    if (wnext == 0) {           /* very common case */
  ------------------
  |  Branch (198:25): [True: 0, False: 0]
  ------------------
  199|      0|                        from += wsize - op;
  200|      0|                        if (op < len) {         /* some from window */
  ------------------
  |  Branch (200:29): [True: 0, False: 0]
  ------------------
  201|      0|                            len -= op;
  202|      0|                            do {
  203|      0|                                *out++ = *from++;
  204|      0|                            } while (--op);
  ------------------
  |  Branch (204:38): [True: 0, False: 0]
  ------------------
  205|      0|                            from = out - dist;  /* rest from output */
  206|      0|                        }
  207|      0|                    }
  208|      0|                    else if (wnext < op) {      /* wrap around window */
  ------------------
  |  Branch (208:30): [True: 0, False: 0]
  ------------------
  209|      0|                        from += wsize + wnext - op;
  210|      0|                        op -= wnext;
  211|      0|                        if (op < len) {         /* some from end of window */
  ------------------
  |  Branch (211:29): [True: 0, False: 0]
  ------------------
  212|      0|                            len -= op;
  213|      0|                            do {
  214|      0|                                *out++ = *from++;
  215|      0|                            } while (--op);
  ------------------
  |  Branch (215:38): [True: 0, False: 0]
  ------------------
  216|      0|                            from = window;
  217|      0|                            if (wnext < len) {  /* some from start of window */
  ------------------
  |  Branch (217:33): [True: 0, False: 0]
  ------------------
  218|      0|                                op = wnext;
  219|      0|                                len -= op;
  220|      0|                                do {
  221|      0|                                    *out++ = *from++;
  222|      0|                                } while (--op);
  ------------------
  |  Branch (222:42): [True: 0, False: 0]
  ------------------
  223|      0|                                from = out - dist;      /* rest from output */
  224|      0|                            }
  225|      0|                        }
  226|      0|                    }
  227|      0|                    else {                      /* contiguous in window */
  228|      0|                        from += wnext - op;
  229|      0|                        if (op < len) {         /* some from window */
  ------------------
  |  Branch (229:29): [True: 0, False: 0]
  ------------------
  230|      0|                            len -= op;
  231|      0|                            do {
  232|      0|                                *out++ = *from++;
  233|      0|                            } while (--op);
  ------------------
  |  Branch (233:38): [True: 0, False: 0]
  ------------------
  234|      0|                            from = out - dist;  /* rest from output */
  235|      0|                        }
  236|      0|                    }
  237|      0|                    while (len > 2) {
  ------------------
  |  Branch (237:28): [True: 0, False: 0]
  ------------------
  238|      0|                        *out++ = *from++;
  239|      0|                        *out++ = *from++;
  240|      0|                        *out++ = *from++;
  241|      0|                        len -= 3;
  242|      0|                    }
  243|      0|                    if (len) {
  ------------------
  |  Branch (243:25): [True: 0, False: 0]
  ------------------
  244|      0|                        *out++ = *from++;
  245|      0|                        if (len > 1)
  ------------------
  |  Branch (245:29): [True: 0, False: 0]
  ------------------
  246|      0|                            *out++ = *from++;
  247|      0|                    }
  248|      0|                }
  249|    779|                else {
  250|    779|                    from = out - dist;          /* copy direct from output */
  251|  14.9k|                    do {                        /* minimum length is three */
  252|  14.9k|                        *out++ = *from++;
  253|  14.9k|                        *out++ = *from++;
  254|  14.9k|                        *out++ = *from++;
  255|  14.9k|                        len -= 3;
  256|  14.9k|                    } while (len > 2);
  ------------------
  |  Branch (256:30): [True: 14.1k, False: 779]
  ------------------
  257|    779|                    if (len) {
  ------------------
  |  Branch (257:25): [True: 528, False: 251]
  ------------------
  258|    528|                        *out++ = *from++;
  259|    528|                        if (len > 1)
  ------------------
  |  Branch (259:29): [True: 265, False: 263]
  ------------------
  260|    265|                            *out++ = *from++;
  261|    528|                    }
  262|    779|                }
  263|    791|            }
  264|      0|            else if ((op & 64) == 0) {          /* 2nd level distance code */
  ------------------
  |  Branch (264:22): [True: 0, False: 0]
  ------------------
  265|      0|                here = dcode + here->val + (hold & ((1U << op) - 1));
  266|      0|                goto dodist;
  267|      0|            }
  268|      0|            else {
  269|      0|                strm->msg = (z_const char *)"invalid distance code";
  270|      0|                state->mode = BAD;
  271|      0|                break;
  272|      0|            }
  273|    791|        }
  274|      6|        else if ((op & 64) == 0) {              /* 2nd level length code */
  ------------------
  |  Branch (274:18): [True: 0, False: 6]
  ------------------
  275|      0|            here = lcode + here->val + (hold & ((1U << op) - 1));
  276|      0|            goto dolen;
  277|      0|        }
  278|      6|        else if (op & 32) {                     /* end-of-block */
  ------------------
  |  Branch (278:18): [True: 5, False: 1]
  ------------------
  279|      5|            Tracevv((stderr, "inflate:         end of block\n"));
  280|      5|            state->mode = TYPE;
  281|      5|            break;
  282|      5|        }
  283|      1|        else {
  284|      1|            strm->msg = (z_const char *)"invalid literal/length code";
  285|      1|            state->mode = BAD;
  286|      1|            break;
  287|      1|        }
  288|  3.35k|    } while (in < last && out < end);
                           ^3.33k       ^3.32k
  ------------------
  |  Branch (288:14): [True: 3.32k, False: 9]
  |  Branch (288:27): [True: 2.85k, False: 467]
  ------------------
  289|       |
  290|       |    /* return unused bytes (on entry, bits < 8, so in won't go too far back) */
  291|    494|    len = bits >> 3;
  292|    494|    in -= len;
  293|    494|    bits -= len << 3;
  294|    494|    hold &= (1U << bits) - 1;
  295|       |
  296|       |    /* update state and return */
  297|    494|    strm->next_in = in;
  298|    494|    strm->next_out = out;
  299|    494|    strm->avail_in = (unsigned)(in < last ? 5 + (last - in) : 5 - (in - last));
                                                                            ^0
  ------------------
  |  Branch (299:33): [True: 494, False: 0]
  ------------------
  300|    494|    strm->avail_out = (unsigned)(out < end ?
  ------------------
  |  Branch (300:34): [True: 18, False: 476]
  ------------------
  301|    476|                                 257 + (end - out) : 257 - (out - end));
                                               ^18
  302|    494|    state->hold = hold;
  303|    494|    state->bits = bits;
  304|    494|    return;
  305|    494|}
  306|       |
  307|       |/*
  308|       |   inflate_fast() speedups that turned out slower (on a PowerPC G3 750CXe):
  309|       |   - Using bit fields for code structure
  310|       |   - Different op definition to avoid & for extra bits (do & for table bits)
  311|       |   - Three separate decoding do-loops for direct, window, and wnext == 0
  312|       |   - Special case for distance > 1 copies to do overlapped load and store copy
  313|       |   - Explicit branch predictions (based on measured branch probabilities)
  314|       |   - Deferring match copy and interspersed it with decoding subsequent codes
  315|       |   - Swapping literal/length else
  316|       |   - Swapping window/direct else
  317|       |   - Larger unrolled copy loops (three is about right)
  318|       |   - Moving len -= 3 statement into middle of loop
  319|       | */
  320|       |
  321|       |#endif /* !ASMINF */

/home/minseo/alfha/targets/zlib/target/inffixed.h:
    1|       |    /* inffixed.h -- table for decoding fixed codes
    2|       |     * Generated automatically by makefixed().
    3|       |     */
    4|       |
    5|       |    /* WARNING: this file should *not* be used by applications.
    6|       |       It is part of the implementation of this library and is
    7|       |       subject to change. Applications should only use zlib.h.
    8|       |     */
    9|       |
   10|   265k|    static const code lenfix[512] = {
   11|   265k|        {96,7,0},{0,8,80},{0,8,16},{20,8,115},{18,7,31},{0,8,112},{0,8,48},
   12|   265k|        {0,9,192},{16,7,10},{0,8,96},{0,8,32},{0,9,160},{0,8,0},{0,8,128},
   13|   265k|        {0,8,64},{0,9,224},{16,7,6},{0,8,88},{0,8,24},{0,9,144},{19,7,59},
   14|   265k|        {0,8,120},{0,8,56},{0,9,208},{17,7,17},{0,8,104},{0,8,40},{0,9,176},
   15|   265k|        {0,8,8},{0,8,136},{0,8,72},{0,9,240},{16,7,4},{0,8,84},{0,8,20},
   16|   265k|        {21,8,227},{19,7,43},{0,8,116},{0,8,52},{0,9,200},{17,7,13},{0,8,100},
   17|   265k|        {0,8,36},{0,9,168},{0,8,4},{0,8,132},{0,8,68},{0,9,232},{16,7,8},
   18|   265k|        {0,8,92},{0,8,28},{0,9,152},{20,7,83},{0,8,124},{0,8,60},{0,9,216},
   19|   265k|        {18,7,23},{0,8,108},{0,8,44},{0,9,184},{0,8,12},{0,8,140},{0,8,76},
   20|   265k|        {0,9,248},{16,7,3},{0,8,82},{0,8,18},{21,8,163},{19,7,35},{0,8,114},
   21|   265k|        {0,8,50},{0,9,196},{17,7,11},{0,8,98},{0,8,34},{0,9,164},{0,8,2},
   22|   265k|        {0,8,130},{0,8,66},{0,9,228},{16,7,7},{0,8,90},{0,8,26},{0,9,148},
   23|   265k|        {20,7,67},{0,8,122},{0,8,58},{0,9,212},{18,7,19},{0,8,106},{0,8,42},
   24|   265k|        {0,9,180},{0,8,10},{0,8,138},{0,8,74},{0,9,244},{16,7,5},{0,8,86},
   25|   265k|        {0,8,22},{64,8,0},{19,7,51},{0,8,118},{0,8,54},{0,9,204},{17,7,15},
   26|   265k|        {0,8,102},{0,8,38},{0,9,172},{0,8,6},{0,8,134},{0,8,70},{0,9,236},
   27|   265k|        {16,7,9},{0,8,94},{0,8,30},{0,9,156},{20,7,99},{0,8,126},{0,8,62},
   28|   265k|        {0,9,220},{18,7,27},{0,8,110},{0,8,46},{0,9,188},{0,8,14},{0,8,142},
   29|   265k|        {0,8,78},{0,9,252},{96,7,0},{0,8,81},{0,8,17},{21,8,131},{18,7,31},
   30|   265k|        {0,8,113},{0,8,49},{0,9,194},{16,7,10},{0,8,97},{0,8,33},{0,9,162},
   31|   265k|        {0,8,1},{0,8,129},{0,8,65},{0,9,226},{16,7,6},{0,8,89},{0,8,25},
   32|   265k|        {0,9,146},{19,7,59},{0,8,121},{0,8,57},{0,9,210},{17,7,17},{0,8,105},
   33|   265k|        {0,8,41},{0,9,178},{0,8,9},{0,8,137},{0,8,73},{0,9,242},{16,7,4},
   34|   265k|        {0,8,85},{0,8,21},{16,8,258},{19,7,43},{0,8,117},{0,8,53},{0,9,202},
   35|   265k|        {17,7,13},{0,8,101},{0,8,37},{0,9,170},{0,8,5},{0,8,133},{0,8,69},
   36|   265k|        {0,9,234},{16,7,8},{0,8,93},{0,8,29},{0,9,154},{20,7,83},{0,8,125},
   37|   265k|        {0,8,61},{0,9,218},{18,7,23},{0,8,109},{0,8,45},{0,9,186},{0,8,13},
   38|   265k|        {0,8,141},{0,8,77},{0,9,250},{16,7,3},{0,8,83},{0,8,19},{21,8,195},
   39|   265k|        {19,7,35},{0,8,115},{0,8,51},{0,9,198},{17,7,11},{0,8,99},{0,8,35},
   40|   265k|        {0,9,166},{0,8,3},{0,8,131},{0,8,67},{0,9,230},{16,7,7},{0,8,91},
   41|   265k|        {0,8,27},{0,9,150},{20,7,67},{0,8,123},{0,8,59},{0,9,214},{18,7,19},
   42|   265k|        {0,8,107},{0,8,43},{0,9,182},{0,8,11},{0,8,139},{0,8,75},{0,9,246},
   43|   265k|        {16,7,5},{0,8,87},{0,8,23},{64,8,0},{19,7,51},{0,8,119},{0,8,55},
   44|   265k|        {0,9,206},{17,7,15},{0,8,103},{0,8,39},{0,9,174},{0,8,7},{0,8,135},
   45|   265k|        {0,8,71},{0,9,238},{16,7,9},{0,8,95},{0,8,31},{0,9,158},{20,7,99},
   46|   265k|        {0,8,127},{0,8,63},{0,9,222},{18,7,27},{0,8,111},{0,8,47},{0,9,190},
   47|   265k|        {0,8,15},{0,8,143},{0,8,79},{0,9,254},{96,7,0},{0,8,80},{0,8,16},
   48|   265k|        {20,8,115},{18,7,31},{0,8,112},{0,8,48},{0,9,193},{16,7,10},{0,8,96},
   49|   265k|        {0,8,32},{0,9,161},{0,8,0},{0,8,128},{0,8,64},{0,9,225},{16,7,6},
   50|   265k|        {0,8,88},{0,8,24},{0,9,145},{19,7,59},{0,8,120},{0,8,56},{0,9,209},
   51|   265k|        {17,7,17},{0,8,104},{0,8,40},{0,9,177},{0,8,8},{0,8,136},{0,8,72},
   52|   265k|        {0,9,241},{16,7,4},{0,8,84},{0,8,20},{21,8,227},{19,7,43},{0,8,116},
   53|   265k|        {0,8,52},{0,9,201},{17,7,13},{0,8,100},{0,8,36},{0,9,169},{0,8,4},
   54|   265k|        {0,8,132},{0,8,68},{0,9,233},{16,7,8},{0,8,92},{0,8,28},{0,9,153},
   55|   265k|        {20,7,83},{0,8,124},{0,8,60},{0,9,217},{18,7,23},{0,8,108},{0,8,44},
   56|   265k|        {0,9,185},{0,8,12},{0,8,140},{0,8,76},{0,9,249},{16,7,3},{0,8,82},
   57|   265k|        {0,8,18},{21,8,163},{19,7,35},{0,8,114},{0,8,50},{0,9,197},{17,7,11},
   58|   265k|        {0,8,98},{0,8,34},{0,9,165},{0,8,2},{0,8,130},{0,8,66},{0,9,229},
   59|   265k|        {16,7,7},{0,8,90},{0,8,26},{0,9,149},{20,7,67},{0,8,122},{0,8,58},
   60|   265k|        {0,9,213},{18,7,19},{0,8,106},{0,8,42},{0,9,181},{0,8,10},{0,8,138},
   61|   265k|        {0,8,74},{0,9,245},{16,7,5},{0,8,86},{0,8,22},{64,8,0},{19,7,51},
   62|   265k|        {0,8,118},{0,8,54},{0,9,205},{17,7,15},{0,8,102},{0,8,38},{0,9,173},
   63|   265k|        {0,8,6},{0,8,134},{0,8,70},{0,9,237},{16,7,9},{0,8,94},{0,8,30},
   64|   265k|        {0,9,157},{20,7,99},{0,8,126},{0,8,62},{0,9,221},{18,7,27},{0,8,110},
   65|   265k|        {0,8,46},{0,9,189},{0,8,14},{0,8,142},{0,8,78},{0,9,253},{96,7,0},
   66|   265k|        {0,8,81},{0,8,17},{21,8,131},{18,7,31},{0,8,113},{0,8,49},{0,9,195},
   67|   265k|        {16,7,10},{0,8,97},{0,8,33},{0,9,163},{0,8,1},{0,8,129},{0,8,65},
   68|   265k|        {0,9,227},{16,7,6},{0,8,89},{0,8,25},{0,9,147},{19,7,59},{0,8,121},
   69|   265k|        {0,8,57},{0,9,211},{17,7,17},{0,8,105},{0,8,41},{0,9,179},{0,8,9},
   70|   265k|        {0,8,137},{0,8,73},{0,9,243},{16,7,4},{0,8,85},{0,8,21},{16,8,258},
   71|   265k|        {19,7,43},{0,8,117},{0,8,53},{0,9,203},{17,7,13},{0,8,101},{0,8,37},
   72|   265k|        {0,9,171},{0,8,5},{0,8,133},{0,8,69},{0,9,235},{16,7,8},{0,8,93},
   73|   265k|        {0,8,29},{0,9,155},{20,7,83},{0,8,125},{0,8,61},{0,9,219},{18,7,23},
   74|   265k|        {0,8,109},{0,8,45},{0,9,187},{0,8,13},{0,8,141},{0,8,77},{0,9,251},
   75|   265k|        {16,7,3},{0,8,83},{0,8,19},{21,8,195},{19,7,35},{0,8,115},{0,8,51},
   76|   265k|        {0,9,199},{17,7,11},{0,8,99},{0,8,35},{0,9,167},{0,8,3},{0,8,131},
   77|   265k|        {0,8,67},{0,9,231},{16,7,7},{0,8,91},{0,8,27},{0,9,151},{20,7,67},
   78|   265k|        {0,8,123},{0,8,59},{0,9,215},{18,7,19},{0,8,107},{0,8,43},{0,9,183},
   79|   265k|        {0,8,11},{0,8,139},{0,8,75},{0,9,247},{16,7,5},{0,8,87},{0,8,23},
   80|   265k|        {64,8,0},{19,7,51},{0,8,119},{0,8,55},{0,9,207},{17,7,15},{0,8,103},
   81|   265k|        {0,8,39},{0,9,175},{0,8,7},{0,8,135},{0,8,71},{0,9,239},{16,7,9},
   82|   265k|        {0,8,95},{0,8,31},{0,9,159},{20,7,99},{0,8,127},{0,8,63},{0,9,223},
   83|   265k|        {18,7,27},{0,8,111},{0,8,47},{0,9,191},{0,8,15},{0,8,143},{0,8,79},
   84|   265k|        {0,9,255}
   85|   265k|    };
   86|       |
   87|   265k|    static const code distfix[32] = {
   88|   265k|        {16,5,1},{23,5,257},{19,5,17},{27,5,4097},{17,5,5},{25,5,1025},
   89|   265k|        {21,5,65},{29,5,16385},{16,5,3},{24,5,513},{20,5,33},{28,5,8193},
   90|   265k|        {18,5,9},{26,5,2049},{22,5,129},{64,5,0},{16,5,2},{23,5,385},
   91|   265k|        {19,5,25},{27,5,6145},{17,5,7},{25,5,1537},{21,5,97},{29,5,24577},
   92|   265k|        {16,5,4},{24,5,769},{20,5,49},{28,5,12289},{18,5,13},{26,5,3073},
   93|   265k|        {22,5,193},{64,5,0}
   94|   265k|    };

/home/minseo/alfha/targets/zlib/target/inflate.c:
    1|       |/* inflate.c -- zlib decompression
    2|       | * Copyright (C) 1995-2025 Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/*
    7|       | * Change history:
    8|       | *
    9|       | * 1.2.beta0    24 Nov 2002
   10|       | * - First version -- complete rewrite of inflate to simplify code, avoid
   11|       | *   creation of window when not needed, minimize use of window when it is
   12|       | *   needed, make inffast.c even faster, implement gzip decoding, and to
   13|       | *   improve code readability and style over the previous zlib inflate code
   14|       | *
   15|       | * 1.2.beta1    25 Nov 2002
   16|       | * - Use pointers for available input and output checking in inffast.c
   17|       | * - Remove input and output counters in inffast.c
   18|       | * - Change inffast.c entry and loop from avail_in >= 7 to >= 6
   19|       | * - Remove unnecessary second byte pull from length extra in inffast.c
   20|       | * - Unroll direct copy to three copies per loop in inffast.c
   21|       | *
   22|       | * 1.2.beta2    4 Dec 2002
   23|       | * - Change external routine names to reduce potential conflicts
   24|       | * - Correct filename to inffixed.h for fixed tables in inflate.c
   25|       | * - Make hbuf[] unsigned char to match parameter type in inflate.c
   26|       | * - Change strm->next_out[-state->offset] to *(strm->next_out - state->offset)
   27|       | *   to avoid negation problem on Alphas (64 bit) in inflate.c
   28|       | *
   29|       | * 1.2.beta3    22 Dec 2002
   30|       | * - Add comments on state->bits assertion in inffast.c
   31|       | * - Add comments on op field in inftrees.h
   32|       | * - Fix bug in reuse of allocated window after inflateReset()
   33|       | * - Remove bit fields--back to byte structure for speed
   34|       | * - Remove distance extra == 0 check in inflate_fast()--only helps for lengths
   35|       | * - Change post-increments to pre-increments in inflate_fast(), PPC biased?
   36|       | * - Add compile time option, POSTINC, to use post-increments instead (Intel?)
   37|       | * - Make MATCH copy in inflate() much faster for when inflate_fast() not used
   38|       | * - Use local copies of stream next and avail values, as well as local bit
   39|       | *   buffer and bit count in inflate()--for speed when inflate_fast() not used
   40|       | *
   41|       | * 1.2.beta4    1 Jan 2003
   42|       | * - Split ptr - 257 statements in inflate_table() to avoid compiler warnings
   43|       | * - Move a comment on output buffer sizes from inffast.c to inflate.c
   44|       | * - Add comments in inffast.c to introduce the inflate_fast() routine
   45|       | * - Rearrange window copies in inflate_fast() for speed and simplification
   46|       | * - Unroll last copy for window match in inflate_fast()
   47|       | * - Use local copies of window variables in inflate_fast() for speed
   48|       | * - Pull out common wnext == 0 case for speed in inflate_fast()
   49|       | * - Make op and len in inflate_fast() unsigned for consistency
   50|       | * - Add FAR to lcode and dcode declarations in inflate_fast()
   51|       | * - Simplified bad distance check in inflate_fast()
   52|       | * - Added inflateBackInit(), inflateBack(), and inflateBackEnd() in new
   53|       | *   source file infback.c to provide a call-back interface to inflate for
   54|       | *   programs like gzip and unzip -- uses window as output buffer to avoid
   55|       | *   window copying
   56|       | *
   57|       | * 1.2.beta5    1 Jan 2003
   58|       | * - Improved inflateBack() interface to allow the caller to provide initial
   59|       | *   input in strm.
   60|       | * - Fixed stored blocks bug in inflateBack()
   61|       | *
   62|       | * 1.2.beta6    4 Jan 2003
   63|       | * - Added comments in inffast.c on effectiveness of POSTINC
   64|       | * - Typecasting all around to reduce compiler warnings
   65|       | * - Changed loops from while (1) or do {} while (1) to for (;;), again to
   66|       | *   make compilers happy
   67|       | * - Changed type of window in inflateBackInit() to unsigned char *
   68|       | *
   69|       | * 1.2.beta7    27 Jan 2003
   70|       | * - Changed many types to unsigned or unsigned short to avoid warnings
   71|       | * - Added inflateCopy() function
   72|       | *
   73|       | * 1.2.0        9 Mar 2003
   74|       | * - Changed inflateBack() interface to provide separate opaque descriptors
   75|       | *   for the in() and out() functions
   76|       | * - Changed inflateBack() argument and in_func typedef to swap the length
   77|       | *   and buffer address return values for the input function
   78|       | * - Check next_in and next_out for Z_NULL on entry to inflate()
   79|       | *
   80|       | * The history for versions after 1.2.0 are in ChangeLog in zlib distribution.
   81|       | */
   82|       |
   83|       |#include "zutil.h"
   84|       |#include "inftrees.h"
   85|       |#include "inflate.h"
   86|       |#include "inffast.h"
   87|       |
   88|       |#ifdef MAKEFIXED
   89|       |#  ifndef BUILDFIXED
   90|       |#    define BUILDFIXED
   91|       |#  endif
   92|       |#endif
   93|       |
   94|  2.64M|local int inflateStateCheck(z_streamp strm) {
   95|  2.64M|    struct inflate_state FAR *state;
   96|  2.64M|    if (strm == Z_NULL ||
  ------------------
  |  Branch (96:9): [True: 0, False: 2.64M]
  ------------------
   97|  2.64M|        strm->zalloc == (alloc_func)0 || strm->zfree == (free_func)0)
  ------------------
  |  Branch (97:9): [True: 0, False: 2.64M]
  |  Branch (97:42): [True: 0, False: 2.64M]
  ------------------
   98|      0|        return 1;
   99|  2.64M|    state = (struct inflate_state FAR *)strm->state;
  100|  2.64M|    if (state == Z_NULL || state->strm != strm ||
  ------------------
  |  Branch (100:9): [True: 0, False: 2.64M]
  |  Branch (100:28): [True: 0, False: 2.64M]
  ------------------
  101|  2.64M|        state->mode < HEAD || state->mode > SYNC)
  ------------------
  |  Branch (101:9): [True: 0, False: 2.64M]
  |  Branch (101:31): [True: 0, False: 2.64M]
  ------------------
  102|      0|        return 1;
  103|  2.64M|    return 0;
  104|  2.64M|}
  105|       |
  106|   526k|int ZEXPORT inflateResetKeep(z_streamp strm) {
  107|   526k|    struct inflate_state FAR *state;
  108|       |
  109|   526k|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
                                               ^0     ^0
  ------------------
  |  Branch (109:9): [True: 0, False: 526k]
  ------------------
  110|   526k|    state = (struct inflate_state FAR *)strm->state;
  111|   526k|    strm->total_in = strm->total_out = state->total = 0;
  112|   526k|    strm->msg = Z_NULL;
  113|   526k|    strm->data_type = 0;
  114|   526k|    if (state->wrap)        /* to support ill-conceived Java test suite */
  ------------------
  |  Branch (114:9): [True: 526k, False: 0]
  ------------------
  115|   526k|        strm->adler = state->wrap & 1;
  116|   526k|    state->mode = HEAD;
  117|   526k|    state->last = 0;
  118|   526k|    state->havedict = 0;
  119|   526k|    state->flags = -1;
  120|   526k|    state->dmax = 32768U;
  121|   526k|    state->head = Z_NULL;
  122|   526k|    state->hold = 0;
  123|   526k|    state->bits = 0;
  124|   526k|    state->lencode = state->distcode = state->next = state->codes;
  125|   526k|    state->sane = 1;
  126|   526k|    state->back = -1;
  127|   526k|    Tracev((stderr, "inflate: reset\n"));
  128|   526k|    return Z_OK;
  129|   526k|}
  130|       |
  131|   526k|int ZEXPORT inflateReset(z_streamp strm) {
  132|   526k|    struct inflate_state FAR *state;
  133|       |
  134|   526k|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
                                               ^0     ^0
  ------------------
  |  Branch (134:9): [True: 0, False: 526k]
  ------------------
  135|   526k|    state = (struct inflate_state FAR *)strm->state;
  136|   526k|    state->wsize = 0;
  137|   526k|    state->whave = 0;
  138|   526k|    state->wnext = 0;
  139|   526k|    return inflateResetKeep(strm);
  140|   526k|}
  141|       |
  142|   526k|int ZEXPORT inflateReset2(z_streamp strm, int windowBits) {
  143|   526k|    int wrap;
  144|   526k|    struct inflate_state FAR *state;
  145|       |
  146|       |    /* get the state */
  147|   526k|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
                                               ^0     ^0
  ------------------
  |  Branch (147:9): [True: 0, False: 526k]
  ------------------
  148|   526k|    state = (struct inflate_state FAR *)strm->state;
  149|       |
  150|       |    /* extract wrap request from windowBits parameter */
  151|   526k|    if (windowBits < 0) {
  ------------------
  |  Branch (151:9): [True: 0, False: 526k]
  ------------------
  152|      0|        if (windowBits < -15)
  ------------------
  |  Branch (152:13): [True: 0, False: 0]
  ------------------
  153|      0|            return Z_STREAM_ERROR;
  154|      0|        wrap = 0;
  155|      0|        windowBits = -windowBits;
  156|      0|    }
  157|   526k|    else {
  158|   526k|        wrap = (windowBits >> 4) + 5;
  159|   526k|#ifdef GUNZIP
  160|   526k|        if (windowBits < 48)
  ------------------
  |  Branch (160:13): [True: 526k, False: 0]
  ------------------
  161|   526k|            windowBits &= 15;
  162|   526k|#endif
  163|   526k|    }
  164|       |
  165|       |    /* set number of window bits, free window if different */
  166|   526k|    if (windowBits && (windowBits < 8 || windowBits > 15))
  ------------------
  |  Branch (166:9): [True: 526k, False: 0]
  |  Branch (166:24): [True: 0, False: 526k]
  |  Branch (166:42): [True: 0, False: 526k]
  ------------------
  167|      0|        return Z_STREAM_ERROR;
  168|   526k|    if (state->window != Z_NULL && state->wbits != (unsigned)windowBits) {
                                                 ^0
  ------------------
  |  Branch (168:9): [True: 0, False: 526k]
  |  Branch (168:36): [True: 0, False: 0]
  ------------------
  169|      0|        ZFREE(strm, state->window);
  170|      0|        state->window = Z_NULL;
  171|      0|    }
  172|       |
  173|       |    /* update state and reset the rest of it */
  174|   526k|    state->wrap = wrap;
  175|   526k|    state->wbits = (unsigned)windowBits;
  176|   526k|    return inflateReset(strm);
  177|   526k|}
  178|       |
  179|       |int ZEXPORT inflateInit2_(z_streamp strm, int windowBits,
  180|   526k|                          const char *version, int stream_size) {
  181|   526k|    int ret;
  182|   526k|    struct inflate_state FAR *state;
  183|       |
  184|   526k|    if (version == Z_NULL || version[0] != ZLIB_VERSION[0] ||
  ------------------
  |  Branch (184:9): [True: 0, False: 526k]
  |  Branch (184:30): [True: 0, False: 526k]
  ------------------
  185|   526k|        stream_size != (int)(sizeof(z_stream)))
  ------------------
  |  Branch (185:9): [True: 0, False: 526k]
  ------------------
  186|      0|        return Z_VERSION_ERROR;
  187|   526k|    if (strm == Z_NULL) return Z_STREAM_ERROR;
                                      ^0     ^0
  ------------------
  |  Branch (187:9): [True: 0, False: 526k]
  ------------------
  188|   526k|    strm->msg = Z_NULL;                 /* in case we return an error */
  189|   526k|    if (strm->zalloc == (alloc_func)0) {
  ------------------
  |  Branch (189:9): [True: 526k, False: 0]
  ------------------
  190|       |#ifdef Z_SOLO
  191|       |        return Z_STREAM_ERROR;
  192|       |#else
  193|   526k|        strm->zalloc = zcalloc;
  194|   526k|        strm->opaque = (voidpf)0;
  195|   526k|#endif
  196|   526k|    }
  197|   526k|    if (strm->zfree == (free_func)0)
  ------------------
  |  Branch (197:9): [True: 526k, False: 0]
  ------------------
  198|       |#ifdef Z_SOLO
  199|       |        return Z_STREAM_ERROR;
  200|       |#else
  201|   526k|        strm->zfree = zcfree;
  202|   526k|#endif
  203|   526k|    state = (struct inflate_state FAR *)
  204|   526k|            ZALLOC(strm, 1, sizeof(struct inflate_state));
  205|   526k|    if (state == Z_NULL) return Z_MEM_ERROR;
                                       ^0     ^0
  ------------------
  |  Branch (205:9): [True: 0, False: 526k]
  ------------------
  206|   526k|    Tracev((stderr, "inflate: allocated\n"));
  207|   526k|    strm->state = (struct internal_state FAR *)state;
  208|   526k|    state->strm = strm;
  209|   526k|    state->window = Z_NULL;
  210|   526k|    state->mode = HEAD;     /* to pass state test in inflateReset2() */
  211|   526k|    ret = inflateReset2(strm, windowBits);
  212|   526k|    if (ret != Z_OK) {
  ------------------
  |  Branch (212:9): [True: 0, False: 526k]
  ------------------
  213|      0|        ZFREE(strm, state);
  214|      0|        strm->state = Z_NULL;
  215|      0|    }
  216|   526k|    return ret;
  217|   526k|}
  218|       |
  219|       |int ZEXPORT inflateInit_(z_streamp strm, const char *version,
  220|   526k|                         int stream_size) {
  221|   526k|    return inflateInit2_(strm, DEF_WBITS, version, stream_size);
  222|   526k|}
  223|       |
  224|      0|int ZEXPORT inflatePrime(z_streamp strm, int bits, int value) {
  225|      0|    struct inflate_state FAR *state;
  226|       |
  227|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (227:9): [True: 0, False: 0]
  ------------------
  228|      0|    if (bits == 0)
  ------------------
  |  Branch (228:9): [True: 0, False: 0]
  ------------------
  229|      0|        return Z_OK;
  230|      0|    state = (struct inflate_state FAR *)strm->state;
  231|      0|    if (bits < 0) {
  ------------------
  |  Branch (231:9): [True: 0, False: 0]
  ------------------
  232|      0|        state->hold = 0;
  233|      0|        state->bits = 0;
  234|      0|        return Z_OK;
  235|      0|    }
  236|      0|    if (bits > 16 || state->bits + (uInt)bits > 32) return Z_STREAM_ERROR;
  ------------------
  |  Branch (236:9): [True: 0, False: 0]
  |  Branch (236:22): [True: 0, False: 0]
  ------------------
  237|      0|    value &= (1L << bits) - 1;
  238|      0|    state->hold += (unsigned long)value << state->bits;
  239|      0|    state->bits += (uInt)bits;
  240|      0|    return Z_OK;
  241|      0|}
  242|       |
  243|       |/*
  244|       |   Return state with length and distance decoding tables and index sizes set to
  245|       |   fixed code decoding.  Normally this returns fixed tables from inffixed.h.
  246|       |   If BUILDFIXED is defined, then instead this routine builds the tables the
  247|       |   first time it's called, and returns those tables the first time and
  248|       |   thereafter.  This reduces the size of the code by about 2K bytes, in
  249|       |   exchange for a little execution time.  However, BUILDFIXED should not be
  250|       |   used for threaded applications, since the rewriting of the tables and virgin
  251|       |   may not be thread-safe.
  252|       | */
  253|   265k|local void fixedtables(struct inflate_state FAR *state) {
  254|       |#ifdef BUILDFIXED
  255|       |    static int virgin = 1;
  256|       |    static code *lenfix, *distfix;
  257|       |    static code fixed[544];
  258|       |
  259|       |    /* build fixed huffman tables if first call (may not be thread safe) */
  260|       |    if (virgin) {
  261|       |        unsigned sym, bits;
  262|       |        static code *next;
  263|       |
  264|       |        /* literal/length table */
  265|       |        sym = 0;
  266|       |        while (sym < 144) state->lens[sym++] = 8;
  267|       |        while (sym < 256) state->lens[sym++] = 9;
  268|       |        while (sym < 280) state->lens[sym++] = 7;
  269|       |        while (sym < 288) state->lens[sym++] = 8;
  270|       |        next = fixed;
  271|       |        lenfix = next;
  272|       |        bits = 9;
  273|       |        inflate_table(LENS, state->lens, 288, &(next), &(bits), state->work);
  274|       |
  275|       |        /* distance table */
  276|       |        sym = 0;
  277|       |        while (sym < 32) state->lens[sym++] = 5;
  278|       |        distfix = next;
  279|       |        bits = 5;
  280|       |        inflate_table(DISTS, state->lens, 32, &(next), &(bits), state->work);
  281|       |
  282|       |        /* do this just once */
  283|       |        virgin = 0;
  284|       |    }
  285|       |#else /* !BUILDFIXED */
  286|   265k|#   include "inffixed.h"
  287|   265k|#endif /* BUILDFIXED */
  288|   265k|    state->lencode = lenfix;
  289|   265k|    state->lenbits = 9;
  290|   265k|    state->distcode = distfix;
  291|   265k|    state->distbits = 5;
  292|   265k|}
  293|       |
  294|       |#ifdef MAKEFIXED
  295|       |#include <stdio.h>
  296|       |
  297|       |/*
  298|       |   Write out the inffixed.h that is #include'd above.  Defining MAKEFIXED also
  299|       |   defines BUILDFIXED, so the tables are built on the fly.  makefixed() writes
  300|       |   those tables to stdout, which would be piped to inffixed.h.  A small program
  301|       |   can simply call makefixed to do this:
  302|       |
  303|       |    void makefixed(void);
  304|       |
  305|       |    int main(void)
  306|       |    {
  307|       |        makefixed();
  308|       |        return 0;
  309|       |    }
  310|       |
  311|       |   Then that can be linked with zlib built with MAKEFIXED defined and run:
  312|       |
  313|       |    a.out > inffixed.h
  314|       | */
  315|       |void makefixed(void)
  316|       |{
  317|       |    unsigned low, size;
  318|       |    struct inflate_state state;
  319|       |
  320|       |    fixedtables(&state);
  321|       |    puts("    /* inffixed.h -- table for decoding fixed codes");
  322|       |    puts("     * Generated automatically by makefixed().");
  323|       |    puts("     */");
  324|       |    puts("");
  325|       |    puts("    /* WARNING: this file should *not* be used by applications.");
  326|       |    puts("       It is part of the implementation of this library and is");
  327|       |    puts("       subject to change. Applications should only use zlib.h.");
  328|       |    puts("     */");
  329|       |    puts("");
  330|       |    size = 1U << 9;
  331|       |    printf("    static const code lenfix[%u] = {", size);
  332|       |    low = 0;
  333|       |    for (;;) {
  334|       |        if ((low % 7) == 0) printf("\n        ");
  335|       |        printf("{%u,%u,%d}", (low & 127) == 99 ? 64 : state.lencode[low].op,
  336|       |               state.lencode[low].bits, state.lencode[low].val);
  337|       |        if (++low == size) break;
  338|       |        putchar(',');
  339|       |    }
  340|       |    puts("\n    };");
  341|       |    size = 1U << 5;
  342|       |    printf("\n    static const code distfix[%u] = {", size);
  343|       |    low = 0;
  344|       |    for (;;) {
  345|       |        if ((low % 6) == 0) printf("\n        ");
  346|       |        printf("{%u,%u,%d}", state.distcode[low].op, state.distcode[low].bits,
  347|       |               state.distcode[low].val);
  348|       |        if (++low == size) break;
  349|       |        putchar(',');
  350|       |    }
  351|       |    puts("\n    };");
  352|       |}
  353|       |#endif /* MAKEFIXED */
  354|       |
  355|       |/*
  356|       |   Update the window with the last wsize (normally 32K) bytes written before
  357|       |   returning.  If window does not exist yet, create it.  This is only called
  358|       |   when a window is already in use, or when output has been written during this
  359|       |   inflate call, but the end of the deflate stream has not been reached yet.
  360|       |   It is also called to create a window for dictionary data when a dictionary
  361|       |   is loaded.
  362|       |
  363|       |   Providing output buffers larger than 32K to inflate() should provide a speed
  364|       |   advantage, since only the last 32K of output is copied to the sliding window
  365|       |   upon return from inflate(), and since all distances after the first 32K of
  366|       |   output will fall in the output data, making match copies simpler and faster.
  367|       |   The advantage may be dependent on the size of the processor's data caches.
  368|       | */
  369|  24.2k|local int updatewindow(z_streamp strm, const Bytef *end, unsigned copy) {
  370|  24.2k|    struct inflate_state FAR *state;
  371|  24.2k|    unsigned dist;
  372|       |
  373|  24.2k|    state = (struct inflate_state FAR *)strm->state;
  374|       |
  375|       |    /* if it hasn't been done already, allocate space for the window */
  376|  24.2k|    if (state->window == Z_NULL) {
  ------------------
  |  Branch (376:9): [True: 12.1k, False: 12.1k]
  ------------------
  377|  12.1k|        state->window = (unsigned char FAR *)
  378|  12.1k|                        ZALLOC(strm, 1U << state->wbits,
  379|  12.1k|                               sizeof(unsigned char));
  380|  12.1k|        if (state->window == Z_NULL) return 1;
                                                   ^0
  ------------------
  |  Branch (380:13): [True: 0, False: 12.1k]
  ------------------
  381|  12.1k|    }
  382|       |
  383|       |    /* if window not in use yet, initialize */
  384|  24.2k|    if (state->wsize == 0) {
  ------------------
  |  Branch (384:9): [True: 12.1k, False: 12.1k]
  ------------------
  385|  12.1k|        state->wsize = 1U << state->wbits;
  386|  12.1k|        state->wnext = 0;
  387|  12.1k|        state->whave = 0;
  388|  12.1k|    }
  389|       |
  390|       |    /* copy state->wsize or less output bytes into the circular window */
  391|  24.2k|    if (copy >= state->wsize) {
  ------------------
  |  Branch (391:9): [True: 0, False: 24.2k]
  ------------------
  392|      0|        zmemcpy(state->window, end - state->wsize, state->wsize);
  393|      0|        state->wnext = 0;
  394|      0|        state->whave = state->wsize;
  395|      0|    }
  396|  24.2k|    else {
  397|  24.2k|        dist = state->wsize - state->wnext;
  398|  24.2k|        if (dist > copy) dist = copy;
  ------------------
  |  Branch (398:13): [True: 24.2k, False: 0]
  ------------------
  399|  24.2k|        zmemcpy(state->window + state->wnext, end - copy, dist);
  400|  24.2k|        copy -= dist;
  401|  24.2k|        if (copy) {
  ------------------
  |  Branch (401:13): [True: 0, False: 24.2k]
  ------------------
  402|      0|            zmemcpy(state->window, end - copy, copy);
  403|      0|            state->wnext = copy;
  404|      0|            state->whave = state->wsize;
  405|      0|        }
  406|  24.2k|        else {
  407|  24.2k|            state->wnext += dist;
  408|  24.2k|            if (state->wnext == state->wsize) state->wnext = 0;
                                                            ^0
  ------------------
  |  Branch (408:17): [True: 0, False: 24.2k]
  ------------------
  409|  24.2k|            if (state->whave < state->wsize) state->whave += dist;
  ------------------
  |  Branch (409:17): [True: 24.2k, False: 0]
  ------------------
  410|  24.2k|        }
  411|  24.2k|    }
  412|  24.2k|    return 0;
  413|  24.2k|}
  414|       |
  415|       |/* Macros for inflate(): */
  416|       |
  417|       |/* check function to use adler32() for zlib or crc32() for gzip */
  418|       |#ifdef GUNZIP
  419|       |#  define UPDATE_CHECK(check, buf, len) \
  420|   279k|    (state->flags ? crc32(check, buf, len) : adler32(check, buf, len))
                                  ^0
  421|       |#else
  422|       |#  define UPDATE_CHECK(check, buf, len) adler32(check, buf, len)
  423|       |#endif
  424|       |
  425|       |/* check macros for header crc */
  426|       |#ifdef GUNZIP
  427|       |#  define CRC2(check, word) \
  428|      0|    do { \
  429|      0|        hbuf[0] = (unsigned char)(word); \
  430|      0|        hbuf[1] = (unsigned char)((word) >> 8); \
  431|      0|        check = crc32(check, hbuf, 2); \
  432|      0|    } while (0)
  433|       |
  434|       |#  define CRC4(check, word) \
  435|      0|    do { \
  436|      0|        hbuf[0] = (unsigned char)(word); \
  437|      0|        hbuf[1] = (unsigned char)((word) >> 8); \
  438|      0|        hbuf[2] = (unsigned char)((word) >> 16); \
  439|      0|        hbuf[3] = (unsigned char)((word) >> 24); \
  440|      0|        check = crc32(check, hbuf, 4); \
  441|      0|    } while (0)
  442|       |#endif
  443|       |
  444|       |/* Load registers with state in inflate() for speed */
  445|       |#define LOAD() \
  446|   539k|    do { \
  447|   539k|        put = strm->next_out; \
  448|   539k|        left = strm->avail_out; \
  449|   539k|        next = strm->next_in; \
  450|   539k|        have = strm->avail_in; \
  451|   539k|        hold = state->hold; \
  452|   539k|        bits = state->bits; \
  453|   539k|    } while (0)
  454|       |
  455|       |/* Restore state from registers in inflate() */
  456|       |#define RESTORE() \
  457|   539k|    do { \
  458|   539k|        strm->next_out = put; \
  459|   539k|        strm->avail_out = left; \
  460|   539k|        strm->next_in = next; \
  461|   539k|        strm->avail_in = have; \
  462|   539k|        state->hold = hold; \
  463|   539k|        state->bits = bits; \
  464|   539k|    } while (0)
  465|       |
  466|       |/* Clear the input bit accumulator */
  467|       |#define INITBITS() \
  468|   592k|    do { \
  469|   592k|        hold = 0; \
  470|   592k|        bits = 0; \
  471|   592k|    } while (0)
  472|       |
  473|       |/* Get a byte of input into the bit accumulator, or return from inflate()
  474|       |   if there is no input available. */
  475|       |#define PULLBYTE() \
  476|  5.55M|    do { \
  477|  5.55M|        if (have == 0) goto inf_leave; \
                                     ^25.5k
  478|  5.55M|        have--; \
  479|  5.52M|        hold += (unsigned long)(*next++) << bits; \
  480|  5.52M|        bits += 8; \
  481|  5.52M|    } while (0)
  482|       |
  483|       |/* Assure that there are at least n bits in the bit accumulator.  If there is
  484|       |   not enough available input to do that, then return from inflate(). */
  485|       |#define NEEDBITS(n) \
  486|  1.46M|    do { \
  487|  4.14M|        while (bits < (unsigned)(n)) \
  488|  2.68M|            PULLBYTE(); \
  489|  1.46M|    } while (0)
                           ^1.46M
  490|       |
  491|       |/* Return the low n bits of the bit accumulator (n < 16) */
  492|       |#define BITS(n) \
  493|  8.10M|    ((unsigned)hold & ((1U << (n)) - 1))
  494|       |
  495|       |/* Remove n bits from the bit accumulator */
  496|       |#define DROPBITS(n) \
  497|  4.31M|    do { \
  498|  4.31M|        hold >>= (n); \
  499|  4.31M|        bits -= (unsigned)(n); \
  500|  4.31M|    } while (0)
  501|       |
  502|       |/* Remove zero to seven bits as needed to go to a byte boundary */
  503|       |#define BYTEBITS() \
  504|   306k|    do { \
  505|   306k|        hold >>= bits & 7; \
  506|   306k|        bits -= bits & 7; \
  507|   306k|    } while (0)
  508|       |
  509|       |/*
  510|       |   inflate() uses a state machine to process as much input data and generate as
  511|       |   much output data as possible before returning.  The state machine is
  512|       |   structured roughly as follows:
  513|       |
  514|       |    for (;;) switch (state) {
  515|       |    ...
  516|       |    case STATEn:
  517|       |        if (not enough input data or output space to make progress)
  518|       |            return;
  519|       |        ... make progress ...
  520|       |        state = STATEm;
  521|       |        break;
  522|       |    ...
  523|       |    }
  524|       |
  525|       |   so when inflate() is called again, the same case is attempted again, and
  526|       |   if the appropriate resources are provided, the machine proceeds to the
  527|       |   next state.  The NEEDBITS() macro is usually the way the state evaluates
  528|       |   whether it can proceed or should return.  NEEDBITS() does the return if
  529|       |   the requested bits are not available.  The typical use of the BITS macros
  530|       |   is:
  531|       |
  532|       |        NEEDBITS(n);
  533|       |        ... do something with BITS(n) ...
  534|       |        DROPBITS(n);
  535|       |
  536|       |   where NEEDBITS(n) either returns from inflate() if there isn't enough
  537|       |   input left to load n bits into the accumulator, or it continues.  BITS(n)
  538|       |   gives the low n bits in the accumulator.  When done, DROPBITS(n) drops
  539|       |   the low n bits off the accumulator.  INITBITS() clears the accumulator
  540|       |   and sets the number of available bits to zero.  BYTEBITS() discards just
  541|       |   enough bits to put the accumulator on a byte boundary.  After BYTEBITS()
  542|       |   and a NEEDBITS(8), then BITS(8) would return the next byte in the stream.
  543|       |
  544|       |   NEEDBITS(n) uses PULLBYTE() to get an available byte of input, or to return
  545|       |   if there is no input available.  The decoding of variable length codes uses
  546|       |   PULLBYTE() directly in order to pull just enough bytes to decode the next
  547|       |   code, and no more.
  548|       |
  549|       |   Some states loop until they get enough input, making sure that enough
  550|       |   state information is maintained to continue the loop where it left off
  551|       |   if NEEDBITS() returns in the loop.  For example, want, need, and keep
  552|       |   would all have to actually be part of the saved state in case NEEDBITS()
  553|       |   returns:
  554|       |
  555|       |    case STATEw:
  556|       |        while (want < need) {
  557|       |            NEEDBITS(n);
  558|       |            keep[want++] = BITS(n);
  559|       |            DROPBITS(n);
  560|       |        }
  561|       |        state = STATEx;
  562|       |    case STATEx:
  563|       |
  564|       |   As shown above, if the next state is also the next case, then the break
  565|       |   is omitted.
  566|       |
  567|       |   A state may also return if there is not enough output space available to
  568|       |   complete that state.  Those states are copying stored data, writing a
  569|       |   literal byte, and copying a matching string.
  570|       |
  571|       |   When returning, a "goto inf_leave" is used to update the total counters,
  572|       |   update the check value, and determine whether any progress has been made
  573|       |   during that inflate() call in order to return the proper return code.
  574|       |   Progress is defined as a change in either strm->avail_in or strm->avail_out.
  575|       |   When there is a window, goto inf_leave will update the window with the last
  576|       |   output written.  If a goto inf_leave occurs in the middle of decompression
  577|       |   and there is no window currently, goto inf_leave will create one and copy
  578|       |   output to the window for the next call of inflate().
  579|       |
  580|       |   In this implementation, the flush parameter of inflate() only affects the
  581|       |   return code (per zlib.h).  inflate() always writes as much as possible to
  582|       |   strm->next_out, given the space available and the provided input--the effect
  583|       |   documented in zlib.h of Z_SYNC_FLUSH.  Furthermore, inflate() always defers
  584|       |   the allocation of and copying into a sliding window until necessary, which
  585|       |   provides the effect documented in zlib.h for Z_FINISH when the entire input
  586|       |   stream available.  So the only thing the flush parameter actually does is:
  587|       |   when flush is set to Z_FINISH, inflate() cannot return Z_OK.  Instead it
  588|       |   will return Z_BUF_ERROR if it has not reached the end of the stream.
  589|       | */
  590|       |
  591|   539k|int ZEXPORT inflate(z_streamp strm, int flush) {
  592|   539k|    struct inflate_state FAR *state;
  593|   539k|    z_const unsigned char FAR *next;    /* next input */
  594|   539k|    unsigned char FAR *put;     /* next output */
  595|   539k|    unsigned have, left;        /* available input and output */
  596|   539k|    unsigned long hold;         /* bit buffer */
  597|   539k|    unsigned bits;              /* bits in bit buffer */
  598|   539k|    unsigned in, out;           /* save starting available input and output */
  599|   539k|    unsigned copy;              /* number of stored or match bytes to copy */
  600|   539k|    unsigned char FAR *from;    /* where to copy match bytes from */
  601|   539k|    code here;                  /* current decoding table entry */
  602|   539k|    code last;                  /* parent table entry */
  603|   539k|    unsigned len;               /* length to copy for repeats, bits to drop */
  604|   539k|    int ret;                    /* return code */
  605|   539k|#ifdef GUNZIP
  606|   539k|    unsigned char hbuf[4];      /* buffer for gzip header crc calculation */
  607|   539k|#endif
  608|   539k|    static const unsigned short order[19] = /* permutation of code lengths */
  609|   539k|        {16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15};
  610|       |
  611|   539k|    if (inflateStateCheck(strm) || strm->next_out == Z_NULL ||
  ------------------
  |  Branch (611:9): [True: 0, False: 539k]
  |  Branch (611:36): [True: 0, False: 539k]
  ------------------
  612|   539k|        (strm->next_in == Z_NULL && strm->avail_in != 0))
                                                  ^0
  ------------------
  |  Branch (612:10): [True: 0, False: 539k]
  |  Branch (612:37): [True: 0, False: 0]
  ------------------
  613|      0|        return Z_STREAM_ERROR;
  614|       |
  615|   539k|    state = (struct inflate_state FAR *)strm->state;
  616|   539k|    if (state->mode == TYPE) state->mode = TYPEDO;      /* skip check */
                                           ^2
  ------------------
  |  Branch (616:9): [True: 2, False: 539k]
  ------------------
  617|   539k|    LOAD();
  618|   539k|    in = have;
  619|   539k|    out = left;
  620|   539k|    ret = Z_OK;
  621|   539k|    for (;;)
  622|  6.43M|        switch (state->mode) {
  623|   526k|        case HEAD:
  ------------------
  |  Branch (623:9): [True: 526k, False: 5.91M]
  ------------------
  624|   526k|            if (state->wrap == 0) {
  ------------------
  |  Branch (624:17): [True: 0, False: 526k]
  ------------------
  625|      0|                state->mode = TYPEDO;
  626|      0|                break;
  627|      0|            }
  628|   526k|            NEEDBITS(16);
  629|   526k|#ifdef GUNZIP
  630|   526k|            if ((state->wrap & 2) && hold == 0x8b1f) {  /* gzip header */
                                                   ^0
  ------------------
  |  Branch (630:17): [True: 0, False: 526k]
  |  Branch (630:38): [True: 0, False: 0]
  ------------------
  631|      0|                if (state->wbits == 0)
  ------------------
  |  Branch (631:21): [True: 0, False: 0]
  ------------------
  632|      0|                    state->wbits = 15;
  633|      0|                state->check = crc32(0L, Z_NULL, 0);
  634|      0|                CRC2(state->check, hold);
  635|      0|                INITBITS();
  636|      0|                state->mode = FLAGS;
  637|      0|                break;
  638|      0|            }
  639|   526k|            if (state->head != Z_NULL)
  ------------------
  |  Branch (639:17): [True: 0, False: 526k]
  ------------------
  640|      0|                state->head->done = -1;
  641|   526k|            if (!(state->wrap & 1) ||   /* check if zlib header allowed */
  ------------------
  |  Branch (641:17): [True: 0, False: 526k]
  ------------------
  642|       |#else
  643|       |            if (
  644|       |#endif
  645|   526k|                ((BITS(8) << 8) + (hold >> 8)) % 31) {
  ------------------
  |  Branch (645:17): [True: 135k, False: 391k]
  ------------------
  646|   135k|                strm->msg = (z_const char *)"incorrect header check";
  647|   135k|                state->mode = BAD;
  648|   135k|                break;
  649|   135k|            }
  650|   391k|            if (BITS(4) != Z_DEFLATED) {
  ------------------
  |  Branch (650:17): [True: 76.2k, False: 315k]
  ------------------
  651|  76.2k|                strm->msg = (z_const char *)"unknown compression method";
  652|  76.2k|                state->mode = BAD;
  653|  76.2k|                break;
  654|  76.2k|            }
  655|   315k|            DROPBITS(4);
  656|   315k|            len = BITS(4) + 8;
  657|   315k|            if (state->wbits == 0)
  ------------------
  |  Branch (657:17): [True: 0, False: 315k]
  ------------------
  658|      0|                state->wbits = len;
  659|   315k|            if (len > 15 || len > state->wbits) {
  ------------------
  |  Branch (659:17): [True: 0, False: 315k]
  |  Branch (659:29): [True: 0, False: 315k]
  ------------------
  660|      0|                strm->msg = (z_const char *)"invalid window size";
  661|      0|                state->mode = BAD;
  662|      0|                break;
  663|      0|            }
  664|   315k|            state->dmax = 1U << len;
  665|   315k|            state->flags = 0;               /* indicate zlib header */
  666|   315k|            Tracev((stderr, "inflate:   zlib header ok\n"));
  667|   315k|            strm->adler = state->check = adler32(0L, Z_NULL, 0);
  668|   315k|            state->mode = hold & 0x200 ? DICTID : TYPE;
                                                       ^0
  ------------------
  |  Branch (668:27): [True: 0, False: 315k]
  ------------------
  669|   315k|            INITBITS();
  670|   315k|            break;
  671|      0|#ifdef GUNZIP
  672|      0|        case FLAGS:
  ------------------
  |  Branch (672:9): [True: 0, False: 6.43M]
  ------------------
  673|      0|            NEEDBITS(16);
  674|      0|            state->flags = (int)(hold);
  675|      0|            if ((state->flags & 0xff) != Z_DEFLATED) {
  ------------------
  |  Branch (675:17): [True: 0, False: 0]
  ------------------
  676|      0|                strm->msg = (z_const char *)"unknown compression method";
  677|      0|                state->mode = BAD;
  678|      0|                break;
  679|      0|            }
  680|      0|            if (state->flags & 0xe000) {
  ------------------
  |  Branch (680:17): [True: 0, False: 0]
  ------------------
  681|      0|                strm->msg = (z_const char *)"unknown header flags set";
  682|      0|                state->mode = BAD;
  683|      0|                break;
  684|      0|            }
  685|      0|            if (state->head != Z_NULL)
  ------------------
  |  Branch (685:17): [True: 0, False: 0]
  ------------------
  686|      0|                state->head->text = (int)((hold >> 8) & 1);
  687|      0|            if ((state->flags & 0x0200) && (state->wrap & 4))
  ------------------
  |  Branch (687:17): [True: 0, False: 0]
  |  Branch (687:44): [True: 0, False: 0]
  ------------------
  688|      0|                CRC2(state->check, hold);
  689|      0|            INITBITS();
  690|      0|            state->mode = TIME;
  691|       |                /* fallthrough */
  692|      0|        case TIME:
  ------------------
  |  Branch (692:9): [True: 0, False: 6.43M]
  ------------------
  693|      0|            NEEDBITS(32);
  694|      0|            if (state->head != Z_NULL)
  ------------------
  |  Branch (694:17): [True: 0, False: 0]
  ------------------
  695|      0|                state->head->time = hold;
  696|      0|            if ((state->flags & 0x0200) && (state->wrap & 4))
  ------------------
  |  Branch (696:17): [True: 0, False: 0]
  |  Branch (696:44): [True: 0, False: 0]
  ------------------
  697|      0|                CRC4(state->check, hold);
  698|      0|            INITBITS();
  699|      0|            state->mode = OS;
  700|       |                /* fallthrough */
  701|      0|        case OS:
  ------------------
  |  Branch (701:9): [True: 0, False: 6.43M]
  ------------------
  702|      0|            NEEDBITS(16);
  703|      0|            if (state->head != Z_NULL) {
  ------------------
  |  Branch (703:17): [True: 0, False: 0]
  ------------------
  704|      0|                state->head->xflags = (int)(hold & 0xff);
  705|      0|                state->head->os = (int)(hold >> 8);
  706|      0|            }
  707|      0|            if ((state->flags & 0x0200) && (state->wrap & 4))
  ------------------
  |  Branch (707:17): [True: 0, False: 0]
  |  Branch (707:44): [True: 0, False: 0]
  ------------------
  708|      0|                CRC2(state->check, hold);
  709|      0|            INITBITS();
  710|      0|            state->mode = EXLEN;
  711|       |                /* fallthrough */
  712|      0|        case EXLEN:
  ------------------
  |  Branch (712:9): [True: 0, False: 6.43M]
  ------------------
  713|      0|            if (state->flags & 0x0400) {
  ------------------
  |  Branch (713:17): [True: 0, False: 0]
  ------------------
  714|      0|                NEEDBITS(16);
  715|      0|                state->length = (unsigned)(hold);
  716|      0|                if (state->head != Z_NULL)
  ------------------
  |  Branch (716:21): [True: 0, False: 0]
  ------------------
  717|      0|                    state->head->extra_len = (unsigned)hold;
  718|      0|                if ((state->flags & 0x0200) && (state->wrap & 4))
  ------------------
  |  Branch (718:21): [True: 0, False: 0]
  |  Branch (718:48): [True: 0, False: 0]
  ------------------
  719|      0|                    CRC2(state->check, hold);
  720|      0|                INITBITS();
  721|      0|            }
  722|      0|            else if (state->head != Z_NULL)
  ------------------
  |  Branch (722:22): [True: 0, False: 0]
  ------------------
  723|      0|                state->head->extra = Z_NULL;
  724|      0|            state->mode = EXTRA;
  725|       |                /* fallthrough */
  726|      0|        case EXTRA:
  ------------------
  |  Branch (726:9): [True: 0, False: 6.43M]
  ------------------
  727|      0|            if (state->flags & 0x0400) {
  ------------------
  |  Branch (727:17): [True: 0, False: 0]
  ------------------
  728|      0|                copy = state->length;
  729|      0|                if (copy > have) copy = have;
  ------------------
  |  Branch (729:21): [True: 0, False: 0]
  ------------------
  730|      0|                if (copy) {
  ------------------
  |  Branch (730:21): [True: 0, False: 0]
  ------------------
  731|      0|                    if (state->head != Z_NULL &&
  ------------------
  |  Branch (731:25): [True: 0, False: 0]
  ------------------
  732|      0|                        state->head->extra != Z_NULL &&
  ------------------
  |  Branch (732:25): [True: 0, False: 0]
  ------------------
  733|      0|                        (len = state->head->extra_len - state->length) <
  ------------------
  |  Branch (733:25): [True: 0, False: 0]
  ------------------
  734|      0|                            state->head->extra_max) {
  735|      0|                        zmemcpy(state->head->extra + len, next,
  736|      0|                                len + copy > state->head->extra_max ?
  ------------------
  |  Branch (736:33): [True: 0, False: 0]
  ------------------
  737|      0|                                state->head->extra_max - len : copy);
  738|      0|                    }
  739|      0|                    if ((state->flags & 0x0200) && (state->wrap & 4))
  ------------------
  |  Branch (739:25): [True: 0, False: 0]
  |  Branch (739:52): [True: 0, False: 0]
  ------------------
  740|      0|                        state->check = crc32(state->check, next, copy);
  741|      0|                    have -= copy;
  742|      0|                    next += copy;
  743|      0|                    state->length -= copy;
  744|      0|                }
  745|      0|                if (state->length) goto inf_leave;
  ------------------
  |  Branch (745:21): [True: 0, False: 0]
  ------------------
  746|      0|            }
  747|      0|            state->length = 0;
  748|      0|            state->mode = NAME;
  749|       |                /* fallthrough */
  750|      0|        case NAME:
  ------------------
  |  Branch (750:9): [True: 0, False: 6.43M]
  ------------------
  751|      0|            if (state->flags & 0x0800) {
  ------------------
  |  Branch (751:17): [True: 0, False: 0]
  ------------------
  752|      0|                if (have == 0) goto inf_leave;
  ------------------
  |  Branch (752:21): [True: 0, False: 0]
  ------------------
  753|      0|                copy = 0;
  754|      0|                do {
  755|      0|                    len = (unsigned)(next[copy++]);
  756|      0|                    if (state->head != Z_NULL &&
  ------------------
  |  Branch (756:25): [True: 0, False: 0]
  ------------------
  757|      0|                            state->head->name != Z_NULL &&
  ------------------
  |  Branch (757:29): [True: 0, False: 0]
  ------------------
  758|      0|                            state->length < state->head->name_max)
  ------------------
  |  Branch (758:29): [True: 0, False: 0]
  ------------------
  759|      0|                        state->head->name[state->length++] = (Bytef)len;
  760|      0|                } while (len && copy < have);
  ------------------
  |  Branch (760:26): [True: 0, False: 0]
  |  Branch (760:33): [True: 0, False: 0]
  ------------------
  761|      0|                if ((state->flags & 0x0200) && (state->wrap & 4))
  ------------------
  |  Branch (761:21): [True: 0, False: 0]
  |  Branch (761:48): [True: 0, False: 0]
  ------------------
  762|      0|                    state->check = crc32(state->check, next, copy);
  763|      0|                have -= copy;
  764|      0|                next += copy;
  765|      0|                if (len) goto inf_leave;
  ------------------
  |  Branch (765:21): [True: 0, False: 0]
  ------------------
  766|      0|            }
  767|      0|            else if (state->head != Z_NULL)
  ------------------
  |  Branch (767:22): [True: 0, False: 0]
  ------------------
  768|      0|                state->head->name = Z_NULL;
  769|      0|            state->length = 0;
  770|      0|            state->mode = COMMENT;
  771|       |                /* fallthrough */
  772|      0|        case COMMENT:
  ------------------
  |  Branch (772:9): [True: 0, False: 6.43M]
  ------------------
  773|      0|            if (state->flags & 0x1000) {
  ------------------
  |  Branch (773:17): [True: 0, False: 0]
  ------------------
  774|      0|                if (have == 0) goto inf_leave;
  ------------------
  |  Branch (774:21): [True: 0, False: 0]
  ------------------
  775|      0|                copy = 0;
  776|      0|                do {
  777|      0|                    len = (unsigned)(next[copy++]);
  778|      0|                    if (state->head != Z_NULL &&
  ------------------
  |  Branch (778:25): [True: 0, False: 0]
  ------------------
  779|      0|                            state->head->comment != Z_NULL &&
  ------------------
  |  Branch (779:29): [True: 0, False: 0]
  ------------------
  780|      0|                            state->length < state->head->comm_max)
  ------------------
  |  Branch (780:29): [True: 0, False: 0]
  ------------------
  781|      0|                        state->head->comment[state->length++] = (Bytef)len;
  782|      0|                } while (len && copy < have);
  ------------------
  |  Branch (782:26): [True: 0, False: 0]
  |  Branch (782:33): [True: 0, False: 0]
  ------------------
  783|      0|                if ((state->flags & 0x0200) && (state->wrap & 4))
  ------------------
  |  Branch (783:21): [True: 0, False: 0]
  |  Branch (783:48): [True: 0, False: 0]
  ------------------
  784|      0|                    state->check = crc32(state->check, next, copy);
  785|      0|                have -= copy;
  786|      0|                next += copy;
  787|      0|                if (len) goto inf_leave;
  ------------------
  |  Branch (787:21): [True: 0, False: 0]
  ------------------
  788|      0|            }
  789|      0|            else if (state->head != Z_NULL)
  ------------------
  |  Branch (789:22): [True: 0, False: 0]
  ------------------
  790|      0|                state->head->comment = Z_NULL;
  791|      0|            state->mode = HCRC;
  792|       |                /* fallthrough */
  793|      0|        case HCRC:
  ------------------
  |  Branch (793:9): [True: 0, False: 6.43M]
  ------------------
  794|      0|            if (state->flags & 0x0200) {
  ------------------
  |  Branch (794:17): [True: 0, False: 0]
  ------------------
  795|      0|                NEEDBITS(16);
  796|      0|                if ((state->wrap & 4) && hold != (state->check & 0xffff)) {
  ------------------
  |  Branch (796:21): [True: 0, False: 0]
  |  Branch (796:42): [True: 0, False: 0]
  ------------------
  797|      0|                    strm->msg = (z_const char *)"header crc mismatch";
  798|      0|                    state->mode = BAD;
  799|      0|                    break;
  800|      0|                }
  801|      0|                INITBITS();
  802|      0|            }
  803|      0|            if (state->head != Z_NULL) {
  ------------------
  |  Branch (803:17): [True: 0, False: 0]
  ------------------
  804|      0|                state->head->hcrc = (int)((state->flags >> 9) & 1);
  805|      0|                state->head->done = 1;
  806|      0|            }
  807|      0|            strm->adler = state->check = crc32(0L, Z_NULL, 0);
  808|      0|            state->mode = TYPE;
  809|      0|            break;
  810|      0|#endif
  811|      0|        case DICTID:
  ------------------
  |  Branch (811:9): [True: 0, False: 6.43M]
  ------------------
  812|      0|            NEEDBITS(32);
  813|      0|            strm->adler = state->check = ZSWAP32(hold);
  814|      0|            INITBITS();
  815|      0|            state->mode = DICT;
  816|       |                /* fallthrough */
  817|      0|        case DICT:
  ------------------
  |  Branch (817:9): [True: 0, False: 6.43M]
  ------------------
  818|      0|            if (state->havedict == 0) {
  ------------------
  |  Branch (818:17): [True: 0, False: 0]
  ------------------
  819|      0|                RESTORE();
  820|      0|                return Z_NEED_DICT;
  821|      0|            }
  822|      0|            strm->adler = state->check = adler32(0L, Z_NULL, 0);
  823|      0|            state->mode = TYPE;
  824|       |                /* fallthrough */
  825|   580k|        case TYPE:
  ------------------
  |  Branch (825:9): [True: 580k, False: 5.85M]
  ------------------
  826|   580k|            if (flush == Z_BLOCK || flush == Z_TREES) goto inf_leave;
                                                                    ^0
  ------------------
  |  Branch (826:17): [True: 0, False: 580k]
  |  Branch (826:37): [True: 0, False: 580k]
  ------------------
  827|       |                /* fallthrough */
  828|   580k|        case TYPEDO:
  ------------------
  |  Branch (828:9): [True: 2, False: 6.43M]
  ------------------
  829|   580k|            if (state->last) {
  ------------------
  |  Branch (829:17): [True: 263k, False: 316k]
  ------------------
  830|   263k|                BYTEBITS();
  831|   263k|                state->mode = CHECK;
  832|   263k|                break;
  833|   263k|            }
  834|   316k|            NEEDBITS(3);
  835|   316k|            state->last = BITS(1);
  836|   316k|            DROPBITS(1);
  837|   316k|            switch (BITS(2)) {
  838|  42.6k|            case 0:                             /* stored block */
  ------------------
  |  Branch (838:13): [True: 42.6k, False: 274k]
  ------------------
  839|  42.6k|                Tracev((stderr, "inflate:     stored block%s\n",
  840|  42.6k|                        state->last ? " (last)" : ""));
  841|  42.6k|                state->mode = STORED;
  842|  42.6k|                break;
  843|   265k|            case 1:                             /* fixed block */
  ------------------
  |  Branch (843:13): [True: 265k, False: 51.3k]
  ------------------
  844|   265k|                fixedtables(state);
  845|   265k|                Tracev((stderr, "inflate:     fixed codes block%s\n",
  846|   265k|                        state->last ? " (last)" : ""));
  847|   265k|                state->mode = LEN_;             /* decode codes */
  848|   265k|                if (flush == Z_TREES) {
  ------------------
  |  Branch (848:21): [True: 0, False: 265k]
  ------------------
  849|      0|                    DROPBITS(2);
  850|      0|                    goto inf_leave;
  851|      0|                }
  852|   265k|                break;
  853|   265k|            case 2:                             /* dynamic block */
  ------------------
  |  Branch (853:13): [True: 4.98k, False: 311k]
  ------------------
  854|  4.98k|                Tracev((stderr, "inflate:     dynamic codes block%s\n",
  855|  4.98k|                        state->last ? " (last)" : ""));
  856|  4.98k|                state->mode = TABLE;
  857|  4.98k|                break;
  858|  3.64k|            case 3:
  ------------------
  |  Branch (858:13): [True: 3.64k, False: 313k]
  ------------------
  859|  3.64k|                strm->msg = (z_const char *)"invalid block type";
  860|  3.64k|                state->mode = BAD;
  861|   316k|            }
  862|   316k|            DROPBITS(2);
  863|   316k|            break;
  864|  42.8k|        case STORED:
  ------------------
  |  Branch (864:9): [True: 42.8k, False: 6.39M]
  ------------------
  865|  42.8k|            BYTEBITS();                         /* go to byte boundary */
  866|  42.8k|            NEEDBITS(32);
  867|  42.4k|            if ((hold & 0xffff) != ((hold >> 16) ^ 0xffff)) {
  ------------------
  |  Branch (867:17): [True: 27.7k, False: 14.6k]
  ------------------
  868|  27.7k|                strm->msg = (z_const char *)"invalid stored block lengths";
  869|  27.7k|                state->mode = BAD;
  870|  27.7k|                break;
  871|  27.7k|            }
  872|  14.6k|            state->length = (unsigned)hold & 0xffff;
  873|  14.6k|            Tracev((stderr, "inflate:       stored length %u\n",
  874|  14.6k|                    state->length));
  875|  14.6k|            INITBITS();
  876|  14.6k|            state->mode = COPY_;
  877|  14.6k|            if (flush == Z_TREES) goto inf_leave;
                                                ^0
  ------------------
  |  Branch (877:17): [True: 0, False: 14.6k]
  ------------------
  878|       |                /* fallthrough */
  879|  14.6k|        case COPY_:
  ------------------
  |  Branch (879:9): [True: 0, False: 6.43M]
  ------------------
  880|  14.6k|            state->mode = COPY;
  881|       |                /* fallthrough */
  882|  29.3k|        case COPY:
  ------------------
  |  Branch (882:9): [True: 14.6k, False: 6.42M]
  ------------------
  883|  29.3k|            copy = state->length;
  884|  29.3k|            if (copy) {
  ------------------
  |  Branch (884:17): [True: 14.6k, False: 14.6k]
  ------------------
  885|  14.6k|                if (copy > have) copy = have;
                                               ^90
  ------------------
  |  Branch (885:21): [True: 90, False: 14.5k]
  ------------------
  886|  14.6k|                if (copy > left) copy = left;
                                               ^0
  ------------------
  |  Branch (886:21): [True: 0, False: 14.6k]
  ------------------
  887|  14.6k|                if (copy == 0) goto inf_leave;
                                             ^60
  ------------------
  |  Branch (887:21): [True: 60, False: 14.6k]
  ------------------
  888|  14.6k|                zmemcpy(put, next, copy);
  889|  14.6k|                have -= copy;
  890|  14.6k|                next += copy;
  891|  14.6k|                left -= copy;
  892|  14.6k|                put += copy;
  893|  14.6k|                state->length -= copy;
  894|  14.6k|                break;
  895|  14.6k|            }
  896|  14.6k|            Tracev((stderr, "inflate:       stored end\n"));
  897|  14.6k|            state->mode = TYPE;
  898|  14.6k|            break;
  899|  4.98k|        case TABLE:
  ------------------
  |  Branch (899:9): [True: 4.98k, False: 6.43M]
  ------------------
  900|  4.98k|            NEEDBITS(14);
  901|  4.97k|            state->nlen = BITS(5) + 257;
  902|  4.97k|            DROPBITS(5);
  903|  4.97k|            state->ndist = BITS(5) + 1;
  904|  4.97k|            DROPBITS(5);
  905|  4.97k|            state->ncode = BITS(4) + 4;
  906|  4.97k|            DROPBITS(4);
  907|  4.97k|#ifndef PKZIP_BUG_WORKAROUND
  908|  4.97k|            if (state->nlen > 286 || state->ndist > 30) {
                                                   ^4.94k
  ------------------
  |  Branch (908:17): [True: 33, False: 4.94k]
  |  Branch (908:38): [True: 32, False: 4.91k]
  ------------------
  909|     65|                strm->msg = (z_const char *)
  910|     65|                    "too many length or distance symbols";
  911|     65|                state->mode = BAD;
  912|     65|                break;
  913|     65|            }
  914|  4.91k|#endif
  915|  4.91k|            Tracev((stderr, "inflate:       table sizes ok\n"));
  916|  4.91k|            state->have = 0;
  917|  4.91k|            state->mode = LENLENS;
  918|       |                /* fallthrough */
  919|  5.68k|        case LENLENS:
  ------------------
  |  Branch (919:9): [True: 771, False: 6.43M]
  ------------------
  920|  60.0k|            while (state->have < state->ncode) {
  ------------------
  |  Branch (920:20): [True: 55.9k, False: 4.14k]
  ------------------
  921|  55.9k|                NEEDBITS(3);
  922|  54.3k|                state->lens[order[state->have++]] = (unsigned short)BITS(3);
  923|  54.3k|                DROPBITS(3);
  924|  54.3k|            }
  925|  38.7k|            while (state->have < 19)
                          ^4.14k
  ------------------
  |  Branch (925:20): [True: 34.6k, False: 4.14k]
  ------------------
  926|  34.6k|                state->lens[order[state->have++]] = 0;
  927|  4.14k|            state->next = state->codes;
  928|  4.14k|            state->lencode = state->distcode = (const code FAR *)(state->next);
  929|  4.14k|            state->lenbits = 7;
  930|  4.14k|            ret = inflate_table(CODES, state->lens, 19, &(state->next),
  931|  4.14k|                                &(state->lenbits), state->work);
  932|  4.14k|            if (ret) {
  ------------------
  |  Branch (932:17): [True: 3.99k, False: 148]
  ------------------
  933|  3.99k|                strm->msg = (z_const char *)"invalid code lengths set";
  934|  3.99k|                state->mode = BAD;
  935|  3.99k|                break;
  936|  3.99k|            }
  937|    148|            Tracev((stderr, "inflate:       code lengths ok\n"));
  938|    148|            state->have = 0;
  939|    148|            state->mode = CODELENS;
  940|       |                /* fallthrough */
  941|    239|        case CODELENS:
  ------------------
  |  Branch (941:9): [True: 91, False: 6.43M]
  ------------------
  942|  19.6k|            while (state->have < state->nlen + state->ndist) {
  ------------------
  |  Branch (942:20): [True: 19.6k, False: 56]
  ------------------
  943|  22.0k|                for (;;) {
  944|  22.0k|                    here = state->lencode[BITS(state->lenbits)];
  945|  22.0k|                    if ((unsigned)(here.bits) <= bits) break;
                                                                     ^19.4k
  ------------------
  |  Branch (945:25): [True: 19.4k, False: 2.61k]
  ------------------
  946|  2.61k|                    PULLBYTE();
  947|  2.61k|                }
  948|  19.4k|                if (here.val < 16) {
  ------------------
  |  Branch (948:21): [True: 19.3k, False: 53]
  ------------------
  949|  19.3k|                    DROPBITS(here.bits);
  950|  19.3k|                    state->lens[state->have++] = here.val;
  951|  19.3k|                }
  952|     53|                else {
  953|     53|                    if (here.val == 16) {
  ------------------
  |  Branch (953:25): [True: 5, False: 48]
  ------------------
  954|      5|                        NEEDBITS(here.bits + 2);
  955|      5|                        DROPBITS(here.bits);
  956|      5|                        if (state->have == 0) {
  ------------------
  |  Branch (956:29): [True: 1, False: 4]
  ------------------
  957|      1|                            strm->msg = (z_const char *)
  958|      1|                                "invalid bit length repeat";
  959|      1|                            state->mode = BAD;
  960|      1|                            break;
  961|      1|                        }
  962|      4|                        len = state->lens[state->have - 1];
  963|      4|                        copy = 3 + BITS(2);
  964|      4|                        DROPBITS(2);
  965|      4|                    }
  966|     48|                    else if (here.val == 17) {
  ------------------
  |  Branch (966:30): [True: 13, False: 35]
  ------------------
  967|     13|                        NEEDBITS(here.bits + 3);
  968|     13|                        DROPBITS(here.bits);
  969|     13|                        len = 0;
  970|     13|                        copy = 3 + BITS(3);
  971|     13|                        DROPBITS(3);
  972|     13|                    }
  973|     35|                    else {
  974|     35|                        NEEDBITS(here.bits + 7);
  975|     35|                        DROPBITS(here.bits);
  976|     35|                        len = 0;
  977|     35|                        copy = 11 + BITS(7);
  978|     35|                        DROPBITS(7);
  979|     35|                    }
  980|     52|                    if (state->have + copy > state->nlen + state->ndist) {
  ------------------
  |  Branch (980:25): [True: 0, False: 52]
  ------------------
  981|      0|                        strm->msg = (z_const char *)
  982|      0|                            "invalid bit length repeat";
  983|      0|                        state->mode = BAD;
  984|      0|                        break;
  985|      0|                    }
  986|  2.11k|                    while (copy--)
                                  ^52
  ------------------
  |  Branch (986:28): [True: 2.06k, False: 52]
  ------------------
  987|  2.06k|                        state->lens[state->have++] = (unsigned short)len;
  988|     52|                }
  989|  19.4k|            }
  990|       |
  991|       |            /* handle error breaks in while */
  992|     57|            if (state->mode == BAD) break;
                                                  ^1
  ------------------
  |  Branch (992:17): [True: 1, False: 56]
  ------------------
  993|       |
  994|       |            /* check for end-of-block code (better have one) */
  995|     56|            if (state->lens[256] == 0) {
  ------------------
  |  Branch (995:17): [True: 48, False: 8]
  ------------------
  996|     48|                strm->msg = (z_const char *)
  997|     48|                    "invalid code -- missing end-of-block";
  998|     48|                state->mode = BAD;
  999|     48|                break;
 1000|     48|            }
 1001|       |
 1002|       |            /* build code tables -- note: do not change the lenbits or distbits
 1003|       |               values here (9 and 6) without reading the comments in inftrees.h
 1004|       |               concerning the ENOUGH constants, which depend on those values */
 1005|      8|            state->next = state->codes;
 1006|      8|            state->lencode = (const code FAR *)(state->next);
 1007|      8|            state->lenbits = 9;
 1008|      8|            ret = inflate_table(LENS, state->lens, state->nlen, &(state->next),
 1009|      8|                                &(state->lenbits), state->work);
 1010|      8|            if (ret) {
  ------------------
  |  Branch (1010:17): [True: 0, False: 8]
  ------------------
 1011|      0|                strm->msg = (z_const char *)"invalid literal/lengths set";
 1012|      0|                state->mode = BAD;
 1013|      0|                break;
 1014|      0|            }
 1015|      8|            state->distcode = (const code FAR *)(state->next);
 1016|      8|            state->distbits = 6;
 1017|      8|            ret = inflate_table(DISTS, state->lens + state->nlen, state->ndist,
 1018|      8|                            &(state->next), &(state->distbits), state->work);
 1019|      8|            if (ret) {
  ------------------
  |  Branch (1019:17): [True: 0, False: 8]
  ------------------
 1020|      0|                strm->msg = (z_const char *)"invalid distances set";
 1021|      0|                state->mode = BAD;
 1022|      0|                break;
 1023|      0|            }
 1024|      8|            Tracev((stderr, "inflate:       codes ok\n"));
 1025|      8|            state->mode = LEN_;
 1026|      8|            if (flush == Z_TREES) goto inf_leave;
                                                ^0
  ------------------
  |  Branch (1026:17): [True: 0, False: 8]
  ------------------
 1027|       |                /* fallthrough */
 1028|   265k|        case LEN_:
  ------------------
  |  Branch (1028:9): [True: 265k, False: 6.17M]
  ------------------
 1029|   265k|            state->mode = LEN;
 1030|       |                /* fallthrough */
 1031|  2.69M|        case LEN:
  ------------------
  |  Branch (1031:9): [True: 2.42M, False: 4.01M]
  ------------------
 1032|  2.69M|            if (have >= 6 && left >= 258) {
                                           ^2.34M
  ------------------
  |  Branch (1032:17): [True: 2.34M, False: 346k]
  |  Branch (1032:30): [True: 494, False: 2.34M]
  ------------------
 1033|    494|                RESTORE();
 1034|    494|                inflate_fast(strm, out);
 1035|    494|                LOAD();
 1036|    494|                if (state->mode == TYPE)
  ------------------
  |  Branch (1036:21): [True: 5, False: 489]
  ------------------
 1037|      5|                    state->back = -1;
 1038|    494|                break;
 1039|    494|            }
 1040|  2.69M|            state->back = 0;
 1041|  5.34M|            for (;;) {
 1042|  5.34M|                here = state->lencode[BITS(state->lenbits)];
 1043|  5.34M|                if ((unsigned)(here.bits) <= bits) break;
                                                                 ^2.66M
  ------------------
  |  Branch (1043:21): [True: 2.66M, False: 2.67M]
  ------------------
 1044|  2.67M|                PULLBYTE();
 1045|  2.67M|            }
 1046|  2.66M|            if (here.op && (here.op & 0xf0) == 0) {
                                         ^604k
  ------------------
  |  Branch (1046:17): [True: 604k, False: 2.06M]
  |  Branch (1046:28): [True: 0, False: 604k]
  ------------------
 1047|      0|                last = here;
 1048|      0|                for (;;) {
 1049|      0|                    here = state->lencode[last.val +
 1050|      0|                            (BITS(last.bits + last.op) >> last.bits)];
 1051|      0|                    if ((unsigned)(last.bits + here.bits) <= bits) break;
  ------------------
  |  Branch (1051:25): [True: 0, False: 0]
  ------------------
 1052|      0|                    PULLBYTE();
 1053|      0|                }
 1054|      0|                DROPBITS(last.bits);
 1055|      0|                state->back += last.bits;
 1056|      0|            }
 1057|  2.66M|            DROPBITS(here.bits);
 1058|  2.66M|            state->back += here.bits;
 1059|  2.66M|            state->length = (unsigned)here.val;
 1060|  2.66M|            if ((int)(here.op) == 0) {
  ------------------
  |  Branch (1060:17): [True: 2.06M, False: 604k]
  ------------------
 1061|  2.06M|                Tracevv((stderr, here.val >= 0x20 && here.val < 0x7f ?
 1062|  2.06M|                        "inflate:         literal '%c'\n" :
 1063|  2.06M|                        "inflate:         literal 0x%02x\n", here.val));
 1064|  2.06M|                state->mode = LIT;
 1065|  2.06M|                break;
 1066|  2.06M|            }
 1067|   604k|            if (here.op & 32) {
  ------------------
  |  Branch (1067:17): [True: 250k, False: 353k]
  ------------------
 1068|   250k|                Tracevv((stderr, "inflate:         end of block\n"));
 1069|   250k|                state->back = -1;
 1070|   250k|                state->mode = TYPE;
 1071|   250k|                break;
 1072|   250k|            }
 1073|   353k|            if (here.op & 64) {
  ------------------
  |  Branch (1073:17): [True: 132, False: 353k]
  ------------------
 1074|    132|                strm->msg = (z_const char *)"invalid literal/length code";
 1075|    132|                state->mode = BAD;
 1076|    132|                break;
 1077|    132|            }
 1078|   353k|            state->extra = (unsigned)(here.op) & 15;
 1079|   353k|            state->mode = LENEXT;
 1080|       |                /* fallthrough */
 1081|   353k|        case LENEXT:
  ------------------
  |  Branch (1081:9): [True: 65, False: 6.43M]
  ------------------
 1082|   353k|            if (state->extra) {
  ------------------
  |  Branch (1082:17): [True: 156k, False: 196k]
  ------------------
 1083|   156k|                NEEDBITS(state->extra);
 1084|   156k|                state->length += BITS(state->extra);
 1085|   156k|                DROPBITS(state->extra);
 1086|   156k|                state->back += state->extra;
 1087|   156k|            }
 1088|   353k|            Tracevv((stderr, "inflate:         length %u\n", state->length));
 1089|   353k|            state->was = state->length;
 1090|   353k|            state->mode = DIST;
 1091|       |                /* fallthrough */
 1092|   353k|        case DIST:
  ------------------
  |  Branch (1092:9): [True: 154, False: 6.43M]
  ------------------
 1093|   551k|            for (;;) {
 1094|   551k|                here = state->distcode[BITS(state->distbits)];
 1095|   551k|                if ((unsigned)(here.bits) <= bits) break;
                                                                 ^353k
  ------------------
  |  Branch (1095:21): [True: 353k, False: 198k]
  ------------------
 1096|   198k|                PULLBYTE();
 1097|   198k|            }
 1098|   353k|            if ((here.op & 0xf0) == 0) {
  ------------------
  |  Branch (1098:17): [True: 0, False: 353k]
  ------------------
 1099|      0|                last = here;
 1100|      0|                for (;;) {
 1101|      0|                    here = state->distcode[last.val +
 1102|      0|                            (BITS(last.bits + last.op) >> last.bits)];
 1103|      0|                    if ((unsigned)(last.bits + here.bits) <= bits) break;
  ------------------
  |  Branch (1103:25): [True: 0, False: 0]
  ------------------
 1104|      0|                    PULLBYTE();
 1105|      0|                }
 1106|      0|                DROPBITS(last.bits);
 1107|      0|                state->back += last.bits;
 1108|      0|            }
 1109|   353k|            DROPBITS(here.bits);
 1110|   353k|            state->back += here.bits;
 1111|   353k|            if (here.op & 64) {
  ------------------
  |  Branch (1111:17): [True: 61, False: 353k]
  ------------------
 1112|     61|                strm->msg = (z_const char *)"invalid distance code";
 1113|     61|                state->mode = BAD;
 1114|     61|                break;
 1115|     61|            }
 1116|   353k|            state->offset = (unsigned)here.val;
 1117|   353k|            state->extra = (unsigned)(here.op) & 15;
 1118|   353k|            state->mode = DISTEXT;
 1119|       |                /* fallthrough */
 1120|   353k|        case DISTEXT:
  ------------------
  |  Branch (1120:9): [True: 242, False: 6.43M]
  ------------------
 1121|   353k|            if (state->extra) {
  ------------------
  |  Branch (1121:17): [True: 96.5k, False: 256k]
  ------------------
 1122|  96.5k|                NEEDBITS(state->extra);
 1123|  96.0k|                state->offset += BITS(state->extra);
 1124|  96.0k|                DROPBITS(state->extra);
 1125|  96.0k|                state->back += state->extra;
 1126|  96.0k|            }
 1127|       |#ifdef INFLATE_STRICT
 1128|       |            if (state->offset > state->dmax) {
 1129|       |                strm->msg = (z_const char *)"invalid distance too far back";
 1130|       |                state->mode = BAD;
 1131|       |                break;
 1132|       |            }
 1133|       |#endif
 1134|   352k|            Tracevv((stderr, "inflate:         distance %u\n", state->offset));
 1135|   352k|            state->mode = MATCH;
 1136|       |                /* fallthrough */
 1137|   353k|        case MATCH:
  ------------------
  |  Branch (1137:9): [True: 280, False: 6.43M]
  ------------------
 1138|   353k|            if (left == 0) goto inf_leave;
                                         ^280
  ------------------
  |  Branch (1138:17): [True: 280, False: 352k]
  ------------------
 1139|   352k|            copy = out - left;
 1140|   352k|            if (state->offset > copy) {         /* copy from window */
  ------------------
  |  Branch (1140:17): [True: 2.98k, False: 349k]
  ------------------
 1141|  2.98k|                copy = state->offset - copy;
 1142|  2.98k|                if (copy > state->whave) {
  ------------------
  |  Branch (1142:21): [True: 2.98k, False: 0]
  ------------------
 1143|  2.98k|                    if (state->sane) {
  ------------------
  |  Branch (1143:25): [True: 2.98k, False: 0]
  ------------------
 1144|  2.98k|                        strm->msg = (z_const char *)
 1145|  2.98k|                            "invalid distance too far back";
 1146|  2.98k|                        state->mode = BAD;
 1147|  2.98k|                        break;
 1148|  2.98k|                    }
 1149|       |#ifdef INFLATE_ALLOW_INVALID_DISTANCE_TOOFAR_ARRR
 1150|       |                    Trace((stderr, "inflate.c too far\n"));
 1151|       |                    copy -= state->whave;
 1152|       |                    if (copy > state->length) copy = state->length;
 1153|       |                    if (copy > left) copy = left;
 1154|       |                    left -= copy;
 1155|       |                    state->length -= copy;
 1156|       |                    do {
 1157|       |                        *put++ = 0;
 1158|       |                    } while (--copy);
 1159|       |                    if (state->length == 0) state->mode = LEN;
 1160|       |                    break;
 1161|       |#endif
 1162|  2.98k|                }
 1163|      0|                if (copy > state->wnext) {
  ------------------
  |  Branch (1163:21): [True: 0, False: 0]
  ------------------
 1164|      0|                    copy -= state->wnext;
 1165|      0|                    from = state->window + (state->wsize - copy);
 1166|      0|                }
 1167|      0|                else
 1168|      0|                    from = state->window + (state->wnext - copy);
 1169|      0|                if (copy > state->length) copy = state->length;
  ------------------
  |  Branch (1169:21): [True: 0, False: 0]
  ------------------
 1170|      0|            }
 1171|   349k|            else {                              /* copy from output */
 1172|   349k|                from = put - state->offset;
 1173|   349k|                copy = state->length;
 1174|   349k|            }
 1175|   349k|            if (copy > left) copy = left;
                                           ^140
  ------------------
  |  Branch (1175:17): [True: 140, False: 349k]
  ------------------
 1176|   349k|            left -= copy;
 1177|   349k|            state->length -= copy;
 1178|  7.59M|            do {
 1179|  7.59M|                *put++ = *from++;
 1180|  7.59M|            } while (--copy);
  ------------------
  |  Branch (1180:22): [True: 7.24M, False: 349k]
  ------------------
 1181|   349k|            if (state->length == 0) state->mode = LEN;
                                                  ^349k
  ------------------
  |  Branch (1181:17): [True: 349k, False: 140]
  ------------------
 1182|   349k|            break;
 1183|  2.06M|        case LIT:
  ------------------
  |  Branch (1183:9): [True: 2.06M, False: 4.37M]
  ------------------
 1184|  2.06M|            if (left == 0) goto inf_leave;
                                         ^52
  ------------------
  |  Branch (1184:17): [True: 52, False: 2.06M]
  ------------------
 1185|  2.06M|            *put++ = (unsigned char)(state->length);
 1186|  2.06M|            left--;
 1187|  2.06M|            state->mode = LEN;
 1188|  2.06M|            break;
 1189|   263k|        case CHECK:
  ------------------
  |  Branch (1189:9): [True: 263k, False: 6.17M]
  ------------------
 1190|   263k|            if (state->wrap) {
  ------------------
  |  Branch (1190:17): [True: 263k, False: 0]
  ------------------
 1191|   263k|                NEEDBITS(32);
 1192|   263k|                out -= left;
 1193|   263k|                strm->total_out += out;
 1194|   263k|                state->total += out;
 1195|   263k|                if ((state->wrap & 4) && out)
  ------------------
  |  Branch (1195:21): [True: 263k, False: 0]
  |  Branch (1195:42): [True: 263k, False: 16]
  ------------------
 1196|   263k|                    strm->adler = state->check =
 1197|   263k|                        UPDATE_CHECK(state->check, put - out, out);
 1198|   263k|                out = left;
 1199|   263k|                if ((state->wrap & 4) && (
  ------------------
  |  Branch (1199:21): [True: 263k, False: 0]
  |  Branch (1199:42): [True: 186, False: 263k]
  ------------------
 1200|   263k|#ifdef GUNZIP
 1201|   263k|                     state->flags ? hold :
                                                  ^0
  ------------------
  |  Branch (1201:22): [True: 0, False: 263k]
  ------------------
 1202|   263k|#endif
 1203|   263k|                     ZSWAP32(hold)) != state->check) {
 1204|    186|                    strm->msg = (z_const char *)"incorrect data check";
 1205|    186|                    state->mode = BAD;
 1206|    186|                    break;
 1207|    186|                }
 1208|   263k|                INITBITS();
 1209|   263k|                Tracev((stderr, "inflate:   check matches trailer\n"));
 1210|   263k|            }
 1211|   263k|#ifdef GUNZIP
 1212|   263k|            state->mode = LENGTH;
 1213|       |                /* fallthrough */
 1214|   263k|        case LENGTH:
  ------------------
  |  Branch (1214:9): [True: 0, False: 6.43M]
  ------------------
 1215|   263k|            if (state->wrap && state->flags) {
  ------------------
  |  Branch (1215:17): [True: 263k, False: 0]
  |  Branch (1215:32): [True: 0, False: 263k]
  ------------------
 1216|      0|                NEEDBITS(32);
 1217|      0|                if ((state->wrap & 4) && hold != (state->total & 0xffffffff)) {
  ------------------
  |  Branch (1217:21): [True: 0, False: 0]
  |  Branch (1217:42): [True: 0, False: 0]
  ------------------
 1218|      0|                    strm->msg = (z_const char *)"incorrect length check";
 1219|      0|                    state->mode = BAD;
 1220|      0|                    break;
 1221|      0|                }
 1222|      0|                INITBITS();
 1223|      0|                Tracev((stderr, "inflate:   length matches trailer\n"));
 1224|      0|            }
 1225|   263k|#endif
 1226|   263k|            state->mode = DONE;
 1227|       |                /* fallthrough */
 1228|   263k|        case DONE:
  ------------------
  |  Branch (1228:9): [True: 0, False: 6.43M]
  ------------------
 1229|   263k|            ret = Z_STREAM_END;
 1230|   263k|            goto inf_leave;
 1231|   250k|        case BAD:
  ------------------
  |  Branch (1231:9): [True: 250k, False: 6.18M]
  ------------------
 1232|   250k|            ret = Z_DATA_ERROR;
 1233|   250k|            goto inf_leave;
 1234|      0|        case MEM:
  ------------------
  |  Branch (1234:9): [True: 0, False: 6.43M]
  ------------------
 1235|      0|            return Z_MEM_ERROR;
 1236|      0|        case SYNC:
  ------------------
  |  Branch (1236:9): [True: 0, False: 6.43M]
  ------------------
 1237|       |                /* fallthrough */
 1238|      0|        default:
  ------------------
  |  Branch (1238:9): [True: 0, False: 6.43M]
  ------------------
 1239|      0|            return Z_STREAM_ERROR;
 1240|  6.43M|        }
 1241|       |
 1242|       |    /*
 1243|       |       Return from inflate(), updating the total counts and the check value.
 1244|       |       If there was no progress during the inflate() call, return a buffer
 1245|       |       error.  Call updatewindow() to create and/or update the window state.
 1246|       |       Note: a memory error from inflate() is non-recoverable.
 1247|       |     */
 1248|   539k|  inf_leave:
 1249|   539k|    RESTORE();
 1250|   539k|    if (state->wsize || (out != strm->avail_out && state->mode < BAD &&
                                      ^527k^527k                     ^15.8k
  ------------------
  |  Branch (1250:9): [True: 12.1k, False: 527k]
  |  Branch (1250:26): [True: 15.8k, False: 511k]
  |  Branch (1250:52): [True: 12.1k, False: 3.70k]
  ------------------
 1251|   527k|            (state->mode < CHECK || flush != Z_FINISH)))
                          ^12.1k^12.1k                 ^25      ^25
  ------------------
  |  Branch (1251:14): [True: 12.1k, False: 25]
  |  Branch (1251:37): [True: 25, False: 0]
  ------------------
 1252|  24.2k|        if (updatewindow(strm, strm->next_out, out - strm->avail_out)) {
  ------------------
  |  Branch (1252:13): [True: 0, False: 24.2k]
  ------------------
 1253|      0|            state->mode = MEM;
 1254|      0|            return Z_MEM_ERROR;
 1255|      0|        }
 1256|   539k|    in -= strm->avail_in;
 1257|   539k|    out -= strm->avail_out;
 1258|   539k|    strm->total_in += in;
 1259|   539k|    strm->total_out += out;
 1260|   539k|    state->total += out;
 1261|   539k|    if ((state->wrap & 4) && out)
  ------------------
  |  Branch (1261:9): [True: 539k, False: 0]
  |  Branch (1261:30): [True: 15.8k, False: 523k]
  ------------------
 1262|  15.8k|        strm->adler = state->check =
 1263|  15.8k|            UPDATE_CHECK(state->check, strm->next_out - out, out);
 1264|   539k|    strm->data_type = (int)state->bits + (state->last ? 64 : 0) +
                                                                      ^273k^265k
  ------------------
  |  Branch (1264:43): [True: 273k, False: 265k]
  ------------------
 1265|   539k|                      (state->mode == TYPE ? 128 : 0) +
                                                           ^2    ^539k
  ------------------
  |  Branch (1265:24): [True: 2, False: 539k]
  ------------------
 1266|   539k|                      (state->mode == LEN_ || state->mode == COPY_ ? 256 : 0);
                                                                                   ^0
  ------------------
  |  Branch (1266:24): [True: 0, False: 539k]
  |  Branch (1266:47): [True: 0, False: 539k]
  ------------------
 1267|   539k|    if (((in == 0 && out == 0) || flush == Z_FINISH) && ret == Z_OK)
                                   ^12.9k       ^526k    ^526k        ^12.9k ^12.9k
  ------------------
  |  Branch (1267:11): [True: 12.9k, False: 526k]
  |  Branch (1267:22): [True: 12.9k, False: 0]
  |  Branch (1267:35): [True: 0, False: 526k]
  |  Branch (1267:57): [True: 12.9k, False: 0]
  ------------------
 1268|  12.9k|        ret = Z_BUF_ERROR;
 1269|   539k|    return ret;
 1270|   539k|}
 1271|       |
 1272|   526k|int ZEXPORT inflateEnd(z_streamp strm) {
 1273|   526k|    struct inflate_state FAR *state;
 1274|   526k|    if (inflateStateCheck(strm))
  ------------------
  |  Branch (1274:9): [True: 0, False: 526k]
  ------------------
 1275|      0|        return Z_STREAM_ERROR;
 1276|   526k|    state = (struct inflate_state FAR *)strm->state;
 1277|   526k|    if (state->window != Z_NULL) ZFREE(strm, state->window);
                                               ^12.1k
  ------------------
  |  Branch (1277:9): [True: 12.1k, False: 514k]
  ------------------
 1278|   526k|    ZFREE(strm, strm->state);
 1279|   526k|    strm->state = Z_NULL;
 1280|   526k|    Tracev((stderr, "inflate: end\n"));
 1281|   526k|    return Z_OK;
 1282|   526k|}
 1283|       |
 1284|       |int ZEXPORT inflateGetDictionary(z_streamp strm, Bytef *dictionary,
 1285|      0|                                 uInt *dictLength) {
 1286|      0|    struct inflate_state FAR *state;
 1287|       |
 1288|       |    /* check state */
 1289|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1289:9): [True: 0, False: 0]
  ------------------
 1290|      0|    state = (struct inflate_state FAR *)strm->state;
 1291|       |
 1292|       |    /* copy dictionary */
 1293|      0|    if (state->whave && dictionary != Z_NULL) {
  ------------------
  |  Branch (1293:9): [True: 0, False: 0]
  |  Branch (1293:25): [True: 0, False: 0]
  ------------------
 1294|      0|        zmemcpy(dictionary, state->window + state->wnext,
 1295|      0|                state->whave - state->wnext);
 1296|      0|        zmemcpy(dictionary + state->whave - state->wnext,
 1297|      0|                state->window, state->wnext);
 1298|      0|    }
 1299|      0|    if (dictLength != Z_NULL)
  ------------------
  |  Branch (1299:9): [True: 0, False: 0]
  ------------------
 1300|      0|        *dictLength = state->whave;
 1301|      0|    return Z_OK;
 1302|      0|}
 1303|       |
 1304|       |int ZEXPORT inflateSetDictionary(z_streamp strm, const Bytef *dictionary,
 1305|      0|                                 uInt dictLength) {
 1306|      0|    struct inflate_state FAR *state;
 1307|      0|    unsigned long dictid;
 1308|      0|    int ret;
 1309|       |
 1310|       |    /* check state */
 1311|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1311:9): [True: 0, False: 0]
  ------------------
 1312|      0|    state = (struct inflate_state FAR *)strm->state;
 1313|      0|    if (state->wrap != 0 && state->mode != DICT)
  ------------------
  |  Branch (1313:9): [True: 0, False: 0]
  |  Branch (1313:29): [True: 0, False: 0]
  ------------------
 1314|      0|        return Z_STREAM_ERROR;
 1315|       |
 1316|       |    /* check for correct dictionary identifier */
 1317|      0|    if (state->mode == DICT) {
  ------------------
  |  Branch (1317:9): [True: 0, False: 0]
  ------------------
 1318|      0|        dictid = adler32(0L, Z_NULL, 0);
 1319|      0|        dictid = adler32(dictid, dictionary, dictLength);
 1320|      0|        if (dictid != state->check)
  ------------------
  |  Branch (1320:13): [True: 0, False: 0]
  ------------------
 1321|      0|            return Z_DATA_ERROR;
 1322|      0|    }
 1323|       |
 1324|       |    /* copy dictionary to window using updatewindow(), which will amend the
 1325|       |       existing dictionary if appropriate */
 1326|      0|    ret = updatewindow(strm, dictionary + dictLength, dictLength);
 1327|      0|    if (ret) {
  ------------------
  |  Branch (1327:9): [True: 0, False: 0]
  ------------------
 1328|      0|        state->mode = MEM;
 1329|      0|        return Z_MEM_ERROR;
 1330|      0|    }
 1331|      0|    state->havedict = 1;
 1332|      0|    Tracev((stderr, "inflate:   dictionary set\n"));
 1333|      0|    return Z_OK;
 1334|      0|}
 1335|       |
 1336|      0|int ZEXPORT inflateGetHeader(z_streamp strm, gz_headerp head) {
 1337|      0|    struct inflate_state FAR *state;
 1338|       |
 1339|       |    /* check state */
 1340|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1340:9): [True: 0, False: 0]
  ------------------
 1341|      0|    state = (struct inflate_state FAR *)strm->state;
 1342|      0|    if ((state->wrap & 2) == 0) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1342:9): [True: 0, False: 0]
  ------------------
 1343|       |
 1344|       |    /* save header structure */
 1345|      0|    state->head = head;
 1346|      0|    head->done = 0;
 1347|      0|    return Z_OK;
 1348|      0|}
 1349|       |
 1350|       |/*
 1351|       |   Search buf[0..len-1] for the pattern: 0, 0, 0xff, 0xff.  Return when found
 1352|       |   or when out of input.  When called, *have is the number of pattern bytes
 1353|       |   found in order so far, in 0..3.  On return *have is updated to the new
 1354|       |   state.  If on return *have equals four, then the pattern was found and the
 1355|       |   return value is how many bytes were read including the last byte of the
 1356|       |   pattern.  If *have is less than four, then the pattern has not been found
 1357|       |   yet and the return value is len.  In the latter case, syncsearch() can be
 1358|       |   called again with more data and the *have state.  *have is initialized to
 1359|       |   zero for the first call.
 1360|       | */
 1361|       |local unsigned syncsearch(unsigned FAR *have, const unsigned char FAR *buf,
 1362|      0|                          unsigned len) {
 1363|      0|    unsigned got;
 1364|      0|    unsigned next;
 1365|       |
 1366|      0|    got = *have;
 1367|      0|    next = 0;
 1368|      0|    while (next < len && got < 4) {
  ------------------
  |  Branch (1368:12): [True: 0, False: 0]
  |  Branch (1368:26): [True: 0, False: 0]
  ------------------
 1369|      0|        if ((int)(buf[next]) == (got < 2 ? 0 : 0xff))
  ------------------
  |  Branch (1369:13): [True: 0, False: 0]
  |  Branch (1369:34): [True: 0, False: 0]
  ------------------
 1370|      0|            got++;
 1371|      0|        else if (buf[next])
  ------------------
  |  Branch (1371:18): [True: 0, False: 0]
  ------------------
 1372|      0|            got = 0;
 1373|      0|        else
 1374|      0|            got = 4 - got;
 1375|      0|        next++;
 1376|      0|    }
 1377|      0|    *have = got;
 1378|      0|    return next;
 1379|      0|}
 1380|       |
 1381|      0|int ZEXPORT inflateSync(z_streamp strm) {
 1382|      0|    unsigned len;               /* number of bytes to look at or looked at */
 1383|      0|    int flags;                  /* temporary to save header status */
 1384|      0|    unsigned long in, out;      /* temporary to save total_in and total_out */
 1385|      0|    unsigned char buf[4];       /* to restore bit buffer to byte string */
 1386|      0|    struct inflate_state FAR *state;
 1387|       |
 1388|       |    /* check parameters */
 1389|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1389:9): [True: 0, False: 0]
  ------------------
 1390|      0|    state = (struct inflate_state FAR *)strm->state;
 1391|      0|    if (strm->avail_in == 0 && state->bits < 8) return Z_BUF_ERROR;
  ------------------
  |  Branch (1391:9): [True: 0, False: 0]
  |  Branch (1391:32): [True: 0, False: 0]
  ------------------
 1392|       |
 1393|       |    /* if first time, start search in bit buffer */
 1394|      0|    if (state->mode != SYNC) {
  ------------------
  |  Branch (1394:9): [True: 0, False: 0]
  ------------------
 1395|      0|        state->mode = SYNC;
 1396|      0|        state->hold >>= state->bits & 7;
 1397|      0|        state->bits -= state->bits & 7;
 1398|      0|        len = 0;
 1399|      0|        while (state->bits >= 8) {
  ------------------
  |  Branch (1399:16): [True: 0, False: 0]
  ------------------
 1400|      0|            buf[len++] = (unsigned char)(state->hold);
 1401|      0|            state->hold >>= 8;
 1402|      0|            state->bits -= 8;
 1403|      0|        }
 1404|      0|        state->have = 0;
 1405|      0|        syncsearch(&(state->have), buf, len);
 1406|      0|    }
 1407|       |
 1408|       |    /* search available input */
 1409|      0|    len = syncsearch(&(state->have), strm->next_in, strm->avail_in);
 1410|      0|    strm->avail_in -= len;
 1411|      0|    strm->next_in += len;
 1412|      0|    strm->total_in += len;
 1413|       |
 1414|       |    /* return no joy or set up to restart inflate() on a new block */
 1415|      0|    if (state->have != 4) return Z_DATA_ERROR;
  ------------------
  |  Branch (1415:9): [True: 0, False: 0]
  ------------------
 1416|      0|    if (state->flags == -1)
  ------------------
  |  Branch (1416:9): [True: 0, False: 0]
  ------------------
 1417|      0|        state->wrap = 0;    /* if no header yet, treat as raw */
 1418|      0|    else
 1419|      0|        state->wrap &= ~4;  /* no point in computing a check value now */
 1420|      0|    flags = state->flags;
 1421|      0|    in = strm->total_in;  out = strm->total_out;
 1422|      0|    inflateReset(strm);
 1423|      0|    strm->total_in = in;  strm->total_out = out;
 1424|      0|    state->flags = flags;
 1425|      0|    state->mode = TYPE;
 1426|      0|    return Z_OK;
 1427|      0|}
 1428|       |
 1429|       |/*
 1430|       |   Returns true if inflate is currently at the end of a block generated by
 1431|       |   Z_SYNC_FLUSH or Z_FULL_FLUSH. This function is used by one PPP
 1432|       |   implementation to provide an additional safety check. PPP uses
 1433|       |   Z_SYNC_FLUSH but removes the length bytes of the resulting empty stored
 1434|       |   block. When decompressing, PPP checks that at the end of input packet,
 1435|       |   inflate is waiting for these length bytes.
 1436|       | */
 1437|      0|int ZEXPORT inflateSyncPoint(z_streamp strm) {
 1438|      0|    struct inflate_state FAR *state;
 1439|       |
 1440|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1440:9): [True: 0, False: 0]
  ------------------
 1441|      0|    state = (struct inflate_state FAR *)strm->state;
 1442|      0|    return state->mode == STORED && state->bits == 0;
  ------------------
  |  Branch (1442:12): [True: 0, False: 0]
  |  Branch (1442:37): [True: 0, False: 0]
  ------------------
 1443|      0|}
 1444|       |
 1445|      0|int ZEXPORT inflateCopy(z_streamp dest, z_streamp source) {
 1446|      0|    struct inflate_state FAR *state;
 1447|      0|    struct inflate_state FAR *copy;
 1448|      0|    unsigned char FAR *window;
 1449|      0|    unsigned wsize;
 1450|       |
 1451|       |    /* check input */
 1452|      0|    if (inflateStateCheck(source) || dest == Z_NULL)
  ------------------
  |  Branch (1452:9): [True: 0, False: 0]
  |  Branch (1452:38): [True: 0, False: 0]
  ------------------
 1453|      0|        return Z_STREAM_ERROR;
 1454|      0|    state = (struct inflate_state FAR *)source->state;
 1455|       |
 1456|       |    /* allocate space */
 1457|      0|    copy = (struct inflate_state FAR *)
 1458|      0|           ZALLOC(source, 1, sizeof(struct inflate_state));
 1459|      0|    if (copy == Z_NULL) return Z_MEM_ERROR;
  ------------------
  |  Branch (1459:9): [True: 0, False: 0]
  ------------------
 1460|      0|    window = Z_NULL;
 1461|      0|    if (state->window != Z_NULL) {
  ------------------
  |  Branch (1461:9): [True: 0, False: 0]
  ------------------
 1462|      0|        window = (unsigned char FAR *)
 1463|      0|                 ZALLOC(source, 1U << state->wbits, sizeof(unsigned char));
 1464|      0|        if (window == Z_NULL) {
  ------------------
  |  Branch (1464:13): [True: 0, False: 0]
  ------------------
 1465|      0|            ZFREE(source, copy);
 1466|      0|            return Z_MEM_ERROR;
 1467|      0|        }
 1468|      0|    }
 1469|       |
 1470|       |    /* copy state */
 1471|      0|    zmemcpy((voidpf)dest, (voidpf)source, sizeof(z_stream));
 1472|      0|    zmemcpy((voidpf)copy, (voidpf)state, sizeof(struct inflate_state));
 1473|      0|    copy->strm = dest;
 1474|      0|    if (state->lencode >= state->codes &&
  ------------------
  |  Branch (1474:9): [True: 0, False: 0]
  ------------------
 1475|      0|        state->lencode <= state->codes + ENOUGH - 1) {
  ------------------
  |  Branch (1475:9): [True: 0, False: 0]
  ------------------
 1476|      0|        copy->lencode = copy->codes + (state->lencode - state->codes);
 1477|      0|        copy->distcode = copy->codes + (state->distcode - state->codes);
 1478|      0|    }
 1479|      0|    copy->next = copy->codes + (state->next - state->codes);
 1480|      0|    if (window != Z_NULL) {
  ------------------
  |  Branch (1480:9): [True: 0, False: 0]
  ------------------
 1481|      0|        wsize = 1U << state->wbits;
 1482|      0|        zmemcpy(window, state->window, wsize);
 1483|      0|    }
 1484|      0|    copy->window = window;
 1485|      0|    dest->state = (struct internal_state FAR *)copy;
 1486|      0|    return Z_OK;
 1487|      0|}
 1488|       |
 1489|      0|int ZEXPORT inflateUndermine(z_streamp strm, int subvert) {
 1490|      0|    struct inflate_state FAR *state;
 1491|       |
 1492|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1492:9): [True: 0, False: 0]
  ------------------
 1493|      0|    state = (struct inflate_state FAR *)strm->state;
 1494|       |#ifdef INFLATE_ALLOW_INVALID_DISTANCE_TOOFAR_ARRR
 1495|       |    state->sane = !subvert;
 1496|       |    return Z_OK;
 1497|       |#else
 1498|      0|    (void)subvert;
 1499|      0|    state->sane = 1;
 1500|      0|    return Z_DATA_ERROR;
 1501|      0|#endif
 1502|      0|}
 1503|       |
 1504|      0|int ZEXPORT inflateValidate(z_streamp strm, int check) {
 1505|      0|    struct inflate_state FAR *state;
 1506|       |
 1507|      0|    if (inflateStateCheck(strm)) return Z_STREAM_ERROR;
  ------------------
  |  Branch (1507:9): [True: 0, False: 0]
  ------------------
 1508|      0|    state = (struct inflate_state FAR *)strm->state;
 1509|      0|    if (check && state->wrap)
  ------------------
  |  Branch (1509:9): [True: 0, False: 0]
  |  Branch (1509:18): [True: 0, False: 0]
  ------------------
 1510|      0|        state->wrap |= 4;
 1511|      0|    else
 1512|      0|        state->wrap &= ~4;
 1513|      0|    return Z_OK;
 1514|      0|}
 1515|       |
 1516|      0|long ZEXPORT inflateMark(z_streamp strm) {
 1517|      0|    struct inflate_state FAR *state;
 1518|       |
 1519|      0|    if (inflateStateCheck(strm))
  ------------------
  |  Branch (1519:9): [True: 0, False: 0]
  ------------------
 1520|      0|        return -(1L << 16);
 1521|      0|    state = (struct inflate_state FAR *)strm->state;
 1522|      0|    return (long)(((unsigned long)((long)state->back)) << 16) +
 1523|      0|        (state->mode == COPY ? state->length :
  ------------------
  |  Branch (1523:10): [True: 0, False: 0]
  ------------------
 1524|      0|            (state->mode == MATCH ? state->was - state->length : 0));
  ------------------
  |  Branch (1524:14): [True: 0, False: 0]
  ------------------
 1525|      0|}
 1526|       |
 1527|      0|unsigned long ZEXPORT inflateCodesUsed(z_streamp strm) {
 1528|      0|    struct inflate_state FAR *state;
 1529|      0|    if (inflateStateCheck(strm)) return (unsigned long)-1;
  ------------------
  |  Branch (1529:9): [True: 0, False: 0]
  ------------------
 1530|      0|    state = (struct inflate_state FAR *)strm->state;
 1531|      0|    return (unsigned long)(state->next - state->codes);
 1532|      0|}

/home/minseo/alfha/targets/zlib/target/inftrees.c:
    1|       |/* inftrees.c -- generate Huffman trees for efficient decoding
    2|       | * Copyright (C) 1995-2025 Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |#include "zutil.h"
    7|       |#include "inftrees.h"
    8|       |
    9|   102k|#define MAXBITS 15
   10|       |
   11|       |const char inflate_copyright[] =
   12|       |   " inflate 1.3.1.2 Copyright 1995-2025 Mark Adler ";
   13|       |/*
   14|       |  If you use the zlib library in a product, an acknowledgment is welcome
   15|       |  in the documentation of your product. If for some reason you cannot
   16|       |  include such an acknowledgment, I would appreciate that you keep this
   17|       |  copyright string in the executable of your product.
   18|       | */
   19|       |
   20|       |/*
   21|       |   Build a set of tables to decode the provided canonical Huffman code.
   22|       |   The code lengths are lens[0..codes-1].  The result starts at *table,
   23|       |   whose indices are 0..2^bits-1.  work is a writable array of at least
   24|       |   lens shorts, which is used as a work area.  type is the type of code
   25|       |   to be generated, CODES, LENS, or DISTS.  On return, zero is success,
   26|       |   -1 is an invalid code, and +1 means that ENOUGH isn't enough.  table
   27|       |   on return points to the next available entry's address.  bits is the
   28|       |   requested root table index bits, and on return it is the actual root
   29|       |   table index bits.  It will differ if the request is greater than the
   30|       |   longest code or if it is less than the shortest code.
   31|       | */
   32|       |int ZLIB_INTERNAL inflate_table(codetype type, unsigned short FAR *lens,
   33|       |                                unsigned codes, code FAR * FAR *table,
   34|  4.15k|                                unsigned FAR *bits, unsigned short FAR *work) {
   35|  4.15k|    unsigned len;               /* a code's length in bits */
   36|  4.15k|    unsigned sym;               /* index of code symbols */
   37|  4.15k|    unsigned min, max;          /* minimum and maximum code lengths */
   38|  4.15k|    unsigned root;              /* number of index bits for root table */
   39|  4.15k|    unsigned curr;              /* number of index bits for current table */
   40|  4.15k|    unsigned drop;              /* code bits to drop for sub-table */
   41|  4.15k|    int left;                   /* number of prefix codes available */
   42|  4.15k|    unsigned used;              /* code entries in table used */
   43|  4.15k|    unsigned huff;              /* Huffman code */
   44|  4.15k|    unsigned incr;              /* for incrementing code, index */
   45|  4.15k|    unsigned fill;              /* index for replicating entries */
   46|  4.15k|    unsigned low;               /* low bits for current root entry */
   47|  4.15k|    unsigned mask;              /* mask for low root bits */
   48|  4.15k|    code here;                  /* table entry for duplication */
   49|  4.15k|    code FAR *next;             /* next available space in table */
   50|  4.15k|    const unsigned short FAR *base;     /* base value table to use */
   51|  4.15k|    const unsigned short FAR *extra;    /* extra bits table to use */
   52|  4.15k|    unsigned match;             /* use base and extra for symbol >= match */
   53|  4.15k|    unsigned short count[MAXBITS+1];    /* number of codes of each length */
   54|  4.15k|    unsigned short offs[MAXBITS+1];     /* offsets in table for each length */
   55|  4.15k|    static const unsigned short lbase[31] = { /* Length codes 257..285 base */
   56|  4.15k|        3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 15, 17, 19, 23, 27, 31,
   57|  4.15k|        35, 43, 51, 59, 67, 83, 99, 115, 131, 163, 195, 227, 258, 0, 0};
   58|  4.15k|    static const unsigned short lext[31] = { /* Length codes 257..285 extra */
   59|  4.15k|        16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18, 18,
   60|  4.15k|        19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 16, 64, 204};
   61|  4.15k|    static const unsigned short dbase[32] = { /* Distance codes 0..29 base */
   62|  4.15k|        1, 2, 3, 4, 5, 7, 9, 13, 17, 25, 33, 49, 65, 97, 129, 193,
   63|  4.15k|        257, 385, 513, 769, 1025, 1537, 2049, 3073, 4097, 6145,
   64|  4.15k|        8193, 12289, 16385, 24577, 0, 0};
   65|  4.15k|    static const unsigned short dext[32] = { /* Distance codes 0..29 extra */
   66|  4.15k|        16, 16, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22,
   67|  4.15k|        23, 23, 24, 24, 25, 25, 26, 26, 27, 27,
   68|  4.15k|        28, 28, 29, 29, 64, 64};
   69|       |
   70|       |    /*
   71|       |       Process a set of code lengths to create a canonical Huffman code.  The
   72|       |       code lengths are lens[0..codes-1].  Each length corresponds to the
   73|       |       symbols 0..codes-1.  The Huffman code is generated by first sorting the
   74|       |       symbols by length from short to long, and retaining the symbol order
   75|       |       for codes with equal lengths.  Then the code starts with all zero bits
   76|       |       for the first code of the shortest length, and the codes are integer
   77|       |       increments for the same length, and zeros are appended as the length
   78|       |       increases.  For the deflate format, these bits are stored backwards
   79|       |       from their more natural integer increment ordering, and so when the
   80|       |       decoding tables are built in the large loop below, the integer codes
   81|       |       are incremented backwards.
   82|       |
   83|       |       This routine assumes, but does not check, that all of the entries in
   84|       |       lens[] are in the range 0..MAXBITS.  The caller must assure this.
   85|       |       1..MAXBITS is interpreted as that code length.  zero means that that
   86|       |       symbol does not occur in this code.
   87|       |
   88|       |       The codes are sorted by computing a count of codes for each length,
   89|       |       creating from that a table of starting indices for each length in the
   90|       |       sorted table, and then entering the symbols in order in the sorted
   91|       |       table.  The sorted table is work[], with that space being provided by
   92|       |       the caller.
   93|       |
   94|       |       The length counts are used for other purposes as well, i.e. finding
   95|       |       the minimum and maximum length codes, determining if there are any
   96|       |       codes at all, checking for a valid set of lengths, and looking ahead
   97|       |       at length counts to determine sub-table sizes when building the
   98|       |       decoding tables.
   99|       |     */
  100|       |
  101|       |    /* accumulate lengths for codes (assumes lens[] all in 0..MAXBITS) */
  102|  70.6k|    for (len = 0; len <= MAXBITS; len++)
                                                ^66.5k
  ------------------
  |  Branch (102:19): [True: 66.5k, False: 4.15k]
  ------------------
  103|  66.5k|        count[len] = 0;
  104|  84.9k|    for (sym = 0; sym < codes; sym++)
                                             ^80.8k
  ------------------
  |  Branch (104:19): [True: 80.8k, False: 4.15k]
  ------------------
  105|  80.8k|        count[lens[sym]]++;
  106|       |
  107|       |    /* bound code lengths, force root to be within code lengths */
  108|  4.15k|    root = *bits;
  109|  42.4k|    for (max = MAXBITS; max >= 1; max--)
                             ^4.15k             ^38.2k
  ------------------
  |  Branch (109:25): [True: 42.2k, False: 134]
  ------------------
  110|  42.2k|        if (count[max] != 0) break;
                                           ^4.02k
  ------------------
  |  Branch (110:13): [True: 4.02k, False: 38.2k]
  ------------------
  111|  4.15k|    if (root > max) root = max;
                                  ^2.88k
  ------------------
  |  Branch (111:9): [True: 2.88k, False: 1.27k]
  ------------------
  112|  4.15k|    if (max == 0) {                     /* no symbols to code at all */
  ------------------
  |  Branch (112:9): [True: 134, False: 4.02k]
  ------------------
  113|    134|        here.op = (unsigned char)64;    /* invalid code marker */
  114|    134|        here.bits = (unsigned char)1;
  115|    134|        here.val = (unsigned short)0;
  116|    134|        *(*table)++ = here;             /* make a table to force an error */
  117|    134|        *(*table)++ = here;
  118|    134|        *bits = 1;
  119|    134|        return 0;     /* no symbols, but wait for decoding to report error */
  120|    134|    }
  121|  5.53k|    for (min = 1; min < max; min++)
                  ^4.02k                   ^1.51k
  ------------------
  |  Branch (121:19): [True: 5.51k, False: 19]
  ------------------
  122|  5.51k|        if (count[min] != 0) break;
                                           ^4.00k
  ------------------
  |  Branch (122:13): [True: 4.00k, False: 1.51k]
  ------------------
  123|  4.02k|    if (root < min) root = min;
                                  ^0
  ------------------
  |  Branch (123:9): [True: 0, False: 4.02k]
  ------------------
  124|       |
  125|       |    /* check for an over-subscribed or incomplete set of lengths */
  126|  4.02k|    left = 1;
  127|  27.5k|    for (len = 1; len <= MAXBITS; len++) {
                                                ^23.5k
  ------------------
  |  Branch (127:19): [True: 26.2k, False: 1.32k]
  ------------------
  128|  26.2k|        left <<= 1;
  129|  26.2k|        left -= count[len];
  130|  26.2k|        if (left < 0) return -1;        /* over-subscribed */
                                    ^2.70k
  ------------------
  |  Branch (130:13): [True: 2.70k, False: 23.5k]
  ------------------
  131|  26.2k|    }
  132|  1.32k|    if (left > 0 && (type == CODES || max != 1))
                                  ^1.29k^1.29k           ^0
  ------------------
  |  Branch (132:9): [True: 1.29k, False: 30]
  |  Branch (132:22): [True: 1.29k, False: 0]
  |  Branch (132:39): [True: 0, False: 0]
  ------------------
  133|  1.29k|        return -1;                      /* incomplete set */
  134|       |
  135|       |    /* generate offsets into symbol table for each length for sorting */
  136|     30|    offs[1] = 0;
  137|    450|    for (len = 1; len < MAXBITS; len++)
                                               ^420
  ------------------
  |  Branch (137:19): [True: 420, False: 30]
  ------------------
  138|    420|        offs[len + 1] = offs[len] + count[len];
  139|       |
  140|       |    /* sort symbols by length, by symbol order within each length */
  141|  2.44k|    for (sym = 0; sym < codes; sym++)
                                             ^2.41k
  ------------------
  |  Branch (141:19): [True: 2.41k, False: 30]
  ------------------
  142|  2.41k|        if (lens[sym] != 0) work[offs[lens[sym]]++] = (unsigned short)sym;
                                          ^191
  ------------------
  |  Branch (142:13): [True: 191, False: 2.22k]
  ------------------
  143|       |
  144|       |    /*
  145|       |       Create and fill in decoding tables.  In this loop, the table being
  146|       |       filled is at next and has curr index bits.  The code being used is huff
  147|       |       with length len.  That code is converted to an index by dropping drop
  148|       |       bits off of the bottom.  For codes where len is less than drop + curr,
  149|       |       those top drop + curr - len bits are incremented through all values to
  150|       |       fill the table with replicated entries.
  151|       |
  152|       |       root is the number of index bits for the root table.  When len exceeds
  153|       |       root, sub-tables are created pointed to by the root entry with an index
  154|       |       of the low root bits of huff.  This is saved in low to check for when a
  155|       |       new sub-table should be started.  drop is zero when the root table is
  156|       |       being filled, and drop is root when sub-tables are being filled.
  157|       |
  158|       |       When a new sub-table is needed, it is necessary to look ahead in the
  159|       |       code lengths to determine what size sub-table is needed.  The length
  160|       |       counts are used for this, and so count[] is decremented as codes are
  161|       |       entered in the tables.
  162|       |
  163|       |       used keeps track of how many table entries have been allocated from the
  164|       |       provided *table space.  It is checked for LENS and DIST tables against
  165|       |       the constants ENOUGH_LENS and ENOUGH_DISTS to guard against changes in
  166|       |       the initial root table size constants.  See the comments in inftrees.h
  167|       |       for more information.
  168|       |
  169|       |       sym increments through all symbols, and the loop terminates when
  170|       |       all codes of length max, i.e. all codes, have been processed.  This
  171|       |       routine permits incomplete codes, so another loop after this one fills
  172|       |       in the rest of the decoding tables with invalid code markers.
  173|       |     */
  174|       |
  175|       |    /* set up for code type */
  176|     30|    switch (type) {
  177|     14|    case CODES:
  ------------------
  |  Branch (177:5): [True: 14, False: 16]
  ------------------
  178|     14|        base = extra = work;    /* dummy value--not used */
  179|     14|        match = 20;
  180|     14|        break;
  181|      8|    case LENS:
  ------------------
  |  Branch (181:5): [True: 8, False: 22]
  ------------------
  182|      8|        base = lbase;
  183|      8|        extra = lext;
  184|      8|        match = 257;
  185|      8|        break;
  186|      8|    default:    /* DISTS */
  ------------------
  |  Branch (186:5): [True: 8, False: 22]
  ------------------
  187|      8|        base = dbase;
  188|      8|        extra = dext;
  189|      8|        match = 0;
  190|     30|    }
  191|       |
  192|       |    /* initialize state for loop */
  193|     30|    huff = 0;                   /* starting code */
  194|     30|    sym = 0;                    /* starting code symbol */
  195|     30|    len = min;                  /* starting code length */
  196|     30|    next = *table;              /* current table to fill in */
  197|     30|    curr = root;                /* current table index bits */
  198|     30|    drop = 0;                   /* current bits to drop from code for index */
  199|     30|    low = (unsigned)(-1);       /* trigger new sub-table when len > root */
  200|     30|    used = 1U << root;          /* use root table entries */
  201|     30|    mask = used - 1;            /* mask for comparing low */
  202|       |
  203|       |    /* check available table space */
  204|     30|    if ((type == LENS && used > ENOUGH_LENS) ||
                                       ^8     ^8
  ------------------
  |  Branch (204:10): [True: 8, False: 22]
  |  Branch (204:26): [True: 0, False: 8]
  ------------------
  205|     30|        (type == DISTS && used > ENOUGH_DISTS))
                                        ^8     ^8
  ------------------
  |  Branch (205:10): [True: 8, False: 22]
  |  Branch (205:27): [True: 0, False: 8]
  ------------------
  206|      0|        return 1;
  207|       |
  208|       |    /* process all codes and make table entries */
  209|    191|    for (;;) {
                  ^30
  210|       |        /* create table entry */
  211|    191|        here.bits = (unsigned char)(len - drop);
  212|    191|        if (work[sym] + 1U < match) {
  ------------------
  |  Branch (212:13): [True: 149, False: 42]
  ------------------
  213|    149|            here.op = (unsigned char)0;
  214|    149|            here.val = work[sym];
  215|    149|        }
  216|     42|        else if (work[sym] >= match) {
  ------------------
  |  Branch (216:18): [True: 34, False: 8]
  ------------------
  217|     34|            here.op = (unsigned char)(extra[work[sym] - match]);
  218|     34|            here.val = base[work[sym] - match];
  219|     34|        }
  220|      8|        else {
  221|      8|            here.op = (unsigned char)(32 + 64);         /* end of block */
  222|      8|            here.val = 0;
  223|      8|        }
  224|       |
  225|       |        /* replicate for those indices with low len bits equal to huff */
  226|    191|        incr = 1U << (len - drop);
  227|    191|        fill = 1U << curr;
  228|    191|        min = fill;                 /* save offset to next table */
  229|    482|        do {
  230|    482|            fill -= incr;
  231|    482|            next[(huff >> drop) + fill] = here;
  232|    482|        } while (fill != 0);
  ------------------
  |  Branch (232:18): [True: 291, False: 191]
  ------------------
  233|       |
  234|       |        /* backwards increment the len-bit code huff */
  235|    191|        incr = 1U << (len - 1);
  236|    352|        while (huff & incr)
  ------------------
  |  Branch (236:16): [True: 161, False: 191]
  ------------------
  237|    161|            incr >>= 1;
  238|    191|        if (incr != 0) {
  ------------------
  |  Branch (238:13): [True: 161, False: 30]
  ------------------
  239|    161|            huff &= incr - 1;
  240|    161|            huff += incr;
  241|    161|        }
  242|     30|        else
  243|     30|            huff = 0;
  244|       |
  245|       |        /* go to next symbol, update count, len */
  246|    191|        sym++;
  247|    191|        if (--(count[len]) == 0) {
  ------------------
  |  Branch (247:13): [True: 73, False: 118]
  ------------------
  248|     73|            if (len == max) break;
                                          ^30
  ------------------
  |  Branch (248:17): [True: 30, False: 43]
  ------------------
  249|     43|            len = lens[work[sym]];
  250|     43|        }
  251|       |
  252|       |        /* create new sub-table if needed */
  253|    161|        if (len > root && (huff & mask) != low) {
                                        ^0
  ------------------
  |  Branch (253:13): [True: 0, False: 161]
  |  Branch (253:27): [True: 0, False: 0]
  ------------------
  254|       |            /* if first time, transition to sub-tables */
  255|      0|            if (drop == 0)
  ------------------
  |  Branch (255:17): [True: 0, False: 0]
  ------------------
  256|      0|                drop = root;
  257|       |
  258|       |            /* increment past last table */
  259|      0|            next += min;            /* here min is 1 << curr */
  260|       |
  261|       |            /* determine length of next table */
  262|      0|            curr = len - drop;
  263|      0|            left = (int)(1 << curr);
  264|      0|            while (curr + drop < max) {
  ------------------
  |  Branch (264:20): [True: 0, False: 0]
  ------------------
  265|      0|                left -= count[curr + drop];
  266|      0|                if (left <= 0) break;
  ------------------
  |  Branch (266:21): [True: 0, False: 0]
  ------------------
  267|      0|                curr++;
  268|      0|                left <<= 1;
  269|      0|            }
  270|       |
  271|       |            /* check for enough space */
  272|      0|            used += 1U << curr;
  273|      0|            if ((type == LENS && used > ENOUGH_LENS) ||
  ------------------
  |  Branch (273:18): [True: 0, False: 0]
  |  Branch (273:34): [True: 0, False: 0]
  ------------------
  274|      0|                (type == DISTS && used > ENOUGH_DISTS))
  ------------------
  |  Branch (274:18): [True: 0, False: 0]
  |  Branch (274:35): [True: 0, False: 0]
  ------------------
  275|      0|                return 1;
  276|       |
  277|       |            /* point entry in root table to sub-table */
  278|      0|            low = huff & mask;
  279|      0|            (*table)[low].op = (unsigned char)curr;
  280|      0|            (*table)[low].bits = (unsigned char)root;
  281|      0|            (*table)[low].val = (unsigned short)(next - *table);
  282|      0|        }
  283|    161|    }
  284|       |
  285|       |    /* fill in remaining table entry if code is incomplete (guaranteed to have
  286|       |       at most one remaining entry, since if the code is incomplete, the
  287|       |       maximum code length that was allowed to get this far is one bit) */
  288|     30|    if (huff != 0) {
  ------------------
  |  Branch (288:9): [True: 0, False: 30]
  ------------------
  289|      0|        here.op = (unsigned char)64;            /* invalid code marker */
  290|      0|        here.bits = (unsigned char)(len - drop);
  291|      0|        here.val = (unsigned short)0;
  292|      0|        next[huff] = here;
  293|      0|    }
  294|       |
  295|       |    /* set return parameters */
  296|     30|    *table += used;
  297|     30|    *bits = root;
  298|     30|    return 0;
  299|     30|}

/home/minseo/alfha/targets/zlib/target/inftrees.h:
    1|       |/* inftrees.h -- header to use inftrees.c
    2|       | * Copyright (C) 1995-2005, 2010 Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* WARNING: this file should *not* be used by applications. It is
    7|       |   part of the implementation of the compression library and is
    8|       |   subject to change. Applications should only use zlib.h.
    9|       | */
   10|       |
   11|       |/* Structure for decoding tables.  Each entry provides either the
   12|       |   information needed to do the operation requested by the code that
   13|       |   indexed that table entry, or it provides a pointer to another
   14|       |   table that indexes more bits of the code.  op indicates whether
   15|       |   the entry is a pointer to another table, a literal, a length or
   16|       |   distance, an end-of-block, or an invalid code.  For a table
   17|       |   pointer, the low four bits of op is the number of index bits of
   18|       |   that table.  For a length or distance, the low four bits of op
   19|       |   is the number of extra bits to get after the code.  bits is
   20|       |   the number of bits in this code or part of the code to drop off
   21|       |   of the bit buffer.  val is the actual byte to output in the case
   22|       |   of a literal, the base length or distance, or the offset from
   23|       |   the current table to the next table.  Each entry is four bytes. */
   24|       |typedef struct {
   25|       |    unsigned char op;           /* operation, extra bits, table bits */
   26|       |    unsigned char bits;         /* bits in this part of the code */
   27|       |    unsigned short val;         /* offset in table or code value */
   28|       |} code;
   29|       |
   30|       |/* op values as set by inflate_table():
   31|       |    00000000 - literal
   32|       |    0000tttt - table link, tttt != 0 is the number of table index bits
   33|       |    0001eeee - length or distance, eeee is the number of extra bits
   34|       |    01100000 - end of block
   35|       |    01000000 - invalid code
   36|       | */
   37|       |
   38|       |/* Maximum size of the dynamic table.  The maximum number of code structures is
   39|       |   1444, which is the sum of 852 for literal/length codes and 592 for distance
   40|       |   codes.  These values were found by exhaustive searches using the program
   41|       |   examples/enough.c found in the zlib distribution.  The arguments to that
   42|       |   program are the number of symbols, the initial root table size, and the
   43|       |   maximum bit length of a code.  "enough 286 9 15" for literal/length codes
   44|       |   returns 852, and "enough 30 6 15" for distance codes returns 592. The
   45|       |   initial root table size (9 or 6) is found in the fifth argument of the
   46|       |   inflate_table() calls in inflate.c and infback.c.  If the root table size is
   47|       |   changed, then these maximum sizes would be need to be recalculated and
   48|       |   updated. */
   49|      8|#define ENOUGH_LENS 852
   50|      8|#define ENOUGH_DISTS 592
   51|      0|#define ENOUGH (ENOUGH_LENS+ENOUGH_DISTS)
   52|       |
   53|       |/* Type of code to build for inflate_table() */
   54|       |typedef enum {
   55|       |    CODES,
   56|       |    LENS,
   57|       |    DISTS
   58|       |} codetype;
   59|       |
   60|       |int ZLIB_INTERNAL inflate_table(codetype type, unsigned short FAR *lens,
   61|       |                                unsigned codes, code FAR * FAR *table,
   62|       |                                unsigned FAR *bits, unsigned short FAR *work);

/home/minseo/alfha/targets/zlib/target/trees.c:
    1|       |/* trees.c -- output deflated data using Huffman coding
    2|       | * Copyright (C) 1995-2024 Jean-loup Gailly
    3|       | * detect_data_type() function provided freely by Cosmin Truta, 2006
    4|       | * For conditions of distribution and use, see copyright notice in zlib.h
    5|       | */
    6|       |
    7|       |/*
    8|       | *  ALGORITHM
    9|       | *
   10|       | *      The "deflation" process uses several Huffman trees. The more
   11|       | *      common source values are represented by shorter bit sequences.
   12|       | *
   13|       | *      Each code tree is stored in a compressed form which is itself
   14|       | * a Huffman encoding of the lengths of all the code strings (in
   15|       | * ascending order by source values).  The actual code strings are
   16|       | * reconstructed from the lengths in the inflate process, as described
   17|       | * in the deflate specification.
   18|       | *
   19|       | *  REFERENCES
   20|       | *
   21|       | *      Deutsch, L.P.,"'Deflate' Compressed Data Format Specification".
   22|       | *      Available in ftp.uu.net:/pub/archiving/zip/doc/deflate-1.1.doc
   23|       | *
   24|       | *      Storer, James A.
   25|       | *          Data Compression:  Methods and Theory, pp. 49-50.
   26|       | *          Computer Science Press, 1988.  ISBN 0-7167-8156-5.
   27|       | *
   28|       | *      Sedgewick, R.
   29|       | *          Algorithms, p290.
   30|       | *          Addison-Wesley, 1983. ISBN 0-201-06672-6.
   31|       | */
   32|       |
   33|       |/* @(#) $Id$ */
   34|       |
   35|       |/* #define GEN_TREES_H */
   36|       |
   37|       |#include "deflate.h"
   38|       |
   39|       |#ifdef ZLIB_DEBUG
   40|       |#  include <ctype.h>
   41|       |#endif
   42|       |
   43|       |/* ===========================================================================
   44|       | * Constants
   45|       | */
   46|       |
   47|       |#define MAX_BL_BITS 7
   48|       |/* Bit length codes must not exceed MAX_BL_BITS bits */
   49|       |
   50|   511k|#define END_BLOCK 256
   51|       |/* end of block literal code */
   52|       |
   53|  1.27k|#define REP_3_6      16
   54|       |/* repeat previous bit length 3-6 times (2 bits of repeat count) */
   55|       |
   56|   260k|#define REPZ_3_10    17
   57|       |/* repeat a zero length 3-10 times  (3 bits of repeat count) */
   58|       |
   59|  1.03M|#define REPZ_11_138  18
   60|       |/* repeat a zero length 11-138 times  (7 bits of repeat count) */
   61|       |
   62|       |local const int extra_lbits[LENGTH_CODES] /* extra bits for each length code */
   63|       |   = {0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0};
   64|       |
   65|       |local const int extra_dbits[D_CODES] /* extra bits for each distance code */
   66|       |   = {0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13};
   67|       |
   68|       |local const int extra_blbits[BL_CODES]/* extra bits for each bit length code */
   69|       |   = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7};
   70|       |
   71|       |local const uch bl_order[BL_CODES]
   72|       |   = {16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15};
   73|       |/* The lengths of the bit length codes are sent in order of decreasing
   74|       | * probability, to avoid transmitting the lengths for unused bit length codes.
   75|       | */
   76|       |
   77|       |/* ===========================================================================
   78|       | * Local data. These are initialized only once.
   79|       | */
   80|       |
   81|       |#define DIST_CODE_LEN  512 /* see definition of array dist_code below */
   82|       |
   83|       |#if defined(GEN_TREES_H) || !defined(STDC)
   84|       |/* non ANSI compilers may not accept trees.h */
   85|       |
   86|       |local ct_data static_ltree[L_CODES+2];
   87|       |/* The static literal tree. Since the bit lengths are imposed, there is no
   88|       | * need for the L_CODES extra codes used during heap construction. However
   89|       | * The codes 286 and 287 are needed to build a canonical tree (see _tr_init
   90|       | * below).
   91|       | */
   92|       |
   93|       |local ct_data static_dtree[D_CODES];
   94|       |/* The static distance tree. (Actually a trivial tree since all codes use
   95|       | * 5 bits.)
   96|       | */
   97|       |
   98|       |uch _dist_code[DIST_CODE_LEN];
   99|       |/* Distance codes. The first 256 values correspond to the distances
  100|       | * 3 .. 258, the last 256 values correspond to the top 8 bits of
  101|       | * the 15 bit distances.
  102|       | */
  103|       |
  104|       |uch _length_code[MAX_MATCH-MIN_MATCH+1];
  105|       |/* length code for each normalized match length (0 == MIN_MATCH) */
  106|       |
  107|       |local int base_length[LENGTH_CODES];
  108|       |/* First normalized length for each code (0 = MIN_MATCH) */
  109|       |
  110|       |local int base_dist[D_CODES];
  111|       |/* First normalized distance for each code (0 = distance of 1) */
  112|       |
  113|       |#else
  114|       |#  include "trees.h"
  115|       |#endif /* GEN_TREES_H */
  116|       |
  117|       |struct static_tree_desc_s {
  118|       |    const ct_data *static_tree;  /* static tree or NULL */
  119|       |    const intf *extra_bits;      /* extra bits for each code or NULL */
  120|       |    int     extra_base;          /* base index for extra_bits */
  121|       |    int     elems;               /* max number of elements in the tree */
  122|       |    int     max_length;          /* max bit length for the codes */
  123|       |};
  124|       |
  125|       |#ifdef NO_INIT_GLOBAL_POINTERS
  126|       |#  define TCONST
  127|       |#else
  128|       |#  define TCONST const
  129|       |#endif
  130|       |
  131|       |local TCONST static_tree_desc static_l_desc =
  132|       |{static_ltree, extra_lbits, LITERALS+1, L_CODES, MAX_BITS};
  133|       |
  134|       |local TCONST static_tree_desc static_d_desc =
  135|       |{static_dtree, extra_dbits, 0,          D_CODES, MAX_BITS};
  136|       |
  137|       |local TCONST static_tree_desc static_bl_desc =
  138|       |{(const ct_data *)0, extra_blbits, 0,   BL_CODES, MAX_BL_BITS};
  139|       |
  140|       |/* ===========================================================================
  141|       | * Output a short LSB first on the stream.
  142|       | * IN assertion: there is enough room in pendingBuf.
  143|       | */
  144|  1.38M|#define put_short(s, w) { \
  145|  1.38M|    put_byte(s, (uch)((w) & 0xff)); \
  146|  1.38M|    put_byte(s, (uch)((ush)(w) >> 8)); \
  147|  1.38M|}
  148|       |
  149|       |/* ===========================================================================
  150|       | * Reverse the first len bits of a code, using straightforward code (a faster
  151|       | * method would use a table)
  152|       | * IN assertion: 1 <= len <= 15
  153|       | */
  154|  3.22M|local unsigned bi_reverse(unsigned code, int len) {
  155|  3.22M|    register unsigned res = 0;
  156|  7.82M|    do {
  157|  7.82M|        res |= code & 1;
  158|  7.82M|        code >>= 1, res <<= 1;
  159|  7.82M|    } while (--len > 0);
  ------------------
  |  Branch (159:14): [True: 4.60M, False: 3.22M]
  ------------------
  160|  3.22M|    return res >> 1;
  161|  3.22M|}
  162|       |
  163|       |/* ===========================================================================
  164|       | * Flush the bit buffer, keeping at most 7 bits in it.
  165|       | */
  166|   789k|local void bi_flush(deflate_state *s) {
  167|   789k|    if (s->bi_valid == 16) {
  ------------------
  |  Branch (167:9): [True: 0, False: 789k]
  ------------------
  168|      0|        put_short(s, s->bi_buf);
  169|      0|        s->bi_buf = 0;
  170|      0|        s->bi_valid = 0;
  171|   789k|    } else if (s->bi_valid >= 8) {
  ------------------
  |  Branch (171:16): [True: 0, False: 789k]
  ------------------
  172|      0|        put_byte(s, (Byte)s->bi_buf);
  173|      0|        s->bi_buf >>= 8;
  174|      0|        s->bi_valid -= 8;
  175|      0|    }
  176|   789k|}
  177|       |
  178|       |/* ===========================================================================
  179|       | * Flush the bit buffer and align the output on a byte boundary
  180|       | */
  181|   263k|local void bi_windup(deflate_state *s) {
  182|   263k|    if (s->bi_valid > 8) {
  ------------------
  |  Branch (182:9): [True: 120k, False: 142k]
  ------------------
  183|   120k|        put_short(s, s->bi_buf);
  184|   142k|    } else if (s->bi_valid > 0) {
  ------------------
  |  Branch (184:16): [True: 142k, False: 0]
  ------------------
  185|   142k|        put_byte(s, (Byte)s->bi_buf);
  186|   142k|    }
  187|   263k|    s->bi_used = ((s->bi_valid - 1) & 7) + 1;
  188|   263k|    s->bi_buf = 0;
  189|   263k|    s->bi_valid = 0;
  190|       |#ifdef ZLIB_DEBUG
  191|       |    s->bits_sent = (s->bits_sent + 7) & ~7;
  192|       |#endif
  193|   263k|}
  194|       |
  195|       |/* ===========================================================================
  196|       | * Generate the codes for a given tree and bit counts (which need not be
  197|       | * optimal).
  198|       | * IN assertion: the array bl_count contains the bit length statistics for
  199|       | * the given tree and the field len is set for all tree elements.
  200|       | * OUT assertion: the field code is set for all tree elements of non
  201|       | *     zero code length.
  202|       | */
  203|   745k|local void gen_codes(ct_data *tree, int max_code, ushf *bl_count) {
  204|   745k|    ush next_code[MAX_BITS+1]; /* next code value for each bit length */
  205|   745k|    unsigned code = 0;         /* running code value */
  206|   745k|    int bits;                  /* bit index */
  207|   745k|    int n;                     /* code index */
  208|       |
  209|       |    /* The distribution counts are first used to generate the code values
  210|       |     * without bit reversal.
  211|       |     */
  212|  11.9M|    for (bits = 1; bits <= MAX_BITS; bits++) {
                                                   ^11.1M
  ------------------
  |  Branch (212:20): [True: 11.1M, False: 745k]
  ------------------
  213|  11.1M|        code = (code + bl_count[bits - 1]) << 1;
  214|  11.1M|        next_code[bits] = (ush)code;
  215|  11.1M|    }
  216|       |    /* Check that the bit counts in bl_count are consistent. The last code
  217|       |     * must be all ones.
  218|       |     */
  219|   745k|    Assert (code + bl_count[MAX_BITS] - 1 == (1 << MAX_BITS) - 1,
  220|   745k|            "inconsistent bit counts");
  221|   745k|    Tracev((stderr,"\ngen_codes: max_code %d ", max_code));
  222|       |
  223|  72.1M|    for (n = 0;  n <= max_code; n++) {
                                              ^71.4M
  ------------------
  |  Branch (223:18): [True: 71.4M, False: 745k]
  ------------------
  224|  71.4M|        int len = tree[n].Len;
  225|  71.4M|        if (len == 0) continue;
                                    ^68.2M
  ------------------
  |  Branch (225:13): [True: 68.2M, False: 3.22M]
  ------------------
  226|       |        /* Now reverse the bits */
  227|  3.22M|        tree[n].Code = (ush)bi_reverse(next_code[len]++, len);
  228|       |
  229|  3.22M|        Tracecv(tree != static_ltree, (stderr,"\nn %3d %c l %2d c %4x (%x) ",
  230|  3.22M|            n, (isgraph(n) ? n : ' '), len, tree[n].Code, next_code[len] - 1));
  231|  3.22M|    }
  232|   745k|}
  233|       |
  234|       |#ifdef GEN_TREES_H
  235|       |local void gen_trees_header(void);
  236|       |#endif
  237|       |
  238|       |#ifndef ZLIB_DEBUG
  239|  2.71M|#  define send_code(s, c, tree) send_bits(s, tree[c].Code, tree[c].Len)
  240|       |   /* Send a code of the given tree. c and tree must not have side effects */
  241|       |
  242|       |#else /* !ZLIB_DEBUG */
  243|       |#  define send_code(s, c, tree) \
  244|       |     { if (z_verbose>2) fprintf(stderr,"\ncd %3d ",(c)); \
  245|       |       send_bits(s, tree[c].Code, tree[c].Len); }
  246|       |#endif
  247|       |
  248|       |/* ===========================================================================
  249|       | * Send a value on a given number of bits.
  250|       | * IN assertion: length <= 16 and value fits in length bits.
  251|       | */
  252|       |#ifdef ZLIB_DEBUG
  253|       |local void send_bits(deflate_state *s, int value, int length) {
  254|       |    Tracevv((stderr," l %2d v %4x ", length, value));
  255|       |    Assert(length > 0 && length <= 15, "invalid length");
  256|       |    s->bits_sent += (ulg)length;
  257|       |
  258|       |    /* If not enough room in bi_buf, use (valid) bits from bi_buf and
  259|       |     * (16 - bi_valid) bits from value, leaving (width - (16 - bi_valid))
  260|       |     * unused bits in value.
  261|       |     */
  262|       |    if (s->bi_valid > (int)Buf_size - length) {
  263|       |        s->bi_buf |= (ush)value << s->bi_valid;
  264|       |        put_short(s, s->bi_buf);
  265|       |        s->bi_buf = (ush)value >> (Buf_size - s->bi_valid);
  266|       |        s->bi_valid += length - Buf_size;
  267|       |    } else {
  268|       |        s->bi_buf |= (ush)value << s->bi_valid;
  269|       |        s->bi_valid += length;
  270|       |    }
  271|       |}
  272|       |#else /* !ZLIB_DEBUG */
  273|       |
  274|  3.22M|#define send_bits(s, value, length) \
  275|  3.22M|{ int len = length;\
  276|  3.22M|  if (s->bi_valid > (int)Buf_size - len) {\
  277|  1.23M|    int val = (int)value;\
  278|  1.23M|    s->bi_buf |= (ush)val << s->bi_valid;\
  279|  1.23M|    put_short(s, s->bi_buf);\
  280|  1.23M|    s->bi_buf = (ush)val >> (Buf_size - s->bi_valid);\
  281|  1.23M|    s->bi_valid += len - Buf_size;\
  282|  1.98M|  } else {\
  283|  1.98M|    s->bi_buf |= (ush)(value) << s->bi_valid;\
  284|  1.98M|    s->bi_valid += len;\
  285|  1.98M|  }\
  286|  3.22M|}
  287|       |#endif /* ZLIB_DEBUG */
  288|       |
  289|       |
  290|       |/* the arguments must not have side effects */
  291|       |
  292|       |/* ===========================================================================
  293|       | * Initialize the various 'constant' tables.
  294|       | */
  295|   263k|local void tr_static_init(void) {
  296|       |#if defined(GEN_TREES_H) || !defined(STDC)
  297|       |    static int static_init_done = 0;
  298|       |    int n;        /* iterates over tree elements */
  299|       |    int bits;     /* bit counter */
  300|       |    int length;   /* length value */
  301|       |    int code;     /* code value */
  302|       |    int dist;     /* distance index */
  303|       |    ush bl_count[MAX_BITS+1];
  304|       |    /* number of codes at each bit length for an optimal tree */
  305|       |
  306|       |    if (static_init_done) return;
  307|       |
  308|       |    /* For some embedded targets, global variables are not initialized: */
  309|       |#ifdef NO_INIT_GLOBAL_POINTERS
  310|       |    static_l_desc.static_tree = static_ltree;
  311|       |    static_l_desc.extra_bits = extra_lbits;
  312|       |    static_d_desc.static_tree = static_dtree;
  313|       |    static_d_desc.extra_bits = extra_dbits;
  314|       |    static_bl_desc.extra_bits = extra_blbits;
  315|       |#endif
  316|       |
  317|       |    /* Initialize the mapping length (0..255) -> length code (0..28) */
  318|       |    length = 0;
  319|       |    for (code = 0; code < LENGTH_CODES-1; code++) {
  320|       |        base_length[code] = length;
  321|       |        for (n = 0; n < (1 << extra_lbits[code]); n++) {
  322|       |            _length_code[length++] = (uch)code;
  323|       |        }
  324|       |    }
  325|       |    Assert (length == 256, "tr_static_init: length != 256");
  326|       |    /* Note that the length 255 (match length 258) can be represented
  327|       |     * in two different ways: code 284 + 5 bits or code 285, so we
  328|       |     * overwrite length_code[255] to use the best encoding:
  329|       |     */
  330|       |    _length_code[length - 1] = (uch)code;
  331|       |
  332|       |    /* Initialize the mapping dist (0..32K) -> dist code (0..29) */
  333|       |    dist = 0;
  334|       |    for (code = 0 ; code < 16; code++) {
  335|       |        base_dist[code] = dist;
  336|       |        for (n = 0; n < (1 << extra_dbits[code]); n++) {
  337|       |            _dist_code[dist++] = (uch)code;
  338|       |        }
  339|       |    }
  340|       |    Assert (dist == 256, "tr_static_init: dist != 256");
  341|       |    dist >>= 7; /* from now on, all distances are divided by 128 */
  342|       |    for ( ; code < D_CODES; code++) {
  343|       |        base_dist[code] = dist << 7;
  344|       |        for (n = 0; n < (1 << (extra_dbits[code] - 7)); n++) {
  345|       |            _dist_code[256 + dist++] = (uch)code;
  346|       |        }
  347|       |    }
  348|       |    Assert (dist == 256, "tr_static_init: 256 + dist != 512");
  349|       |
  350|       |    /* Construct the codes of the static literal tree */
  351|       |    for (bits = 0; bits <= MAX_BITS; bits++) bl_count[bits] = 0;
  352|       |    n = 0;
  353|       |    while (n <= 143) static_ltree[n++].Len = 8, bl_count[8]++;
  354|       |    while (n <= 255) static_ltree[n++].Len = 9, bl_count[9]++;
  355|       |    while (n <= 279) static_ltree[n++].Len = 7, bl_count[7]++;
  356|       |    while (n <= 287) static_ltree[n++].Len = 8, bl_count[8]++;
  357|       |    /* Codes 286 and 287 do not exist, but we must include them in the
  358|       |     * tree construction to get a canonical Huffman tree (longest code
  359|       |     * all ones)
  360|       |     */
  361|       |    gen_codes((ct_data *)static_ltree, L_CODES+1, bl_count);
  362|       |
  363|       |    /* The static distance tree is trivial: */
  364|       |    for (n = 0; n < D_CODES; n++) {
  365|       |        static_dtree[n].Len = 5;
  366|       |        static_dtree[n].Code = bi_reverse((unsigned)n, 5);
  367|       |    }
  368|       |    static_init_done = 1;
  369|       |
  370|       |#  ifdef GEN_TREES_H
  371|       |    gen_trees_header();
  372|       |#  endif
  373|       |#endif /* defined(GEN_TREES_H) || !defined(STDC) */
  374|   263k|}
  375|       |
  376|       |/* ===========================================================================
  377|       | * Generate the file trees.h describing the static trees.
  378|       | */
  379|       |#ifdef GEN_TREES_H
  380|       |#  ifndef ZLIB_DEBUG
  381|       |#    include <stdio.h>
  382|       |#  endif
  383|       |
  384|       |#  define SEPARATOR(i, last, width) \
  385|       |      ((i) == (last)? "\n};\n\n" :    \
  386|       |       ((i) % (width) == (width) - 1 ? ",\n" : ", "))
  387|       |
  388|       |void gen_trees_header(void) {
  389|       |    FILE *header = fopen("trees.h", "w");
  390|       |    int i;
  391|       |
  392|       |    Assert (header != NULL, "Can't open trees.h");
  393|       |    fprintf(header,
  394|       |            "/* header created automatically with -DGEN_TREES_H */\n\n");
  395|       |
  396|       |    fprintf(header, "local const ct_data static_ltree[L_CODES+2] = {\n");
  397|       |    for (i = 0; i < L_CODES+2; i++) {
  398|       |        fprintf(header, "{{%3u},{%3u}}%s", static_ltree[i].Code,
  399|       |                static_ltree[i].Len, SEPARATOR(i, L_CODES+1, 5));
  400|       |    }
  401|       |
  402|       |    fprintf(header, "local const ct_data static_dtree[D_CODES] = {\n");
  403|       |    for (i = 0; i < D_CODES; i++) {
  404|       |        fprintf(header, "{{%2u},{%2u}}%s", static_dtree[i].Code,
  405|       |                static_dtree[i].Len, SEPARATOR(i, D_CODES-1, 5));
  406|       |    }
  407|       |
  408|       |    fprintf(header, "const uch ZLIB_INTERNAL _dist_code[DIST_CODE_LEN] = {\n");
  409|       |    for (i = 0; i < DIST_CODE_LEN; i++) {
  410|       |        fprintf(header, "%2u%s", _dist_code[i],
  411|       |                SEPARATOR(i, DIST_CODE_LEN-1, 20));
  412|       |    }
  413|       |
  414|       |    fprintf(header,
  415|       |        "const uch ZLIB_INTERNAL _length_code[MAX_MATCH-MIN_MATCH+1]= {\n");
  416|       |    for (i = 0; i < MAX_MATCH-MIN_MATCH+1; i++) {
  417|       |        fprintf(header, "%2u%s", _length_code[i],
  418|       |                SEPARATOR(i, MAX_MATCH-MIN_MATCH, 20));
  419|       |    }
  420|       |
  421|       |    fprintf(header, "local const int base_length[LENGTH_CODES] = {\n");
  422|       |    for (i = 0; i < LENGTH_CODES; i++) {
  423|       |        fprintf(header, "%1u%s", base_length[i],
  424|       |                SEPARATOR(i, LENGTH_CODES-1, 20));
  425|       |    }
  426|       |
  427|       |    fprintf(header, "local const int base_dist[D_CODES] = {\n");
  428|       |    for (i = 0; i < D_CODES; i++) {
  429|       |        fprintf(header, "%5u%s", base_dist[i],
  430|       |                SEPARATOR(i, D_CODES-1, 10));
  431|       |    }
  432|       |
  433|       |    fclose(header);
  434|       |}
  435|       |#endif /* GEN_TREES_H */
  436|       |
  437|       |/* ===========================================================================
  438|       | * Initialize a new block.
  439|       | */
  440|   511k|local void init_block(deflate_state *s) {
  441|   511k|    int n; /* iterates over tree elements */
  442|       |
  443|       |    /* Initialize the trees. */
  444|   146M|    for (n = 0; n < L_CODES;  n++) s->dyn_ltree[n].Freq = 0;
                                            ^146M^146M           ^146M
  ------------------
  |  Branch (444:17): [True: 146M, False: 511k]
  ------------------
  445|  15.8M|    for (n = 0; n < D_CODES;  n++) s->dyn_dtree[n].Freq = 0;
                                            ^15.3M^15.3M          ^15.3M
  ------------------
  |  Branch (445:17): [True: 15.3M, False: 511k]
  ------------------
  446|  10.2M|    for (n = 0; n < BL_CODES; n++) s->bl_tree[n].Freq = 0;
                                            ^9.72M^9.72M        ^9.72M
  ------------------
  |  Branch (446:17): [True: 9.72M, False: 511k]
  ------------------
  447|       |
  448|   511k|    s->dyn_ltree[END_BLOCK].Freq = 1;
  449|   511k|    s->opt_len = s->static_len = 0L;
  450|   511k|    s->sym_next = s->matches = 0;
  451|   511k|}
  452|       |
  453|       |/* ===========================================================================
  454|       | * Initialize the tree data structures for a new zlib stream.
  455|       | */
  456|   263k|void ZLIB_INTERNAL _tr_init(deflate_state *s) {
  457|   263k|    tr_static_init();
  458|       |
  459|   263k|    s->l_desc.dyn_tree = s->dyn_ltree;
  460|   263k|    s->l_desc.stat_desc = &static_l_desc;
  461|       |
  462|   263k|    s->d_desc.dyn_tree = s->dyn_dtree;
  463|   263k|    s->d_desc.stat_desc = &static_d_desc;
  464|       |
  465|   263k|    s->bl_desc.dyn_tree = s->bl_tree;
  466|   263k|    s->bl_desc.stat_desc = &static_bl_desc;
  467|       |
  468|   263k|    s->bi_buf = 0;
  469|   263k|    s->bi_valid = 0;
  470|   263k|    s->bi_used = 0;
  471|       |#ifdef ZLIB_DEBUG
  472|       |    s->compressed_len = 0L;
  473|       |    s->bits_sent = 0L;
  474|       |#endif
  475|       |
  476|       |    /* Initialize the first block of the first file: */
  477|   263k|    init_block(s);
  478|   263k|}
  479|       |
  480|  15.6M|#define SMALLEST 1
  481|       |/* Index within the heap array of least frequent node in the Huffman tree */
  482|       |
  483|       |
  484|       |/* ===========================================================================
  485|       | * Remove the smallest element from the heap and recreate the heap with
  486|       | * one less element. Updates heap and heap_len.
  487|       | */
  488|  2.47M|#define pqremove(s, tree, top) \
  489|  2.47M|{\
  490|  2.47M|    top = s->heap[SMALLEST]; \
  491|  2.47M|    s->heap[SMALLEST] = s->heap[s->heap_len--]; \
  492|  2.47M|    pqdownheap(s, tree, SMALLEST); \
  493|  2.47M|}
  494|       |
  495|       |/* ===========================================================================
  496|       | * Compares to subtrees, using the tree depth as tie breaker when
  497|       | * the subtrees have equal frequency. This minimizes the worst case length.
  498|       | */
  499|       |#define smaller(tree, n, m, depth) \
  500|  10.2M|   (tree[n].Freq < tree[m].Freq || \
  501|  10.2M|   (tree[n].Freq == tree[m].Freq && depth[n] <= depth[m]))
                 ^9.14M^9.14M  ^9.14M          ^9.14M  ^3.35M
  502|       |
  503|       |/* ===========================================================================
  504|       | * Restore the heap property by moving down the tree starting at node k,
  505|       | * exchanging a node with the smallest of its two sons if necessary, stopping
  506|       | * when the heap property is re-established (each father smaller than its
  507|       | * two sons).
  508|       | */
  509|  6.43M|local void pqdownheap(deflate_state *s, ct_data *tree, int k) {
  510|  6.43M|    int v = s->heap[k];
  511|  6.43M|    int j = k << 1;  /* left son of k */
  512|  10.7M|    while (j <= s->heap_len) {
  ------------------
  |  Branch (512:12): [True: 6.21M, False: 4.56M]
  ------------------
  513|       |        /* Set j to the smallest of the two sons: */
  514|  6.21M|        if (j < s->heap_len &&
  ------------------
  |  Branch (514:13): [True: 4.07M, False: 2.14M]
  ------------------
  515|  6.21M|            smaller(tree, s->heap[j + 1], s->heap[j], s->depth)) {
                          ^4.07M
  516|  1.94M|            j++;
  517|  1.94M|        }
  518|       |        /* Exit if v is smaller than both sons */
  519|  6.21M|        if (smaller(tree, v, s->heap[j], s->depth)) break;
                                                                  ^1.86M
  520|       |
  521|       |        /* Exchange v with the smallest son */
  522|  4.34M|        s->heap[k] = s->heap[j];  k = j;
  523|       |
  524|       |        /* And continue down the tree, setting j to the left son of k */
  525|  4.34M|        j <<= 1;
  526|  4.34M|    }
  527|  6.43M|    s->heap[k] = v;
  528|  6.43M|}
  529|       |
  530|       |/* ===========================================================================
  531|       | * Compute the optimal bit lengths for a tree and update the total bit length
  532|       | * for the current block.
  533|       | * IN assertion: the fields freq and dad are set, heap[heap_max] and
  534|       | *    above are the tree nodes sorted by increasing frequency.
  535|       | * OUT assertions: the field len is set to the optimal bit length, the
  536|       | *     array bl_count contains the frequencies for each bit length.
  537|       | *     The length opt_len is updated; static_len is also updated if stree is
  538|       | *     not null.
  539|       | */
  540|   745k|local void gen_bitlen(deflate_state *s, tree_desc *desc) {
  541|   745k|    ct_data *tree        = desc->dyn_tree;
  542|   745k|    int max_code         = desc->max_code;
  543|   745k|    const ct_data *stree = desc->stat_desc->static_tree;
  544|   745k|    const intf *extra    = desc->stat_desc->extra_bits;
  545|   745k|    int base             = desc->stat_desc->extra_base;
  546|   745k|    int max_length       = desc->stat_desc->max_length;
  547|   745k|    int h;              /* heap index */
  548|   745k|    int n, m;           /* iterate over the tree elements */
  549|   745k|    int bits;           /* bit length */
  550|   745k|    int xbits;          /* extra bits */
  551|   745k|    ush f;              /* frequency */
  552|   745k|    int overflow = 0;   /* number of elements with bit length too large */
  553|       |
  554|  12.6M|    for (bits = 0; bits <= MAX_BITS; bits++) s->bl_count[bits] = 0;
                                                   ^11.9M  ^11.9M
  ------------------
  |  Branch (554:20): [True: 11.9M, False: 745k]
  ------------------
  555|       |
  556|       |    /* In a first pass, compute the optimal bit lengths (which may
  557|       |     * overflow in the case of the bit length tree).
  558|       |     */
  559|   745k|    tree[s->heap[s->heap_max]].Len = 0; /* root of the heap */
  560|       |
  561|  5.69M|    for (h = s->heap_max + 1; h < HEAP_SIZE; h++) {
                                                           ^4.95M
  ------------------
  |  Branch (561:31): [True: 4.95M, False: 745k]
  ------------------
  562|  4.95M|        n = s->heap[h];
  563|  4.95M|        bits = tree[tree[n].Dad].Len + 1;
  564|  4.95M|        if (bits > max_length) bits = max_length, overflow++;
                                             ^0
  ------------------
  |  Branch (564:13): [True: 0, False: 4.95M]
  ------------------
  565|  4.95M|        tree[n].Len = (ush)bits;
  566|       |        /* We overwrite tree[n].Dad which is no longer needed */
  567|       |
  568|  4.95M|        if (n > max_code) continue; /* not a leaf node */
                                        ^1.73M
  ------------------
  |  Branch (568:13): [True: 1.73M, False: 3.22M]
  ------------------
  569|       |
  570|  3.22M|        s->bl_count[bits]++;
  571|  3.22M|        xbits = 0;
  572|  3.22M|        if (n >= base) xbits = extra[n - base];
                                     ^2.06M
  ------------------
  |  Branch (572:13): [True: 2.06M, False: 1.16M]
  ------------------
  573|  3.22M|        f = tree[n].Freq;
  574|  3.22M|        s->opt_len += (ulg)f * (unsigned)(bits + xbits);
  575|  3.22M|        if (stree) s->static_len += (ulg)f * (unsigned)(stree[n].Len + xbits);
                                 ^2.00M                                        ^2.00M
  ------------------
  |  Branch (575:13): [True: 2.00M, False: 1.21M]
  ------------------
  576|  3.22M|    }
  577|   745k|    if (overflow == 0) return;
  ------------------
  |  Branch (577:9): [True: 745k, False: 0]
  ------------------
  578|       |
  579|      0|    Tracev((stderr,"\nbit length overflow\n"));
  580|       |    /* This happens for example on obj2 and pic of the Calgary corpus */
  581|       |
  582|       |    /* Find the first bit length which could increase: */
  583|      0|    do {
  584|      0|        bits = max_length - 1;
  585|      0|        while (s->bl_count[bits] == 0) bits--;
  ------------------
  |  Branch (585:16): [True: 0, False: 0]
  ------------------
  586|      0|        s->bl_count[bits]--;        /* move one leaf down the tree */
  587|      0|        s->bl_count[bits + 1] += 2; /* move one overflow item as its brother */
  588|      0|        s->bl_count[max_length]--;
  589|       |        /* The brother of the overflow item also moves one step up,
  590|       |         * but this does not affect bl_count[max_length]
  591|       |         */
  592|      0|        overflow -= 2;
  593|      0|    } while (overflow > 0);
  ------------------
  |  Branch (593:14): [True: 0, False: 0]
  ------------------
  594|       |
  595|       |    /* Now recompute all bit lengths, scanning in increasing frequency.
  596|       |     * h is still equal to HEAP_SIZE. (It is simpler to reconstruct all
  597|       |     * lengths instead of fixing only the wrong ones. This idea is taken
  598|       |     * from 'ar' written by Haruhiko Okumura.)
  599|       |     */
  600|      0|    for (bits = max_length; bits != 0; bits--) {
  ------------------
  |  Branch (600:29): [True: 0, False: 0]
  ------------------
  601|      0|        n = s->bl_count[bits];
  602|      0|        while (n != 0) {
  ------------------
  |  Branch (602:16): [True: 0, False: 0]
  ------------------
  603|      0|            m = s->heap[--h];
  604|      0|            if (m > max_code) continue;
  ------------------
  |  Branch (604:17): [True: 0, False: 0]
  ------------------
  605|      0|            if ((unsigned) tree[m].Len != (unsigned) bits) {
  ------------------
  |  Branch (605:17): [True: 0, False: 0]
  ------------------
  606|      0|                Tracev((stderr,"code %d bits %d->%d\n", m, tree[m].Len, bits));
  607|      0|                s->opt_len += ((ulg)bits - tree[m].Len) * tree[m].Freq;
  608|      0|                tree[m].Len = (ush)bits;
  609|      0|            }
  610|      0|            n--;
  611|      0|        }
  612|      0|    }
  613|      0|}
  614|       |
  615|       |#ifdef DUMP_BL_TREE
  616|       |#  include <stdio.h>
  617|       |#endif
  618|       |
  619|       |/* ===========================================================================
  620|       | * Construct one Huffman tree and assigns the code bit strings and lengths.
  621|       | * Update the total bit length for the current block.
  622|       | * IN assertion: the field freq is set for all tree elements.
  623|       | * OUT assertions: the fields len and code are set to the optimal bit length
  624|       | *     and corresponding code. The length opt_len is updated; static_len is
  625|       | *     also updated if stree is not null. The field max_code is set.
  626|       | */
  627|   745k|local void build_tree(deflate_state *s, tree_desc *desc) {
  628|   745k|    ct_data *tree         = desc->dyn_tree;
  629|   745k|    const ct_data *stree  = desc->stat_desc->static_tree;
  630|   745k|    int elems             = desc->stat_desc->elems;
  631|   745k|    int n, m;          /* iterate over heap elements */
  632|   745k|    int max_code = -1; /* largest code with non zero frequency */
  633|   745k|    int node;          /* new node being created */
  634|       |
  635|       |    /* Construct the initial heap, with least frequent element in
  636|       |     * heap[SMALLEST]. The sons of heap[n] are heap[2*n] and heap[2*n + 1].
  637|       |     * heap[0] is not used.
  638|       |     */
  639|   745k|    s->heap_len = 0, s->heap_max = HEAP_SIZE;
  640|       |
  641|  84.0M|    for (n = 0; n < elems; n++) {
                                         ^83.2M
  ------------------
  |  Branch (641:17): [True: 83.2M, False: 745k]
  ------------------
  642|  83.2M|        if (tree[n].Freq != 0) {
  ------------------
  |  Branch (642:13): [True: 2.96M, False: 80.3M]
  ------------------
  643|  2.96M|            s->heap[++(s->heap_len)] = max_code = n;
  644|  2.96M|            s->depth[n] = 0;
  645|  80.3M|        } else {
  646|  80.3M|            tree[n].Len = 0;
  647|  80.3M|        }
  648|  83.2M|    }
  649|       |
  650|       |    /* The pkzip format requires that at least one distance code exists,
  651|       |     * and that at least one bit should be sent even if there is only one
  652|       |     * possible code. So to avoid special checks later on we force at least
  653|       |     * two codes of non zero frequency.
  654|       |     */
  655|  1.00M|    while (s->heap_len < 2) {
  ------------------
  |  Branch (655:12): [True: 258k, False: 745k]
  ------------------
  656|   258k|        node = s->heap[++(s->heap_len)] = (max_code < 2 ? ++max_code : 0);
                                                                        ^248k        ^9.27k
  ------------------
  |  Branch (656:44): [True: 248k, False: 9.27k]
  ------------------
  657|   258k|        tree[node].Freq = 1;
  658|   258k|        s->depth[node] = 0;
  659|   258k|        s->opt_len--; if (stree) s->static_len -= stree[node].Len;
  ------------------
  |  Branch (659:27): [True: 258k, False: 0]
  ------------------
  660|       |        /* node is 0 or 1 so it does not have extra bits */
  661|   258k|    }
  662|   745k|    desc->max_code = max_code;
  663|       |
  664|       |    /* The elements heap[heap_len/2 + 1 .. heap_len] are leaves of the tree,
  665|       |     * establish sub-heaps of increasing lengths:
  666|       |     */
  667|  2.22M|    for (n = s->heap_len/2; n >= 1; n--) pqdownheap(s, tree, n);
                                                  ^1.48M^1.48M
  ------------------
  |  Branch (667:29): [True: 1.48M, False: 745k]
  ------------------
  668|       |
  669|       |    /* Construct the Huffman tree by repeatedly combining the least two
  670|       |     * frequent nodes.
  671|       |     */
  672|   745k|    node = elems;              /* next internal node of the tree */
  673|  2.47M|    do {
  674|  2.47M|        pqremove(s, tree, n);  /* n = node of least frequency */
  675|  2.47M|        m = s->heap[SMALLEST]; /* m = node of next least frequency */
  676|       |
  677|  2.47M|        s->heap[--(s->heap_max)] = n; /* keep the nodes sorted by frequency */
  678|  2.47M|        s->heap[--(s->heap_max)] = m;
  679|       |
  680|       |        /* Create a new node father of n and m */
  681|  2.47M|        tree[node].Freq = tree[n].Freq + tree[m].Freq;
  682|  2.47M|        s->depth[node] = (uch)((s->depth[n] >= s->depth[m] ?
  ------------------
  |  Branch (682:33): [True: 1.81M, False: 661k]
  ------------------
  683|  1.81M|                                s->depth[n] : s->depth[m]) + 1);
                                                            ^661k
  684|  2.47M|        tree[n].Dad = tree[m].Dad = (ush)node;
  685|       |#ifdef DUMP_BL_TREE
  686|       |        if (tree == s->bl_tree) {
  687|       |            fprintf(stderr,"\nnode %d(%d), sons %d(%d) %d(%d)",
  688|       |                    node, tree[node].Freq, n, tree[n].Freq, m, tree[m].Freq);
  689|       |        }
  690|       |#endif
  691|       |        /* and insert the new node in the heap */
  692|  2.47M|        s->heap[SMALLEST] = node++;
  693|  2.47M|        pqdownheap(s, tree, SMALLEST);
  694|       |
  695|  2.47M|    } while (s->heap_len >= 2);
  ------------------
  |  Branch (695:14): [True: 1.73M, False: 745k]
  ------------------
  696|       |
  697|   745k|    s->heap[--(s->heap_max)] = s->heap[SMALLEST];
  698|       |
  699|       |    /* At this point, the fields freq and dad are set. We can now
  700|       |     * generate the bit lengths.
  701|       |     */
  702|   745k|    gen_bitlen(s, (tree_desc *)desc);
  703|       |
  704|       |    /* The field len is now set, we can generate the bit codes */
  705|   745k|    gen_codes ((ct_data *)tree, max_code, s->bl_count);
  706|   745k|}
  707|       |
  708|       |/* ===========================================================================
  709|       | * Scan a literal or distance tree to determine the frequencies of the codes
  710|       | * in the bit length tree.
  711|       | */
  712|   497k|local void scan_tree(deflate_state *s, ct_data *tree, int max_code) {
  713|   497k|    int n;                     /* iterates over all tree elements */
  714|   497k|    int prevlen = -1;          /* last emitted length */
  715|   497k|    int curlen;                /* length of current code */
  716|   497k|    int nextlen = tree[0].Len; /* length of next code */
  717|   497k|    int count = 0;             /* repeat count of the current code */
  718|   497k|    int max_count = 7;         /* max repeat count */
  719|   497k|    int min_count = 4;         /* min repeat count */
  720|       |
  721|   497k|    if (nextlen == 0) max_count = 138, min_count = 3;
                                    ^192k
  ------------------
  |  Branch (721:9): [True: 192k, False: 304k]
  ------------------
  722|   497k|    tree[max_code + 1].Len = (ush)0xffff; /* guard */
  723|       |
  724|  67.1M|    for (n = 0; n <= max_code; n++) {
                                             ^66.7M
  ------------------
  |  Branch (724:17): [True: 66.7M, False: 497k]
  ------------------
  725|  66.7M|        curlen = nextlen; nextlen = tree[n + 1].Len;
  726|  66.7M|        if (++count < max_count && curlen == nextlen) {
                                                 ^66.6M
  ------------------
  |  Branch (726:13): [True: 66.6M, False: 92.9k]
  |  Branch (726:36): [True: 63.5M, False: 3.09M]
  ------------------
  727|  63.5M|            continue;
  728|  63.5M|        } else if (count < min_count) {
                             ^3.18M^3.18M
  ------------------
  |  Branch (728:20): [True: 1.88M, False: 1.29M]
  ------------------
  729|  1.88M|            s->bl_tree[curlen].Freq += (ush)count;
  730|  1.88M|        } else if (curlen != 0) {
                             ^1.29M^1.29M
  ------------------
  |  Branch (730:20): [True: 1.27k, False: 1.29M]
  ------------------
  731|  1.27k|            if (curlen != prevlen) s->bl_tree[curlen].Freq++;
  ------------------
  |  Branch (731:17): [True: 1.27k, False: 0]
  ------------------
  732|  1.27k|            s->bl_tree[REP_3_6].Freq++;
  733|  1.29M|        } else if (count <= 10) {
  ------------------
  |  Branch (733:20): [True: 260k, False: 1.03M]
  ------------------
  734|   260k|            s->bl_tree[REPZ_3_10].Freq++;
  735|  1.03M|        } else {
  736|  1.03M|            s->bl_tree[REPZ_11_138].Freq++;
  737|  1.03M|        }
  738|  3.18M|        count = 0; prevlen = curlen;
  739|  3.18M|        if (nextlen == 0) {
  ------------------
  |  Branch (739:13): [True: 1.25M, False: 1.92M]
  ------------------
  740|  1.25M|            max_count = 138, min_count = 3;
  741|  1.92M|        } else if (curlen == nextlen) {
  ------------------
  |  Branch (741:20): [True: 0, False: 1.92M]
  ------------------
  742|      0|            max_count = 6, min_count = 3;
  743|  1.92M|        } else {
  744|  1.92M|            max_count = 7, min_count = 4;
  745|  1.92M|        }
  746|  3.18M|    }
  747|   497k|}
  748|       |
  749|       |/* ===========================================================================
  750|       | * Send a literal or distance tree in compressed form, using the codes in
  751|       | * bl_tree.
  752|       | */
  753|     16|local void send_tree(deflate_state *s, ct_data *tree, int max_code) {
  754|     16|    int n;                     /* iterates over all tree elements */
  755|     16|    int prevlen = -1;          /* last emitted length */
  756|     16|    int curlen;                /* length of current code */
  757|     16|    int nextlen = tree[0].Len; /* length of next code */
  758|     16|    int count = 0;             /* repeat count of the current code */
  759|     16|    int max_count = 7;         /* max repeat count */
  760|     16|    int min_count = 4;         /* min repeat count */
  761|       |
  762|       |    /* tree[max_code + 1].Len = -1; */  /* guard already set */
  763|     16|    if (nextlen == 0) max_count = 138, min_count = 3;
                                    ^5
  ------------------
  |  Branch (763:9): [True: 5, False: 11]
  ------------------
  764|       |
  765|  2.16k|    for (n = 0; n <= max_code; n++) {
                                             ^2.14k
  ------------------
  |  Branch (765:17): [True: 2.14k, False: 16]
  ------------------
  766|  2.14k|        curlen = nextlen; nextlen = tree[n + 1].Len;
  767|  2.14k|        if (++count < max_count && curlen == nextlen) {
                                                 ^2.14k
  ------------------
  |  Branch (767:13): [True: 2.14k, False: 4]
  |  Branch (767:36): [True: 2.01k, False: 127]
  ------------------
  768|  2.01k|            continue;
  769|  2.01k|        } else if (count < min_count) {
                             ^131^131
  ------------------
  |  Branch (769:20): [True: 82, False: 49]
  ------------------
  770|     94|            do { send_code(s, curlen, s->bl_tree); } while (--count != 0);
  ------------------
  |  Branch (770:61): [True: 12, False: 82]
  ------------------
  771|       |
  772|     82|        } else if (curlen != 0) {
                             ^49 ^49
  ------------------
  |  Branch (772:20): [True: 4, False: 45]
  ------------------
  773|      4|            if (curlen != prevlen) {
  ------------------
  |  Branch (773:17): [True: 4, False: 0]
  ------------------
  774|      4|                send_code(s, curlen, s->bl_tree); count--;
  775|      4|            }
  776|      4|            Assert(count >= 3 && count <= 6, " 3_6?");
  777|      4|            send_code(s, REP_3_6, s->bl_tree); send_bits(s, count - 3, 2);
  778|       |
  779|     45|        } else if (count <= 10) {
  ------------------
  |  Branch (779:20): [True: 10, False: 35]
  ------------------
  780|     10|            send_code(s, REPZ_3_10, s->bl_tree); send_bits(s, count - 3, 3);
  781|       |
  782|     35|        } else {
  783|     35|            send_code(s, REPZ_11_138, s->bl_tree); send_bits(s, count - 11, 7);
  784|     35|        }
  785|    131|        count = 0; prevlen = curlen;
  786|    131|        if (nextlen == 0) {
  ------------------
  |  Branch (786:13): [True: 45, False: 86]
  ------------------
  787|     45|            max_count = 138, min_count = 3;
  788|     86|        } else if (curlen == nextlen) {
  ------------------
  |  Branch (788:20): [True: 0, False: 86]
  ------------------
  789|      0|            max_count = 6, min_count = 3;
  790|     86|        } else {
  791|     86|            max_count = 7, min_count = 4;
  792|     86|        }
  793|    131|    }
  794|     16|}
  795|       |
  796|       |/* ===========================================================================
  797|       | * Construct the Huffman tree for the bit lengths and return the index in
  798|       | * bl_order of the last bit length code to send.
  799|       | */
  800|   248k|local int build_bl_tree(deflate_state *s) {
  801|   248k|    int max_blindex;  /* index of last bit length code of non zero freq */
  802|       |
  803|       |    /* Determine the bit length frequencies for literal and distance trees */
  804|   248k|    scan_tree(s, (ct_data *)s->dyn_ltree, s->l_desc.max_code);
  805|   248k|    scan_tree(s, (ct_data *)s->dyn_dtree, s->d_desc.max_code);
  806|       |
  807|       |    /* Build the bit length tree: */
  808|   248k|    build_tree(s, (tree_desc *)(&(s->bl_desc)));
  809|       |    /* opt_len now includes the length of the tree representations, except the
  810|       |     * lengths of the bit lengths codes and the 5 + 5 + 4 bits for the counts.
  811|       |     */
  812|       |
  813|       |    /* Determine the number of bit length codes to send. The pkzip format
  814|       |     * requires that at least 4 bit length codes be sent. (appnote.txt says
  815|       |     * 3 but the actual value used is 4.)
  816|       |     */
  817|   502k|    for (max_blindex = BL_CODES-1; max_blindex >= 3; max_blindex--) {
                                     ^248k                         ^253k
  ------------------
  |  Branch (817:36): [True: 502k, False: 0]
  ------------------
  818|   502k|        if (s->bl_tree[bl_order[max_blindex]].Len != 0) break;
                                                                      ^248k
  ------------------
  |  Branch (818:13): [True: 248k, False: 253k]
  ------------------
  819|   502k|    }
  820|       |    /* Update opt_len to include the bit length tree and counts */
  821|   248k|    s->opt_len += 3*((ulg)max_blindex + 1) + 5 + 5 + 4;
  822|   248k|    Tracev((stderr, "\ndyn trees: dyn %ld, stat %ld",
  823|   248k|            s->opt_len, s->static_len));
  824|       |
  825|   248k|    return max_blindex;
  826|   248k|}
  827|       |
  828|       |/* ===========================================================================
  829|       | * Send the header for a block using dynamic Huffman trees: the counts, the
  830|       | * lengths of the bit length codes, the literal tree and the distance tree.
  831|       | * IN assertion: lcodes >= 257, dcodes >= 1, blcodes >= 4.
  832|       | */
  833|       |local void send_all_trees(deflate_state *s, int lcodes, int dcodes,
  834|      8|                          int blcodes) {
  835|      8|    int rank;                    /* index in bl_order */
  836|       |
  837|      8|    Assert (lcodes >= 257 && dcodes >= 1 && blcodes >= 4, "not enough codes");
  838|      8|    Assert (lcodes <= L_CODES && dcodes <= D_CODES && blcodes <= BL_CODES,
  839|      8|            "too many codes");
  840|      8|    Tracev((stderr, "\nbl counts: "));
  841|      8|    send_bits(s, lcodes - 257, 5);  /* not +255 as stated in appnote.txt */
  842|      8|    send_bits(s, dcodes - 1,   5);
  843|      8|    send_bits(s, blcodes - 4,  4);  /* not -3 as stated in appnote.txt */
  844|    152|    for (rank = 0; rank < blcodes; rank++) {
                                                 ^144
  ------------------
  |  Branch (844:20): [True: 144, False: 8]
  ------------------
  845|    144|        Tracev((stderr, "\nbl code %2d ", bl_order[rank]));
  846|    144|        send_bits(s, s->bl_tree[bl_order[rank]].Len, 3);
  847|    144|    }
  848|      8|    Tracev((stderr, "\nbl tree: sent %ld", s->bits_sent));
  849|       |
  850|      8|    send_tree(s, (ct_data *)s->dyn_ltree, lcodes - 1);  /* literal tree */
  851|      8|    Tracev((stderr, "\nlit tree: sent %ld", s->bits_sent));
  852|       |
  853|      8|    send_tree(s, (ct_data *)s->dyn_dtree, dcodes - 1);  /* distance tree */
  854|      8|    Tracev((stderr, "\ndist tree: sent %ld", s->bits_sent));
  855|      8|}
  856|       |
  857|       |/* ===========================================================================
  858|       | * Send a stored block
  859|       | */
  860|       |void ZLIB_INTERNAL _tr_stored_block(deflate_state *s, charf *buf,
  861|  14.5k|                                    ulg stored_len, int last) {
  862|  14.5k|    send_bits(s, (STORED_BLOCK<<1) + last, 3);  /* send block type */
  863|  14.5k|    bi_windup(s);        /* align on byte boundary */
  864|  14.5k|    put_short(s, (ush)stored_len);
  865|  14.5k|    put_short(s, (ush)~stored_len);
  866|  14.5k|    if (stored_len)
  ------------------
  |  Branch (866:9): [True: 0, False: 14.5k]
  ------------------
  867|      0|        zmemcpy(s->pending_buf + s->pending, (Bytef *)buf, stored_len);
  868|  14.5k|    s->pending += stored_len;
  869|       |#ifdef ZLIB_DEBUG
  870|       |    s->compressed_len = (s->compressed_len + 3 + 7) & (ulg)~7L;
  871|       |    s->compressed_len += (stored_len + 4) << 3;
  872|       |    s->bits_sent += 2*16;
  873|       |    s->bits_sent += stored_len << 3;
  874|       |#endif
  875|  14.5k|}
  876|       |
  877|       |/* ===========================================================================
  878|       | * Flush the bits in the bit buffer to pending output (leaves at most 7 bits)
  879|       | */
  880|   789k|void ZLIB_INTERNAL _tr_flush_bits(deflate_state *s) {
  881|   789k|    bi_flush(s);
  882|   789k|}
  883|       |
  884|       |/* ===========================================================================
  885|       | * Send one empty static block to give enough lookahead for inflate.
  886|       | * This takes 10 bits, of which 7 may remain in the bit buffer.
  887|       | */
  888|      0|void ZLIB_INTERNAL _tr_align(deflate_state *s) {
  889|      0|    send_bits(s, STATIC_TREES<<1, 3);
  890|      0|    send_code(s, END_BLOCK, static_ltree);
  891|       |#ifdef ZLIB_DEBUG
  892|       |    s->compressed_len += 10L; /* 3 for block type, 7 for EOB */
  893|       |#endif
  894|      0|    bi_flush(s);
  895|      0|}
  896|       |
  897|       |/* ===========================================================================
  898|       | * Send the block data compressed using the given Huffman trees
  899|       | */
  900|       |local void compress_block(deflate_state *s, const ct_data *ltree,
  901|   248k|                          const ct_data *dtree) {
  902|   248k|    unsigned dist;      /* distance of matched string */
  903|   248k|    int lc;             /* match length or unmatched char (if dist == 0) */
  904|   248k|    unsigned sx = 0;    /* running index in symbol buffers */
  905|   248k|    unsigned code;      /* the code to send */
  906|   248k|    int extra;          /* number of extra bits to send */
  907|       |
  908|  2.11M|    if (s->sym_next != 0) do {
                      ^248k             ^248k
  ------------------
  |  Branch (908:9): [True: 248k, False: 0]
  ------------------
  909|       |#ifdef LIT_MEM
  910|       |        dist = s->d_buf[sx];
  911|       |        lc = s->l_buf[sx++];
  912|       |#else
  913|  2.11M|        dist = s->sym_buf[sx++] & 0xff;
  914|  2.11M|        dist += (unsigned)(s->sym_buf[sx++] & 0xff) << 8;
  915|  2.11M|        lc = s->sym_buf[sx++];
  916|  2.11M|#endif
  917|  2.11M|        if (dist == 0) {
  ------------------
  |  Branch (917:13): [True: 1.76M, False: 350k]
  ------------------
  918|  1.76M|            send_code(s, lc, ltree); /* send a literal byte */
  919|  1.76M|            Tracecv(isgraph(lc), (stderr," '%c' ", lc));
  920|  1.76M|        } else {
  921|       |            /* Here, lc is the match length - MIN_MATCH */
  922|   350k|            code = _length_code[lc];
  923|   350k|            send_code(s, code + LITERALS + 1, ltree);   /* send length code */
  924|   350k|            extra = extra_lbits[code];
  925|   350k|            if (extra != 0) {
  ------------------
  |  Branch (925:17): [True: 154k, False: 195k]
  ------------------
  926|   154k|                lc -= base_length[code];
  927|   154k|                send_bits(s, lc, extra);       /* send the extra length bits */
  928|   154k|            }
  929|   350k|            dist--; /* dist is now the match distance - 1 */
  930|   350k|            code = d_code(dist);
  931|   350k|            Assert (code < D_CODES, "bad d_code");
  932|       |
  933|   350k|            send_code(s, code, dtree);       /* send the distance code */
  934|   350k|            extra = extra_dbits[code];
  935|   350k|            if (extra != 0) {
  ------------------
  |  Branch (935:17): [True: 93.6k, False: 256k]
  ------------------
  936|  93.6k|                dist -= (unsigned)base_dist[code];
  937|  93.6k|                send_bits(s, dist, extra);   /* send the extra distance bits */
  938|  93.6k|            }
  939|   350k|        } /* literal or match pair ? */
  940|       |
  941|       |        /* Check for no overlay of pending_buf on needed symbols */
  942|       |#ifdef LIT_MEM
  943|       |        Assert(s->pending < 2 * (s->lit_bufsize + sx), "pendingBuf overflow");
  944|       |#else
  945|  2.11M|        Assert(s->pending < s->lit_bufsize + sx, "pendingBuf overflow");
  946|  2.11M|#endif
  947|       |
  948|  2.11M|    } while (sx < s->sym_next);
  ------------------
  |  Branch (948:14): [True: 1.86M, False: 248k]
  ------------------
  949|       |
  950|   248k|    send_code(s, END_BLOCK, ltree);
  951|   248k|}
  952|       |
  953|       |/* ===========================================================================
  954|       | * Check if the data type is TEXT or BINARY, using the following algorithm:
  955|       | * - TEXT if the two conditions below are satisfied:
  956|       | *    a) There are no non-portable control characters belonging to the
  957|       | *       "block list" (0..6, 14..25, 28..31).
  958|       | *    b) There is at least one printable character belonging to the
  959|       | *       "allow list" (9 {TAB}, 10 {LF}, 13 {CR}, 32..255).
  960|       | * - BINARY otherwise.
  961|       | * - The following partially-portable control characters form a
  962|       | *   "gray list" that is ignored in this detection algorithm:
  963|       | *   (7 {BEL}, 8 {BS}, 11 {VT}, 12 {FF}, 26 {SUB}, 27 {ESC}).
  964|       | * IN assertion: the fields Freq of dyn_ltree are set.
  965|       | */
  966|   248k|local int detect_data_type(deflate_state *s) {
  967|       |    /* block_mask is the bit mask of block-listed bytes
  968|       |     * set bits 0..6, 14..25, and 28..31
  969|       |     * 0xf3ffc07f = binary 11110011111111111100000001111111
  970|       |     */
  971|   248k|    unsigned long block_mask = 0xf3ffc07fUL;
  972|   248k|    int n;
  973|       |
  974|       |    /* Check for non-textual ("block-listed") bytes. */
  975|  6.11M|    for (n = 0; n <= 31; n++, block_mask >>= 1)
                                       ^5.86M
  ------------------
  |  Branch (975:17): [True: 5.93M, False: 178k]
  ------------------
  976|  5.93M|        if ((block_mask & 1) && (s->dyn_ltree[n].Freq != 0))
                                              ^4.28M           ^4.28M
  ------------------
  |  Branch (976:13): [True: 4.28M, False: 1.65M]
  |  Branch (976:33): [True: 70.3k, False: 4.21M]
  ------------------
  977|  70.3k|            return Z_BINARY;
  978|       |
  979|       |    /* Check for textual ("allow-listed") bytes. */
  980|   178k|    if (s->dyn_ltree[9].Freq != 0 || s->dyn_ltree[10].Freq != 0
                                                   ^176k            ^176k
  ------------------
  |  Branch (980:9): [True: 1.38k, False: 176k]
  |  Branch (980:38): [True: 2.01k, False: 174k]
  ------------------
  981|   178k|            || s->dyn_ltree[13].Freq != 0)
                             ^174k            ^174k
  ------------------
  |  Branch (981:16): [True: 336, False: 174k]
  ------------------
  982|  3.73k|        return Z_TEXT;
  983|  7.15M|    for (n = 32; n < LITERALS; n++)
                  ^174k                      ^6.97M
  ------------------
  |  Branch (983:18): [True: 7.15M, False: 82]
  ------------------
  984|  7.15M|        if (s->dyn_ltree[n].Freq != 0)
  ------------------
  |  Branch (984:13): [True: 174k, False: 6.97M]
  ------------------
  985|   174k|            return Z_TEXT;
  986|       |
  987|       |    /* There are no "block-listed" or "allow-listed" bytes:
  988|       |     * this stream either is empty or has tolerated ("gray-listed") bytes only.
  989|       |     */
  990|     82|    return Z_BINARY;
  991|   174k|}
  992|       |
  993|       |/* ===========================================================================
  994|       | * Determine the best encoding for the current block: dynamic trees, static
  995|       | * trees or store, and write out the encoded block.
  996|       | */
  997|       |void ZLIB_INTERNAL _tr_flush_block(deflate_state *s, charf *buf,
  998|   248k|                                   ulg stored_len, int last) {
  999|   248k|    ulg opt_lenb, static_lenb; /* opt_len and static_len in bytes */
 1000|   248k|    int max_blindex = 0;  /* index of last bit length code of non zero freq */
 1001|       |
 1002|       |    /* Build the Huffman trees unless a stored block is forced */
 1003|   248k|    if (s->level > 0) {
  ------------------
  |  Branch (1003:9): [True: 248k, False: 0]
  ------------------
 1004|       |
 1005|       |        /* Check if the file is binary or text */
 1006|   248k|        if (s->strm->data_type == Z_UNKNOWN)
  ------------------
  |  Branch (1006:13): [True: 248k, False: 0]
  ------------------
 1007|   248k|            s->strm->data_type = detect_data_type(s);
 1008|       |
 1009|       |        /* Construct the literal and distance trees */
 1010|   248k|        build_tree(s, (tree_desc *)(&(s->l_desc)));
 1011|   248k|        Tracev((stderr, "\nlit data: dyn %ld, stat %ld", s->opt_len,
 1012|   248k|                s->static_len));
 1013|       |
 1014|   248k|        build_tree(s, (tree_desc *)(&(s->d_desc)));
 1015|   248k|        Tracev((stderr, "\ndist data: dyn %ld, stat %ld", s->opt_len,
 1016|   248k|                s->static_len));
 1017|       |        /* At this point, opt_len and static_len are the total bit lengths of
 1018|       |         * the compressed block data, excluding the tree representations.
 1019|       |         */
 1020|       |
 1021|       |        /* Build the bit length tree for the above two trees, and get the index
 1022|       |         * in bl_order of the last bit length code to send.
 1023|       |         */
 1024|   248k|        max_blindex = build_bl_tree(s);
 1025|       |
 1026|       |        /* Determine the best encoding. Compute the block lengths in bytes. */
 1027|   248k|        opt_lenb = (s->opt_len + 3 + 7) >> 3;
 1028|   248k|        static_lenb = (s->static_len + 3 + 7) >> 3;
 1029|       |
 1030|   248k|        Tracev((stderr, "\nopt %lu(%lu) stat %lu(%lu) stored %lu lit %u ",
 1031|   248k|                opt_lenb, s->opt_len, static_lenb, s->static_len, stored_len,
 1032|   248k|                s->sym_next / 3));
 1033|       |
 1034|   248k|#ifndef FORCE_STATIC
 1035|   248k|        if (static_lenb <= opt_lenb || s->strategy == Z_FIXED)
                                                     ^8             ^8
  ------------------
  |  Branch (1035:13): [True: 248k, False: 8]
  |  Branch (1035:40): [True: 0, False: 8]
  ------------------
 1036|   248k|#endif
 1037|   248k|            opt_lenb = static_lenb;
 1038|       |
 1039|   248k|    } else {
 1040|      0|        Assert(buf != (char*)0, "lost buf");
 1041|      0|        opt_lenb = static_lenb = stored_len + 5; /* force a stored block */
 1042|      0|    }
 1043|       |
 1044|       |#ifdef FORCE_STORED
 1045|       |    if (buf != (char*)0) { /* force stored block */
 1046|       |#else
 1047|   248k|    if (stored_len + 4 <= opt_lenb && buf != (char*)0) {
                                                    ^0
  ------------------
  |  Branch (1047:9): [True: 0, False: 248k]
  |  Branch (1047:39): [True: 0, False: 0]
  ------------------
 1048|       |                       /* 4: two words for the lengths */
 1049|      0|#endif
 1050|       |        /* The test buf != NULL is only necessary if LIT_BUFSIZE > WSIZE.
 1051|       |         * Otherwise we can't have processed more than WSIZE input bytes since
 1052|       |         * the last block flush, because compression would have been
 1053|       |         * successful. If LIT_BUFSIZE <= WSIZE, it is never too late to
 1054|       |         * transform a block into a stored block.
 1055|       |         */
 1056|      0|        _tr_stored_block(s, buf, stored_len, last);
 1057|       |
 1058|   248k|    } else if (static_lenb == opt_lenb) {
  ------------------
  |  Branch (1058:16): [True: 248k, False: 8]
  ------------------
 1059|   248k|        send_bits(s, (STATIC_TREES<<1) + last, 3);
 1060|   248k|        compress_block(s, (const ct_data *)static_ltree,
 1061|   248k|                       (const ct_data *)static_dtree);
 1062|       |#ifdef ZLIB_DEBUG
 1063|       |        s->compressed_len += 3 + s->static_len;
 1064|       |#endif
 1065|   248k|    } else {
 1066|      8|        send_bits(s, (DYN_TREES<<1) + last, 3);
 1067|      8|        send_all_trees(s, s->l_desc.max_code + 1, s->d_desc.max_code + 1,
 1068|      8|                       max_blindex + 1);
 1069|      8|        compress_block(s, (const ct_data *)s->dyn_ltree,
 1070|      8|                       (const ct_data *)s->dyn_dtree);
 1071|       |#ifdef ZLIB_DEBUG
 1072|       |        s->compressed_len += 3 + s->opt_len;
 1073|       |#endif
 1074|      8|    }
 1075|   248k|    Assert (s->compressed_len == s->bits_sent, "bad compressed size");
 1076|       |    /* The above check is made mod 2^32, for files larger than 512 MB
 1077|       |     * and uLong implemented on 32 bits.
 1078|       |     */
 1079|   248k|    init_block(s);
 1080|       |
 1081|   248k|    if (last) {
  ------------------
  |  Branch (1081:9): [True: 248k, False: 0]
  ------------------
 1082|   248k|        bi_windup(s);
 1083|       |#ifdef ZLIB_DEBUG
 1084|       |        s->compressed_len += 7;  /* align on byte boundary */
 1085|       |#endif
 1086|   248k|    }
 1087|   248k|    Tracev((stderr,"\ncomprlen %lu(%lu) ", s->compressed_len >> 3,
 1088|   248k|           s->compressed_len - 7*last));
 1089|   248k|}
 1090|       |
 1091|       |/* ===========================================================================
 1092|       | * Save the match info and tally the frequency counts. Return true if
 1093|       | * the current block must be flushed.
 1094|       | */
 1095|      0|int ZLIB_INTERNAL _tr_tally(deflate_state *s, unsigned dist, unsigned lc) {
 1096|       |#ifdef LIT_MEM
 1097|       |    s->d_buf[s->sym_next] = (ush)dist;
 1098|       |    s->l_buf[s->sym_next++] = (uch)lc;
 1099|       |#else
 1100|      0|    s->sym_buf[s->sym_next++] = (uch)dist;
 1101|      0|    s->sym_buf[s->sym_next++] = (uch)(dist >> 8);
 1102|      0|    s->sym_buf[s->sym_next++] = (uch)lc;
 1103|      0|#endif
 1104|      0|    if (dist == 0) {
  ------------------
  |  Branch (1104:9): [True: 0, False: 0]
  ------------------
 1105|       |        /* lc is the unmatched char */
 1106|      0|        s->dyn_ltree[lc].Freq++;
 1107|      0|    } else {
 1108|      0|        s->matches++;
 1109|       |        /* Here, lc is the match length - MIN_MATCH */
 1110|      0|        dist--;             /* dist = match distance - 1 */
 1111|      0|        Assert((ush)dist < (ush)MAX_DIST(s) &&
 1112|      0|               (ush)lc <= (ush)(MAX_MATCH-MIN_MATCH) &&
 1113|      0|               (ush)d_code(dist) < (ush)D_CODES,  "_tr_tally: bad match");
 1114|       |
 1115|      0|        s->dyn_ltree[_length_code[lc] + LITERALS + 1].Freq++;
 1116|      0|        s->dyn_dtree[d_code(dist)].Freq++;
 1117|      0|    }
 1118|      0|    return (s->sym_next == s->sym_end);
 1119|      0|}

/home/minseo/alfha/targets/zlib/target/uncompr.c:
    1|       |/* uncompr.c -- decompress a memory buffer
    2|       | * Copyright (C) 1995-2003, 2010, 2014, 2016 Jean-loup Gailly, Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* @(#) $Id$ */
    7|       |
    8|       |#define ZLIB_INTERNAL
    9|       |#include "zlib.h"
   10|       |
   11|       |/* ===========================================================================
   12|       |     Decompresses the source buffer into the destination buffer.  *sourceLen is
   13|       |   the byte length of the source buffer. Upon entry, *destLen is the total size
   14|       |   of the destination buffer, which must be large enough to hold the entire
   15|       |   uncompressed data. (The size of the uncompressed data must have been saved
   16|       |   previously by the compressor and transmitted to the decompressor by some
   17|       |   mechanism outside the scope of this compression library.) Upon exit,
   18|       |   *destLen is the size of the decompressed data and *sourceLen is the number
   19|       |   of source bytes consumed. Upon return, source + *sourceLen points to the
   20|       |   first unused input byte.
   21|       |
   22|       |     uncompress returns Z_OK if success, Z_MEM_ERROR if there was not enough
   23|       |   memory, Z_BUF_ERROR if there was not enough room in the output buffer, or
   24|       |   Z_DATA_ERROR if the input data was corrupted, including if the input data is
   25|       |   an incomplete zlib stream.
   26|       |*/
   27|       |int ZEXPORT uncompress2(Bytef *dest, uLongf *destLen, const Bytef *source,
   28|   526k|                        uLong *sourceLen) {
   29|   526k|    z_stream stream;
   30|   526k|    int err;
   31|   526k|    const uInt max = (uInt)-1;
   32|   526k|    uLong len, left;
   33|   526k|    Byte buf[1];    /* for detection of incomplete stream when *destLen == 0 */
   34|       |
   35|   526k|    len = *sourceLen;
   36|   526k|    if (*destLen) {
  ------------------
  |  Branch (36:9): [True: 526k, False: 0]
  ------------------
   37|   526k|        left = *destLen;
   38|   526k|        *destLen = 0;
   39|   526k|    }
   40|      0|    else {
   41|      0|        left = 1;
   42|      0|        dest = buf;
   43|      0|    }
   44|       |
   45|   526k|    stream.next_in = (z_const Bytef *)source;
   46|   526k|    stream.avail_in = 0;
   47|   526k|    stream.zalloc = (alloc_func)0;
   48|   526k|    stream.zfree = (free_func)0;
   49|   526k|    stream.opaque = (voidpf)0;
   50|       |
   51|   526k|    err = inflateInit(&stream);
   52|   526k|    if (err != Z_OK) return err;
                                   ^0
  ------------------
  |  Branch (52:9): [True: 0, False: 526k]
  ------------------
   53|       |
   54|   526k|    stream.next_out = dest;
   55|   526k|    stream.avail_out = 0;
   56|       |
   57|   539k|    do {
   58|   539k|        if (stream.avail_out == 0) {
  ------------------
  |  Branch (58:13): [True: 526k, False: 12.8k]
  ------------------
   59|   526k|            stream.avail_out = left > (uLong)max ? max : (uInt)left;
                                                                 ^0
  ------------------
  |  Branch (59:32): [True: 0, False: 526k]
  ------------------
   60|   526k|            left -= stream.avail_out;
   61|   526k|        }
   62|   539k|        if (stream.avail_in == 0) {
  ------------------
  |  Branch (62:13): [True: 539k, False: 160]
  ------------------
   63|   539k|            stream.avail_in = len > (uLong)max ? max : (uInt)len;
                                                               ^0
  ------------------
  |  Branch (63:31): [True: 0, False: 539k]
  ------------------
   64|   539k|            len -= stream.avail_in;
   65|   539k|        }
   66|   539k|        err = inflate(&stream, Z_NO_FLUSH);
   67|   539k|    } while (err == Z_OK);
  ------------------
  |  Branch (67:14): [True: 12.9k, False: 526k]
  ------------------
   68|       |
   69|   526k|    *sourceLen -= len + stream.avail_in;
   70|   526k|    if (dest != buf)
  ------------------
  |  Branch (70:9): [True: 526k, False: 0]
  ------------------
   71|   526k|        *destLen = stream.total_out;
   72|      0|    else if (stream.total_out && err == Z_BUF_ERROR)
  ------------------
  |  Branch (72:14): [True: 0, False: 0]
  |  Branch (72:34): [True: 0, False: 0]
  ------------------
   73|      0|        left = 1;
   74|       |
   75|   526k|    inflateEnd(&stream);
   76|   526k|    return err == Z_STREAM_END ? Z_OK :
                                               ^263k
  ------------------
  |  Branch (76:12): [True: 263k, False: 263k]
  ------------------
   77|   526k|           err == Z_NEED_DICT ? Z_DATA_ERROR  :
                         ^263k  ^263k         ^0
  ------------------
  |  Branch (77:12): [True: 0, False: 263k]
  ------------------
   78|   263k|           err == Z_BUF_ERROR && left + stream.avail_out ? Z_DATA_ERROR :
                                               ^12.9k                    ^12.8k
  ------------------
  |  Branch (78:12): [True: 12.9k, False: 250k]
  |  Branch (78:34): [True: 12.8k, False: 172]
  ------------------
   79|   263k|           err;
                         ^250k
   80|   526k|}
   81|       |
   82|       |int ZEXPORT uncompress(Bytef *dest, uLongf *destLen, const Bytef *source,
   83|   526k|                       uLong sourceLen) {
   84|   526k|    return uncompress2(dest, destLen, source, &sourceLen);
   85|   526k|}

/home/minseo/alfha/targets/zlib/target/zconf.h:
    1|       |/* zconf.h -- configuration of the zlib compression library
    2|       | * Copyright (C) 1995-2025 Jean-loup Gailly, Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* @(#) $Id$ */
    7|       |
    8|       |#ifndef ZCONF_H
    9|       |#define ZCONF_H
   10|       |
   11|       |/*
   12|       | * If you *really* need a unique prefix for all types and library functions,
   13|       | * compile with -DZ_PREFIX. The "standard" zlib should be compiled without it.
   14|       | * Even better than compiling with -DZ_PREFIX would be to use configure to set
   15|       | * this permanently in zconf.h using "./configure --zprefix".
   16|       | */
   17|       |#ifdef Z_PREFIX     /* may be set to #if 1 by ./configure */
   18|       |#  define Z_PREFIX_SET
   19|       |
   20|       |/* all linked symbols and init macros */
   21|       |#  define _dist_code            z__dist_code
   22|       |#  define _length_code          z__length_code
   23|       |#  define _tr_align             z__tr_align
   24|       |#  define _tr_flush_bits        z__tr_flush_bits
   25|       |#  define _tr_flush_block       z__tr_flush_block
   26|       |#  define _tr_init              z__tr_init
   27|       |#  define _tr_stored_block      z__tr_stored_block
   28|       |#  define _tr_tally             z__tr_tally
   29|       |#  define adler32               z_adler32
   30|       |#  define adler32_combine       z_adler32_combine
   31|       |#  define adler32_combine64     z_adler32_combine64
   32|       |#  define adler32_z             z_adler32_z
   33|       |#  ifndef Z_SOLO
   34|       |#    define compress              z_compress
   35|       |#    define compress2             z_compress2
   36|       |#    define compressBound         z_compressBound
   37|       |#  endif
   38|       |#  define crc32                 z_crc32
   39|       |#  define crc32_combine         z_crc32_combine
   40|       |#  define crc32_combine64       z_crc32_combine64
   41|       |#  define crc32_combine_gen     z_crc32_combine_gen
   42|       |#  define crc32_combine_gen64   z_crc32_combine_gen64
   43|       |#  define crc32_combine_op      z_crc32_combine_op
   44|       |#  define crc32_z               z_crc32_z
   45|       |#  define deflate               z_deflate
   46|       |#  define deflateBound          z_deflateBound
   47|       |#  define deflateCopy           z_deflateCopy
   48|       |#  define deflateEnd            z_deflateEnd
   49|       |#  define deflateGetDictionary  z_deflateGetDictionary
   50|       |#  define deflateInit           z_deflateInit
   51|       |#  define deflateInit2          z_deflateInit2
   52|       |#  define deflateInit2_         z_deflateInit2_
   53|       |#  define deflateInit_          z_deflateInit_
   54|       |#  define deflateParams         z_deflateParams
   55|       |#  define deflatePending        z_deflatePending
   56|       |#  define deflatePrime          z_deflatePrime
   57|       |#  define deflateReset          z_deflateReset
   58|       |#  define deflateResetKeep      z_deflateResetKeep
   59|       |#  define deflateSetDictionary  z_deflateSetDictionary
   60|       |#  define deflateSetHeader      z_deflateSetHeader
   61|       |#  define deflateTune           z_deflateTune
   62|       |#  define deflateUsed           z_deflateUsed
   63|       |#  define deflate_copyright     z_deflate_copyright
   64|       |#  define get_crc_table         z_get_crc_table
   65|       |#  ifndef Z_SOLO
   66|       |#    define gz_error              z_gz_error
   67|       |#    define gz_intmax             z_gz_intmax
   68|       |#    define gz_strwinerror        z_gz_strwinerror
   69|       |#    define gzbuffer              z_gzbuffer
   70|       |#    define gzclearerr            z_gzclearerr
   71|       |#    define gzclose               z_gzclose
   72|       |#    define gzclose_r             z_gzclose_r
   73|       |#    define gzclose_w             z_gzclose_w
   74|       |#    define gzdirect              z_gzdirect
   75|       |#    define gzdopen               z_gzdopen
   76|       |#    define gzeof                 z_gzeof
   77|       |#    define gzerror               z_gzerror
   78|       |#    define gzflush               z_gzflush
   79|       |#    define gzfread               z_gzfread
   80|       |#    define gzfwrite              z_gzfwrite
   81|       |#    define gzgetc                z_gzgetc
   82|       |#    define gzgetc_               z_gzgetc_
   83|       |#    define gzgets                z_gzgets
   84|       |#    define gzoffset              z_gzoffset
   85|       |#    define gzoffset64            z_gzoffset64
   86|       |#    define gzopen                z_gzopen
   87|       |#    define gzopen64              z_gzopen64
   88|       |#    ifdef _WIN32
   89|       |#      define gzopen_w              z_gzopen_w
   90|       |#    endif
   91|       |#    define gzprintf              z_gzprintf
   92|       |#    define gzputc                z_gzputc
   93|       |#    define gzputs                z_gzputs
   94|       |#    define gzread                z_gzread
   95|       |#    define gzrewind              z_gzrewind
   96|       |#    define gzseek                z_gzseek
   97|       |#    define gzseek64              z_gzseek64
   98|       |#    define gzsetparams           z_gzsetparams
   99|       |#    define gztell                z_gztell
  100|       |#    define gztell64              z_gztell64
  101|       |#    define gzungetc              z_gzungetc
  102|       |#    define gzvprintf             z_gzvprintf
  103|       |#    define gzwrite               z_gzwrite
  104|       |#  endif
  105|       |#  define inflate               z_inflate
  106|       |#  define inflateBack           z_inflateBack
  107|       |#  define inflateBackEnd        z_inflateBackEnd
  108|       |#  define inflateBackInit       z_inflateBackInit
  109|       |#  define inflateBackInit_      z_inflateBackInit_
  110|       |#  define inflateCodesUsed      z_inflateCodesUsed
  111|       |#  define inflateCopy           z_inflateCopy
  112|       |#  define inflateEnd            z_inflateEnd
  113|       |#  define inflateGetDictionary  z_inflateGetDictionary
  114|       |#  define inflateGetHeader      z_inflateGetHeader
  115|       |#  define inflateInit           z_inflateInit
  116|       |#  define inflateInit2          z_inflateInit2
  117|       |#  define inflateInit2_         z_inflateInit2_
  118|       |#  define inflateInit_          z_inflateInit_
  119|       |#  define inflateMark           z_inflateMark
  120|       |#  define inflatePrime          z_inflatePrime
  121|       |#  define inflateReset          z_inflateReset
  122|       |#  define inflateReset2         z_inflateReset2
  123|       |#  define inflateResetKeep      z_inflateResetKeep
  124|       |#  define inflateSetDictionary  z_inflateSetDictionary
  125|       |#  define inflateSync           z_inflateSync
  126|       |#  define inflateSyncPoint      z_inflateSyncPoint
  127|       |#  define inflateUndermine      z_inflateUndermine
  128|       |#  define inflateValidate       z_inflateValidate
  129|       |#  define inflate_copyright     z_inflate_copyright
  130|       |#  define inflate_fast          z_inflate_fast
  131|       |#  define inflate_table         z_inflate_table
  132|       |#  ifndef Z_SOLO
  133|       |#    define uncompress            z_uncompress
  134|       |#    define uncompress2           z_uncompress2
  135|       |#  endif
  136|       |#  define zError                z_zError
  137|       |#  ifndef Z_SOLO
  138|       |#    define zcalloc               z_zcalloc
  139|       |#    define zcfree                z_zcfree
  140|       |#  endif
  141|       |#  define zlibCompileFlags      z_zlibCompileFlags
  142|       |#  define zlibVersion           z_zlibVersion
  143|       |
  144|       |/* all zlib typedefs in zlib.h and zconf.h */
  145|       |#  define Byte                  z_Byte
  146|       |#  define Bytef                 z_Bytef
  147|       |#  define alloc_func            z_alloc_func
  148|       |#  define charf                 z_charf
  149|       |#  define free_func             z_free_func
  150|       |#  ifndef Z_SOLO
  151|       |#    define gzFile                z_gzFile
  152|       |#  endif
  153|       |#  define gz_header             z_gz_header
  154|       |#  define gz_headerp            z_gz_headerp
  155|       |#  define in_func               z_in_func
  156|       |#  define intf                  z_intf
  157|       |#  define out_func              z_out_func
  158|       |#  define uInt                  z_uInt
  159|       |#  define uIntf                 z_uIntf
  160|       |#  define uLong                 z_uLong
  161|       |#  define uLongf                z_uLongf
  162|       |#  define voidp                 z_voidp
  163|       |#  define voidpc                z_voidpc
  164|       |#  define voidpf                z_voidpf
  165|       |
  166|       |/* all zlib structs in zlib.h and zconf.h */
  167|       |#  define gz_header_s           z_gz_header_s
  168|       |#  define internal_state        z_internal_state
  169|       |
  170|       |#endif
  171|       |
  172|       |#if defined(__MSDOS__) && !defined(MSDOS)
  173|       |#  define MSDOS
  174|       |#endif
  175|       |#if (defined(OS_2) || defined(__OS2__)) && !defined(OS2)
  176|       |#  define OS2
  177|       |#endif
  178|       |#if defined(_WINDOWS) && !defined(WINDOWS)
  179|       |#  define WINDOWS
  180|       |#endif
  181|       |#if defined(_WIN32) || defined(_WIN32_WCE) || defined(__WIN32__)
  182|       |#  ifndef WIN32
  183|       |#    define WIN32
  184|       |#  endif
  185|       |#endif
  186|       |#if (defined(MSDOS) || defined(OS2) || defined(WINDOWS)) && !defined(WIN32)
  187|       |#  if !defined(__GNUC__) && !defined(__FLAT__) && !defined(__386__)
  188|       |#    ifndef SYS16BIT
  189|       |#      define SYS16BIT
  190|       |#    endif
  191|       |#  endif
  192|       |#endif
  193|       |
  194|       |/*
  195|       | * Compile with -DMAXSEG_64K if the alloc function cannot allocate more
  196|       | * than 64k bytes at a time (needed on systems with 16-bit int).
  197|       | */
  198|       |#ifdef SYS16BIT
  199|       |#  define MAXSEG_64K
  200|       |#endif
  201|       |#ifdef MSDOS
  202|       |#  define UNALIGNED_OK
  203|       |#endif
  204|       |
  205|       |#ifdef __STDC_VERSION__
  206|       |#  ifndef STDC
  207|       |#    define STDC
  208|       |#  endif
  209|       |#  if __STDC_VERSION__ >= 199901L
  210|       |#    ifndef STDC99
  211|       |#      define STDC99
  212|       |#    endif
  213|       |#  endif
  214|       |#endif
  215|       |#if !defined(STDC) && (defined(__STDC__) || defined(__cplusplus))
  216|       |#  define STDC
  217|       |#endif
  218|       |#if !defined(STDC) && (defined(__GNUC__) || defined(__BORLANDC__))
  219|       |#  define STDC
  220|       |#endif
  221|       |#if !defined(STDC) && (defined(MSDOS) || defined(WINDOWS) || defined(WIN32))
  222|       |#  define STDC
  223|       |#endif
  224|       |#if !defined(STDC) && (defined(OS2) || defined(__HOS_AIX__))
  225|       |#  define STDC
  226|       |#endif
  227|       |
  228|       |#if defined(__OS400__) && !defined(STDC)    /* iSeries (formerly AS/400). */
  229|       |#  define STDC
  230|       |#endif
  231|       |
  232|       |#ifndef STDC
  233|       |#  ifndef const /* cannot use !defined(STDC) && !defined(const) on Mac */
  234|       |#    define const       /* note: need a more gentle solution here */
  235|       |#  endif
  236|       |#endif
  237|       |
  238|       |#ifndef z_const
  239|       |#  ifdef ZLIB_CONST
  240|       |#    define z_const const
  241|       |#  else
  242|       |#    define z_const
  243|       |#  endif
  244|       |#endif
  245|       |
  246|       |#ifdef Z_SOLO
  247|       |#  ifdef _WIN64
  248|       |     typedef unsigned long long z_size_t;
  249|       |#  else
  250|       |     typedef unsigned long z_size_t;
  251|       |#  endif
  252|       |#else
  253|       |#  define z_longlong long long
  254|       |#  if defined(NO_SIZE_T)
  255|       |     typedef unsigned NO_SIZE_T z_size_t;
  256|       |#  elif defined(STDC)
  257|       |#    include <stddef.h>
  258|       |     typedef size_t z_size_t;
  259|       |#  else
  260|       |     typedef unsigned long z_size_t;
  261|       |#  endif
  262|       |#  undef z_longlong
  263|       |#endif
  264|       |
  265|       |/* Maximum value for memLevel in deflateInit2 */
  266|       |#ifndef MAX_MEM_LEVEL
  267|       |#  ifdef MAXSEG_64K
  268|       |#    define MAX_MEM_LEVEL 8
  269|       |#  else
  270|   526k|#    define MAX_MEM_LEVEL 9
  271|       |#  endif
  272|       |#endif
  273|       |
  274|       |/* Maximum value for windowBits in deflateInit2 and inflateInit2.
  275|       | * WARNING: reducing MAX_WBITS makes minigzip unable to extract .gz files
  276|       | * created by gzip. (Files created by minigzip can still be extracted by
  277|       | * gzip.)
  278|       | */
  279|       |#ifndef MAX_WBITS
  280|   789k|#  define MAX_WBITS   15 /* 32K LZ77 window */
  281|       |#endif
  282|       |
  283|       |/* The memory requirements for deflate are (in bytes):
  284|       |            (1 << (windowBits+2)) +  (1 << (memLevel+9))
  285|       | that is: 128K for windowBits=15  +  128K for memLevel = 8  (default values)
  286|       | plus a few kilobytes for small objects. For example, if you want to reduce
  287|       | the default memory requirements from 256K to 128K, compile with
  288|       |     make CFLAGS="-O -DMAX_WBITS=14 -DMAX_MEM_LEVEL=7"
  289|       | Of course this will generally degrade compression (there's no free lunch).
  290|       |
  291|       |   The memory requirements for inflate are (in bytes) 1 << windowBits
  292|       | that is, 32K for windowBits=15 (default value) plus about 7 kilobytes
  293|       | for small objects.
  294|       |*/
  295|       |
  296|       |                        /* Type declarations */
  297|       |
  298|       |#ifndef OF /* function prototypes */
  299|       |#  ifdef STDC
  300|       |#    define OF(args)  args
  301|       |#  else
  302|       |#    define OF(args)  ()
  303|       |#  endif
  304|       |#endif
  305|       |
  306|       |/* The following definitions for FAR are needed only for MSDOS mixed
  307|       | * model programming (small or medium model with some far allocations).
  308|       | * This was tested only with MSC; for other MSDOS compilers you may have
  309|       | * to define NO_MEMCPY in zutil.h.  If you don't need the mixed model,
  310|       | * just define FAR to be empty.
  311|       | */
  312|       |#ifdef SYS16BIT
  313|       |#  if defined(M_I86SM) || defined(M_I86MM)
  314|       |     /* MSC small or medium model */
  315|       |#    define SMALL_MEDIUM
  316|       |#    ifdef _MSC_VER
  317|       |#      define FAR _far
  318|       |#    else
  319|       |#      define FAR far
  320|       |#    endif
  321|       |#  endif
  322|       |#  if (defined(__SMALL__) || defined(__MEDIUM__))
  323|       |     /* Turbo C small or medium model */
  324|       |#    define SMALL_MEDIUM
  325|       |#    ifdef __BORLANDC__
  326|       |#      define FAR _far
  327|       |#    else
  328|       |#      define FAR far
  329|       |#    endif
  330|       |#  endif
  331|       |#endif
  332|       |
  333|       |#if defined(WINDOWS) || defined(WIN32)
  334|       |   /* If building or using zlib as a DLL, define ZLIB_DLL.
  335|       |    * This is not mandatory, but it offers a little performance increase.
  336|       |    */
  337|       |#  ifdef ZLIB_DLL
  338|       |#    if defined(WIN32) && (!defined(__BORLANDC__) || (__BORLANDC__ >= 0x500))
  339|       |#      ifdef ZLIB_INTERNAL
  340|       |#        define ZEXTERN extern __declspec(dllexport)
  341|       |#      else
  342|       |#        define ZEXTERN extern __declspec(dllimport)
  343|       |#      endif
  344|       |#    endif
  345|       |#  endif  /* ZLIB_DLL */
  346|       |   /* If building or using zlib with the WINAPI/WINAPIV calling convention,
  347|       |    * define ZLIB_WINAPI.
  348|       |    * Caution: the standard ZLIB1.DLL is NOT compiled using ZLIB_WINAPI.
  349|       |    */
  350|       |#  ifdef ZLIB_WINAPI
  351|       |#    ifdef FAR
  352|       |#      undef FAR
  353|       |#    endif
  354|       |#    ifndef WIN32_LEAN_AND_MEAN
  355|       |#      define WIN32_LEAN_AND_MEAN
  356|       |#    endif
  357|       |#    include <windows.h>
  358|       |     /* No need for _export, use ZLIB.DEF instead. */
  359|       |     /* For complete Windows compatibility, use WINAPI, not __stdcall. */
  360|       |#    define ZEXPORT WINAPI
  361|       |#    ifdef WIN32
  362|       |#      define ZEXPORTVA WINAPIV
  363|       |#    else
  364|       |#      define ZEXPORTVA FAR CDECL
  365|       |#    endif
  366|       |#  endif
  367|       |#endif
  368|       |
  369|       |#if defined (__BEOS__)
  370|       |#  ifdef ZLIB_DLL
  371|       |#    ifdef ZLIB_INTERNAL
  372|       |#      define ZEXPORT   __declspec(dllexport)
  373|       |#      define ZEXPORTVA __declspec(dllexport)
  374|       |#    else
  375|       |#      define ZEXPORT   __declspec(dllimport)
  376|       |#      define ZEXPORTVA __declspec(dllimport)
  377|       |#    endif
  378|       |#  endif
  379|       |#endif
  380|       |
  381|       |#ifndef ZEXTERN
  382|       |#  define ZEXTERN extern
  383|       |#endif
  384|       |#ifndef ZEXPORT
  385|       |#  define ZEXPORT
  386|       |#endif
  387|       |#ifndef ZEXPORTVA
  388|       |#  define ZEXPORTVA
  389|       |#endif
  390|       |
  391|       |#ifndef FAR
  392|       |#  define FAR
  393|       |#endif
  394|       |
  395|       |#if !defined(__MACTYPES__)
  396|       |typedef unsigned char  Byte;  /* 8 bits */
  397|       |#endif
  398|       |typedef unsigned int   uInt;  /* 16 bits or more */
  399|       |typedef unsigned long  uLong; /* 32 bits or more */
  400|       |
  401|       |#ifdef SMALL_MEDIUM
  402|       |   /* Borland C/C++ and some old MSC versions ignore FAR inside typedef */
  403|       |#  define Bytef Byte FAR
  404|       |#else
  405|       |   typedef Byte  FAR Bytef;
  406|       |#endif
  407|       |typedef char  FAR charf;
  408|       |typedef int   FAR intf;
  409|       |typedef uInt  FAR uIntf;
  410|       |typedef uLong FAR uLongf;
  411|       |
  412|       |#ifdef STDC
  413|       |   typedef void const *voidpc;
  414|       |   typedef void FAR   *voidpf;
  415|       |   typedef void       *voidp;
  416|       |#else
  417|       |   typedef Byte const *voidpc;
  418|       |   typedef Byte FAR   *voidpf;
  419|       |   typedef Byte       *voidp;
  420|       |#endif
  421|       |
  422|       |#if !defined(Z_U4) && !defined(Z_SOLO) && defined(STDC)
  423|       |#  include <limits.h>
  424|       |#  if (UINT_MAX == 0xffffffffUL)
  425|       |#    define Z_U4 unsigned
  426|       |#  elif (ULONG_MAX == 0xffffffffUL)
  427|       |#    define Z_U4 unsigned long
  428|       |#  elif (USHRT_MAX == 0xffffffffUL)
  429|       |#    define Z_U4 unsigned short
  430|       |#  endif
  431|       |#endif
  432|       |
  433|       |#ifdef Z_U4
  434|       |   typedef Z_U4 z_crc_t;
  435|       |#else
  436|       |   typedef unsigned long z_crc_t;
  437|       |#endif
  438|       |
  439|       |#if 1     /* was set to #if 1 by ./configure */
  440|       |#  define Z_HAVE_UNISTD_H
  441|       |#endif
  442|       |
  443|       |#if 1     /* was set to #if 1 by ./configure */
  444|       |#  define Z_HAVE_STDARG_H
  445|       |#endif
  446|       |
  447|       |#ifdef STDC
  448|       |#  ifndef Z_SOLO
  449|       |#    include <sys/types.h>      /* for off_t */
  450|       |#  endif
  451|       |#endif
  452|       |
  453|       |#if defined(STDC) || defined(Z_HAVE_STDARG_H)
  454|       |#  ifndef Z_SOLO
  455|       |#    include <stdarg.h>         /* for va_list */
  456|       |#  endif
  457|       |#endif
  458|       |
  459|       |#ifdef _WIN32
  460|       |#  ifndef Z_SOLO
  461|       |#    include <stddef.h>         /* for wchar_t */
  462|       |#  endif
  463|       |#endif
  464|       |
  465|       |/* a little trick to accommodate both "#define _LARGEFILE64_SOURCE" and
  466|       | * "#define _LARGEFILE64_SOURCE 1" as requesting 64-bit operations, (even
  467|       | * though the former does not conform to the LFS document), but considering
  468|       | * both "#undef _LARGEFILE64_SOURCE" and "#define _LARGEFILE64_SOURCE 0" as
  469|       | * equivalently requesting no 64-bit operations
  470|       | */
  471|       |#if defined(_LARGEFILE64_SOURCE) && -_LARGEFILE64_SOURCE - -1 == 1
  472|       |#  undef _LARGEFILE64_SOURCE
  473|       |#endif
  474|       |
  475|       |#ifndef Z_HAVE_UNISTD_H
  476|       |#  if defined(__WATCOMC__) || defined(__GO32__) || \
  477|       |      (defined(_LARGEFILE64_SOURCE) && !defined(_WIN32))
  478|       |#    define Z_HAVE_UNISTD_H
  479|       |#  endif
  480|       |#endif
  481|       |#ifndef Z_SOLO
  482|       |#  if defined(Z_HAVE_UNISTD_H)
  483|       |#    include <unistd.h>         /* for SEEK_*, off_t, and _LFS64_LARGEFILE */
  484|       |#    ifdef VMS
  485|       |#      include <unixio.h>       /* for off_t */
  486|       |#    endif
  487|       |#    ifndef z_off_t
  488|       |#      define z_off_t off_t
  489|       |#    endif
  490|       |#  endif
  491|       |#endif
  492|       |
  493|       |#if defined(_LFS64_LARGEFILE) && _LFS64_LARGEFILE-0
  494|       |#  define Z_LFS64
  495|       |#endif
  496|       |
  497|       |#if defined(_LARGEFILE64_SOURCE) && defined(Z_LFS64)
  498|       |#  define Z_LARGE64
  499|       |#endif
  500|       |
  501|       |#if defined(_FILE_OFFSET_BITS) && _FILE_OFFSET_BITS-0 == 64 && defined(Z_LFS64)
  502|       |#  define Z_WANT64
  503|       |#endif
  504|       |
  505|       |#if !defined(SEEK_SET) && !defined(Z_SOLO)
  506|       |#  define SEEK_SET        0       /* Seek from beginning of file.  */
  507|       |#  define SEEK_CUR        1       /* Seek from current position.  */
  508|       |#  define SEEK_END        2       /* Set file pointer to EOF plus "offset" */
  509|       |#endif
  510|       |
  511|       |#ifndef z_off_t
  512|       |#  define z_off_t long long
  513|       |#endif
  514|       |
  515|       |#if !defined(_WIN32) && defined(Z_LARGE64)
  516|       |#  define z_off64_t off64_t
  517|       |#elif defined(__MINGW32__)
  518|       |#  define z_off64_t long long
  519|       |#elif defined(_WIN32) && !defined(__GNUC__)
  520|       |#  define z_off64_t __int64
  521|       |#elif defined(__GO32__)
  522|       |#  define z_off64_t offset_t
  523|       |#else
  524|       |#  define z_off64_t z_off_t
  525|       |#endif
  526|       |
  527|       |/* MVS linker does not support external names larger than 8 bytes */
  528|       |#if defined(__MVS__)
  529|       |  #pragma map(deflateInit_,"DEIN")
  530|       |  #pragma map(deflateInit2_,"DEIN2")
  531|       |  #pragma map(deflateEnd,"DEEND")
  532|       |  #pragma map(deflateBound,"DEBND")
  533|       |  #pragma map(inflateInit_,"ININ")
  534|       |  #pragma map(inflateInit2_,"ININ2")
  535|       |  #pragma map(inflateEnd,"INEND")
  536|       |  #pragma map(inflateSync,"INSY")
  537|       |  #pragma map(inflateSetDictionary,"INSEDI")
  538|       |  #pragma map(compressBound,"CMBND")
  539|       |  #pragma map(inflate_table,"INTABL")
  540|       |  #pragma map(inflate_fast,"INFA")
  541|       |  #pragma map(inflate_copyright,"INCOPY")
  542|       |#endif
  543|       |
  544|       |#endif /* ZCONF_H */

/home/minseo/alfha/targets/zlib/target/zlib.h:
    1|       |/* zlib.h -- interface of the 'zlib' general purpose compression library
    2|       |  version 1.3.1.2, December 8th, 2025
    3|       |
    4|       |  Copyright (C) 1995-2025 Jean-loup Gailly and Mark Adler
    5|       |
    6|       |  This software is provided 'as-is', without any express or implied
    7|       |  warranty.  In no event will the authors be held liable for any damages
    8|       |  arising from the use of this software.
    9|       |
   10|       |  Permission is granted to anyone to use this software for any purpose,
   11|       |  including commercial applications, and to alter it and redistribute it
   12|       |  freely, subject to the following restrictions:
   13|       |
   14|       |  1. The origin of this software must not be misrepresented; you must not
   15|       |     claim that you wrote the original software. If you use this software
   16|       |     in a product, an acknowledgment in the product documentation would be
   17|       |     appreciated but is not required.
   18|       |  2. Altered source versions must be plainly marked as such, and must not be
   19|       |     misrepresented as being the original software.
   20|       |  3. This notice may not be removed or altered from any source distribution.
   21|       |
   22|       |  Jean-loup Gailly        Mark Adler
   23|       |  jloup@gzip.org          madler@alumni.caltech.edu
   24|       |
   25|       |
   26|       |  The data format used by the zlib library is described by RFCs (Request for
   27|       |  Comments) 1950 to 1952 at https://datatracker.ietf.org/doc/html/rfc1950
   28|       |  (zlib format), rfc1951 (deflate format) and rfc1952 (gzip format).
   29|       |*/
   30|       |
   31|       |#ifndef ZLIB_H
   32|       |#define ZLIB_H
   33|       |
   34|       |#ifdef ZLIB_BUILD
   35|       |#  include <zconf.h>
   36|       |#else
   37|       |# include "zconf.h"
   38|       |#endif
   39|       |
   40|       |#ifdef __cplusplus
   41|       |extern "C" {
   42|       |#endif
   43|       |
   44|  1.57M|#define ZLIB_VERSION "1.3.1.2-audit"
   45|       |#define ZLIB_VERNUM 0x1312
   46|       |#define ZLIB_VER_MAJOR 1
   47|       |#define ZLIB_VER_MINOR 3
   48|       |#define ZLIB_VER_REVISION 1
   49|       |#define ZLIB_VER_SUBREVISION 2
   50|       |
   51|       |/*
   52|       |    The 'zlib' compression library provides in-memory compression and
   53|       |  decompression functions, including integrity checks of the uncompressed data.
   54|       |  This version of the library supports only one compression method (deflation)
   55|       |  but other algorithms will be added later and will have the same stream
   56|       |  interface.
   57|       |
   58|       |    Compression can be done in a single step if the buffers are large enough,
   59|       |  or can be done by repeated calls of the compression function.  In the latter
   60|       |  case, the application must provide more input and/or consume the output
   61|       |  (providing more output space) before each call.
   62|       |
   63|       |    The compressed data format used by default by the in-memory functions is
   64|       |  the zlib format, which is a zlib wrapper documented in RFC 1950, wrapped
   65|       |  around a deflate stream, which is itself documented in RFC 1951.
   66|       |
   67|       |    The library also supports reading and writing files in gzip (.gz) format
   68|       |  with an interface similar to that of stdio using the functions that start
   69|       |  with "gz".  The gzip format is different from the zlib format.  gzip is a
   70|       |  gzip wrapper, documented in RFC 1952, wrapped around a deflate stream.
   71|       |
   72|       |    This library can optionally read and write gzip and raw deflate streams in
   73|       |  memory as well.
   74|       |
   75|       |    The zlib format was designed to be compact and fast for use in memory
   76|       |  and on communications channels.  The gzip format was designed for single-
   77|       |  file compression on file systems, has a larger header than zlib to maintain
   78|       |  directory information, and uses a different, slower check method than zlib.
   79|       |
   80|       |    The library does not install any signal handler.  The decoder checks
   81|       |  the consistency of the compressed data, so the library should never crash
   82|       |  even in the case of corrupted input.
   83|       |*/
   84|       |
   85|       |typedef voidpf (*alloc_func)(voidpf opaque, uInt items, uInt size);
   86|       |typedef void   (*free_func)(voidpf opaque, voidpf address);
   87|       |
   88|       |struct internal_state;
   89|       |
   90|       |typedef struct z_stream_s {
   91|       |    z_const Bytef *next_in;     /* next input byte */
   92|       |    uInt     avail_in;  /* number of bytes available at next_in */
   93|       |    uLong    total_in;  /* total number of input bytes read so far */
   94|       |
   95|       |    Bytef    *next_out; /* next output byte will go here */
   96|       |    uInt     avail_out; /* remaining free space at next_out */
   97|       |    uLong    total_out; /* total number of bytes output so far */
   98|       |
   99|       |    z_const char *msg;  /* last error message, NULL if no error */
  100|       |    struct internal_state FAR *state; /* not visible by applications */
  101|       |
  102|       |    alloc_func zalloc;  /* used to allocate the internal state */
  103|       |    free_func  zfree;   /* used to free the internal state */
  104|       |    voidpf     opaque;  /* private data object passed to zalloc and zfree */
  105|       |
  106|       |    int     data_type;  /* best guess about the data type: binary or text
  107|       |                           for deflate, or the decoding state for inflate */
  108|       |    uLong   adler;      /* Adler-32 or CRC-32 value of the uncompressed data */
  109|       |    uLong   reserved;   /* reserved for future use */
  110|       |} z_stream;
  111|       |
  112|       |typedef z_stream FAR *z_streamp;
  113|       |
  114|       |/*
  115|       |     gzip header information passed to and from zlib routines.  See RFC 1952
  116|       |  for more details on the meanings of these fields.
  117|       |*/
  118|       |typedef struct gz_header_s {
  119|       |    int     text;       /* true if compressed data believed to be text */
  120|       |    uLong   time;       /* modification time */
  121|       |    int     xflags;     /* extra flags (not used when writing a gzip file) */
  122|       |    int     os;         /* operating system */
  123|       |    Bytef   *extra;     /* pointer to extra field or Z_NULL if none */
  124|       |    uInt    extra_len;  /* extra field length (valid if extra != Z_NULL) */
  125|       |    uInt    extra_max;  /* space at extra (only when reading header) */
  126|       |    Bytef   *name;      /* pointer to zero-terminated file name or Z_NULL */
  127|       |    uInt    name_max;   /* space at name (only when reading header) */
  128|       |    Bytef   *comment;   /* pointer to zero-terminated comment or Z_NULL */
  129|       |    uInt    comm_max;   /* space at comment (only when reading header) */
  130|       |    int     hcrc;       /* true if there was or will be a header crc */
  131|       |    int     done;       /* true when done reading gzip header (not used
  132|       |                           when writing a gzip file) */
  133|       |} gz_header;
  134|       |
  135|       |typedef gz_header FAR *gz_headerp;
  136|       |
  137|       |/*
  138|       |     The application must update next_in and avail_in when avail_in has dropped
  139|       |   to zero.  It must update next_out and avail_out when avail_out has dropped
  140|       |   to zero.  The application must initialize zalloc, zfree and opaque before
  141|       |   calling the init function.  All other fields are set by the compression
  142|       |   library and must not be updated by the application.
  143|       |
  144|       |     The opaque value provided by the application will be passed as the first
  145|       |   parameter for calls of zalloc and zfree.  This can be useful for custom
  146|       |   memory management.  The compression library attaches no meaning to the
  147|       |   opaque value.
  148|       |
  149|       |     zalloc must return Z_NULL if there is not enough memory for the object.
  150|       |   If zlib is used in a multi-threaded application, zalloc and zfree must be
  151|       |   thread safe.  In that case, zlib is thread-safe.  When zalloc and zfree are
  152|       |   Z_NULL on entry to the initialization function, they are set to internal
  153|       |   routines that use the standard library functions malloc() and free().
  154|       |
  155|       |     On 16-bit systems, the functions zalloc and zfree must be able to allocate
  156|       |   exactly 65536 bytes, but will not be required to allocate more than this if
  157|       |   the symbol MAXSEG_64K is defined (see zconf.h).  WARNING: On MSDOS, pointers
  158|       |   returned by zalloc for objects of exactly 65536 bytes *must* have their
  159|       |   offset normalized to zero.  The default allocation function provided by this
  160|       |   library ensures this (see zutil.c).  To reduce memory requirements and avoid
  161|       |   any allocation of 64K objects, at the expense of compression ratio, compile
  162|       |   the library with -DMAX_WBITS=14 (see zconf.h).
  163|       |
  164|       |     The fields total_in and total_out can be used for statistics or progress
  165|       |   reports.  After compression, total_in holds the total size of the
  166|       |   uncompressed data and may be saved for use by the decompressor (particularly
  167|       |   if the decompressor wants to decompress everything in a single step).
  168|       |*/
  169|       |
  170|       |                        /* constants */
  171|       |
  172|  3.25M|#define Z_NO_FLUSH      0
  173|      0|#define Z_PARTIAL_FLUSH 1
  174|       |#define Z_SYNC_FLUSH    2
  175|      0|#define Z_FULL_FLUSH    3
  176|  1.33M|#define Z_FINISH        4
  177|  1.68M|#define Z_BLOCK         5
  178|   860k|#define Z_TREES         6
  179|       |/* Allowed flush values; see deflate() and inflate() below for details */
  180|       |
  181|  5.03M|#define Z_OK            0
  182|  1.31M|#define Z_STREAM_END    1
  183|   263k|#define Z_NEED_DICT     2
  184|       |#define Z_ERRNO        (-1)
  185|      0|#define Z_STREAM_ERROR (-2)
  186|   263k|#define Z_DATA_ERROR   (-3)
  187|      0|#define Z_MEM_ERROR    (-4)
  188|   539k|#define Z_BUF_ERROR    (-5)
  189|      0|#define Z_VERSION_ERROR (-6)
  190|       |/* Return codes for the compression/decompression functions. Negative values
  191|       | * are errors, positive values are used for special but normal events.
  192|       | */
  193|       |
  194|       |#define Z_NO_COMPRESSION         0
  195|       |#define Z_BEST_SPEED             1
  196|       |#define Z_BEST_COMPRESSION       9
  197|   263k|#define Z_DEFAULT_COMPRESSION  (-1)
  198|       |/* compression levels */
  199|       |
  200|   448k|#define Z_FILTERED            1
  201|   774k|#define Z_HUFFMAN_ONLY        2
  202|   248k|#define Z_RLE                 3
  203|   526k|#define Z_FIXED               4
  204|   263k|#define Z_DEFAULT_STRATEGY    0
  205|       |/* compression strategy; see deflateInit2() below for details */
  206|       |
  207|  70.4k|#define Z_BINARY   0
  208|   352k|#define Z_TEXT     1
  209|       |#define Z_ASCII    Z_TEXT   /* for compatibility with 1.2.2 and earlier */
  210|   511k|#define Z_UNKNOWN  2
  211|       |/* Possible values of the data_type field for deflate() */
  212|       |
  213|  1.44M|#define Z_DEFLATED   8
  214|       |/* The deflate compression method (the only one supported in this version) */
  215|       |
  216|  29.7M|#define Z_NULL  0  /* for initializing zalloc, zfree, opaque */
  217|       |
  218|       |#define zlib_version zlibVersion()
  219|       |/* for compatibility with versions < 1.0.2 */
  220|       |
  221|       |
  222|       |                        /* basic functions */
  223|       |
  224|       |ZEXTERN const char * ZEXPORT zlibVersion(void);
  225|       |/* The application can compare zlibVersion and ZLIB_VERSION for consistency.
  226|       |   If the first character differs, the library code actually used is not
  227|       |   compatible with the zlib.h header file used by the application.  This check
  228|       |   is automatically made by deflateInit and inflateInit.
  229|       | */
  230|       |
  231|       |/*
  232|       |ZEXTERN int ZEXPORT deflateInit(z_streamp strm, int level);
  233|       |
  234|       |     Initializes the internal stream state for compression.  The fields
  235|       |   zalloc, zfree and opaque must be initialized before by the caller.  If
  236|       |   zalloc and zfree are set to Z_NULL, deflateInit updates them to use default
  237|       |   allocation functions.  total_in, total_out, adler, and msg are initialized.
  238|       |
  239|       |     The compression level must be Z_DEFAULT_COMPRESSION, or between 0 and 9:
  240|       |   1 gives best speed, 9 gives best compression, 0 gives no compression at all
  241|       |   (the input data is simply copied a block at a time).  Z_DEFAULT_COMPRESSION
  242|       |   requests a default compromise between speed and compression (currently
  243|       |   equivalent to level 6).
  244|       |
  245|       |     deflateInit returns Z_OK if success, Z_MEM_ERROR if there was not enough
  246|       |   memory, Z_STREAM_ERROR if level is not a valid compression level, or
  247|       |   Z_VERSION_ERROR if the zlib library version (zlib_version) is incompatible
  248|       |   with the version assumed by the caller (ZLIB_VERSION).  msg is set to null
  249|       |   if there is no error message.  deflateInit does not perform any compression:
  250|       |   this will be done by deflate().
  251|       |*/
  252|       |
  253|       |
  254|       |ZEXTERN int ZEXPORT deflate(z_streamp strm, int flush);
  255|       |/*
  256|       |    deflate compresses as much data as possible, and stops when the input
  257|       |  buffer becomes empty or the output buffer becomes full.  It may introduce
  258|       |  some output latency (reading input without producing any output) except when
  259|       |  forced to flush.
  260|       |
  261|       |    The detailed semantics are as follows.  deflate performs one or both of the
  262|       |  following actions:
  263|       |
  264|       |  - Compress more input starting at next_in and update next_in and avail_in
  265|       |    accordingly.  If not all input can be processed (because there is not
  266|       |    enough room in the output buffer), next_in and avail_in are updated and
  267|       |    processing will resume at this point for the next call of deflate().
  268|       |
  269|       |  - Generate more output starting at next_out and update next_out and avail_out
  270|       |    accordingly.  This action is forced if the parameter flush is non zero.
  271|       |    Forcing flush frequently degrades the compression ratio, so this parameter
  272|       |    should be set only when necessary.  Some output may be provided even if
  273|       |    flush is zero.
  274|       |
  275|       |    Before the call of deflate(), the application should ensure that at least
  276|       |  one of the actions is possible, by providing more input and/or consuming more
  277|       |  output, and updating avail_in or avail_out accordingly; avail_out should
  278|       |  never be zero before the call.  The application can consume the compressed
  279|       |  output when it wants, for example when the output buffer is full (avail_out
  280|       |  == 0), or after each call of deflate().  If deflate returns Z_OK and with
  281|       |  zero avail_out, it must be called again after making room in the output
  282|       |  buffer because there might be more output pending. See deflatePending(),
  283|       |  which can be used if desired to determine whether or not there is more output
  284|       |  in that case.
  285|       |
  286|       |    Normally the parameter flush is set to Z_NO_FLUSH, which allows deflate to
  287|       |  decide how much data to accumulate before producing output, in order to
  288|       |  maximize compression.
  289|       |
  290|       |    If the parameter flush is set to Z_SYNC_FLUSH, all pending output is
  291|       |  flushed to the output buffer and the output is aligned on a byte boundary, so
  292|       |  that the decompressor can get all input data available so far.  (In
  293|       |  particular avail_in is zero after the call if enough output space has been
  294|       |  provided before the call.) Flushing may degrade compression for some
  295|       |  compression algorithms and so it should be used only when necessary.  This
  296|       |  completes the current deflate block and follows it with an empty stored block
  297|       |  that is three bits plus filler bits to the next byte, followed by four bytes
  298|       |  (00 00 ff ff).
  299|       |
  300|       |    If flush is set to Z_PARTIAL_FLUSH, all pending output is flushed to the
  301|       |  output buffer, but the output is not aligned to a byte boundary.  All of the
  302|       |  input data so far will be available to the decompressor, as for Z_SYNC_FLUSH.
  303|       |  This completes the current deflate block and follows it with an empty fixed
  304|       |  codes block that is 10 bits long.  This assures that enough bytes are output
  305|       |  in order for the decompressor to finish the block before the empty fixed
  306|       |  codes block.
  307|       |
  308|       |    If flush is set to Z_BLOCK, a deflate block is completed and emitted, as
  309|       |  for Z_SYNC_FLUSH, but the output is not aligned on a byte boundary, and up to
  310|       |  seven bits of the current block are held to be written as the next byte after
  311|       |  the next deflate block is completed.  In this case, the decompressor may not
  312|       |  be provided enough bits at this point in order to complete decompression of
  313|       |  the data provided so far to the compressor.  It may need to wait for the next
  314|       |  block to be emitted.  This is for advanced applications that need to control
  315|       |  the emission of deflate blocks.
  316|       |
  317|       |    If flush is set to Z_FULL_FLUSH, all output is flushed as with
  318|       |  Z_SYNC_FLUSH, and the compression state is reset so that decompression can
  319|       |  restart from this point if previous compressed data has been damaged or if
  320|       |  random access is desired.  Using Z_FULL_FLUSH too often can seriously degrade
  321|       |  compression.
  322|       |
  323|       |    If deflate returns with avail_out == 0, this function must be called again
  324|       |  with the same value of the flush parameter and more output space (updated
  325|       |  avail_out), until the flush is complete (deflate returns with non-zero
  326|       |  avail_out).  In the case of a Z_FULL_FLUSH or Z_SYNC_FLUSH, make sure that
  327|       |  avail_out is greater than six when the flush marker begins, in order to avoid
  328|       |  repeated flush markers upon calling deflate() again when avail_out == 0.
  329|       |
  330|       |    If the parameter flush is set to Z_FINISH, pending input is processed,
  331|       |  pending output is flushed and deflate returns with Z_STREAM_END if there was
  332|       |  enough output space.  If deflate returns with Z_OK or Z_BUF_ERROR, this
  333|       |  function must be called again with Z_FINISH and more output space (updated
  334|       |  avail_out) but no more input data, until it returns with Z_STREAM_END or an
  335|       |  error.  After deflate has returned Z_STREAM_END, the only possible operations
  336|       |  on the stream are deflateReset or deflateEnd.
  337|       |
  338|       |    Z_FINISH can be used in the first deflate call after deflateInit if all the
  339|       |  compression is to be done in a single step.  In order to complete in one
  340|       |  call, avail_out must be at least the value returned by deflateBound (see
  341|       |  below).  Then deflate is guaranteed to return Z_STREAM_END.  If not enough
  342|       |  output space is provided, deflate will not return Z_STREAM_END, and it must
  343|       |  be called again as described above.
  344|       |
  345|       |    deflate() sets strm->adler to the Adler-32 checksum of all input read
  346|       |  so far (that is, total_in bytes).  If a gzip stream is being generated, then
  347|       |  strm->adler will be the CRC-32 checksum of the input read so far.  (See
  348|       |  deflateInit2 below.)
  349|       |
  350|       |    deflate() may update strm->data_type if it can make a good guess about
  351|       |  the input data type (Z_BINARY or Z_TEXT).  If in doubt, the data is
  352|       |  considered binary.  This field is only for information purposes and does not
  353|       |  affect the compression algorithm in any manner.
  354|       |
  355|       |    deflate() returns Z_OK if some progress has been made (more input
  356|       |  processed or more output produced), Z_STREAM_END if all input has been
  357|       |  consumed and all output has been produced (only when flush is set to
  358|       |  Z_FINISH), Z_STREAM_ERROR if the stream state was inconsistent (for example
  359|       |  if next_in or next_out was Z_NULL or the state was inadvertently written over
  360|       |  by the application), or Z_BUF_ERROR if no progress is possible (for example
  361|       |  avail_in or avail_out was zero).  Note that Z_BUF_ERROR is not fatal, and
  362|       |  deflate() can be called again with more input and more output space to
  363|       |  continue compressing.
  364|       |*/
  365|       |
  366|       |
  367|       |ZEXTERN int ZEXPORT deflateEnd(z_streamp strm);
  368|       |/*
  369|       |     All dynamically allocated data structures for this stream are freed.
  370|       |   This function discards any unprocessed input and does not flush any pending
  371|       |   output.
  372|       |
  373|       |     deflateEnd returns Z_OK if success, Z_STREAM_ERROR if the
  374|       |   stream state was inconsistent, Z_DATA_ERROR if the stream was freed
  375|       |   prematurely (some input or output was discarded).  In the error case, msg
  376|       |   may be set but then points to a static string (which must not be
  377|       |   deallocated).
  378|       |*/
  379|       |
  380|       |
  381|       |/*
  382|       |ZEXTERN int ZEXPORT inflateInit(z_streamp strm);
  383|       |
  384|       |     Initializes the internal stream state for decompression.  The fields
  385|       |   next_in, avail_in, zalloc, zfree and opaque must be initialized before by
  386|       |   the caller.  In the current version of inflate, the provided input is not
  387|       |   read or consumed.  The allocation of a sliding window will be deferred to
  388|       |   the first call of inflate (if the decompression does not complete on the
  389|       |   first call).  If zalloc and zfree are set to Z_NULL, inflateInit updates
  390|       |   them to use default allocation functions.  total_in, total_out, adler, and
  391|       |   msg are initialized.
  392|       |
  393|       |     inflateInit returns Z_OK if success, Z_MEM_ERROR if there was not enough
  394|       |   memory, Z_VERSION_ERROR if the zlib library version is incompatible with the
  395|       |   version assumed by the caller, or Z_STREAM_ERROR if the parameters are
  396|       |   invalid, such as a null pointer to the structure.  msg is set to null if
  397|       |   there is no error message.  inflateInit does not perform any decompression.
  398|       |   Actual decompression will be done by inflate().  So next_in, and avail_in,
  399|       |   next_out, and avail_out are unused and unchanged.  The current
  400|       |   implementation of inflateInit() does not process any header information --
  401|       |   that is deferred until inflate() is called.
  402|       |*/
  403|       |
  404|       |
  405|       |ZEXTERN int ZEXPORT inflate(z_streamp strm, int flush);
  406|       |/*
  407|       |    inflate decompresses as much data as possible, and stops when the input
  408|       |  buffer becomes empty or the output buffer becomes full.  It may introduce
  409|       |  some output latency (reading input without producing any output) except when
  410|       |  forced to flush.
  411|       |
  412|       |  The detailed semantics are as follows.  inflate performs one or both of the
  413|       |  following actions:
  414|       |
  415|       |  - Decompress more input starting at next_in and update next_in and avail_in
  416|       |    accordingly.  If not all input can be processed (because there is not
  417|       |    enough room in the output buffer), then next_in and avail_in are updated
  418|       |    accordingly, and processing will resume at this point for the next call of
  419|       |    inflate().
  420|       |
  421|       |  - Generate more output starting at next_out and update next_out and avail_out
  422|       |    accordingly.  inflate() provides as much output as possible, until there is
  423|       |    no more input data or no more space in the output buffer (see below about
  424|       |    the flush parameter).
  425|       |
  426|       |    Before the call of inflate(), the application should ensure that at least
  427|       |  one of the actions is possible, by providing more input and/or consuming more
  428|       |  output, and updating the next_* and avail_* values accordingly.  If the
  429|       |  caller of inflate() does not provide both available input and available
  430|       |  output space, it is possible that there will be no progress made.  The
  431|       |  application can consume the uncompressed output when it wants, for example
  432|       |  when the output buffer is full (avail_out == 0), or after each call of
  433|       |  inflate().  If inflate returns Z_OK and with zero avail_out, it must be
  434|       |  called again after making room in the output buffer because there might be
  435|       |  more output pending.
  436|       |
  437|       |    The flush parameter of inflate() can be Z_NO_FLUSH, Z_SYNC_FLUSH, Z_FINISH,
  438|       |  Z_BLOCK, or Z_TREES.  Z_SYNC_FLUSH requests that inflate() flush as much
  439|       |  output as possible to the output buffer.  Z_BLOCK requests that inflate()
  440|       |  stop if and when it gets to the next deflate block boundary.  When decoding
  441|       |  the zlib or gzip format, this will cause inflate() to return immediately
  442|       |  after the header and before the first block.  When doing a raw inflate,
  443|       |  inflate() will go ahead and process the first block, and will return when it
  444|       |  gets to the end of that block, or when it runs out of data.
  445|       |
  446|       |    The Z_BLOCK option assists in appending to or combining deflate streams.
  447|       |  To assist in this, on return inflate() always sets strm->data_type to the
  448|       |  number of unused bits in the input taken from strm->next_in, plus 64 if
  449|       |  inflate() is currently decoding the last block in the deflate stream, plus
  450|       |  128 if inflate() returned immediately after decoding an end-of-block code or
  451|       |  decoding the complete header up to just before the first byte of the deflate
  452|       |  stream.  The end-of-block will not be indicated until all of the uncompressed
  453|       |  data from that block has been written to strm->next_out.  The number of
  454|       |  unused bits may in general be greater than seven, except when bit 7 of
  455|       |  data_type is set, in which case the number of unused bits will be less than
  456|       |  eight.  data_type is set as noted here every time inflate() returns for all
  457|       |  flush options, and so can be used to determine the amount of currently
  458|       |  consumed input in bits.
  459|       |
  460|       |    The Z_TREES option behaves as Z_BLOCK does, but it also returns when the
  461|       |  end of each deflate block header is reached, before any actual data in that
  462|       |  block is decoded.  This allows the caller to determine the length of the
  463|       |  deflate block header for later use in random access within a deflate block.
  464|       |  256 is added to the value of strm->data_type when inflate() returns
  465|       |  immediately after reaching the end of the deflate block header.
  466|       |
  467|       |    inflate() should normally be called until it returns Z_STREAM_END or an
  468|       |  error.  However if all decompression is to be performed in a single step (a
  469|       |  single call of inflate), the parameter flush should be set to Z_FINISH.  In
  470|       |  this case all pending input is processed and all pending output is flushed;
  471|       |  avail_out must be large enough to hold all of the uncompressed data for the
  472|       |  operation to complete.  (The size of the uncompressed data may have been
  473|       |  saved by the compressor for this purpose.)  The use of Z_FINISH is not
  474|       |  required to perform an inflation in one step.  However it may be used to
  475|       |  inform inflate that a faster approach can be used for the single inflate()
  476|       |  call.  Z_FINISH also informs inflate to not maintain a sliding window if the
  477|       |  stream completes, which reduces inflate's memory footprint.  If the stream
  478|       |  does not complete, either because not all of the stream is provided or not
  479|       |  enough output space is provided, then a sliding window will be allocated and
  480|       |  inflate() can be called again to continue the operation as if Z_NO_FLUSH had
  481|       |  been used.
  482|       |
  483|       |     In this implementation, inflate() always flushes as much output as
  484|       |  possible to the output buffer, and always uses the faster approach on the
  485|       |  first call.  So the effects of the flush parameter in this implementation are
  486|       |  on the return value of inflate() as noted below, when inflate() returns early
  487|       |  when Z_BLOCK or Z_TREES is used, and when inflate() avoids the allocation of
  488|       |  memory for a sliding window when Z_FINISH is used.
  489|       |
  490|       |     If a preset dictionary is needed after this call (see inflateSetDictionary
  491|       |  below), inflate sets strm->adler to the Adler-32 checksum of the dictionary
  492|       |  chosen by the compressor and returns Z_NEED_DICT; otherwise it sets
  493|       |  strm->adler to the Adler-32 checksum of all output produced so far (that is,
  494|       |  total_out bytes) and returns Z_OK, Z_STREAM_END or an error code as described
  495|       |  below.  At the end of the stream, inflate() checks that its computed Adler-32
  496|       |  checksum is equal to that saved by the compressor and returns Z_STREAM_END
  497|       |  only if the checksum is correct.
  498|       |
  499|       |    inflate() can decompress and check either zlib-wrapped or gzip-wrapped
  500|       |  deflate data.  The header type is detected automatically, if requested when
  501|       |  initializing with inflateInit2().  Any information contained in the gzip
  502|       |  header is not retained unless inflateGetHeader() is used.  When processing
  503|       |  gzip-wrapped deflate data, strm->adler32 is set to the CRC-32 of the output
  504|       |  produced so far.  The CRC-32 is checked against the gzip trailer, as is the
  505|       |  uncompressed length, modulo 2^32.
  506|       |
  507|       |    inflate() returns Z_OK if some progress has been made (more input processed
  508|       |  or more output produced), Z_STREAM_END if the end of the compressed data has
  509|       |  been reached and all uncompressed output has been produced, Z_NEED_DICT if a
  510|       |  preset dictionary is needed at this point, Z_DATA_ERROR if the input data was
  511|       |  corrupted (input stream not conforming to the zlib format or incorrect check
  512|       |  value, in which case strm->msg points to a string with a more specific
  513|       |  error), Z_STREAM_ERROR if the stream structure was inconsistent (for example
  514|       |  next_in or next_out was Z_NULL, or the state was inadvertently written over
  515|       |  by the application), Z_MEM_ERROR if there was not enough memory, Z_BUF_ERROR
  516|       |  if no progress was possible or if there was not enough room in the output
  517|       |  buffer when Z_FINISH is used.  Note that Z_BUF_ERROR is not fatal, and
  518|       |  inflate() can be called again with more input and more output space to
  519|       |  continue decompressing.  If Z_DATA_ERROR is returned, the application may
  520|       |  then call inflateSync() to look for a good compression block if a partial
  521|       |  recovery of the data is to be attempted.
  522|       |*/
  523|       |
  524|       |
  525|       |ZEXTERN int ZEXPORT inflateEnd(z_streamp strm);
  526|       |/*
  527|       |     All dynamically allocated data structures for this stream are freed.
  528|       |   This function discards any unprocessed input and does not flush any pending
  529|       |   output.
  530|       |
  531|       |     inflateEnd returns Z_OK if success, or Z_STREAM_ERROR if the stream state
  532|       |   was inconsistent.
  533|       |*/
  534|       |
  535|       |
  536|       |                        /* Advanced functions */
  537|       |
  538|       |/*
  539|       |    The following functions are needed only in some special applications.
  540|       |*/
  541|       |
  542|       |/*
  543|       |ZEXTERN int ZEXPORT deflateInit2(z_streamp strm,
  544|       |                                 int level,
  545|       |                                 int method,
  546|       |                                 int windowBits,
  547|       |                                 int memLevel,
  548|       |                                 int strategy);
  549|       |
  550|       |     This is another version of deflateInit with more compression options.  The
  551|       |   fields zalloc, zfree and opaque must be initialized before by the caller.
  552|       |
  553|       |     The method parameter is the compression method.  It must be Z_DEFLATED in
  554|       |   this version of the library.
  555|       |
  556|       |     The windowBits parameter is the base two logarithm of the window size
  557|       |   (the size of the history buffer).  It should be in the range 8..15 for this
  558|       |   version of the library.  Larger values of this parameter result in better
  559|       |   compression at the expense of memory usage.  The default value is 15 if
  560|       |   deflateInit is used instead.
  561|       |
  562|       |     For the current implementation of deflate(), a windowBits value of 8 (a
  563|       |   window size of 256 bytes) is not supported.  As a result, a request for 8
  564|       |   will result in 9 (a 512-byte window).  In that case, providing 8 to
  565|       |   inflateInit2() will result in an error when the zlib header with 9 is
  566|       |   checked against the initialization of inflate().  The remedy is to not use 8
  567|       |   with deflateInit2() with this initialization, or at least in that case use 9
  568|       |   with inflateInit2().
  569|       |
  570|       |     windowBits can also be -8..-15 for raw deflate.  In this case, -windowBits
  571|       |   determines the window size.  deflate() will then generate raw deflate data
  572|       |   with no zlib header or trailer, and will not compute a check value.
  573|       |
  574|       |     windowBits can also be greater than 15 for optional gzip encoding.  Add
  575|       |   16 to windowBits to write a simple gzip header and trailer around the
  576|       |   compressed data instead of a zlib wrapper.  The gzip header will have no
  577|       |   file name, no extra data, no comment, no modification time (set to zero), no
  578|       |   header crc, and the operating system will be set to the appropriate value,
  579|       |   if the operating system was determined at compile time.  If a gzip stream is
  580|       |   being written, strm->adler is a CRC-32 instead of an Adler-32.
  581|       |
  582|       |     For raw deflate or gzip encoding, a request for a 256-byte window is
  583|       |   rejected as invalid, since only the zlib header provides a means of
  584|       |   transmitting the window size to the decompressor.
  585|       |
  586|       |     The memLevel parameter specifies how much memory should be allocated
  587|       |   for the internal compression state.  memLevel=1 uses minimum memory but is
  588|       |   slow and reduces compression ratio; memLevel=9 uses maximum memory for
  589|       |   optimal speed.  The default value is 8.  See zconf.h for total memory usage
  590|       |   as a function of windowBits and memLevel.
  591|       |
  592|       |     The strategy parameter is used to tune the compression algorithm.  Use the
  593|       |   value Z_DEFAULT_STRATEGY for normal data, Z_FILTERED for data produced by a
  594|       |   filter (or predictor), Z_RLE to limit match distances to one (run-length
  595|       |   encoding), or Z_HUFFMAN_ONLY to force Huffman encoding only (no string
  596|       |   matching).  Filtered data consists mostly of small values with a somewhat
  597|       |   random distribution, as produced by the PNG filters.  In this case, the
  598|       |   compression algorithm is tuned to compress them better.  The effect of
  599|       |   Z_FILTERED is to force more Huffman coding and less string matching than the
  600|       |   default; it is intermediate between Z_DEFAULT_STRATEGY and Z_HUFFMAN_ONLY.
  601|       |   Z_RLE is almost as fast as Z_HUFFMAN_ONLY, but should give better
  602|       |   compression for PNG image data than Huffman only.  The degree of string
  603|       |   matching from most to none is: Z_DEFAULT_STRATEGY, Z_FILTERED, Z_RLE, then
  604|       |   Z_HUFFMAN_ONLY. The strategy parameter affects the compression ratio but
  605|       |   never the correctness of the compressed output, even if it is not set
  606|       |   optimally for the given data.  Z_FIXED uses the default string matching, but
  607|       |   prevents the use of dynamic Huffman codes, allowing for a simpler decoder
  608|       |   for special applications.
  609|       |
  610|       |     deflateInit2 returns Z_OK if success, Z_MEM_ERROR if there was not enough
  611|       |   memory, Z_STREAM_ERROR if any parameter is invalid (such as an invalid
  612|       |   method), or Z_VERSION_ERROR if the zlib library version (zlib_version) is
  613|       |   incompatible with the version assumed by the caller (ZLIB_VERSION).  msg is
  614|       |   set to null if there is no error message.  deflateInit2 does not perform any
  615|       |   compression: this will be done by deflate().
  616|       |*/
  617|       |
  618|       |ZEXTERN int ZEXPORT deflateSetDictionary(z_streamp strm,
  619|       |                                         const Bytef *dictionary,
  620|       |                                         uInt  dictLength);
  621|       |/*
  622|       |     Initializes the compression dictionary from the given byte sequence
  623|       |   without producing any compressed output.  When using the zlib format, this
  624|       |   function must be called immediately after deflateInit, deflateInit2 or
  625|       |   deflateReset, and before any call of deflate.  When doing raw deflate, this
  626|       |   function must be called either before any call of deflate, or immediately
  627|       |   after the completion of a deflate block, i.e. after all input has been
  628|       |   consumed and all output has been delivered when using any of the flush
  629|       |   options Z_BLOCK, Z_PARTIAL_FLUSH, Z_SYNC_FLUSH, or Z_FULL_FLUSH.  The
  630|       |   compressor and decompressor must use exactly the same dictionary (see
  631|       |   inflateSetDictionary).
  632|       |
  633|       |     The dictionary should consist of strings (byte sequences) that are likely
  634|       |   to be encountered later in the data to be compressed, with the most commonly
  635|       |   used strings preferably put towards the end of the dictionary.  Using a
  636|       |   dictionary is most useful when the data to be compressed is short and can be
  637|       |   predicted with good accuracy; the data can then be compressed better than
  638|       |   with the default empty dictionary.
  639|       |
  640|       |     Depending on the size of the compression data structures selected by
  641|       |   deflateInit or deflateInit2, a part of the dictionary may in effect be
  642|       |   discarded, for example if the dictionary is larger than the window size
  643|       |   provided in deflateInit or deflateInit2.  Thus the strings most likely to be
  644|       |   useful should be put at the end of the dictionary, not at the front.  In
  645|       |   addition, the current implementation of deflate will use at most the window
  646|       |   size minus 262 bytes of the provided dictionary.
  647|       |
  648|       |     Upon return of this function, strm->adler is set to the Adler-32 value
  649|       |   of the dictionary; the decompressor may later use this value to determine
  650|       |   which dictionary has been used by the compressor.  (The Adler-32 value
  651|       |   applies to the whole dictionary even if only a subset of the dictionary is
  652|       |   actually used by the compressor.) If a raw deflate was requested, then the
  653|       |   Adler-32 value is not computed and strm->adler is not set.
  654|       |
  655|       |     deflateSetDictionary returns Z_OK if success, or Z_STREAM_ERROR if a
  656|       |   parameter is invalid (e.g.  dictionary being Z_NULL) or the stream state is
  657|       |   inconsistent (for example if deflate has already been called for this stream
  658|       |   or if not at a block boundary for raw deflate).  deflateSetDictionary does
  659|       |   not perform any compression: this will be done by deflate().
  660|       |*/
  661|       |
  662|       |ZEXTERN int ZEXPORT deflateGetDictionary(z_streamp strm,
  663|       |                                         Bytef *dictionary,
  664|       |                                         uInt  *dictLength);
  665|       |/*
  666|       |     Returns the sliding dictionary being maintained by deflate.  dictLength is
  667|       |   set to the number of bytes in the dictionary, and that many bytes are copied
  668|       |   to dictionary.  dictionary must have enough space, where 32768 bytes is
  669|       |   always enough.  If deflateGetDictionary() is called with dictionary equal to
  670|       |   Z_NULL, then only the dictionary length is returned, and nothing is copied.
  671|       |   Similarly, if dictLength is Z_NULL, then it is not set.
  672|       |
  673|       |     deflateGetDictionary() may return a length less than the window size, even
  674|       |   when more than the window size in input has been provided. It may return up
  675|       |   to 258 bytes less in that case, due to how zlib's implementation of deflate
  676|       |   manages the sliding window and lookahead for matches, where matches can be
  677|       |   up to 258 bytes long. If the application needs the last window-size bytes of
  678|       |   input, then that would need to be saved by the application outside of zlib.
  679|       |
  680|       |     deflateGetDictionary returns Z_OK on success, or Z_STREAM_ERROR if the
  681|       |   stream state is inconsistent.
  682|       |*/
  683|       |
  684|       |ZEXTERN int ZEXPORT deflateCopy(z_streamp dest,
  685|       |                                z_streamp source);
  686|       |/*
  687|       |     Sets the destination stream as a complete copy of the source stream.
  688|       |
  689|       |     This function can be useful when several compression strategies will be
  690|       |   tried, for example when there are several ways of pre-processing the input
  691|       |   data with a filter.  The streams that will be discarded should then be freed
  692|       |   by calling deflateEnd.  Note that deflateCopy duplicates the internal
  693|       |   compression state which can be quite large, so this strategy is slow and can
  694|       |   consume lots of memory.
  695|       |
  696|       |     deflateCopy returns Z_OK if success, Z_MEM_ERROR if there was not
  697|       |   enough memory, Z_STREAM_ERROR if the source stream state was inconsistent
  698|       |   (such as zalloc being Z_NULL).  msg is left unchanged in both source and
  699|       |   destination.
  700|       |*/
  701|       |
  702|       |ZEXTERN int ZEXPORT deflateReset(z_streamp strm);
  703|       |/*
  704|       |     This function is equivalent to deflateEnd followed by deflateInit, but
  705|       |   does not free and reallocate the internal compression state.  The stream
  706|       |   will leave the compression level and any other attributes that may have been
  707|       |   set unchanged.  total_in, total_out, adler, and msg are initialized.
  708|       |
  709|       |     deflateReset returns Z_OK if success, or Z_STREAM_ERROR if the source
  710|       |   stream state was inconsistent (such as zalloc or state being Z_NULL).
  711|       |*/
  712|       |
  713|       |ZEXTERN int ZEXPORT deflateParams(z_streamp strm,
  714|       |                                  int level,
  715|       |                                  int strategy);
  716|       |/*
  717|       |     Dynamically update the compression level and compression strategy.  The
  718|       |   interpretation of level and strategy is as in deflateInit2().  This can be
  719|       |   used to switch between compression and straight copy of the input data, or
  720|       |   to switch to a different kind of input data requiring a different strategy.
  721|       |   If the compression approach (which is a function of the level) or the
  722|       |   strategy is changed, and if there have been any deflate() calls since the
  723|       |   state was initialized or reset, then the input available so far is
  724|       |   compressed with the old level and strategy using deflate(strm, Z_BLOCK).
  725|       |   There are three approaches for the compression levels 0, 1..3, and 4..9
  726|       |   respectively.  The new level and strategy will take effect at the next call
  727|       |   of deflate().
  728|       |
  729|       |     If a deflate(strm, Z_BLOCK) is performed by deflateParams(), and it does
  730|       |   not have enough output space to complete, then the parameter change will not
  731|       |   take effect.  In this case, deflateParams() can be called again with the
  732|       |   same parameters and more output space to try again.
  733|       |
  734|       |     In order to assure a change in the parameters on the first try, the
  735|       |   deflate stream should be flushed using deflate() with Z_BLOCK or other flush
  736|       |   request until strm.avail_out is not zero, before calling deflateParams().
  737|       |   Then no more input data should be provided before the deflateParams() call.
  738|       |   If this is done, the old level and strategy will be applied to the data
  739|       |   compressed before deflateParams(), and the new level and strategy will be
  740|       |   applied to the data compressed after deflateParams().
  741|       |
  742|       |     deflateParams returns Z_OK on success, Z_STREAM_ERROR if the source stream
  743|       |   state was inconsistent or if a parameter was invalid, or Z_BUF_ERROR if
  744|       |   there was not enough output space to complete the compression of the
  745|       |   available input data before a change in the strategy or approach.  Note that
  746|       |   in the case of a Z_BUF_ERROR, the parameters are not changed.  A return
  747|       |   value of Z_BUF_ERROR is not fatal, in which case deflateParams() can be
  748|       |   retried with more output space.
  749|       |*/
  750|       |
  751|       |ZEXTERN int ZEXPORT deflateTune(z_streamp strm,
  752|       |                                int good_length,
  753|       |                                int max_lazy,
  754|       |                                int nice_length,
  755|       |                                int max_chain);
  756|       |/*
  757|       |     Fine tune deflate's internal compression parameters.  This should only be
  758|       |   used by someone who understands the algorithm used by zlib's deflate for
  759|       |   searching for the best matching string, and even then only by the most
  760|       |   fanatic optimizer trying to squeeze out the last compressed bit for their
  761|       |   specific input data.  Read the deflate.c source code for the meaning of the
  762|       |   max_lazy, good_length, nice_length, and max_chain parameters.
  763|       |
  764|       |     deflateTune() can be called after deflateInit() or deflateInit2(), and
  765|       |   returns Z_OK on success, or Z_STREAM_ERROR for an invalid deflate stream.
  766|       | */
  767|       |
  768|       |ZEXTERN uLong ZEXPORT deflateBound(z_streamp strm,
  769|       |                                   uLong sourceLen);
  770|       |/*
  771|       |     deflateBound() returns an upper bound on the compressed size after
  772|       |   deflation of sourceLen bytes.  It must be called after deflateInit() or
  773|       |   deflateInit2(), and after deflateSetHeader(), if used.  This would be used
  774|       |   to allocate an output buffer for deflation in a single pass, and so would be
  775|       |   called before deflate().  If that first deflate() call is provided the
  776|       |   sourceLen input bytes, an output buffer allocated to the size returned by
  777|       |   deflateBound(), and the flush value Z_FINISH, then deflate() is guaranteed
  778|       |   to return Z_STREAM_END.  Note that it is possible for the compressed size to
  779|       |   be larger than the value returned by deflateBound() if flush options other
  780|       |   than Z_FINISH or Z_NO_FLUSH are used.
  781|       |*/
  782|       |
  783|       |ZEXTERN int ZEXPORT deflatePending(z_streamp strm,
  784|       |                                   unsigned *pending,
  785|       |                                   int *bits);
  786|       |/*
  787|       |     deflatePending() returns the number of bytes and bits of output that have
  788|       |   been generated, but not yet provided in the available output.  The bytes not
  789|       |   provided would be due to the available output space having being consumed.
  790|       |   The number of bits of output not provided are between 0 and 7, where they
  791|       |   await more bits to join them in order to fill out a full byte.  If pending
  792|       |   or bits are Z_NULL, then those values are not set.
  793|       |
  794|       |     deflatePending returns Z_OK if success, or Z_STREAM_ERROR if the source
  795|       |   stream state was inconsistent.
  796|       | */
  797|       |
  798|       |ZEXTERN int ZEXPORT deflateUsed(z_streamp strm,
  799|       |                                int *bits);
  800|       |/*
  801|       |     deflateUsed() returns in *bits the most recent number of deflate bits used
  802|       |   in the last byte when flushing to a byte boundary. The result is in 1..8, or
  803|       |   0 if there has not yet been a flush. This helps determine the location of
  804|       |   the last bit of a deflate stream.
  805|       |
  806|       |     deflateUsed returns Z_OK if success, or Z_STREAM_ERROR if the source
  807|       |   stream state was inconsistent.
  808|       | */
  809|       |
  810|       |ZEXTERN int ZEXPORT deflatePrime(z_streamp strm,
  811|       |                                 int bits,
  812|       |                                 int value);
  813|       |/*
  814|       |     deflatePrime() inserts bits in the deflate output stream.  The intent
  815|       |   is that this function is used to start off the deflate output with the bits
  816|       |   leftover from a previous deflate stream when appending to it.  As such, this
  817|       |   function can only be used for raw deflate, and must be used before the first
  818|       |   deflate() call after a deflateInit2() or deflateReset().  bits must be less
  819|       |   than or equal to 16, and that many of the least significant bits of value
  820|       |   will be inserted in the output.
  821|       |
  822|       |     deflatePrime returns Z_OK if success, Z_BUF_ERROR if there was not enough
  823|       |   room in the internal buffer to insert the bits, or Z_STREAM_ERROR if the
  824|       |   source stream state was inconsistent.
  825|       |*/
  826|       |
  827|       |ZEXTERN int ZEXPORT deflateSetHeader(z_streamp strm,
  828|       |                                     gz_headerp head);
  829|       |/*
  830|       |     deflateSetHeader() provides gzip header information for when a gzip
  831|       |   stream is requested by deflateInit2().  deflateSetHeader() may be called
  832|       |   after deflateInit2() or deflateReset() and before the first call of
  833|       |   deflate().  The text, time, os, extra field, name, and comment information
  834|       |   in the provided gz_header structure are written to the gzip header (xflag is
  835|       |   ignored -- the extra flags are set according to the compression level).  The
  836|       |   caller must assure that, if not Z_NULL, name and comment are terminated with
  837|       |   a zero byte, and that if extra is not Z_NULL, that extra_len bytes are
  838|       |   available there.  If hcrc is true, a gzip header crc is included.  Note that
  839|       |   the current versions of the command-line version of gzip (up through version
  840|       |   1.3.x) do not support header crc's, and will report that it is a "multi-part
  841|       |   gzip file" and give up.
  842|       |
  843|       |     If deflateSetHeader is not used, the default gzip header has text false,
  844|       |   the time set to zero, and os set to the current operating system, with no
  845|       |   extra, name, or comment fields.  The gzip header is returned to the default
  846|       |   state by deflateReset().
  847|       |
  848|       |     deflateSetHeader returns Z_OK if success, or Z_STREAM_ERROR if the source
  849|       |   stream state was inconsistent.
  850|       |*/
  851|       |
  852|       |/*
  853|       |ZEXTERN int ZEXPORT inflateInit2(z_streamp strm,
  854|       |                                 int windowBits);
  855|       |
  856|       |     This is another version of inflateInit with an extra parameter.  The
  857|       |   fields next_in, avail_in, zalloc, zfree and opaque must be initialized
  858|       |   before by the caller.
  859|       |
  860|       |     The windowBits parameter is the base two logarithm of the maximum window
  861|       |   size (the size of the history buffer).  It should be in the range 8..15 for
  862|       |   this version of the library.  The default value is 15 if inflateInit is used
  863|       |   instead.  windowBits must be greater than or equal to the windowBits value
  864|       |   provided to deflateInit2() while compressing, or it must be equal to 15 if
  865|       |   deflateInit2() was not used.  If a compressed stream with a larger window
  866|       |   size is given as input, inflate() will return with the error code
  867|       |   Z_DATA_ERROR instead of trying to allocate a larger window.
  868|       |
  869|       |     windowBits can also be zero to request that inflate use the window size in
  870|       |   the zlib header of the compressed stream.
  871|       |
  872|       |     windowBits can also be -8..-15 for raw inflate.  In this case, -windowBits
  873|       |   determines the window size.  inflate() will then process raw deflate data,
  874|       |   not looking for a zlib or gzip header, not generating a check value, and not
  875|       |   looking for any check values for comparison at the end of the stream.  This
  876|       |   is for use with other formats that use the deflate compressed data format
  877|       |   such as zip.  Those formats provide their own check values.  If a custom
  878|       |   format is developed using the raw deflate format for compressed data, it is
  879|       |   recommended that a check value such as an Adler-32 or a CRC-32 be applied to
  880|       |   the uncompressed data as is done in the zlib, gzip, and zip formats.  For
  881|       |   most applications, the zlib format should be used as is.  Note that comments
  882|       |   above on the use in deflateInit2() applies to the magnitude of windowBits.
  883|       |
  884|       |     windowBits can also be greater than 15 for optional gzip decoding.  Add
  885|       |   32 to windowBits to enable zlib and gzip decoding with automatic header
  886|       |   detection, or add 16 to decode only the gzip format (the zlib format will
  887|       |   return a Z_DATA_ERROR).  If a gzip stream is being decoded, strm->adler is a
  888|       |   CRC-32 instead of an Adler-32.  Unlike the gunzip utility and gzread() (see
  889|       |   below), inflate() will *not* automatically decode concatenated gzip members.
  890|       |   inflate() will return Z_STREAM_END at the end of the gzip member.  The state
  891|       |   would need to be reset to continue decoding a subsequent gzip member.  This
  892|       |   *must* be done if there is more data after a gzip member, in order for the
  893|       |   decompression to be compliant with the gzip standard (RFC 1952).
  894|       |
  895|       |     inflateInit2 returns Z_OK if success, Z_MEM_ERROR if there was not enough
  896|       |   memory, Z_VERSION_ERROR if the zlib library version is incompatible with the
  897|       |   version assumed by the caller, or Z_STREAM_ERROR if the parameters are
  898|       |   invalid, such as a null pointer to the structure.  msg is set to null if
  899|       |   there is no error message.  inflateInit2 does not perform any decompression
  900|       |   apart from possibly reading the zlib header if present: actual decompression
  901|       |   will be done by inflate().  (So next_in and avail_in may be modified, but
  902|       |   next_out and avail_out are unused and unchanged.) The current implementation
  903|       |   of inflateInit2() does not process any header information -- that is
  904|       |   deferred until inflate() is called.
  905|       |*/
  906|       |
  907|       |ZEXTERN int ZEXPORT inflateSetDictionary(z_streamp strm,
  908|       |                                         const Bytef *dictionary,
  909|       |                                         uInt  dictLength);
  910|       |/*
  911|       |     Initializes the decompression dictionary from the given uncompressed byte
  912|       |   sequence.  This function must be called immediately after a call of inflate,
  913|       |   if that call returned Z_NEED_DICT.  The dictionary chosen by the compressor
  914|       |   can be determined from the Adler-32 value returned by that call of inflate.
  915|       |   The compressor and decompressor must use exactly the same dictionary (see
  916|       |   deflateSetDictionary).  For raw inflate, this function can be called at any
  917|       |   time to set the dictionary.  If the provided dictionary is smaller than the
  918|       |   window and there is already data in the window, then the provided dictionary
  919|       |   will amend what's there.  The application must insure that the dictionary
  920|       |   that was used for compression is provided.
  921|       |
  922|       |     inflateSetDictionary returns Z_OK if success, Z_STREAM_ERROR if a
  923|       |   parameter is invalid (e.g.  dictionary being Z_NULL) or the stream state is
  924|       |   inconsistent, Z_DATA_ERROR if the given dictionary doesn't match the
  925|       |   expected one (incorrect Adler-32 value).  inflateSetDictionary does not
  926|       |   perform any decompression: this will be done by subsequent calls of
  927|       |   inflate().
  928|       |*/
  929|       |
  930|       |ZEXTERN int ZEXPORT inflateGetDictionary(z_streamp strm,
  931|       |                                         Bytef *dictionary,
  932|       |                                         uInt  *dictLength);
  933|       |/*
  934|       |     Returns the sliding dictionary being maintained by inflate.  dictLength is
  935|       |   set to the number of bytes in the dictionary, and that many bytes are copied
  936|       |   to dictionary.  dictionary must have enough space, where 32768 bytes is
  937|       |   always enough.  If inflateGetDictionary() is called with dictionary equal to
  938|       |   Z_NULL, then only the dictionary length is returned, and nothing is copied.
  939|       |   Similarly, if dictLength is Z_NULL, then it is not set.
  940|       |
  941|       |     inflateGetDictionary returns Z_OK on success, or Z_STREAM_ERROR if the
  942|       |   stream state is inconsistent.
  943|       |*/
  944|       |
  945|       |ZEXTERN int ZEXPORT inflateSync(z_streamp strm);
  946|       |/*
  947|       |     Skips invalid compressed data until a possible full flush point (see above
  948|       |   for the description of deflate with Z_FULL_FLUSH) can be found, or until all
  949|       |   available input is skipped.  No output is provided.
  950|       |
  951|       |     inflateSync searches for a 00 00 FF FF pattern in the compressed data.
  952|       |   All full flush points have this pattern, but not all occurrences of this
  953|       |   pattern are full flush points.
  954|       |
  955|       |     inflateSync returns Z_OK if a possible full flush point has been found,
  956|       |   Z_BUF_ERROR if no more input was provided, Z_DATA_ERROR if no flush point
  957|       |   has been found, or Z_STREAM_ERROR if the stream structure was inconsistent.
  958|       |   In the success case, the application may save the current value of total_in
  959|       |   which indicates where valid compressed data was found.  In the error case,
  960|       |   the application may repeatedly call inflateSync, providing more input each
  961|       |   time, until success or end of the input data.
  962|       |*/
  963|       |
  964|       |ZEXTERN int ZEXPORT inflateCopy(z_streamp dest,
  965|       |                                z_streamp source);
  966|       |/*
  967|       |     Sets the destination stream as a complete copy of the source stream.
  968|       |
  969|       |     This function can be useful when randomly accessing a large stream.  The
  970|       |   first pass through the stream can periodically record the inflate state,
  971|       |   allowing restarting inflate at those points when randomly accessing the
  972|       |   stream.
  973|       |
  974|       |     inflateCopy returns Z_OK if success, Z_MEM_ERROR if there was not
  975|       |   enough memory, Z_STREAM_ERROR if the source stream state was inconsistent
  976|       |   (such as zalloc being Z_NULL).  msg is left unchanged in both source and
  977|       |   destination.
  978|       |*/
  979|       |
  980|       |ZEXTERN int ZEXPORT inflateReset(z_streamp strm);
  981|       |/*
  982|       |     This function is equivalent to inflateEnd followed by inflateInit,
  983|       |   but does not free and reallocate the internal decompression state.  The
  984|       |   stream will keep attributes that may have been set by inflateInit2.
  985|       |   total_in, total_out, adler, and msg are initialized.
  986|       |
  987|       |     inflateReset returns Z_OK if success, or Z_STREAM_ERROR if the source
  988|       |   stream state was inconsistent (such as zalloc or state being Z_NULL).
  989|       |*/
  990|       |
  991|       |ZEXTERN int ZEXPORT inflateReset2(z_streamp strm,
  992|       |                                  int windowBits);
  993|       |/*
  994|       |     This function is the same as inflateReset, but it also permits changing
  995|       |   the wrap and window size requests.  The windowBits parameter is interpreted
  996|       |   the same as it is for inflateInit2.  If the window size is changed, then the
  997|       |   memory allocated for the window is freed, and the window will be reallocated
  998|       |   by inflate() if needed.
  999|       |
 1000|       |     inflateReset2 returns Z_OK if success, or Z_STREAM_ERROR if the source
 1001|       |   stream state was inconsistent (such as zalloc or state being Z_NULL), or if
 1002|       |   the windowBits parameter is invalid.
 1003|       |*/
 1004|       |
 1005|       |ZEXTERN int ZEXPORT inflatePrime(z_streamp strm,
 1006|       |                                 int bits,
 1007|       |                                 int value);
 1008|       |/*
 1009|       |     This function inserts bits in the inflate input stream.  The intent is to
 1010|       |   use inflatePrime() to start inflating at a bit position in the middle of a
 1011|       |   byte.  The provided bits will be used before any bytes are used from
 1012|       |   next_in.  This function should be used with raw inflate, before the first
 1013|       |   inflate() call, after inflateInit2() or inflateReset().  It can also be used
 1014|       |   after an inflate() return indicates the end of a deflate block or header
 1015|       |   when using Z_BLOCK.  bits must be less than or equal to 16, and that many of
 1016|       |   the least significant bits of value will be inserted in the input.  The
 1017|       |   other bits in value can be non-zero, and will be ignored.
 1018|       |
 1019|       |     If bits is negative, then the input stream bit buffer is emptied.  Then
 1020|       |   inflatePrime() can be called again to put bits in the buffer.  This is used
 1021|       |   to clear out bits leftover after feeding inflate a block description prior
 1022|       |   to feeding inflate codes.
 1023|       |
 1024|       |     inflatePrime returns Z_OK if success, or Z_STREAM_ERROR if the source
 1025|       |   stream state was inconsistent, or if bits is out of range.  If inflate was
 1026|       |   in the middle of processing a header, trailer, or stored block lengths, then
 1027|       |   it is possible for there to be only eight bits available in the bit buffer.
 1028|       |   In that case, bits > 8 is considered out of range.  However, when used as
 1029|       |   outlined above, there will always be 16 bits available in the buffer for
 1030|       |   insertion.  As noted in its documentation above, inflate records the number
 1031|       |   of bits in the bit buffer on return in data_type. 32 minus that is the
 1032|       |   number of bits available for insertion.  inflatePrime does not update
 1033|       |   data_type with the new number of bits in buffer.
 1034|       |*/
 1035|       |
 1036|       |ZEXTERN long ZEXPORT inflateMark(z_streamp strm);
 1037|       |/*
 1038|       |     This function returns two values, one in the lower 16 bits of the return
 1039|       |   value, and the other in the remaining upper bits, obtained by shifting the
 1040|       |   return value down 16 bits.  If the upper value is -1 and the lower value is
 1041|       |   zero, then inflate() is currently decoding information outside of a block.
 1042|       |   If the upper value is -1 and the lower value is non-zero, then inflate is in
 1043|       |   the middle of a stored block, with the lower value equaling the number of
 1044|       |   bytes from the input remaining to copy.  If the upper value is not -1, then
 1045|       |   it is the number of bits back from the current bit position in the input of
 1046|       |   the code (literal or length/distance pair) currently being processed.  In
 1047|       |   that case the lower value is the number of bytes already emitted for that
 1048|       |   code.
 1049|       |
 1050|       |     A code is being processed if inflate is waiting for more input to complete
 1051|       |   decoding of the code, or if it has completed decoding but is waiting for
 1052|       |   more output space to write the literal or match data.
 1053|       |
 1054|       |     inflateMark() is used to mark locations in the input data for random
 1055|       |   access, which may be at bit positions, and to note those cases where the
 1056|       |   output of a code may span boundaries of random access blocks.  The current
 1057|       |   location in the input stream can be determined from avail_in and data_type
 1058|       |   as noted in the description for the Z_BLOCK flush parameter for inflate.
 1059|       |
 1060|       |     inflateMark returns the value noted above, or -65536 if the provided
 1061|       |   source stream state was inconsistent.
 1062|       |*/
 1063|       |
 1064|       |ZEXTERN int ZEXPORT inflateGetHeader(z_streamp strm,
 1065|       |                                     gz_headerp head);
 1066|       |/*
 1067|       |     inflateGetHeader() requests that gzip header information be stored in the
 1068|       |   provided gz_header structure.  inflateGetHeader() may be called after
 1069|       |   inflateInit2() or inflateReset(), and before the first call of inflate().
 1070|       |   As inflate() processes the gzip stream, head->done is zero until the header
 1071|       |   is completed, at which time head->done is set to one.  If a zlib stream is
 1072|       |   being decoded, then head->done is set to -1 to indicate that there will be
 1073|       |   no gzip header information forthcoming.  Note that Z_BLOCK or Z_TREES can be
 1074|       |   used to force inflate() to return immediately after header processing is
 1075|       |   complete and before any actual data is decompressed.
 1076|       |
 1077|       |     The text, time, xflags, and os fields are filled in with the gzip header
 1078|       |   contents.  hcrc is set to true if there is a header CRC.  (The header CRC
 1079|       |   was valid if done is set to one.)  The extra, name, and comment pointers
 1080|       |   much each be either Z_NULL or point to space to store that information from
 1081|       |   the header.  If extra is not Z_NULL, then extra_max contains the maximum
 1082|       |   number of bytes that can be written to extra.  Once done is true, extra_len
 1083|       |   contains the actual extra field length, and extra contains the extra field,
 1084|       |   or that field truncated if extra_max is less than extra_len.  If name is not
 1085|       |   Z_NULL, then up to name_max characters, including the terminating zero, are
 1086|       |   written there.  If comment is not Z_NULL, then up to comm_max characters,
 1087|       |   including the terminating zero, are written there.  The application can tell
 1088|       |   that the name or comment did not fit in the provided space by the absence of
 1089|       |   a terminating zero.  If any of extra, name, or comment are not present in
 1090|       |   the header, then that field's pointer is set to Z_NULL.  This allows the use
 1091|       |   of deflateSetHeader() with the returned structure to duplicate the header.
 1092|       |   Note that if those fields initially pointed to allocated memory, then the
 1093|       |   application will need to save them elsewhere so that they can be eventually
 1094|       |   freed.
 1095|       |
 1096|       |     If inflateGetHeader is not used, then the header information is simply
 1097|       |   discarded.  The header is always checked for validity, including the header
 1098|       |   CRC if present.  inflateReset() will reset the process to discard the header
 1099|       |   information.  The application would need to call inflateGetHeader() again to
 1100|       |   retrieve the header from the next gzip stream.
 1101|       |
 1102|       |     inflateGetHeader returns Z_OK if success, or Z_STREAM_ERROR if the source
 1103|       |   stream state was inconsistent.
 1104|       |*/
 1105|       |
 1106|       |/*
 1107|       |ZEXTERN int ZEXPORT inflateBackInit(z_streamp strm, int windowBits,
 1108|       |                                    unsigned char FAR *window);
 1109|       |
 1110|       |     Initialize the internal stream state for decompression using inflateBack()
 1111|       |   calls.  The fields zalloc, zfree and opaque in strm must be initialized
 1112|       |   before the call.  If zalloc and zfree are Z_NULL, then the default library-
 1113|       |   derived memory allocation routines are used.  windowBits is the base two
 1114|       |   logarithm of the window size, in the range 8..15.  window is a caller
 1115|       |   supplied buffer of that size.  Except for special applications where it is
 1116|       |   assured that deflate was used with small window sizes, windowBits must be 15
 1117|       |   and a 32K byte window must be supplied to be able to decompress general
 1118|       |   deflate streams.
 1119|       |
 1120|       |     See inflateBack() for the usage of these routines.
 1121|       |
 1122|       |     inflateBackInit will return Z_OK on success, Z_STREAM_ERROR if any of
 1123|       |   the parameters are invalid, Z_MEM_ERROR if the internal state could not be
 1124|       |   allocated, or Z_VERSION_ERROR if the version of the library does not match
 1125|       |   the version of the header file.
 1126|       |*/
 1127|       |
 1128|       |typedef unsigned (*in_func)(void FAR *,
 1129|       |                            z_const unsigned char FAR * FAR *);
 1130|       |typedef int (*out_func)(void FAR *, unsigned char FAR *, unsigned);
 1131|       |
 1132|       |ZEXTERN int ZEXPORT inflateBack(z_streamp strm,
 1133|       |                                in_func in, void FAR *in_desc,
 1134|       |                                out_func out, void FAR *out_desc);
 1135|       |/*
 1136|       |     inflateBack() does a raw inflate with a single call using a call-back
 1137|       |   interface for input and output.  This is potentially more efficient than
 1138|       |   inflate() for file i/o applications, in that it avoids copying between the
 1139|       |   output and the sliding window by simply making the window itself the output
 1140|       |   buffer.  inflate() can be faster on modern CPUs when used with large
 1141|       |   buffers.  inflateBack() trusts the application to not change the output
 1142|       |   buffer passed by the output function, at least until inflateBack() returns.
 1143|       |
 1144|       |     inflateBackInit() must be called first to allocate the internal state
 1145|       |   and to initialize the state with the user-provided window buffer.
 1146|       |   inflateBack() may then be used multiple times to inflate a complete, raw
 1147|       |   deflate stream with each call.  inflateBackEnd() is then called to free the
 1148|       |   allocated state.
 1149|       |
 1150|       |     A raw deflate stream is one with no zlib or gzip header or trailer.
 1151|       |   This routine would normally be used in a utility that reads zip or gzip
 1152|       |   files and writes out uncompressed files.  The utility would decode the
 1153|       |   header and process the trailer on its own, hence this routine expects only
 1154|       |   the raw deflate stream to decompress.  This is different from the default
 1155|       |   behavior of inflate(), which expects a zlib header and trailer around the
 1156|       |   deflate stream.
 1157|       |
 1158|       |     inflateBack() uses two subroutines supplied by the caller that are then
 1159|       |   called by inflateBack() for input and output.  inflateBack() calls those
 1160|       |   routines until it reads a complete deflate stream and writes out all of the
 1161|       |   uncompressed data, or until it encounters an error.  The function's
 1162|       |   parameters and return types are defined above in the in_func and out_func
 1163|       |   typedefs.  inflateBack() will call in(in_desc, &buf) which should return the
 1164|       |   number of bytes of provided input, and a pointer to that input in buf.  If
 1165|       |   there is no input available, in() must return zero -- buf is ignored in that
 1166|       |   case -- and inflateBack() will return a buffer error.  inflateBack() will
 1167|       |   call out(out_desc, buf, len) to write the uncompressed data buf[0..len-1].
 1168|       |   out() should return zero on success, or non-zero on failure.  If out()
 1169|       |   returns non-zero, inflateBack() will return with an error.  Neither in() nor
 1170|       |   out() are permitted to change the contents of the window provided to
 1171|       |   inflateBackInit(), which is also the buffer that out() uses to write from.
 1172|       |   The length written by out() will be at most the window size.  Any non-zero
 1173|       |   amount of input may be provided by in().
 1174|       |
 1175|       |     For convenience, inflateBack() can be provided input on the first call by
 1176|       |   setting strm->next_in and strm->avail_in.  If that input is exhausted, then
 1177|       |   in() will be called.  Therefore strm->next_in must be initialized before
 1178|       |   calling inflateBack().  If strm->next_in is Z_NULL, then in() will be called
 1179|       |   immediately for input.  If strm->next_in is not Z_NULL, then strm->avail_in
 1180|       |   must also be initialized, and then if strm->avail_in is not zero, input will
 1181|       |   initially be taken from strm->next_in[0 ..  strm->avail_in - 1].
 1182|       |
 1183|       |     The in_desc and out_desc parameters of inflateBack() is passed as the
 1184|       |   first parameter of in() and out() respectively when they are called.  These
 1185|       |   descriptors can be optionally used to pass any information that the caller-
 1186|       |   supplied in() and out() functions need to do their job.
 1187|       |
 1188|       |     On return, inflateBack() will set strm->next_in and strm->avail_in to
 1189|       |   pass back any unused input that was provided by the last in() call.  The
 1190|       |   return values of inflateBack() can be Z_STREAM_END on success, Z_BUF_ERROR
 1191|       |   if in() or out() returned an error, Z_DATA_ERROR if there was a format error
 1192|       |   in the deflate stream (in which case strm->msg is set to indicate the nature
 1193|       |   of the error), or Z_STREAM_ERROR if the stream was not properly initialized.
 1194|       |   In the case of Z_BUF_ERROR, an input or output error can be distinguished
 1195|       |   using strm->next_in which will be Z_NULL only if in() returned an error.  If
 1196|       |   strm->next_in is not Z_NULL, then the Z_BUF_ERROR was due to out() returning
 1197|       |   non-zero.  (in() will always be called before out(), so strm->next_in is
 1198|       |   assured to be defined if out() returns non-zero.)  Note that inflateBack()
 1199|       |   cannot return Z_OK.
 1200|       |*/
 1201|       |
 1202|       |ZEXTERN int ZEXPORT inflateBackEnd(z_streamp strm);
 1203|       |/*
 1204|       |     All memory allocated by inflateBackInit() is freed.
 1205|       |
 1206|       |     inflateBackEnd() returns Z_OK on success, or Z_STREAM_ERROR if the stream
 1207|       |   state was inconsistent.
 1208|       |*/
 1209|       |
 1210|       |ZEXTERN uLong ZEXPORT zlibCompileFlags(void);
 1211|       |/* Return flags indicating compile-time options.
 1212|       |
 1213|       |    Type sizes, two bits each, 00 = 16 bits, 01 = 32, 10 = 64, 11 = other:
 1214|       |     1.0: size of uInt
 1215|       |     3.2: size of uLong
 1216|       |     5.4: size of voidpf (pointer)
 1217|       |     7.6: size of z_off_t
 1218|       |
 1219|       |    Compiler, assembler, and debug options:
 1220|       |     8: ZLIB_DEBUG
 1221|       |     9: ASMV or ASMINF -- use ASM code
 1222|       |     10: ZLIB_WINAPI -- exported functions use the WINAPI calling convention
 1223|       |     11: 0 (reserved)
 1224|       |
 1225|       |    One-time table building (smaller code, but not thread-safe if true):
 1226|       |     12: BUILDFIXED -- build static block decoding tables when needed
 1227|       |     13: DYNAMIC_CRC_TABLE -- build CRC calculation tables when needed
 1228|       |     14,15: 0 (reserved)
 1229|       |
 1230|       |    Library content (indicates missing functionality):
 1231|       |     16: NO_GZCOMPRESS -- gz* functions cannot compress (to avoid linking
 1232|       |                          deflate code when not needed)
 1233|       |     17: NO_GZIP -- deflate can't write gzip streams, and inflate can't detect
 1234|       |                    and decode gzip streams (to avoid linking crc code)
 1235|       |     18-19: 0 (reserved)
 1236|       |
 1237|       |    Operation variations (changes in library functionality):
 1238|       |     20: PKZIP_BUG_WORKAROUND -- slightly more permissive inflate
 1239|       |     21: FASTEST -- deflate algorithm with only one, lowest compression level
 1240|       |     22,23: 0 (reserved)
 1241|       |
 1242|       |    The sprintf variant used by gzprintf (zero is best):
 1243|       |     24: 0 = vs*, 1 = s* -- 1 means limited to 20 arguments after the format
 1244|       |     25: 0 = *nprintf, 1 = *printf -- 1 means gzprintf() not secure!
 1245|       |     26: 0 = returns value, 1 = void -- 1 means inferred string length returned
 1246|       |
 1247|       |    Remainder:
 1248|       |     27-31: 0 (reserved)
 1249|       | */
 1250|       |
 1251|       |#ifndef Z_SOLO
 1252|       |
 1253|       |                        /* utility functions */
 1254|       |
 1255|       |/*
 1256|       |     The following utility functions are implemented on top of the basic
 1257|       |   stream-oriented functions.  To simplify the interface, some default options
 1258|       |   are assumed (compression level and memory usage, standard memory allocation
 1259|       |   functions).  The source code of these utility functions can be modified if
 1260|       |   you need special options.
 1261|       |*/
 1262|       |
 1263|       |ZEXTERN int ZEXPORT compress(Bytef *dest,   uLongf *destLen,
 1264|       |                             const Bytef *source, uLong sourceLen);
 1265|       |/*
 1266|       |     Compresses the source buffer into the destination buffer.  sourceLen is
 1267|       |   the byte length of the source buffer.  Upon entry, destLen is the total size
 1268|       |   of the destination buffer, which must be at least the value returned by
 1269|       |   compressBound(sourceLen).  Upon exit, destLen is the actual size of the
 1270|       |   compressed data.  compress() is equivalent to compress2() with a level
 1271|       |   parameter of Z_DEFAULT_COMPRESSION.
 1272|       |
 1273|       |     compress returns Z_OK if success, Z_MEM_ERROR if there was not
 1274|       |   enough memory, Z_BUF_ERROR if there was not enough room in the output
 1275|       |   buffer.
 1276|       |*/
 1277|       |
 1278|       |ZEXTERN int ZEXPORT compress2(Bytef *dest,   uLongf *destLen,
 1279|       |                              const Bytef *source, uLong sourceLen,
 1280|       |                              int level);
 1281|       |/*
 1282|       |     Compresses the source buffer into the destination buffer.  The level
 1283|       |   parameter has the same meaning as in deflateInit.  sourceLen is the byte
 1284|       |   length of the source buffer.  Upon entry, destLen is the total size of the
 1285|       |   destination buffer, which must be at least the value returned by
 1286|       |   compressBound(sourceLen).  Upon exit, destLen is the actual size of the
 1287|       |   compressed data.
 1288|       |
 1289|       |     compress2 returns Z_OK if success, Z_MEM_ERROR if there was not enough
 1290|       |   memory, Z_BUF_ERROR if there was not enough room in the output buffer,
 1291|       |   Z_STREAM_ERROR if the level parameter is invalid.
 1292|       |*/
 1293|       |
 1294|       |ZEXTERN uLong ZEXPORT compressBound(uLong sourceLen);
 1295|       |/*
 1296|       |     compressBound() returns an upper bound on the compressed size after
 1297|       |   compress() or compress2() on sourceLen bytes.  It would be used before a
 1298|       |   compress() or compress2() call to allocate the destination buffer.
 1299|       |*/
 1300|       |
 1301|       |ZEXTERN int ZEXPORT uncompress(Bytef *dest,   uLongf *destLen,
 1302|       |                               const Bytef *source, uLong sourceLen);
 1303|       |/*
 1304|       |     Decompresses the source buffer into the destination buffer.  sourceLen is
 1305|       |   the byte length of the source buffer.  Upon entry, destLen is the total size
 1306|       |   of the destination buffer, which must be large enough to hold the entire
 1307|       |   uncompressed data.  (The size of the uncompressed data must have been saved
 1308|       |   previously by the compressor and transmitted to the decompressor by some
 1309|       |   mechanism outside the scope of this compression library.) Upon exit, destLen
 1310|       |   is the actual size of the uncompressed data.
 1311|       |
 1312|       |     uncompress returns Z_OK if success, Z_MEM_ERROR if there was not
 1313|       |   enough memory, Z_BUF_ERROR if there was not enough room in the output
 1314|       |   buffer, or Z_DATA_ERROR if the input data was corrupted or incomplete.  In
 1315|       |   the case where there is not enough room, uncompress() will fill the output
 1316|       |   buffer with the uncompressed data up to that point.
 1317|       |*/
 1318|       |
 1319|       |ZEXTERN int ZEXPORT uncompress2(Bytef *dest,   uLongf *destLen,
 1320|       |                                const Bytef *source, uLong *sourceLen);
 1321|       |/*
 1322|       |     Same as uncompress, except that sourceLen is a pointer, where the
 1323|       |   length of the source is *sourceLen.  On return, *sourceLen is the number of
 1324|       |   source bytes consumed.
 1325|       |*/
 1326|       |
 1327|       |                        /* gzip file access functions */
 1328|       |
 1329|       |/*
 1330|       |     This library supports reading and writing files in gzip (.gz) format with
 1331|       |   an interface similar to that of stdio, using the functions that start with
 1332|       |   "gz".  The gzip format is different from the zlib format.  gzip is a gzip
 1333|       |   wrapper, documented in RFC 1952, wrapped around a deflate stream.
 1334|       |*/
 1335|       |
 1336|       |typedef struct gzFile_s *gzFile;    /* semi-opaque gzip file descriptor */
 1337|       |
 1338|       |/*
 1339|       |ZEXTERN gzFile ZEXPORT gzopen(const char *path, const char *mode);
 1340|       |
 1341|       |     Open the gzip (.gz) file at path for reading and decompressing, or
 1342|       |   compressing and writing.  The mode parameter is as in fopen ("rb" or "wb")
 1343|       |   but can also include a compression level ("wb9") or a strategy: 'f' for
 1344|       |   filtered data as in "wb6f", 'h' for Huffman-only compression as in "wb1h",
 1345|       |   'R' for run-length encoding as in "wb1R", or 'F' for fixed code compression
 1346|       |   as in "wb9F".  (See the description of deflateInit2 for more information
 1347|       |   about the strategy parameter.)  'T' will request transparent writing or
 1348|       |   appending with no compression and not using the gzip format. 'T' cannot be
 1349|       |   used to force transparent reading. Transparent reading is automatically
 1350|       |   performed if there is no gzip header at the start. Transparent reading can
 1351|       |   be disabled with the 'G' option, which will instead return an error if there
 1352|       |   is no gzip header. 'N' will open the file in non-blocking mode.
 1353|       |
 1354|       |     'a' can be used instead of 'w' to request that the gzip stream that will
 1355|       |   be written be appended to the file.  '+' will result in an error, since
 1356|       |   reading and writing to the same gzip file is not supported.  The addition of
 1357|       |   'x' when writing will create the file exclusively, which fails if the file
 1358|       |   already exists.  On systems that support it, the addition of 'e' when
 1359|       |   reading or writing will set the flag to close the file on an execve() call.
 1360|       |
 1361|       |     These functions, as well as gzip, will read and decode a sequence of gzip
 1362|       |   streams in a file.  The append function of gzopen() can be used to create
 1363|       |   such a file.  (Also see gzflush() for another way to do this.)  When
 1364|       |   appending, gzopen does not test whether the file begins with a gzip stream,
 1365|       |   nor does it look for the end of the gzip streams to begin appending.  gzopen
 1366|       |   will simply append a gzip stream to the existing file.
 1367|       |
 1368|       |     gzopen can be used to read a file which is not in gzip format; in this
 1369|       |   case gzread will directly read from the file without decompression.  When
 1370|       |   reading, this will be detected automatically by looking for the magic two-
 1371|       |   byte gzip header.
 1372|       |
 1373|       |     gzopen returns NULL if the file could not be opened, if there was
 1374|       |   insufficient memory to allocate the gzFile state, or if an invalid mode was
 1375|       |   specified (an 'r', 'w', or 'a' was not provided, or '+' was provided).
 1376|       |   errno can be checked to determine if the reason gzopen failed was that the
 1377|       |   file could not be opened. Note that if 'N' is in mode for non-blocking, the
 1378|       |   open() itself can fail in order to not block. In that case gzopen() will
 1379|       |   return NULL and errno will be EAGAIN or ENONBLOCK. The call to gzopen() can
 1380|       |   then be re-tried. If the application would like to block on opening the
 1381|       |   file, then it can use open() without O_NONBLOCK, and then gzdopen() with the
 1382|       |   resulting file descriptor and 'N' in the mode, which will set it to non-
 1383|       |   blocking.
 1384|       |*/
 1385|       |
 1386|       |ZEXTERN gzFile ZEXPORT gzdopen(int fd, const char *mode);
 1387|       |/*
 1388|       |     Associate a gzFile with the file descriptor fd.  File descriptors are
 1389|       |   obtained from calls like open, dup, creat, pipe or fileno (if the file has
 1390|       |   been previously opened with fopen).  The mode parameter is as in gzopen. An
 1391|       |   'e' in mode will set fd's flag to close the file on an execve() call. An 'N'
 1392|       |   in mode will set fd's non-blocking flag.
 1393|       |
 1394|       |     The next call of gzclose on the returned gzFile will also close the file
 1395|       |   descriptor fd, just like fclose(fdopen(fd, mode)) closes the file descriptor
 1396|       |   fd.  If you want to keep fd open, use fd = dup(fd_keep); gz = gzdopen(fd,
 1397|       |   mode);.  The duplicated descriptor should be saved to avoid a leak, since
 1398|       |   gzdopen does not close fd if it fails.  If you are using fileno() to get the
 1399|       |   file descriptor from a FILE *, then you will have to use dup() to avoid
 1400|       |   double-close()ing the file descriptor.  Both gzclose() and fclose() will
 1401|       |   close the associated file descriptor, so they need to have different file
 1402|       |   descriptors.
 1403|       |
 1404|       |     gzdopen returns NULL if there was insufficient memory to allocate the
 1405|       |   gzFile state, if an invalid mode was specified (an 'r', 'w', or 'a' was not
 1406|       |   provided, or '+' was provided), or if fd is -1.  The file descriptor is not
 1407|       |   used until the next gz* read, write, seek, or close operation, so gzdopen
 1408|       |   will not detect if fd is invalid (unless fd is -1).
 1409|       |*/
 1410|       |
 1411|       |ZEXTERN int ZEXPORT gzbuffer(gzFile file, unsigned size);
 1412|       |/*
 1413|       |     Set the internal buffer size used by this library's functions for file to
 1414|       |   size.  The default buffer size is 8192 bytes.  This function must be called
 1415|       |   after gzopen() or gzdopen(), and before any other calls that read or write
 1416|       |   the file.  The buffer memory allocation is always deferred to the first read
 1417|       |   or write.  Three times that size in buffer space is allocated.  A larger
 1418|       |   buffer size of, for example, 64K or 128K bytes will noticeably increase the
 1419|       |   speed of decompression (reading).
 1420|       |
 1421|       |     The new buffer size also affects the maximum length for gzprintf().
 1422|       |
 1423|       |     gzbuffer() returns 0 on success, or -1 on failure, such as being called
 1424|       |   too late.
 1425|       |*/
 1426|       |
 1427|       |ZEXTERN int ZEXPORT gzsetparams(gzFile file, int level, int strategy);
 1428|       |/*
 1429|       |     Dynamically update the compression level and strategy for file.  See the
 1430|       |   description of deflateInit2 for the meaning of these parameters. Previously
 1431|       |   provided data is flushed before applying the parameter changes.
 1432|       |
 1433|       |     gzsetparams returns Z_OK if success, Z_STREAM_ERROR if the file was not
 1434|       |   opened for writing, Z_ERRNO if there is an error writing the flushed data,
 1435|       |   or Z_MEM_ERROR if there is a memory allocation error.
 1436|       |*/
 1437|       |
 1438|       |ZEXTERN int ZEXPORT gzread(gzFile file, voidp buf, unsigned len);
 1439|       |/*
 1440|       |     Read and decompress up to len uncompressed bytes from file into buf.  If
 1441|       |   the input file is not in gzip format, gzread copies the given number of
 1442|       |   bytes into the buffer directly from the file.
 1443|       |
 1444|       |     After reaching the end of a gzip stream in the input, gzread will continue
 1445|       |   to read, looking for another gzip stream.  Any number of gzip streams may be
 1446|       |   concatenated in the input file, and will all be decompressed by gzread().
 1447|       |   If something other than a gzip stream is encountered after a gzip stream,
 1448|       |   that remaining trailing garbage is ignored (and no error is returned).
 1449|       |
 1450|       |     gzread can be used to read a gzip file that is being concurrently written.
 1451|       |   Upon reaching the end of the input, gzread will return with the available
 1452|       |   data.  If the error code returned by gzerror is Z_OK or Z_BUF_ERROR, then
 1453|       |   gzclearerr can be used to clear the end of file indicator in order to permit
 1454|       |   gzread to be tried again.  Z_OK indicates that a gzip stream was completed
 1455|       |   on the last gzread.  Z_BUF_ERROR indicates that the input file ended in the
 1456|       |   middle of a gzip stream.  Note that gzread does not return -1 in the event
 1457|       |   of an incomplete gzip stream.  This error is deferred until gzclose(), which
 1458|       |   will return Z_BUF_ERROR if the last gzread ended in the middle of a gzip
 1459|       |   stream.  Alternatively, gzerror can be used before gzclose to detect this
 1460|       |   case.
 1461|       |
 1462|       |     gzread can be used to read a gzip file on a non-blocking device. If the
 1463|       |   input stalls and there is no uncompressed data to return, then gzread() will
 1464|       |   return -1, and errno will be EAGAIN or EWOULDBLOCK. gzread() can then be
 1465|       |   called again.
 1466|       |
 1467|       |     gzread returns the number of uncompressed bytes actually read, less than
 1468|       |   len for end of file, or -1 for error.  If len is too large to fit in an int,
 1469|       |   then nothing is read, -1 is returned, and the error state is set to
 1470|       |   Z_STREAM_ERROR. If some data was read before an error, then that data is
 1471|       |   returned until exhausted, after which the next call will signal the error.
 1472|       |*/
 1473|       |
 1474|       |ZEXTERN z_size_t ZEXPORT gzfread(voidp buf, z_size_t size, z_size_t nitems,
 1475|       |                                 gzFile file);
 1476|       |/*
 1477|       |     Read and decompress up to nitems items of size size from file into buf,
 1478|       |   otherwise operating as gzread() does.  This duplicates the interface of
 1479|       |   stdio's fread(), with size_t request and return types.  If the library
 1480|       |   defines size_t, then z_size_t is identical to size_t.  If not, then z_size_t
 1481|       |   is an unsigned integer type that can contain a pointer.
 1482|       |
 1483|       |     gzfread() returns the number of full items read of size size, or zero if
 1484|       |   the end of the file was reached and a full item could not be read, or if
 1485|       |   there was an error.  gzerror() must be consulted if zero is returned in
 1486|       |   order to determine if there was an error.  If the multiplication of size and
 1487|       |   nitems overflows, i.e. the product does not fit in a z_size_t, then nothing
 1488|       |   is read, zero is returned, and the error state is set to Z_STREAM_ERROR.
 1489|       |
 1490|       |     In the event that the end of file is reached and only a partial item is
 1491|       |   available at the end, i.e. the remaining uncompressed data length is not a
 1492|       |   multiple of size, then the final partial item is nevertheless read into buf
 1493|       |   and the end-of-file flag is set.  The length of the partial item read is not
 1494|       |   provided, but could be inferred from the result of gztell().  This behavior
 1495|       |   is the same as that of fread() implementations in common libraries. This
 1496|       |   could result in data loss if used with size != 1 when reading a concurrently
 1497|       |   written file or a non-blocking file. In that case, use size == 1 or gzread()
 1498|       |   instead.
 1499|       |*/
 1500|       |
 1501|       |ZEXTERN int ZEXPORT gzwrite(gzFile file, voidpc buf, unsigned len);
 1502|       |/*
 1503|       |     Compress and write the len uncompressed bytes at buf to file. gzwrite
 1504|       |   returns the number of uncompressed bytes written, or 0 in case of error or
 1505|       |   if len is 0.  If the write destination is non-blocking, then gzwrite() may
 1506|       |   return a number of bytes written that is not 0 and less than len.
 1507|       |
 1508|       |     If len does not fit in an int, then 0 is returned and nothing is written.
 1509|       |*/
 1510|       |
 1511|       |ZEXTERN z_size_t ZEXPORT gzfwrite(voidpc buf, z_size_t size,
 1512|       |                                  z_size_t nitems, gzFile file);
 1513|       |/*
 1514|       |     Compress and write nitems items of size size from buf to file, duplicating
 1515|       |   the interface of stdio's fwrite(), with size_t request and return types.  If
 1516|       |   the library defines size_t, then z_size_t is identical to size_t.  If not,
 1517|       |   then z_size_t is an unsigned integer type that can contain a pointer.
 1518|       |
 1519|       |     gzfwrite() returns the number of full items written of size size, or zero
 1520|       |   if there was an error.  If the multiplication of size and nitems overflows,
 1521|       |   i.e. the product does not fit in a z_size_t, then nothing is written, zero
 1522|       |   is returned, and the error state is set to Z_STREAM_ERROR.
 1523|       |
 1524|       |     If writing a concurrently read file or a non-blocking file with size != 1,
 1525|       |   a partial item could be written, with no way of knowing how much of it was
 1526|       |   not written, resulting in data loss.  In that case, use size == 1 or
 1527|       |   gzwrite() instead.
 1528|       |*/
 1529|       |
 1530|       |ZEXTERN int ZEXPORTVA gzprintf(gzFile file, const char *format, ...);
 1531|       |/*
 1532|       |     Convert, format, compress, and write the arguments (...) to file under
 1533|       |   control of the string format, as in fprintf.  gzprintf returns the number of
 1534|       |   uncompressed bytes actually written, or a negative zlib error code in case
 1535|       |   of error.  The number of uncompressed bytes written is limited to 8191, or
 1536|       |   one less than the buffer size given to gzbuffer().  The caller should assure
 1537|       |   that this limit is not exceeded.  If it is exceeded, then gzprintf() will
 1538|       |   return an error (0) with nothing written.  In this case, there may also be a
 1539|       |   buffer overflow with unpredictable consequences, which is possible only if
 1540|       |   zlib was compiled with the insecure functions sprintf() or vsprintf(),
 1541|       |   because the secure snprintf() or vsnprintf() functions were not available.
 1542|       |   This can be determined using zlibCompileFlags().
 1543|       |
 1544|       |     If a Z_BUF_ERROR is returned, then nothing was written due to a stall on
 1545|       |   the non-blocking write destination.
 1546|       |*/
 1547|       |
 1548|       |ZEXTERN int ZEXPORT gzputs(gzFile file, const char *s);
 1549|       |/*
 1550|       |     Compress and write the given null-terminated string s to file, excluding
 1551|       |   the terminating null character.
 1552|       |
 1553|       |     gzputs returns the number of characters written, or -1 in case of error.
 1554|       |   The number of characters written may be less than the length of the string
 1555|       |   if the write destination is non-blocking.
 1556|       |
 1557|       |     If the length of the string does not fit in an int, then -1 is returned
 1558|       |   and nothing is written.
 1559|       |*/
 1560|       |
 1561|       |ZEXTERN char * ZEXPORT gzgets(gzFile file, char *buf, int len);
 1562|       |/*
 1563|       |     Read and decompress bytes from file into buf, until len-1 characters are
 1564|       |   read, or until a newline character is read and transferred to buf, or an
 1565|       |   end-of-file condition is encountered.  If any characters are read or if len
 1566|       |   is one, the string is terminated with a null character.  If no characters
 1567|       |   are read due to an end-of-file or len is less than one, then the buffer is
 1568|       |   left untouched.
 1569|       |
 1570|       |     gzgets returns buf which is a null-terminated string, or it returns NULL
 1571|       |   for end-of-file or in case of error. If some data was read before an error,
 1572|       |   then that data is returned until exhausted, after which the next call will
 1573|       |   return NULL to signal the error.
 1574|       |
 1575|       |     gzgets can be used on a file being concurrently written, and on a non-
 1576|       |   blocking device, both as for gzread(). However lines may be broken in the
 1577|       |   middle, leaving it up to the application to reassemble them as needed.
 1578|       |*/
 1579|       |
 1580|       |ZEXTERN int ZEXPORT gzputc(gzFile file, int c);
 1581|       |/*
 1582|       |     Compress and write c, converted to an unsigned char, into file.  gzputc
 1583|       |   returns the value that was written, or -1 in case of error.
 1584|       |*/
 1585|       |
 1586|       |ZEXTERN int ZEXPORT gzgetc(gzFile file);
 1587|       |/*
 1588|       |     Read and decompress one byte from file. gzgetc returns this byte or -1 in
 1589|       |   case of end of file or error. If some data was read before an error, then
 1590|       |   that data is returned until exhausted, after which the next call will return
 1591|       |   -1 to signal the error.
 1592|       |
 1593|       |     This is implemented as a macro for speed. As such, it does not do all of
 1594|       |   the checking the other functions do. I.e. it does not check to see if file
 1595|       |   is NULL, nor whether the structure file points to has been clobbered or not.
 1596|       |
 1597|       |     gzgetc can be used to read a gzip file on a non-blocking device. If the
 1598|       |   input stalls and there is no uncompressed data to return, then gzgetc() will
 1599|       |   return -1, and errno will be EAGAIN or EWOULDBLOCK. gzread() can then be
 1600|       |   called again.
 1601|       |*/
 1602|       |
 1603|       |ZEXTERN int ZEXPORT gzungetc(int c, gzFile file);
 1604|       |/*
 1605|       |     Push c back onto the stream for file to be read as the first character on
 1606|       |   the next read.  At least one character of push-back is always allowed.
 1607|       |   gzungetc() returns the character pushed, or -1 on failure.  gzungetc() will
 1608|       |   fail if c is -1, and may fail if a character has been pushed but not read
 1609|       |   yet.  If gzungetc is used immediately after gzopen or gzdopen, at least the
 1610|       |   output buffer size of pushed characters is allowed.  (See gzbuffer above.)
 1611|       |   The pushed character will be discarded if the stream is repositioned with
 1612|       |   gzseek() or gzrewind().
 1613|       |
 1614|       |     gzungetc(-1, file) will force any pending seek to execute. Then gztell()
 1615|       |   will report the position, even if the requested seek reached end of file.
 1616|       |   This can be used to determine the number of uncompressed bytes in a gzip
 1617|       |   file without having to read it into a buffer.
 1618|       |*/
 1619|       |
 1620|       |ZEXTERN int ZEXPORT gzflush(gzFile file, int flush);
 1621|       |/*
 1622|       |     Flush all pending output to file.  The parameter flush is as in the
 1623|       |   deflate() function.  The return value is the zlib error number (see function
 1624|       |   gzerror below).  gzflush is only permitted when writing.
 1625|       |
 1626|       |     If the flush parameter is Z_FINISH, the remaining data is written and the
 1627|       |   gzip stream is completed in the output.  If gzwrite() is called again, a new
 1628|       |   gzip stream will be started in the output.  gzread() is able to read such
 1629|       |   concatenated gzip streams.
 1630|       |
 1631|       |     gzflush should be called only when strictly necessary because it will
 1632|       |   degrade compression if called too often.
 1633|       |*/
 1634|       |
 1635|       |/*
 1636|       |ZEXTERN z_off_t ZEXPORT gzseek(gzFile file,
 1637|       |                               z_off_t offset, int whence);
 1638|       |
 1639|       |     Set the starting position to offset relative to whence for the next gzread
 1640|       |   or gzwrite on file.  The offset represents a number of bytes in the
 1641|       |   uncompressed data stream.  The whence parameter is defined as in lseek(2);
 1642|       |   the value SEEK_END is not supported.
 1643|       |
 1644|       |     If the file is opened for reading, this function is emulated but can be
 1645|       |   extremely slow.  If the file is opened for writing, only forward seeks are
 1646|       |   supported; gzseek then compresses a sequence of zeroes up to the new
 1647|       |   starting position. For reading or writing, any actual seeking is deferred
 1648|       |   until the next read or write operation, or close operation when writing.
 1649|       |
 1650|       |     gzseek returns the resulting offset location as measured in bytes from
 1651|       |   the beginning of the uncompressed stream, or -1 in case of error, in
 1652|       |   particular if the file is opened for writing and the new starting position
 1653|       |   would be before the current position.
 1654|       |*/
 1655|       |
 1656|       |ZEXTERN int ZEXPORT gzrewind(gzFile file);
 1657|       |/*
 1658|       |     Rewind file. This function is supported only for reading.
 1659|       |
 1660|       |     gzrewind(file) is equivalent to (int)gzseek(file, 0L, SEEK_SET).
 1661|       |*/
 1662|       |
 1663|       |/*
 1664|       |ZEXTERN z_off_t ZEXPORT gztell(gzFile file);
 1665|       |
 1666|       |     Return the starting position for the next gzread or gzwrite on file.
 1667|       |   This position represents a number of bytes in the uncompressed data stream,
 1668|       |   and is zero when starting, even if appending or reading a gzip stream from
 1669|       |   the middle of a file using gzdopen().
 1670|       |
 1671|       |     gztell(file) is equivalent to gzseek(file, 0L, SEEK_CUR)
 1672|       |*/
 1673|       |
 1674|       |/*
 1675|       |ZEXTERN z_off_t ZEXPORT gzoffset(gzFile file);
 1676|       |
 1677|       |     Return the current compressed (actual) read or write offset of file.  This
 1678|       |   offset includes the count of bytes that precede the gzip stream, for example
 1679|       |   when appending or when using gzdopen() for reading.  When reading, the
 1680|       |   offset does not include as yet unused buffered input.  This information can
 1681|       |   be used for a progress indicator.  On error, gzoffset() returns -1.
 1682|       |*/
 1683|       |
 1684|       |ZEXTERN int ZEXPORT gzeof(gzFile file);
 1685|       |/*
 1686|       |     Return true (1) if the end-of-file indicator for file has been set while
 1687|       |   reading, false (0) otherwise.  Note that the end-of-file indicator is set
 1688|       |   only if the read tried to go past the end of the input, but came up short.
 1689|       |   Therefore, just like feof(), gzeof() may return false even if there is no
 1690|       |   more data to read, in the event that the last read request was for the exact
 1691|       |   number of bytes remaining in the input file.  This will happen if the input
 1692|       |   file size is an exact multiple of the buffer size.
 1693|       |
 1694|       |     If gzeof() returns true, then the read functions will return no more data,
 1695|       |   unless the end-of-file indicator is reset by gzclearerr() and the input file
 1696|       |   has grown since the previous end of file was detected.
 1697|       |*/
 1698|       |
 1699|       |ZEXTERN int ZEXPORT gzdirect(gzFile file);
 1700|       |/*
 1701|       |     Return true (1) if file is being copied directly while reading, or false
 1702|       |   (0) if file is a gzip stream being decompressed.
 1703|       |
 1704|       |     If the input file is empty, gzdirect() will return true, since the input
 1705|       |   does not contain a gzip stream.
 1706|       |
 1707|       |     If gzdirect() is used immediately after gzopen() or gzdopen() it will
 1708|       |   cause buffers to be allocated to allow reading the file to determine if it
 1709|       |   is a gzip file. Therefore if gzbuffer() is used, it should be called before
 1710|       |   gzdirect(). If the input is being written concurrently or the device is non-
 1711|       |   blocking, then gzdirect() may give a different answer once four bytes of
 1712|       |   input have been accumulated, which is what is needed to confirm or deny a
 1713|       |   gzip header. Before this, gzdirect() will return true (1).
 1714|       |
 1715|       |     When writing, gzdirect() returns true (1) if transparent writing was
 1716|       |   requested ("wT" for the gzopen() mode), or false (0) otherwise.  (Note:
 1717|       |   gzdirect() is not needed when writing.  Transparent writing must be
 1718|       |   explicitly requested, so the application already knows the answer.  When
 1719|       |   linking statically, using gzdirect() will include all of the zlib code for
 1720|       |   gzip file reading and decompression, which may not be desired.)
 1721|       |*/
 1722|       |
 1723|       |ZEXTERN int ZEXPORT gzclose(gzFile file);
 1724|       |/*
 1725|       |     Flush all pending output for file, if necessary, close file and
 1726|       |   deallocate the (de)compression state.  Note that once file is closed, you
 1727|       |   cannot call gzerror with file, since its structures have been deallocated.
 1728|       |   gzclose must not be called more than once on the same file, just as free
 1729|       |   must not be called more than once on the same allocation.
 1730|       |
 1731|       |     gzclose will return Z_STREAM_ERROR if file is not valid, Z_ERRNO on a
 1732|       |   file operation error, Z_MEM_ERROR if out of memory, Z_BUF_ERROR if the
 1733|       |   last read ended in the middle of a gzip stream, or Z_OK on success.
 1734|       |*/
 1735|       |
 1736|       |ZEXTERN int ZEXPORT gzclose_r(gzFile file);
 1737|       |ZEXTERN int ZEXPORT gzclose_w(gzFile file);
 1738|       |/*
 1739|       |     Same as gzclose(), but gzclose_r() is only for use when reading, and
 1740|       |   gzclose_w() is only for use when writing or appending.  The advantage to
 1741|       |   using these instead of gzclose() is that they avoid linking in zlib
 1742|       |   compression or decompression code that is not used when only reading or only
 1743|       |   writing respectively.  If gzclose() is used, then both compression and
 1744|       |   decompression code will be included the application when linking to a static
 1745|       |   zlib library.
 1746|       |*/
 1747|       |
 1748|       |ZEXTERN const char * ZEXPORT gzerror(gzFile file, int *errnum);
 1749|       |/*
 1750|       |     Return the error message for the last error which occurred on file.
 1751|       |   If errnum is not NULL, *errnum is set to zlib error number.  If an error
 1752|       |   occurred in the file system and not in the compression library, *errnum is
 1753|       |   set to Z_ERRNO and the application may consult errno to get the exact error
 1754|       |   code.
 1755|       |
 1756|       |     The application must not modify the returned string.  Future calls to
 1757|       |   this function may invalidate the previously returned string.  If file is
 1758|       |   closed, then the string previously returned by gzerror will no longer be
 1759|       |   available.
 1760|       |
 1761|       |     gzerror() should be used to distinguish errors from end-of-file for those
 1762|       |   functions above that do not distinguish those cases in their return values.
 1763|       |*/
 1764|       |
 1765|       |ZEXTERN void ZEXPORT gzclearerr(gzFile file);
 1766|       |/*
 1767|       |     Clear the error and end-of-file flags for file.  This is analogous to the
 1768|       |   clearerr() function in stdio.  This is useful for continuing to read a gzip
 1769|       |   file that is being written concurrently.
 1770|       |*/
 1771|       |
 1772|       |#endif /* !Z_SOLO */
 1773|       |
 1774|       |                        /* checksum functions */
 1775|       |
 1776|       |/*
 1777|       |     These functions are not related to compression but are exported
 1778|       |   anyway because they might be useful in applications using the compression
 1779|       |   library.
 1780|       |*/
 1781|       |
 1782|       |ZEXTERN uLong ZEXPORT adler32(uLong adler, const Bytef *buf, uInt len);
 1783|       |/*
 1784|       |     Update a running Adler-32 checksum with the bytes buf[0..len-1] and
 1785|       |   return the updated checksum. An Adler-32 value is in the range of a 32-bit
 1786|       |   unsigned integer. If buf is Z_NULL, this function returns the required
 1787|       |   initial value for the checksum.
 1788|       |
 1789|       |     An Adler-32 checksum is almost as reliable as a CRC-32 but can be computed
 1790|       |   much faster.
 1791|       |
 1792|       |   Usage example:
 1793|       |
 1794|       |     uLong adler = adler32(0L, Z_NULL, 0);
 1795|       |
 1796|       |     while (read_buffer(buffer, length) != EOF) {
 1797|       |       adler = adler32(adler, buffer, length);
 1798|       |     }
 1799|       |     if (adler != original_adler) error();
 1800|       |*/
 1801|       |
 1802|       |ZEXTERN uLong ZEXPORT adler32_z(uLong adler, const Bytef *buf,
 1803|       |                                z_size_t len);
 1804|       |/*
 1805|       |     Same as adler32(), but with a size_t length.
 1806|       |*/
 1807|       |
 1808|       |/*
 1809|       |ZEXTERN uLong ZEXPORT adler32_combine(uLong adler1, uLong adler2,
 1810|       |                                      z_off_t len2);
 1811|       |
 1812|       |     Combine two Adler-32 checksums into one.  For two sequences of bytes, seq1
 1813|       |   and seq2 with lengths len1 and len2, Adler-32 checksums were calculated for
 1814|       |   each, adler1 and adler2.  adler32_combine() returns the Adler-32 checksum of
 1815|       |   seq1 and seq2 concatenated, requiring only adler1, adler2, and len2.  Note
 1816|       |   that the z_off_t type (like off_t) is a signed integer.  If len2 is
 1817|       |   negative, the result has no meaning or utility.
 1818|       |*/
 1819|       |
 1820|       |ZEXTERN uLong ZEXPORT crc32(uLong crc, const Bytef *buf, uInt len);
 1821|       |/*
 1822|       |     Update a running CRC-32 with the bytes buf[0..len-1] and return the
 1823|       |   updated CRC-32. A CRC-32 value is in the range of a 32-bit unsigned integer.
 1824|       |   If buf is Z_NULL, this function returns the required initial value for the
 1825|       |   crc. Pre- and post-conditioning (one's complement) is performed within this
 1826|       |   function so it shouldn't be done by the application.
 1827|       |
 1828|       |   Usage example:
 1829|       |
 1830|       |     uLong crc = crc32(0L, Z_NULL, 0);
 1831|       |
 1832|       |     while (read_buffer(buffer, length) != EOF) {
 1833|       |       crc = crc32(crc, buffer, length);
 1834|       |     }
 1835|       |     if (crc != original_crc) error();
 1836|       |*/
 1837|       |
 1838|       |ZEXTERN uLong ZEXPORT crc32_z(uLong crc, const Bytef *buf,
 1839|       |                              z_size_t len);
 1840|       |/*
 1841|       |     Same as crc32(), but with a size_t length.
 1842|       |*/
 1843|       |
 1844|       |/*
 1845|       |ZEXTERN uLong ZEXPORT crc32_combine(uLong crc1, uLong crc2, z_off_t len2);
 1846|       |
 1847|       |     Combine two CRC-32 check values into one.  For two sequences of bytes,
 1848|       |   seq1 and seq2 with lengths len1 and len2, CRC-32 check values were
 1849|       |   calculated for each, crc1 and crc2.  crc32_combine() returns the CRC-32
 1850|       |   check value of seq1 and seq2 concatenated, requiring only crc1, crc2, and
 1851|       |   len2. len2 must be non-negative.
 1852|       |*/
 1853|       |
 1854|       |/*
 1855|       |ZEXTERN uLong ZEXPORT crc32_combine_gen(z_off_t len2);
 1856|       |
 1857|       |     Return the operator corresponding to length len2, to be used with
 1858|       |   crc32_combine_op(). len2 must be non-negative.
 1859|       |*/
 1860|       |
 1861|       |ZEXTERN uLong ZEXPORT crc32_combine_op(uLong crc1, uLong crc2, uLong op);
 1862|       |/*
 1863|       |     Give the same result as crc32_combine(), using op in place of len2. op is
 1864|       |   is generated from len2 by crc32_combine_gen(). This will be faster than
 1865|       |   crc32_combine() if the generated op is used more than once.
 1866|       |*/
 1867|       |
 1868|       |
 1869|       |                        /* various hacks, don't look :) */
 1870|       |
 1871|       |/* deflateInit and inflateInit are macros to allow checking the zlib version
 1872|       | * and the compiler's view of z_stream:
 1873|       | */
 1874|       |ZEXTERN int ZEXPORT deflateInit_(z_streamp strm, int level,
 1875|       |                                 const char *version, int stream_size);
 1876|       |ZEXTERN int ZEXPORT inflateInit_(z_streamp strm,
 1877|       |                                 const char *version, int stream_size);
 1878|       |ZEXTERN int ZEXPORT deflateInit2_(z_streamp strm, int  level, int  method,
 1879|       |                                  int windowBits, int memLevel,
 1880|       |                                  int strategy, const char *version,
 1881|       |                                  int stream_size);
 1882|       |ZEXTERN int ZEXPORT inflateInit2_(z_streamp strm, int  windowBits,
 1883|       |                                  const char *version, int stream_size);
 1884|       |ZEXTERN int ZEXPORT inflateBackInit_(z_streamp strm, int windowBits,
 1885|       |                                     unsigned char FAR *window,
 1886|       |                                     const char *version,
 1887|       |                                     int stream_size);
 1888|       |#ifdef Z_PREFIX_SET
 1889|       |#  define z_deflateInit(strm, level) \
 1890|       |          deflateInit_((strm), (level), ZLIB_VERSION, (int)sizeof(z_stream))
 1891|       |#  define z_inflateInit(strm) \
 1892|       |          inflateInit_((strm), ZLIB_VERSION, (int)sizeof(z_stream))
 1893|       |#  define z_deflateInit2(strm, level, method, windowBits, memLevel, strategy) \
 1894|       |          deflateInit2_((strm),(level),(method),(windowBits),(memLevel),\
 1895|       |                        (strategy), ZLIB_VERSION, (int)sizeof(z_stream))
 1896|       |#  define z_inflateInit2(strm, windowBits) \
 1897|       |          inflateInit2_((strm), (windowBits), ZLIB_VERSION, \
 1898|       |                        (int)sizeof(z_stream))
 1899|       |#  define z_inflateBackInit(strm, windowBits, window) \
 1900|       |          inflateBackInit_((strm), (windowBits), (window), \
 1901|       |                           ZLIB_VERSION, (int)sizeof(z_stream))
 1902|       |#else
 1903|       |#  define deflateInit(strm, level) \
 1904|   263k|          deflateInit_((strm), (level), ZLIB_VERSION, (int)sizeof(z_stream))
 1905|       |#  define inflateInit(strm) \
 1906|   526k|          inflateInit_((strm), ZLIB_VERSION, (int)sizeof(z_stream))
 1907|       |#  define deflateInit2(strm, level, method, windowBits, memLevel, strategy) \
 1908|       |          deflateInit2_((strm),(level),(method),(windowBits),(memLevel),\
 1909|       |                        (strategy), ZLIB_VERSION, (int)sizeof(z_stream))
 1910|       |#  define inflateInit2(strm, windowBits) \
 1911|       |          inflateInit2_((strm), (windowBits), ZLIB_VERSION, \
 1912|       |                        (int)sizeof(z_stream))
 1913|       |#  define inflateBackInit(strm, windowBits, window) \
 1914|       |          inflateBackInit_((strm), (windowBits), (window), \
 1915|       |                           ZLIB_VERSION, (int)sizeof(z_stream))
 1916|       |#endif
 1917|       |
 1918|       |#ifndef Z_SOLO
 1919|       |
 1920|       |/* gzgetc() macro and its supporting function and exposed data structure.  Note
 1921|       | * that the real internal state is much larger than the exposed structure.
 1922|       | * This abbreviated structure exposes just enough for the gzgetc() macro.  The
 1923|       | * user should not mess with these exposed elements, since their names or
 1924|       | * behavior could change in the future, perhaps even capriciously.  They can
 1925|       | * only be used by the gzgetc() macro.  You have been warned.
 1926|       | */
 1927|       |struct gzFile_s {
 1928|       |    unsigned have;
 1929|       |    unsigned char *next;
 1930|       |    z_off64_t pos;
 1931|       |};
 1932|       |ZEXTERN int ZEXPORT gzgetc_(gzFile file);       /* backward compatibility */
 1933|       |#ifdef Z_PREFIX_SET
 1934|       |#  undef z_gzgetc
 1935|       |#  define z_gzgetc(g) \
 1936|       |          ((g)->have ? ((g)->have--, (g)->pos++, *((g)->next)++) : (gzgetc)(g))
 1937|       |#else
 1938|       |#  define gzgetc(g) \
 1939|       |          ((g)->have ? ((g)->have--, (g)->pos++, *((g)->next)++) : (gzgetc)(g))
 1940|       |#endif
 1941|       |
 1942|       |/* provide 64-bit offset functions if _LARGEFILE64_SOURCE defined, and/or
 1943|       | * change the regular functions to 64 bits if _FILE_OFFSET_BITS is 64 (if
 1944|       | * both are true, the application gets the *64 functions, and the regular
 1945|       | * functions are changed to 64 bits) -- in case these are set on systems
 1946|       | * without large file support, _LFS64_LARGEFILE must also be true
 1947|       | */
 1948|       |#ifdef Z_LARGE64
 1949|       |   ZEXTERN gzFile ZEXPORT gzopen64(const char *, const char *);
 1950|       |   ZEXTERN z_off64_t ZEXPORT gzseek64(gzFile, z_off64_t, int);
 1951|       |   ZEXTERN z_off64_t ZEXPORT gztell64(gzFile);
 1952|       |   ZEXTERN z_off64_t ZEXPORT gzoffset64(gzFile);
 1953|       |   ZEXTERN uLong ZEXPORT adler32_combine64(uLong, uLong, z_off64_t);
 1954|       |   ZEXTERN uLong ZEXPORT crc32_combine64(uLong, uLong, z_off64_t);
 1955|       |   ZEXTERN uLong ZEXPORT crc32_combine_gen64(z_off64_t);
 1956|       |#endif
 1957|       |
 1958|       |#if !defined(ZLIB_INTERNAL) && defined(Z_WANT64)
 1959|       |#  ifdef Z_PREFIX_SET
 1960|       |#    define z_gzopen z_gzopen64
 1961|       |#    define z_gzseek z_gzseek64
 1962|       |#    define z_gztell z_gztell64
 1963|       |#    define z_gzoffset z_gzoffset64
 1964|       |#    define z_adler32_combine z_adler32_combine64
 1965|       |#    define z_crc32_combine z_crc32_combine64
 1966|       |#    define z_crc32_combine_gen z_crc32_combine_gen64
 1967|       |#  else
 1968|       |#    define gzopen gzopen64
 1969|       |#    define gzseek gzseek64
 1970|       |#    define gztell gztell64
 1971|       |#    define gzoffset gzoffset64
 1972|       |#    define adler32_combine adler32_combine64
 1973|       |#    define crc32_combine crc32_combine64
 1974|       |#    define crc32_combine_gen crc32_combine_gen64
 1975|       |#  endif
 1976|       |#  ifndef Z_LARGE64
 1977|       |     ZEXTERN gzFile ZEXPORT gzopen64(const char *, const char *);
 1978|       |     ZEXTERN z_off_t ZEXPORT gzseek64(gzFile, z_off_t, int);
 1979|       |     ZEXTERN z_off_t ZEXPORT gztell64(gzFile);
 1980|       |     ZEXTERN z_off_t ZEXPORT gzoffset64(gzFile);
 1981|       |     ZEXTERN uLong ZEXPORT adler32_combine64(uLong, uLong, z_off64_t);
 1982|       |     ZEXTERN uLong ZEXPORT crc32_combine64(uLong, uLong, z_off64_t);
 1983|       |     ZEXTERN uLong ZEXPORT crc32_combine_gen64(z_off64_t);
 1984|       |#  endif
 1985|       |#else
 1986|       |   ZEXTERN gzFile ZEXPORT gzopen(const char *, const char *);
 1987|       |   ZEXTERN z_off_t ZEXPORT gzseek(gzFile, z_off_t, int);
 1988|       |   ZEXTERN z_off_t ZEXPORT gztell(gzFile);
 1989|       |   ZEXTERN z_off_t ZEXPORT gzoffset(gzFile);
 1990|       |   ZEXTERN uLong ZEXPORT adler32_combine(uLong, uLong, z_off_t);
 1991|       |   ZEXTERN uLong ZEXPORT crc32_combine(uLong, uLong, z_off_t);
 1992|       |   ZEXTERN uLong ZEXPORT crc32_combine_gen(z_off_t);
 1993|       |#endif
 1994|       |
 1995|       |#else /* Z_SOLO */
 1996|       |
 1997|       |   ZEXTERN uLong ZEXPORT adler32_combine(uLong, uLong, z_off_t);
 1998|       |   ZEXTERN uLong ZEXPORT crc32_combine(uLong, uLong, z_off_t);
 1999|       |   ZEXTERN uLong ZEXPORT crc32_combine_gen(z_off_t);
 2000|       |
 2001|       |#endif /* !Z_SOLO */
 2002|       |
 2003|       |/* undocumented functions */
 2004|       |ZEXTERN const char   * ZEXPORT zError(int);
 2005|       |ZEXTERN int            ZEXPORT inflateSyncPoint(z_streamp);
 2006|       |ZEXTERN const z_crc_t FAR * ZEXPORT get_crc_table(void);
 2007|       |ZEXTERN int            ZEXPORT inflateUndermine(z_streamp, int);
 2008|       |ZEXTERN int            ZEXPORT inflateValidate(z_streamp, int);
 2009|       |ZEXTERN unsigned long  ZEXPORT inflateCodesUsed(z_streamp);
 2010|       |ZEXTERN int            ZEXPORT inflateResetKeep(z_streamp);
 2011|       |ZEXTERN int            ZEXPORT deflateResetKeep(z_streamp);
 2012|       |#if defined(_WIN32) && !defined(Z_SOLO)
 2013|       |ZEXTERN gzFile         ZEXPORT gzopen_w(const wchar_t *path,
 2014|       |                                        const char *mode);
 2015|       |#endif
 2016|       |#if defined(STDC) || defined(Z_HAVE_STDARG_H)
 2017|       |#  ifndef Z_SOLO
 2018|       |ZEXTERN int            ZEXPORTVA gzvprintf(gzFile file,
 2019|       |                                           const char *format,
 2020|       |                                           va_list va);
 2021|       |#  endif
 2022|       |#endif
 2023|       |
 2024|       |#ifdef __cplusplus
 2025|       |}
 2026|       |#endif
 2027|       |
 2028|       |#endif /* ZLIB_H */

/home/minseo/alfha/targets/zlib/target/zutil.c:
    1|       |/* zutil.c -- target dependent utility functions for the compression library
    2|       | * Copyright (C) 1995-2017 Jean-loup Gailly
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* @(#) $Id$ */
    7|       |
    8|       |#include "zutil.h"
    9|       |#ifndef Z_SOLO
   10|       |#  include "gzguts.h"
   11|       |#endif
   12|       |
   13|       |z_const char * const z_errmsg[10] = {
   14|       |    (z_const char *)"need dictionary",     /* Z_NEED_DICT       2  */
   15|       |    (z_const char *)"stream end",          /* Z_STREAM_END      1  */
   16|       |    (z_const char *)"",                    /* Z_OK              0  */
   17|       |    (z_const char *)"file error",          /* Z_ERRNO         (-1) */
   18|       |    (z_const char *)"stream error",        /* Z_STREAM_ERROR  (-2) */
   19|       |    (z_const char *)"data error",          /* Z_DATA_ERROR    (-3) */
   20|       |    (z_const char *)"insufficient memory", /* Z_MEM_ERROR     (-4) */
   21|       |    (z_const char *)"buffer error",        /* Z_BUF_ERROR     (-5) */
   22|       |    (z_const char *)"incompatible version",/* Z_VERSION_ERROR (-6) */
   23|       |    (z_const char *)""
   24|       |};
   25|       |
   26|       |
   27|      0|const char * ZEXPORT zlibVersion(void) {
   28|      0|    return ZLIB_VERSION;
   29|      0|}
   30|       |
   31|      0|uLong ZEXPORT zlibCompileFlags(void) {
   32|      0|    uLong flags;
   33|       |
   34|      0|    flags = 0;
   35|      0|    switch ((int)(sizeof(uInt))) {
   36|      0|    case 2:     break;
  ------------------
  |  Branch (36:5): [True: 0, False: 0]
  ------------------
   37|      0|    case 4:     flags += 1;     break;
  ------------------
  |  Branch (37:5): [True: 0, False: 0]
  ------------------
   38|      0|    case 8:     flags += 2;     break;
  ------------------
  |  Branch (38:5): [True: 0, False: 0]
  ------------------
   39|      0|    default:    flags += 3;
  ------------------
  |  Branch (39:5): [True: 0, False: 0]
  ------------------
   40|      0|    }
   41|      0|    switch ((int)(sizeof(uLong))) {
   42|      0|    case 2:     break;
  ------------------
  |  Branch (42:5): [True: 0, False: 0]
  ------------------
   43|      0|    case 4:     flags += 1 << 2;        break;
  ------------------
  |  Branch (43:5): [True: 0, False: 0]
  ------------------
   44|      0|    case 8:     flags += 2 << 2;        break;
  ------------------
  |  Branch (44:5): [True: 0, False: 0]
  ------------------
   45|      0|    default:    flags += 3 << 2;
  ------------------
  |  Branch (45:5): [True: 0, False: 0]
  ------------------
   46|      0|    }
   47|      0|    switch ((int)(sizeof(voidpf))) {
   48|      0|    case 2:     break;
  ------------------
  |  Branch (48:5): [True: 0, False: 0]
  ------------------
   49|      0|    case 4:     flags += 1 << 4;        break;
  ------------------
  |  Branch (49:5): [True: 0, False: 0]
  ------------------
   50|      0|    case 8:     flags += 2 << 4;        break;
  ------------------
  |  Branch (50:5): [True: 0, False: 0]
  ------------------
   51|      0|    default:    flags += 3 << 4;
  ------------------
  |  Branch (51:5): [True: 0, False: 0]
  ------------------
   52|      0|    }
   53|      0|    switch ((int)(sizeof(z_off_t))) {
   54|      0|    case 2:     break;
  ------------------
  |  Branch (54:5): [True: 0, False: 0]
  ------------------
   55|      0|    case 4:     flags += 1 << 6;        break;
  ------------------
  |  Branch (55:5): [True: 0, False: 0]
  ------------------
   56|      0|    case 8:     flags += 2 << 6;        break;
  ------------------
  |  Branch (56:5): [True: 0, False: 0]
  ------------------
   57|      0|    default:    flags += 3 << 6;
  ------------------
  |  Branch (57:5): [True: 0, False: 0]
  ------------------
   58|      0|    }
   59|       |#ifdef ZLIB_DEBUG
   60|       |    flags += 1 << 8;
   61|       |#endif
   62|       |    /*
   63|       |#if defined(ASMV) || defined(ASMINF)
   64|       |    flags += 1 << 9;
   65|       |#endif
   66|       |     */
   67|       |#ifdef ZLIB_WINAPI
   68|       |    flags += 1 << 10;
   69|       |#endif
   70|       |#ifdef BUILDFIXED
   71|       |    flags += 1 << 12;
   72|       |#endif
   73|       |#ifdef DYNAMIC_CRC_TABLE
   74|       |    flags += 1 << 13;
   75|       |#endif
   76|       |#ifdef NO_GZCOMPRESS
   77|       |    flags += 1L << 16;
   78|       |#endif
   79|       |#ifdef NO_GZIP
   80|       |    flags += 1L << 17;
   81|       |#endif
   82|       |#ifdef PKZIP_BUG_WORKAROUND
   83|       |    flags += 1L << 20;
   84|       |#endif
   85|       |#ifdef FASTEST
   86|       |    flags += 1L << 21;
   87|       |#endif
   88|      0|#if defined(STDC) || defined(Z_HAVE_STDARG_H)
   89|       |#  ifdef NO_vsnprintf
   90|       |    flags += 1L << 25;
   91|       |#    ifdef HAS_vsprintf_void
   92|       |    flags += 1L << 26;
   93|       |#    endif
   94|       |#  else
   95|       |#    ifdef HAS_vsnprintf_void
   96|       |    flags += 1L << 26;
   97|       |#    endif
   98|      0|#  endif
   99|       |#else
  100|       |    flags += 1L << 24;
  101|       |#  ifdef NO_snprintf
  102|       |    flags += 1L << 25;
  103|       |#    ifdef HAS_sprintf_void
  104|       |    flags += 1L << 26;
  105|       |#    endif
  106|       |#  else
  107|       |#    ifdef HAS_snprintf_void
  108|       |    flags += 1L << 26;
  109|       |#    endif
  110|       |#  endif
  111|       |#endif
  112|      0|    return flags;
  113|      0|}
  114|       |
  115|       |#ifdef ZLIB_DEBUG
  116|       |#include <stdlib.h>
  117|       |#  ifndef verbose
  118|       |#    define verbose 0
  119|       |#  endif
  120|       |int ZLIB_INTERNAL z_verbose = verbose;
  121|       |
  122|       |void ZLIB_INTERNAL z_error(char *m) {
  123|       |    fprintf(stderr, "%s\n", m);
  124|       |    exit(1);
  125|       |}
  126|       |#endif
  127|       |
  128|       |/* exported to allow conversion of error code to string for compress() and
  129|       | * uncompress()
  130|       | */
  131|      0|const char * ZEXPORT zError(int err) {
  132|      0|    return ERR_MSG(err);
  133|      0|}
  134|       |
  135|       |#if defined(_WIN32_WCE) && _WIN32_WCE < 0x800
  136|       |    /* The older Microsoft C Run-Time Library for Windows CE doesn't have
  137|       |     * errno.  We define it as a global variable to simplify porting.
  138|       |     * Its value is always 0 and should not be used.
  139|       |     */
  140|       |    int errno = 0;
  141|       |#endif
  142|       |
  143|       |#ifndef HAVE_MEMCPY
  144|       |
  145|       |void ZLIB_INTERNAL zmemcpy(Bytef* dest, const Bytef* source, uInt len) {
  146|       |    if (len == 0) return;
  147|       |    do {
  148|       |        *dest++ = *source++; /* ??? to be unrolled */
  149|       |    } while (--len != 0);
  150|       |}
  151|       |
  152|       |int ZLIB_INTERNAL zmemcmp(const Bytef* s1, const Bytef* s2, uInt len) {
  153|       |    uInt j;
  154|       |
  155|       |    for (j = 0; j < len; j++) {
  156|       |        if (s1[j] != s2[j]) return 2*(s1[j] > s2[j])-1;
  157|       |    }
  158|       |    return 0;
  159|       |}
  160|       |
  161|       |void ZLIB_INTERNAL zmemzero(Bytef* dest, uInt len) {
  162|       |    if (len == 0) return;
  163|       |    do {
  164|       |        *dest++ = 0;  /* ??? to be unrolled */
  165|       |    } while (--len != 0);
  166|       |}
  167|       |#endif
  168|       |
  169|       |#ifndef Z_SOLO
  170|       |
  171|       |#ifdef SYS16BIT
  172|       |
  173|       |#ifdef __TURBOC__
  174|       |/* Turbo C in 16-bit mode */
  175|       |
  176|       |#  define MY_ZCALLOC
  177|       |
  178|       |/* Turbo C malloc() does not allow dynamic allocation of 64K bytes
  179|       | * and farmalloc(64K) returns a pointer with an offset of 8, so we
  180|       | * must fix the pointer. Warning: the pointer must be put back to its
  181|       | * original form in order to free it, use zcfree().
  182|       | */
  183|       |
  184|       |#define MAX_PTR 10
  185|       |/* 10*64K = 640K */
  186|       |
  187|       |local int next_ptr = 0;
  188|       |
  189|       |typedef struct ptr_table_s {
  190|       |    voidpf org_ptr;
  191|       |    voidpf new_ptr;
  192|       |} ptr_table;
  193|       |
  194|       |local ptr_table table[MAX_PTR];
  195|       |/* This table is used to remember the original form of pointers
  196|       | * to large buffers (64K). Such pointers are normalized with a zero offset.
  197|       | * Since MSDOS is not a preemptive multitasking OS, this table is not
  198|       | * protected from concurrent access. This hack doesn't work anyway on
  199|       | * a protected system like OS/2. Use Microsoft C instead.
  200|       | */
  201|       |
  202|       |voidpf ZLIB_INTERNAL zcalloc(voidpf opaque, unsigned items, unsigned size) {
  203|       |    voidpf buf;
  204|       |    ulg bsize = (ulg)items*size;
  205|       |
  206|       |    (void)opaque;
  207|       |
  208|       |    /* If we allocate less than 65520 bytes, we assume that farmalloc
  209|       |     * will return a usable pointer which doesn't have to be normalized.
  210|       |     */
  211|       |    if (bsize < 65520L) {
  212|       |        buf = farmalloc(bsize);
  213|       |        if (*(ush*)&buf != 0) return buf;
  214|       |    } else {
  215|       |        buf = farmalloc(bsize + 16L);
  216|       |    }
  217|       |    if (buf == NULL || next_ptr >= MAX_PTR) return NULL;
  218|       |    table[next_ptr].org_ptr = buf;
  219|       |
  220|       |    /* Normalize the pointer to seg:0 */
  221|       |    *((ush*)&buf+1) += ((ush)((uch*)buf-0) + 15) >> 4;
  222|       |    *(ush*)&buf = 0;
  223|       |    table[next_ptr++].new_ptr = buf;
  224|       |    return buf;
  225|       |}
  226|       |
  227|       |void ZLIB_INTERNAL zcfree(voidpf opaque, voidpf ptr) {
  228|       |    int n;
  229|       |
  230|       |    (void)opaque;
  231|       |
  232|       |    if (*(ush*)&ptr != 0) { /* object < 64K */
  233|       |        farfree(ptr);
  234|       |        return;
  235|       |    }
  236|       |    /* Find the original pointer */
  237|       |    for (n = 0; n < next_ptr; n++) {
  238|       |        if (ptr != table[n].new_ptr) continue;
  239|       |
  240|       |        farfree(table[n].org_ptr);
  241|       |        while (++n < next_ptr) {
  242|       |            table[n-1] = table[n];
  243|       |        }
  244|       |        next_ptr--;
  245|       |        return;
  246|       |    }
  247|       |    Assert(0, "zcfree: ptr not found");
  248|       |}
  249|       |
  250|       |#endif /* __TURBOC__ */
  251|       |
  252|       |
  253|       |#ifdef M_I86
  254|       |/* Microsoft C in 16-bit mode */
  255|       |
  256|       |#  define MY_ZCALLOC
  257|       |
  258|       |#if (!defined(_MSC_VER) || (_MSC_VER <= 600))
  259|       |#  define _halloc  halloc
  260|       |#  define _hfree   hfree
  261|       |#endif
  262|       |
  263|       |voidpf ZLIB_INTERNAL zcalloc(voidpf opaque, uInt items, uInt size) {
  264|       |    (void)opaque;
  265|       |    return _halloc((long)items, size);
  266|       |}
  267|       |
  268|       |void ZLIB_INTERNAL zcfree(voidpf opaque, voidpf ptr) {
  269|       |    (void)opaque;
  270|       |    _hfree(ptr);
  271|       |}
  272|       |
  273|       |#endif /* M_I86 */
  274|       |
  275|       |#endif /* SYS16BIT */
  276|       |
  277|       |
  278|       |#ifndef MY_ZCALLOC /* Any system without a special alloc function */
  279|       |
  280|       |#ifndef STDC
  281|       |extern voidp malloc(uInt size);
  282|       |extern voidp calloc(uInt items, uInt size);
  283|       |extern void free(voidpf ptr);
  284|       |#endif
  285|       |
  286|  1.85M|voidpf ZLIB_INTERNAL zcalloc(voidpf opaque, unsigned items, unsigned size) {
  287|  1.85M|    (void)opaque;
  288|  1.85M|    return sizeof(uInt) > 2 ? (voidpf)malloc(items * size) :
  ------------------
  |  Branch (288:12): [Folded - Ignored]
  ------------------
  289|  1.85M|                              (voidpf)calloc(items, size);
                                            ^0
  290|  1.85M|}
  291|       |
  292|  1.85M|void ZLIB_INTERNAL zcfree(voidpf opaque, voidpf ptr) {
  293|  1.85M|    (void)opaque;
  294|  1.85M|    free(ptr);
  295|  1.85M|}
  296|       |
  297|       |#endif /* MY_ZCALLOC */
  298|       |
  299|       |#endif /* !Z_SOLO */

/home/minseo/alfha/targets/zlib/target/zutil.h:
    1|       |/* zutil.h -- internal interface and configuration of the compression library
    2|       | * Copyright (C) 1995-2024 Jean-loup Gailly, Mark Adler
    3|       | * For conditions of distribution and use, see copyright notice in zlib.h
    4|       | */
    5|       |
    6|       |/* WARNING: this file should *not* be used by applications. It is
    7|       |   part of the implementation of the compression library and is
    8|       |   subject to change. Applications should only use zlib.h.
    9|       | */
   10|       |
   11|       |/* @(#) $Id$ */
   12|       |
   13|       |#ifndef ZUTIL_H
   14|       |#define ZUTIL_H
   15|       |
   16|       |#ifdef HAVE_HIDDEN
   17|       |#  define ZLIB_INTERNAL __attribute__((visibility ("hidden")))
   18|       |#else
   19|       |#  define ZLIB_INTERNAL
   20|       |#endif
   21|       |
   22|       |#include "zlib.h"
   23|       |
   24|       |#if defined(STDC) && !defined(Z_SOLO)
   25|       |#  if !(defined(_WIN32_WCE) && defined(_MSC_VER))
   26|       |#    include <stddef.h>
   27|       |#  endif
   28|       |#  include <string.h>
   29|       |#  include <stdlib.h>
   30|       |#endif
   31|       |
   32|       |#ifndef local
   33|       |#  define local static
   34|       |#endif
   35|       |/* since "static" is used to mean two completely different things in C, we
   36|       |   define "local" for the non-static meaning of "static", for readability
   37|       |   (compile with -Dlocal if your debugger can't find static symbols) */
   38|       |
   39|       |typedef unsigned char  uch;
   40|       |typedef uch FAR uchf;
   41|       |typedef unsigned short ush;
   42|       |typedef ush FAR ushf;
   43|       |typedef unsigned long  ulg;
   44|       |
   45|       |#if !defined(Z_U8) && !defined(Z_SOLO) && defined(STDC)
   46|       |#  include <limits.h>
   47|       |#  if (ULONG_MAX == 0xffffffffffffffff)
   48|       |#    define Z_U8 unsigned long
   49|       |#  elif (ULLONG_MAX == 0xffffffffffffffff)
   50|       |#    define Z_U8 unsigned long long
   51|       |#  elif (ULONG_LONG_MAX == 0xffffffffffffffff)
   52|       |#    define Z_U8 unsigned long long
   53|       |#  elif (UINT_MAX == 0xffffffffffffffff)
   54|       |#    define Z_U8 unsigned
   55|       |#  endif
   56|       |#endif
   57|       |
   58|       |extern z_const char * const z_errmsg[10]; /* indexed by 2-zlib_error */
   59|       |/* (size given to avoid silly warnings with Visual C++) */
   60|       |
   61|      0|#define ERR_MSG(err) z_errmsg[(err) < -6 || (err) > 2 ? 9 : 2 - (err)]
   62|       |
   63|       |#define ERR_RETURN(strm,err) \
   64|      0|  return (strm->msg = ERR_MSG(err), (err))
   65|       |/* To be used only when the state is known to be valid */
   66|       |
   67|       |        /* common constants */
   68|       |#if MAX_WBITS < 9 || MAX_WBITS > 15
   69|       |#  error MAX_WBITS must be in 9..15
   70|       |#endif
   71|       |#ifndef DEF_WBITS
   72|   526k|#  define DEF_WBITS MAX_WBITS
   73|       |#endif
   74|       |/* default windowBits for decompression. MAX_WBITS is for compression only */
   75|       |
   76|       |#if MAX_MEM_LEVEL >= 8
   77|   263k|#  define DEF_MEM_LEVEL 8
   78|       |#else
   79|       |#  define DEF_MEM_LEVEL  MAX_MEM_LEVEL
   80|       |#endif
   81|       |/* default memLevel */
   82|       |
   83|       |#define STORED_BLOCK 0
   84|       |#define STATIC_TREES 1
   85|       |#define DYN_TREES    2
   86|       |/* The three kinds of block type */
   87|       |
   88|  21.4M|#define MIN_MATCH  3
   89|  14.8M|#define MAX_MATCH  258
   90|       |/* The minimum and maximum match lengths */
   91|       |
   92|      0|#define PRESET_DICT 0x20 /* preset dictionary flag in zlib header */
   93|       |
   94|       |        /* target dependencies */
   95|       |
   96|       |#if defined(MSDOS) || (defined(WINDOWS) && !defined(WIN32))
   97|       |#  define OS_CODE  0x00
   98|       |#  ifndef Z_SOLO
   99|       |#    if defined(__TURBOC__) || defined(__BORLANDC__)
  100|       |#      if (__STDC__ == 1) && (defined(__LARGE__) || defined(__COMPACT__))
  101|       |         /* Allow compilation with ANSI keywords only enabled */
  102|       |         void _Cdecl farfree( void *block );
  103|       |         void *_Cdecl farmalloc( unsigned long nbytes );
  104|       |#      else
  105|       |#        include <alloc.h>
  106|       |#      endif
  107|       |#    else /* MSC or DJGPP */
  108|       |#      include <malloc.h>
  109|       |#    endif
  110|       |#  endif
  111|       |#endif
  112|       |
  113|       |#ifdef AMIGA
  114|       |#  define OS_CODE  1
  115|       |#endif
  116|       |
  117|       |#if defined(VAXC) || defined(VMS)
  118|       |#  define OS_CODE  2
  119|       |#  define F_OPEN(name, mode) \
  120|       |     fopen((name), (mode), "mbc=60", "ctx=stm", "rfm=fix", "mrs=512")
  121|       |#endif
  122|       |
  123|       |#ifdef __370__
  124|       |#  if __TARGET_LIB__ < 0x20000000
  125|       |#    define OS_CODE 4
  126|       |#  elif __TARGET_LIB__ < 0x40000000
  127|       |#    define OS_CODE 11
  128|       |#  else
  129|       |#    define OS_CODE 8
  130|       |#  endif
  131|       |#endif
  132|       |
  133|       |#if defined(ATARI) || defined(atarist)
  134|       |#  define OS_CODE  5
  135|       |#endif
  136|       |
  137|       |#ifdef OS2
  138|       |#  define OS_CODE  6
  139|       |#  if defined(M_I86) && !defined(Z_SOLO)
  140|       |#    include <malloc.h>
  141|       |#  endif
  142|       |#endif
  143|       |
  144|       |#if defined(MACOS)
  145|       |#  define OS_CODE  7
  146|       |#endif
  147|       |
  148|       |#if defined(__acorn) || defined(__riscos)
  149|       |#  define OS_CODE 13
  150|       |#endif
  151|       |
  152|       |#if defined(WIN32) && !defined(__CYGWIN__)
  153|       |#  define OS_CODE  10
  154|       |#endif
  155|       |
  156|       |#ifdef _BEOS_
  157|       |#  define OS_CODE  16
  158|       |#endif
  159|       |
  160|       |#ifdef __TOS_OS400__
  161|       |#  define OS_CODE 18
  162|       |#endif
  163|       |
  164|       |#ifdef __APPLE__
  165|       |#  define OS_CODE 19
  166|       |#endif
  167|       |
  168|       |#if defined(__BORLANDC__) && !defined(MSDOS)
  169|       |  #pragma warn -8004
  170|       |  #pragma warn -8008
  171|       |  #pragma warn -8066
  172|       |#endif
  173|       |
  174|       |/* provide prototypes for these when building zlib without LFS */
  175|       |#ifndef Z_LARGE64
  176|       |   ZEXTERN uLong ZEXPORT adler32_combine64(uLong, uLong, z_off64_t);
  177|       |   ZEXTERN uLong ZEXPORT crc32_combine64(uLong, uLong, z_off64_t);
  178|       |   ZEXTERN uLong ZEXPORT crc32_combine_gen64(z_off64_t);
  179|       |#endif
  180|       |
  181|       |        /* common defaults */
  182|       |
  183|       |#ifndef OS_CODE
  184|       |#  define OS_CODE  3     /* assume Unix */
  185|       |#endif
  186|       |
  187|       |#ifndef F_OPEN
  188|       |#  define F_OPEN(name, mode) fopen((name), (mode))
  189|       |#endif
  190|       |
  191|       |         /* functions */
  192|       |
  193|       |#if defined(pyr) || defined(Z_SOLO)
  194|       |#  define NO_MEMCPY
  195|       |#endif
  196|       |#if defined(SMALL_MEDIUM) && !defined(_MSC_VER) && !defined(__SC__)
  197|       | /* Use our own functions for small and medium model with MSC <= 5.0.
  198|       |  * You may have to use the same strategy for Borland C (untested).
  199|       |  * The __SC__ check is for Symantec.
  200|       |  */
  201|       |#  define NO_MEMCPY
  202|       |#endif
  203|       |#if defined(STDC) && !defined(HAVE_MEMCPY) && !defined(NO_MEMCPY)
  204|       |#  define HAVE_MEMCPY
  205|       |#endif
  206|       |#ifdef HAVE_MEMCPY
  207|       |#  ifdef SMALL_MEDIUM /* MSDOS small or medium model */
  208|       |#    define zmemcpy _fmemcpy
  209|       |#    define zmemcmp _fmemcmp
  210|       |#    define zmemzero(dest, len) _fmemset(dest, 0, len)
  211|       |#  else
  212|  1.10M|#    define zmemcpy memcpy
  213|       |#    define zmemcmp memcmp
  214|   511k|#    define zmemzero(dest, len) memset(dest, 0, len)
  215|       |#  endif
  216|       |#else
  217|       |   void ZLIB_INTERNAL zmemcpy(Bytef* dest, const Bytef* source, uInt len);
  218|       |   int ZLIB_INTERNAL zmemcmp(const Bytef* s1, const Bytef* s2, uInt len);
  219|       |   void ZLIB_INTERNAL zmemzero(Bytef* dest, uInt len);
  220|       |#endif
  221|       |
  222|       |/* Diagnostic functions */
  223|       |#ifdef ZLIB_DEBUG
  224|       |#  include <stdio.h>
  225|       |   extern int ZLIB_INTERNAL z_verbose;
  226|       |   extern void ZLIB_INTERNAL z_error(char *m);
  227|       |#  define Assert(cond,msg) {if(!(cond)) z_error(msg);}
  228|       |#  define Trace(x) {if (z_verbose>=0) fprintf x ;}
  229|       |#  define Tracev(x) {if (z_verbose>0) fprintf x ;}
  230|       |#  define Tracevv(x) {if (z_verbose>1) fprintf x ;}
  231|       |#  define Tracec(c,x) {if (z_verbose>0 && (c)) fprintf x ;}
  232|       |#  define Tracecv(c,x) {if (z_verbose>1 && (c)) fprintf x ;}
  233|       |#else
  234|       |#  define Assert(cond,msg)
  235|       |#  define Trace(x)
  236|       |#  define Tracev(x)
  237|       |#  define Tracevv(x)
  238|       |#  define Tracec(c,x)
  239|       |#  define Tracecv(c,x)
  240|       |#endif
  241|       |
  242|       |#ifndef Z_SOLO
  243|       |   voidpf ZLIB_INTERNAL zcalloc(voidpf opaque, unsigned items,
  244|       |                                unsigned size);
  245|       |   void ZLIB_INTERNAL zcfree(voidpf opaque, voidpf ptr);
  246|       |#endif
  247|       |
  248|       |#define ZALLOC(strm, items, size) \
  249|  1.85M|           (*((strm)->zalloc))((strm)->opaque, (items), (size))
  250|  1.85M|#define ZFREE(strm, addr)  (*((strm)->zfree))((strm)->opaque, (voidpf)(addr))
  251|  1.05M|#define TRY_FREE(s, p) {if (p) ZFREE(s, p);}
  252|       |
  253|       |/* Reverse the bytes in a 32-bit value */
  254|   263k|#define ZSWAP32(q) ((((q) >> 24) & 0xff) + (((q) >> 8) & 0xff00) + \
  255|   263k|                    (((q) & 0xff00) << 8) + (((q) & 0xff) << 24))
  256|       |
  257|       |#endif /* ZUTIL_H */

